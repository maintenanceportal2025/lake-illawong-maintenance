<!--
=====================================================================
LAKE ILLAWONG MANAGEMENT SYSTEM - COMMUNITY SURVEYS
=====================================================================
PURPOSE: Resident interface for viewing and completing community surveys
PORTAL: Residents Portal (Public Access)
VERSION: 2.2.0 (Unit number collection for non-anonymous surveys)
LAST UPDATED: January 27, 2026
BACKEND API: SurveyModule V1.2.1 (JSONP only)
DESIGN SYSTEM: Lake Illawong Unified v1.4 + Mockup Design

CHANGES IN V2.2.0:
- NEW: Unit number collection for non-anonymous surveys
- Unit dropdown modal appears before non-anonymous survey starts
- Respondent field now uses actual unit number (e.g., "Unit 5") for identified surveys
- Duplicate prevention now works correctly (per unit, not system-wide)
- Anonymous surveys unchanged - still use "Anonymous" as respondent

CHANGES IN V2.1.1:
- BUGFIX: Improved null handling for ratingMin/ratingMax (prevents "Null 1 2 3" display)
- Added explicit null checks in rating scale rendering

CHANGES IN V2.1:
- Dynamic rating scales: supports 1-5 (satisfaction) and 0-10 (NPS) scales
- Rating labels adjust based on scale type
- Backend reads ratingMin/ratingMax from question data

CHANGES IN V2.0:
- Questions use dividing lines instead of boxes (cleaner mockup design)
- Survey cards include icon/emoji display
- Status badge appears inline with title
- Meta items use emojis (üìÖ üìä üë• ‚è±Ô∏è)
- "Take Survey ‚Üí" button text
- Character counter on text areas
- Question numbering excludes section breaks (matches progress bar)
=====================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Surveys - Lake Illawong</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(90deg, #1e40af 0%, #1e3a8a 100%);
            min-height: 100vh;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* HEADER */
        .header {
            background: transparent;
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .logo-container {
            flex-shrink: 0;
        }

        .logo-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            padding: 5px;
        }

        .header-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
        }

        .header-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: white;
            margin: 0 0 5px 0;
            line-height: 1.1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header-subtitle {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            margin: 0;
        }

        .header-divider {
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            margin-top: 15px;
        }

        /* BACK BUTTON */
        .back-button {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            color: #374151;
            border: 2px solid #e2e8f0;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .back-button:hover {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .nav-button {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            color: #374151;
            border: 2px solid #e2e8f0;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .nav-button:hover {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        /* CONTENT CARD */
        .content-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        /* SURVEY LIST */
        .survey-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .survey-item {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .survey-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
        }

        .survey-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .survey-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .survey-status {
            background: #d1fae5;
            color: #047857;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .survey-description {
            color: #64748b;
            font-size: 1rem;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .survey-meta {
            display: flex;
            gap: 20px;
            font-size: 0.85rem;
            color: #64748b;
        }

        .survey-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .survey-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .btn-take-survey {
            flex: 1;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .btn-take-survey:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* QUESTION FORM */
        .question-container {
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
        }

        .question-container:last-of-type {
            border-bottom: none;
        }

        .question-number {
            font-size: 0.9rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .question-required {
            color: #ef4444;
            font-size: 0.9rem;
            margin-left: 4px;
        }

        .question-help {
            font-size: 0.9rem;
            color: #5f6368;
            margin: 8px 0 15px 0;
            line-height: 1.4;
            padding: 10px 15px;
            background: #f8f9fa;
            border-left: 3px solid #4285f4;
            border-radius: 0 8px 8px 0;
        }

        /* INPUT STYLES */
        .text-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .text-input.textarea {
            min-height: 120px;
            resize: vertical;
        }

        .char-count {
            text-align: right;
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 5px;
        }

        /* CHOICE OPTIONS */
        .choice-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .choice-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .choice-option:hover {
            border-color: #667eea;
            background: #f8fafc;
        }

        .choice-input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .choice-label {
            flex: 1;
            font-size: 0.95rem;
            color: #374151;
            cursor: pointer;
            font-weight: 500;
        }

        /* RATING STARS */
        /* RATING SCALE */
        .rating-scale {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .rating-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .rating-circle {
            width: 50px;
            height: 50px;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-circle:hover {
            border-color: #667eea;
            background: #f8fafc;
            transform: scale(1.1);
        }

        .rating-circle.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.15);
        }

        /* Add this to your CSS section */
.rating-label {
    font-size: 0.75rem;
    color: #64748b;
    font-weight: 600;
    text-align: center;
    white-space: pre-line; /* Allows \n for line breaks */
    line-height: 1.2;
    min-height: 2.4rem; /* Fixed height for consistency */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
}

/* For middle numbers with no labels */
.rating-label:empty {
    min-height: 1.2rem; /* Smaller height when empty */
}

.rating-label:not(:empty) {
    margin-top: 4px;
}

        /* PROGRESS BAR - GOOGLE FORMS STYLE */
        .progress-container {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-text {
            font-size: 1rem;
            color: #1e293b;
            font-weight: 500;
        }

        .progress-percentage {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1rem;
        }

        .progress-bar-google {
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill-google {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-fill-google::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* BUTTONS */
        .btn-primary {
            flex: 1;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            flex: 1;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            color: #374151;
            border: 2px solid #e2e8f0;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            transform: translateY(-2px);
        }

        /* MESSAGES */
        .success-message {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #047857;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .success-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .success-text {
            font-size: 1rem;
            line-height: 1.6;
        }

        .error-message {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #dc2626;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .warning-message {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* LOADING STATE */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 40px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #64748b;
            font-size: 1.1rem;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .empty-state-description {
            font-size: 1rem;
            margin-bottom: 25px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .header-text {
                align-items: center;
                text-align: center;
            }

            .header-title {
                font-size: 1.8rem;
            }

            .logo-image {
                width: 70px;
                height: 70px;
            }

            .content-card {
                padding: 20px;
            }

            .survey-title {
                font-size: 1.2rem;
            }

            .question-text {
                font-size: 1.1rem;
            }

            .rating-scale {
                flex-wrap: wrap;
                gap: 8px;
            }

            .rating-circle {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
        }
/* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
        }

        .modal-description {
            color: #64748b;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 20px;
            background: white;
            cursor: pointer;
        }

        .modal-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        .modal-btn-primary {
            flex: 1;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn-primary:hover {
            opacity: 0.9;
        }

        .modal-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-btn-secondary {
            flex: 1;
            padding: 12px 24px;
            background: white;
            color: #64748b;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn-secondary:hover {
            background: #f8fafc;
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="header-content">
                <div class="logo-container">
                    <img src="logo.png" alt="Lake Illawong Logo" class="logo-image">
                </div>
                <div class="header-text">
                    <h1 class="header-title">Community Surveys</h1>
                    <p class="header-subtitle">Share your feedback and help shape our community</p>
                </div>
            </div>
            <div class="header-divider"></div>
        </div>

        <!-- NAVIGATION HEADER -->
        <div style="background: white; padding: 20px 30px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); display: flex; justify-content: space-between; align-items: center;">
            <a href="ResidentPortal.html" class="back-button">‚Üê Back to Resident Portal</a>
            <button onclick="showView('list')" class="nav-button">Survey Listing</button>
        </div>

        <!-- SURVEY LIST VIEW -->
        <div id="listView" class="content-card">
            <h2 style="font-size: 1.8rem; font-weight: 700; margin-bottom: 20px; color: #1e293b;">Active Surveys</h2>
            <div id="surveyList">
                <div class="loading-message">
                    <div class="loading-spinner"></div>
                    <div>Loading surveys...</div>
                </div>
            </div>
        </div>

        <!-- TAKE SURVEY VIEW -->
        <div id="surveyView" class="content-card hidden">
            <div id="surveyHeader">
                <!-- Survey title and description -->
            </div>

            <!-- PROGRESS BAR -->
            <div style="margin-bottom: 30px;">
                <div style="background: #e2e8f0; border-radius: 8px; height: 8px; margin-bottom: 10px; overflow: hidden;">
                    <div id="progressBar" style="background: linear-gradient(135deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="progressText" style="text-align: center; color: #64748b; font-size: 0.85rem;">Question 0 of 0</div>
            </div>

            <div id="messageContainer"></div>

            <form id="surveyForm">
                <div id="questionsContainer">
                    <!-- Questions will be added here -->
                </div>

                <div style="display: flex; gap: 15px; margin-top: 40px; padding-top: 30px; border-top: 2px solid #e2e8f0;">
                    <button type="button" class="btn-secondary" onclick="showView('list')">
                        ‚Üê Cancel
                    </button>
                    <button type="submit" id="submitBtn" class="btn-primary">
                        Submit Survey ‚úì
                    </button>
                </div>
            </form>
        </div>

        <!-- ENHANCED THANK YOU VIEW -->
        <div id="thankYouView" class="content-card hidden">
            <div class="success-message">
                <div class="success-icon">‚úÖ</div>
                <div class="success-title">Survey Submitted Successfully!</div>
                <div id="confirmationContent" class="success-text"></div>
            </div>
            
            <div id="responseSummary" style="
                background: #f8fafc;
                border: 2px solid #e2e8f0;
                border-radius: 12px;
                padding: 20px;
                margin: 20px 0;
                display: none;
            ">
                <h3 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; color: #1e293b;">
                    Your Response Summary
                </h3>
                <div id="summaryContent"></div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;">
                <button class="btn-primary" onclick="showView('list')">View Other Surveys</button>
                <button id="anotherResponseBtn" class="btn-secondary" style="display: none;" onclick="submitAnotherResponse()">
                    Submit Another Response
                </button>
            </div>
        </div>
    </div>

<!-- UNIT NUMBER MODAL (for non-anonymous surveys) -->
        <div id="unitModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-title">Before You Begin</div>
                <div class="modal-description">
                    This survey collects identified responses. Please select your unit number to continue.
                </div>
                <select id="unitSelect" class="modal-select">
                    <option value="">-- Select Your Unit --</option>
                    <option value="Unit 1">Unit 1</option>
                    <option value="Unit 2">Unit 2</option>
                    <option value="Unit 3">Unit 3</option>
                    <option value="Unit 4">Unit 4</option>
                    <option value="Unit 5">Unit 5</option>
                    <option value="Unit 6">Unit 6</option>
                    <option value="Unit 7">Unit 7</option>
                    <option value="Unit 8">Unit 8</option>
                    <option value="Unit 9">Unit 9</option>
                    <option value="Unit 10">Unit 10</option>
                    <option value="Unit 11">Unit 11</option>
                    <option value="Unit 12">Unit 12</option>
                    <option value="Unit 13">Unit 13</option>
                    <option value="Unit 14">Unit 14</option>
                    <option value="Unit 15">Unit 15</option>
                    <option value="Unit 16">Unit 16</option>
                    <option value="Unit 17">Unit 17</option>
                    <option value="Unit 18">Unit 18</option>
                    <option value="Unit 19">Unit 19</option>
                    <option value="Unit 20">Unit 20</option>
                    <option value="Unit 21">Unit 21</option>
                    <option value="Unit 22">Unit 22</option>
                    <option value="Unit 23">Unit 23</option>
                    <option value="Unit 24">Unit 24</option>
                    <option value="Unit 25">Unit 25</option>
                    <option value="Unit 26">Unit 26</option>
                    <option value="Unit 27">Unit 27</option>
                    <option value="Unit 28">Unit 28</option>
                    <option value="Unit 29">Unit 29</option>
                    <option value="Unit 30">Unit 30</option>
                    <option value="Unit 31">Unit 31</option>
                    <option value="Unit 32">Unit 32</option>
                    <option value="Unit 33">Unit 33</option>
                    <option value="Unit 34">Unit 34</option>
                    <option value="Unit 35">Unit 35</option>
                    <option value="Unit 36">Unit 36</option>
                    <option value="Unit 37">Unit 37</option>
                    <option value="Unit 38">Unit 38</option>
                    <option value="Unit 39">Unit 39</option>
                    <option value="Unit 40">Unit 40</option>
                    <option value="Unit 41">Unit 41</option>
                    <option value="Unit 42">Unit 42</option>
                    <option value="Unit 43">Unit 43</option>
                    <option value="Unit 44">Unit 44</option>
                </select>
                <div class="modal-buttons">
                    <button class="modal-btn-secondary" onclick="cancelUnitSelection()">Cancel</button>
                    <button class="modal-btn-primary" onclick="confirmUnitSelection()">Continue to Survey</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const SURVEY_API_URL = 'https://script.google.com/macros/s/AKfycby4CGaQHZbNwQZTv1t4zFnZ8L8opU0jqpAOWBzstfTqA7oTAN-oPykOhWjdZAxJrLazFA/exec';

        // STATE
        let allSurveys = [];
        let currentSurvey = null;
        let currentQuestionIndex = 0;
        let responses = {};
        let currentRespondent = null; // Stores unit number for non-anonymous surveys
        let isTestMode = false; // Test mode flag

        /// INITIALIZATION
        document.addEventListener('DOMContentLoaded', function() {
            // Check for survey ID in URL
            const urlParams = new URLSearchParams(window.location.search);
            const surveyId = urlParams.get('survey');
            isTestMode = urlParams.get('testMode') === 'true'; // Check if in test mode
            
            if (surveyId) {
                loadSurveyDetails(surveyId);
            } else {
                loadSurveys();
            }

            // Form submission
            document.getElementById('surveyForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitSurvey();
            });
        });

        // JSONP HELPER
        function callAPI(action, params, callback) {
            const callbackName = 'surveyCallback_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            
            console.log('üîç Calling API:', action, params);
            
            window[callbackName] = function(response) {
                console.log('‚úÖ API Response received:', response);
                callback(response);
                delete window[callbackName];
                const script = document.querySelector(`script[src*="${callbackName}"]`);
                if (script) script.remove();
            };
            
            const script = document.createElement('script');
            let url = `${SURVEY_API_URL}?action=${action}&callback=${callbackName}`;
            
            // Add additional parameters
            for (let key in params) {
                url += `&${key}=${encodeURIComponent(params[key])}`;
            }
            
            console.log('üîç Request URL:', url);
            
            script.src = url;
            script.onerror = function(e) {
                console.error('‚ùå Script load error:', e);
                callback({ success: false, error: 'Network error - unable to load script' });
                delete window[callbackName];
            };
            
            document.head.appendChild(script);
        }

        // VIEW MANAGEMENT
        function showView(viewName) {
            document.getElementById('listView').classList.add('hidden');
            document.getElementById('surveyView').classList.add('hidden');
            document.getElementById('thankYouView').classList.add('hidden');

            if (viewName === 'list') {
                document.getElementById('listView').classList.remove('hidden');
                loadSurveys();
            } else if (viewName === 'survey') {
                document.getElementById('surveyView').classList.remove('hidden');
            } else if (viewName === 'thankyou') {
                document.getElementById('thankYouView').classList.remove('hidden');
            }
        }

        // LOAD SURVEYS
        function loadSurveys() {
            const container = document.getElementById('surveyList');
            container.innerHTML = '<div class="loading-message"><div class="loading-spinner"></div><div>Loading surveys...</div></div>';

            console.log('üîç Loading surveys...');
            console.log('üîç API URL:', SURVEY_API_URL);

            callAPI('getSurveys', { includeArchived: 'false', isAdmin: 'false' }, function(data) {
                console.log('‚úÖ Surveys response:', data);
                
                if (data.success) {
                    allSurveys = data.surveys;
                    renderSurveys();
                } else {
                    const errorMsg = data.message || data.error || 'Unknown error';
                    console.error('‚ùå Error:', errorMsg);
                    container.innerHTML = `<div class="error-message">‚ùå Error loading surveys: ${errorMsg}</div>`;
                }
            });
        }

        // RENDER SURVEYS
        function renderSurveys() {
            const container = document.getElementById('surveyList');
            
            if (allSurveys.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-title">No Active Surveys</div>
                        <div class="empty-state-description">There are currently no surveys available. Check back soon!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="survey-list">' + allSurveys.map(survey => {
                const icon = survey.icon || 'üìã';
                const estimatedTime = survey.estimatedTime || '~5 minutes';
                const dateLabel = survey.closeDate ? `Closes: ${formatDate(survey.closeDate)}` : `Created: ${formatDate(survey.createdDate)}`;
                
                return `
                <div class="survey-item" onclick="loadSurveyDetails('${survey.surveyId}')">
                    <div class="survey-item-header">
                        <div style="display: flex; align-items: flex-start; flex: 1; gap: 15px;">
                            <div style="font-size: 2rem; flex-shrink: 0;">${icon}</div>
                            <div style="flex: 1;">
                                <div class="survey-title">${escapeHtml(survey.title)}</div>
                                <span class="survey-status">Active</span>
                            </div>
                        </div>
                    </div>
                    <div class="survey-description">${escapeHtml(survey.description || 'No description available')}</div>
                    <div class="survey-meta">
                        <div class="survey-meta-item">
                            üìÖ ${dateLabel}
                        </div>
                        <div class="survey-meta-item">
                            üë• ${survey.totalResponses || 0} responses
                        </div>
                        <div class="survey-meta-item">
                            ‚è±Ô∏è ${estimatedTime}
                        </div>
                        ${survey.isAnonymous ? '<div class="survey-meta-item">üîí Anonymous</div>' : ''}
                    </div>
                    <div class="survey-actions" onclick="event.stopPropagation()">
                        <button class="btn-take-survey" onclick="loadSurveyDetails('${survey.surveyId}')">
                            Take Survey ‚Üí
                        </button>
                    </div>
                </div>
            `;
            }).join('') + '</div>';
        }

        // LOAD SURVEY DETAILS
        function loadSurveyDetails(surveyId) {
            // Immediately show loading state in the survey list (only if called from button click)
            let button = null;
            if (typeof event !== 'undefined' && event.target) {
                button = event.target.closest('.btn-take-survey');
                if (button) {
                    button.disabled = true;
                    button.style.opacity = '0.6';
                    button.innerHTML = 'Loading...';
                }
            }
            
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '<div class="loading-message"><div class="loading-spinner"></div><div>Loading survey...</div></div>';

            callAPI('getSurveyDetails', { surveyId: surveyId }, function(data) {
                // Re-enable button
                if (button) {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.innerHTML = 'Take Survey ‚Üí';
                }
                
                if (data.success) {
                    currentSurvey = data.survey;
                    responses = {};
                    currentQuestionIndex = 0;
                    
                    // Check if this is a non-anonymous survey that needs unit collection
                    if (!currentSurvey.isAnonymous) {
                        // Show unit selection modal
                        showUnitModal();
                    } else {
                        // Anonymous survey - proceed directly
                        currentRespondent = null;
                        showView('survey');
                        renderSurvey();
                    }
                } else {
                    container.innerHTML = '<div class="error-message">Error: ' + data.message + '</div>';
                }
            });
        }

// UNIT MODAL FUNCTIONS
        function showUnitModal() {
            document.getElementById('unitModal').classList.remove('hidden');
            document.getElementById('unitSelect').value = '';
        }

        function cancelUnitSelection() {
            document.getElementById('unitModal').classList.add('hidden');
            currentRespondent = null;
            showView('list');
        }

        function confirmUnitSelection() {
            const unitSelect = document.getElementById('unitSelect');
            const selectedUnit = unitSelect.value;
            
            if (!selectedUnit) {
                alert('Please select your unit number');
                return;
            }
            
            currentRespondent = selectedUnit;
            document.getElementById('unitModal').classList.add('hidden');
            showView('survey');
            renderSurvey();
        }

        // RENDER SURVEY
        function renderSurvey() {
            const survey = currentSurvey;
            // Update header with mockup styling
            document.getElementById('surveyHeader').innerHTML = `
                <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                    ${isTestMode ? '<div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 600; font-size: 1rem;">üß™ TEST MODE - Responses will NOT be saved to the database</div>' : ''}
                    <h2 style="font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; color: #1e293b;">${escapeHtml(survey.title)}</h2>
                    <p style="color: #64748b; font-size: 1rem; line-height: 1.6;">${escapeHtml(survey.description || '')}</p>


                    ${survey.isAnonymous ? '<div style="margin-top: 15px; padding: 10px 16px; background: #e0f2fe; color: #0369a1; border-radius: 8px; display: inline-block; font-size: 0.85rem;">üîí This survey is anonymous. Your responses will not be linked to your identity.</div>' : ''}
                </div>
            `;

            // Update progress
            updateProgress();
            
            // Calculate total regular questions (excluding section breaks) for numbering
            const regularQuestions = survey.questions.filter(q => q.questionType !== 'Section Break');
            const totalRegularQuestions = regularQuestions.length;
            
            // Track question number for regular questions only
            let regularQuestionNumber = 0;
            
            // Render questions
            const container = document.getElementById('questionsContainer');
            container.innerHTML = survey.questions.map((question, index) => {
                // Increment question number only for regular questions
                if (question.questionType !== 'Section Break') {
                    regularQuestionNumber++;
                }
                return renderQuestion(question, index, regularQuestionNumber, totalRegularQuestions);
            }).join('');
        }

        // RENDER QUESTION
        function renderQuestion(question, index, questionNum, totalQuestions) {
            
            // Handle Section Break differently - it's not a regular question
            if (question.questionType === 'Section Break') {
                return `
                    <div class="section-break" style="
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        padding: 30px;
                        border-radius: 12px;
                        margin: 40px 0;
                        text-align: center;
                        position: relative;
                        overflow: hidden;
                    ">
                        <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; position: relative; z-index: 1;">
                            ${escapeHtml(question.questionText || 'Section Break')}
                        </div>
                        ${question.helpText ? `
                            <div style="width: 80px; height: 4px; background: rgba(255, 255, 255, 0.3); margin: 20px auto; border-radius: 2px;"></div>
                            <div style="font-size: 1rem; opacity: 0.9; line-height: 1.6; position: relative; z-index: 1;">
                                ${escapeHtml(question.helpText)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // For regular questions, build the input HTML
            let inputHtml = '';
            
            if (question.questionType === 'Multiple Choice') {
                inputHtml = `
                    <div class="choice-options">
                        ${question.optionsArray.map((option, optIndex) => `
                            <div class="choice-option" onclick="toggleChoice('${question.questionId}', '${escapeHtml(option)}', true, this)">
                                <input type="checkbox" 
                                       id="${question.questionId}_${optIndex}" 
                                       name="${question.questionId}" 
                                       value="${escapeHtml(option)}"
                                       class="choice-input"
                                       onchange="updateResponse('${question.questionId}')">
                                <label for="${question.questionId}_${optIndex}" class="choice-label">${escapeHtml(option)}</label>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (question.questionType === 'Single Choice' || question.questionType === 'Yes/No') {
                inputHtml = `
                    <div class="choice-options">
                        ${question.optionsArray.map((option, optIndex) => `
                            <div class="choice-option" onclick="toggleChoice('${question.questionId}', '${escapeHtml(option)}', false, this)">
                                <input type="radio" 
                                       id="${question.questionId}_${optIndex}" 
                                       name="${question.questionId}" 
                                       value="${escapeHtml(option)}"
                                       class="choice-input"
                                       onchange="updateResponse('${question.questionId}')">
                                <label for="${question.questionId}_${optIndex}" class="choice-label">${escapeHtml(option)}</label>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (question.questionType === 'Text') {
                inputHtml = `
                    <textarea 
                        id="${question.questionId}" 
                        class="text-input textarea" 
                        placeholder="Enter your response..."
                        onchange="updateResponse('${question.questionId}')"
                        oninput="updateCharCount(this, 500)"
                        maxlength="500"
                        ${question.isRequired ? 'required' : ''}></textarea>
                    <div class="char-count">0 / 500 characters</div>
                `;
            } else if (question.questionType === 'Rating') {
    // Get rating range from question (default to 1-5)
    const ratingMin = (question.ratingMin !== undefined && question.ratingMin !== null) ? question.ratingMin : 1;
    const ratingMax = (question.ratingMax !== undefined && question.ratingMax !== null) ? question.ratingMax : 5;
    
    // Get custom rating labels if available
    const ratingLabels = question.ratingLabels || [];
    
    // Build rating array dynamically
    const ratings = [];
    for (let i = ratingMin; i <= ratingMax; i++) {
        ratings.push(i);
    }
    
    // SIMPLE SOLUTION: Build HTML with conditional label display
    let ratingScaleHTML = '<div class="rating-scale">';
    
    ratings.forEach(rating => {
        const label = getRatingLabel(rating, ratingMin, ratingMax, ratingLabels);
        ratingScaleHTML += `
            <div class="rating-option">
                <div class="rating-circle" onclick="selectRating('${question.questionId}', ${rating}, this)">${rating}</div>
                ${label ? `<div class="rating-label">${label}</div>` : '<div class="rating-label" style="visibility: hidden;">&nbsp;</div>'}
            </div>
        `;
    });
    
    ratingScaleHTML += '</div>';
    inputHtml = ratingScaleHTML + `<input type="hidden" id="${question.questionId}" ${question.isRequired ? 'required' : ''}>`;
    
    // Add scale info at the bottom
    const minLabel = ratingLabels[0] || (ratingMin === 1 ? 'Very Dissatisfied' : ratingMin === 0 ? 'Not at all likely' : '');
    const maxLabel = ratingLabels[ratingLabels.length - 1] || (ratingMax === 5 ? 'Very Satisfied' : ratingMax === 10 ? 'Extremely likely' : '');
    
    if (minLabel || maxLabel) {
        inputHtml += `
            <div style="text-align: center; margin-top: 10px; padding: 8px; background: #f8fafc; border-radius: 6px; font-size: 0.8rem; color: #64748b;">
                <strong>Scale:</strong> ${ratingMin} = ${minLabel} 
                <span style="margin: 0 8px;">‚Ä¢</span>
                ${ratingMax} = ${maxLabel}
            </div>
        `;
    }
}
            
            // Build question header (for regular questions only)
            const questionHeader = `
                <div class="question-text">
                    ${escapeHtml(question.questionText)}
                    ${question.isRequired ? '<span class="question-required">*</span>' : ''}
                </div>
                ${question.helpText ? `<div class="question-help">${escapeHtml(question.helpText)}</div>` : ''}
            `;
            
            return `
                <div class="question-container" data-question-index="${index}" data-question-id="${question.questionId}" data-question-type="${question.questionType}" data-has-conditional="${question.conditionalLogic && question.conditionalLogic !== 'none' ? 'true' : 'false'}">
                    <div class="question-number">Question ${questionNum} of ${totalQuestions}</div>
                    ${questionHeader}
                    ${inputHtml}
                </div>
            `;
        }

        // TOGGLE CHOICE
        function toggleChoice(questionId, value, isMultiple, element) {
            const input = element.querySelector('input');
            
            if (isMultiple) {
                // For checkboxes, just toggle
                input.checked = !input.checked;
            } else {
                // For radio buttons, uncheck all others first
                const container = element.parentElement;
                container.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.checked = false;
                });
                input.checked = true;
            }
            
            updateResponse(questionId);
        }

        // SET RATING
        // SELECT RATING
        function selectRating(questionId, rating, circle) {
            // Find the rating scale container (parent of parent)
            const container = circle.parentElement.parentElement;
            
            // Deselect all circles
            container.querySelectorAll('.rating-circle').forEach(c => {
                c.classList.remove('selected');
            });
            
            // Select the clicked circle
            circle.classList.add('selected');
            
            // Store the rating
            document.getElementById(questionId).value = rating;
            responses[questionId] = rating.toString();
            // EVALUATE SKIP LOGIC for rating questions
            evaluateSkipLogic(questionId, rating.toString());
            updateProgress();
        }

        // GET RATING LABEL
       function getRatingLabel(rating, min, max, ratingLabels = []) {
    // First check if custom labels are provided
    if (ratingLabels && ratingLabels.length > 0) {
        // Calculate index for the rating (0-based for arrays)
        const index = rating - min;
        if (index >= 0 && index < ratingLabels.length) {
            const label = ratingLabels[index];
            // SIMPLE SOLUTION: Only return label if it's not empty
            // Empty strings for middle numbers = show number only
            return label && label.trim() !== '' ? label : '';
        }
    }
    
    // Fallback to default labels - also using SIMPLE SOLUTION
    // For 1-5 scale (satisfaction) - only show labels on 1 and 5
    if (min === 1 && max === 5) {
        if (rating === 1) return 'Very\nDissatisfied';
        if (rating === 5) return 'Very\nSatisfied';
        return ''; // 2, 3, 4 show as numbers only
    }
    
    // For 0-10 scale (NPS) - only show labels on 0 and 10
    if (min === 0 && max === 10) {
        if (rating === 0) return 'Not at all\nlikely';
        if (rating === 10) return 'Extremely\nlikely';
        return ''; // 1-9 show as numbers only
    }
    
    // For other scales, show min/max labels only
    if (rating === min) return 'Low';
    if (rating === max) return 'High';
    return '';
}

// EVALUATE SKIP LOGIC
        function evaluateSkipLogic(questionId, answer) {
            const question = currentSurvey.questions.find(q => q.questionId === questionId);
            
            // Check if question has conditional logic
            if (!question || !question.conditionalLogic || question.conditionalLogic === 'none') {
                return; // No skip logic on this question
            }
            
            // Check if there are condition rules
            if (!question.conditionRules || question.conditionRules.length === 0) {
                return; // No rules defined
            }
            
            // Find matching rule based on answer
            let matchedRule = null;
            for (let rule of question.conditionRules) {
                if (rule.value === answer) {
                    matchedRule = rule;
                    break;
                }
            }
            
            if (!matchedRule) {
                // No rule matched - show all questions (reset to normal flow)
                const allContainers = document.querySelectorAll('.question-container');
                allContainers.forEach(container => {
                    container.style.display = 'block';
                });
                return;
            }
            
            // Get current question index
            const currentQuestionIndex = currentSurvey.questions.findIndex(q => q.questionId === questionId);
            
            // Handle the matched rule
            if (matchedRule.target === 'end_survey') {
                // Hide all questions after current one
                const allContainers = document.querySelectorAll('.question-container');
                allContainers.forEach(container => {
                    const containerIndex = parseInt(container.getAttribute('data-question-index'));
                    if (containerIndex > currentQuestionIndex) {
                        container.style.display = 'none';
                    }
                });
            } else {
                // Skip to specific question (format: "Q4" or "Q10")
                const targetQuestionRef = matchedRule.target;
                
                // Find target question index
                let targetQuestionIndex = -1;
                if (targetQuestionRef.startsWith('Q')) {
                    // It's a Q reference - need to find the actual question
                    const targetQuestionNum = parseInt(targetQuestionRef.substring(1));
                    // Find the Nth regular question (excluding section breaks)
                    let regularQuestionCount = 0;
                    for (let i = 0; i < currentSurvey.questions.length; i++) {
                        if (currentSurvey.questions[i].questionType !== 'Section Break') {
                            regularQuestionCount++;
                            if (regularQuestionCount === targetQuestionNum) {
                                targetQuestionIndex = i;
                                break;
                            }
                        }
                    }
                } else {
                    // It's a question ID - find by ID
                    targetQuestionIndex = currentSurvey.questions.findIndex(q => q.questionId === targetQuestionRef);
                }
                
                if (targetQuestionIndex === -1) {
                    return; // Target not found
                }
                
                // Hide all questions between current and target (exclusive)
                const allContainers = document.querySelectorAll('.question-container');
                allContainers.forEach(container => {
                    const containerIndex = parseInt(container.getAttribute('data-question-index'));
                    if (containerIndex > currentQuestionIndex && containerIndex < targetQuestionIndex) {
                        container.style.display = 'none';
                    } else {
                        container.style.display = 'block';
                    }
                });
            }
        }

        // UPDATE RESPONSE
        function updateResponse(questionId) {
            const question = currentSurvey.questions.find(q => q.questionId === questionId);
            
            if (!question) return;
            
            if (question.questionType === 'Multiple Choice') {
                const checked = Array.from(document.querySelectorAll(`input[name="${questionId}"]:checked`))
                    .map(input => input.value);
                responses[questionId] = checked.join('|');
} else if (question.questionType === 'Single Choice' || question.questionType === 'Yes/No') {
                const checked = document.querySelector(`input[name="${questionId}"]:checked`);
                responses[questionId] = checked ? checked.value : '';
                // EVALUATE SKIP LOGIC for single choice/yes-no questions
                if (checked) {
                    evaluateSkipLogic(questionId, checked.value);
                }
            } else if (question.questionType === 'Text') {
                responses[questionId] = document.getElementById(questionId).value;
            }
            
            updateProgress();
        }

        // UPDATE CHARACTER COUNT
        function updateCharCount(textarea, maxLength) {
            const charCount = textarea.value.length;
            const counter = textarea.nextElementSibling;
            if (counter && counter.classList.contains('char-count')) {
                counter.textContent = `${charCount} / ${maxLength} characters`;
            }
            updateResponse(textarea.id);
        }

        // UPDATE PROGRESS
        function updateProgress() {
            if (!currentSurvey || !currentSurvey.questions) return;
            
            // Filter out section breaks - they don't count in progress
            const regularQuestions = currentSurvey.questions.filter(q => q.questionType !== 'Section Break');
            
            // Count only answered regular questions (not section breaks)
            const answeredCount = regularQuestions.filter(question => 
                responses[question.questionId] && 
                responses[question.questionId].toString().trim() !== ''
            ).length;
            
            const totalQuestions = regularQuestions.length;
            const percentage = Math.round((answeredCount / totalQuestions) * 100);
            
            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
            
            // Update progress text
            const progressText = document.getElementById('progressText');
            if (progressText) {
                progressText.textContent = `Question ${answeredCount} of ${totalQuestions}`;
            }
        }

        // SUBMIT SURVEY
        function submitSurvey() {
            const messageDiv = document.getElementById('messageContainer');
            messageDiv.innerHTML = '';

            // Validate required questions (skip section breaks)
            const requiredQuestions = currentSurvey.questions.filter(q => 
                q.questionType !== 'Section Break' && q.isRequired
            );
            
            const missingRequired = requiredQuestions.filter(q => 
                !responses[q.questionId] || responses[q.questionId].toString().trim() === ''
            );
            
            if (missingRequired.length > 0) {
                messageDiv.innerHTML = `<div class="error-message">‚ùå Please answer all required questions (marked with *)</div>`;
                
                // Scroll to first missing required question
                const firstMissing = missingRequired[0];
                const questionIndex = currentSurvey.questions.findIndex(q => q.questionId === firstMissing.questionId);
                const questionElement = document.querySelector(`[data-question-index="${questionIndex}"]`);
                if (questionElement) {
                    questionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }

            // Build answers array (skip section breaks)
            const answers = currentSurvey.questions
                .filter(q => q.questionType !== 'Section Break')
                .map(question => ({
                    questionId: question.questionId,
                    answer: responses[question.questionId] || ''
                }));

            // Get respondent (unit number for identified surveys)
            const respondent = currentSurvey.isAnonymous ? 'Anonymous' : currentRespondent;

            const submitData = {
                surveyId: currentSurvey.surveyId,
                respondent: respondent,
                answers: answers
            };

            // Show loading
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            // Check if in test mode
            if (isTestMode) {
                // TEST MODE - Don't save, just show completion
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Survey';
                
                document.getElementById('confirmationContent').textContent = 'üß™ Test Complete! This was a test submission - no data was saved to the database. You can now close this window.';
                
                // Show response summary if enabled
                if (currentSurvey.showResponseSummary) {
                    showResponseSummary(responses);
                }
                
                showView('thankyou');
            } else {
                // REAL MODE - Submit via JSONP
                callAPI('submitResponse', { data: JSON.stringify(submitData) }, function(result) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Survey';

                    if (result.success) {
                        // Use custom confirmation message if available, otherwise use default
                        const confirmationMessage = currentSurvey.confirmationMessage || 
                                                   result.thankYouMessage || 
                                                   'Thank you for completing our survey! Your feedback is valuable to us.';
                        
                        document.getElementById('confirmationContent').textContent = confirmationMessage;
                        
                        // Show response summary if enabled
                        if (currentSurvey.showResponseSummary) {
                            showResponseSummary(responses);
                        }
                        
                        // Show "Submit Another Response" button if enabled and multiple responses allowed
                        if (currentSurvey.allowAnotherResponse && currentSurvey.allowMultipleResponses) {
                            document.getElementById('anotherResponseBtn').style.display = 'block';
                        }
                        
                        showView('thankyou');
                    } else {
                        messageDiv.innerHTML = `<div class="error-message">‚ùå Error: ${result.message || result.error}</div>`;
                    }
                });
            }
        }

        // SHOW RESPONSE SUMMARY
        function showResponseSummary(responses) {
            const summaryDiv = document.getElementById('responseSummary');
            const contentDiv = document.getElementById('summaryContent');
            
            let summaryHTML = '';
            
            currentSurvey.questions.forEach((question, index) => {
                if (question.questionType === 'Section Break') return;
                
                const response = responses[question.questionId];
                if (response) {
                    summaryHTML += `
                        <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0;">
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 5px;">
                                ${index + 1}. ${escapeHtml(question.questionText)}
                            </div>
                            <div style="color: #64748b; padding-left: 10px;">
                                <strong>Your answer:</strong> ${escapeHtml(response.toString())}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (summaryHTML) {
                contentDiv.innerHTML = summaryHTML;
                summaryDiv.style.display = 'block';
            }
        }

        // SUBMIT ANOTHER RESPONSE
        function submitAnotherResponse() {
            // Reset the form and show the survey again
            responses = {};
            currentQuestionIndex = 0;
            document.getElementById('surveyForm').reset();
            document.getElementById('anotherResponseBtn').style.display = 'none';
            document.getElementById('responseSummary').style.display = 'none';
            showView('survey');
            renderSurvey();
        }

        // UTILITY
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-AU', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
    </script>
</body>
</html>
