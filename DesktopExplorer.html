<!--
=====================================================================
üîç DESKTOP EXPLORER - DESKTOP PROBLEM DATA ANALYTICS
=====================================================================
PURPOSE: Desktop-optimized analytics interface with modern collapsible slicer design
PORTAL: Zone Reps Portal, Field Operations Portal, Admin Portal Module
VERSION: v2.0.0 - MODERN SLICER DESIGN
LAST UPDATED: November 4, 2025
DESIGN SYSTEM: Lake Illawong Unified v1.4
- Terminology: "Problem" standard (V1.4 update)
- Header: Transparent with logo (V1.3 standard)
- Colors: Primary gradient page background
- Layout: White content cards on gradient
- API Protocol: JSONP with proper callback cleanup
- Slicer Design: Collapsible sections matching ExecutiveDashboard.html
AUTHENTICATION: None (Public Access)
DEPENDENCIES: Explorer V1.0.js backend
RELATED FILES: ExecutiveDashboard.html (slicer pattern source)
HIERARCHICAL POSITION: system_desktop_explorer

MAJOR UPDATES V2.0.0:
‚úÖ Applied ExecutiveDashboard.html collapsible slicer pattern
‚úÖ Eliminated scrollbars - modern collapsible sections
‚úÖ Shows only items that exist in actual data
‚úÖ Excluded "Not Set" / empty values
‚úÖ Alphabetically sorted filter options
‚úÖ Year dropdown (2020-2035) instead of individual buttons
‚úÖ Date picker for custom ranges with 1M, 3M, 6M, 1Y retained
‚úÖ Programmed status filter at top (matching ExecutiveDashboard pattern)
‚úÖ Retained Generate Chart functionality
‚úÖ All sections start collapsed for clean interface
‚úÖ Follows Unified Design System v1.4 exactly
=====================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Desktop Explorer - Problem Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* UNIFIED DESIGN SYSTEM - Standard Typography */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(90deg, #1e40af 0%, #1e3a8a 100%);
            min-height: 100vh;
            color: #1e293b;
            line-height: 1.6;
        }

        /* UNIFIED DESIGN SYSTEM - Container Standards */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* UNIFIED DESIGN SYSTEM - Header Standards */
        .header {
            background: transparent;
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header-divider {
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 10%, rgba(255, 255, 255, 0.8) 50%, rgba(255, 255, 255, 0.3) 90%, transparent 100%);
            margin: 25px 0px 0px;
            border-radius: 1.5px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .logo-container {
            flex-shrink: 0;
        }

        .logo-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            padding: 5px;
        }

        .header-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
        }

        .header-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-text {
                align-items: center;
                text-align: center;
            }

            .logo-image {
                width: 80px;
                height: 80px;
            }

            .header-title {
                font-size: 1.8rem;
            }

            .header-subtitle {
                font-size: 1rem;
            }
        }

        /* Dataset Controls */
        .dataset-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .dataset-toggle {
            display: flex;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .dataset-btn {
            background: transparent;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .dataset-btn.active {
            background: white;
            color: #1e3a8a;
            font-weight: 600;
        }

        .dataset-btn:hover:not(.active) {
            background: rgba(255,255,255,0.2);
        }

        .refresh-btn {
            background: transparent;
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: white;
            color: #1e3a8a;
        }

        /* Main Layout */
        .dashboard-main {
            display: flex;
            gap: 20px;
            min-height: calc(100vh - 200px);
        }

        /* Slicer Panel - Matching ExecutiveDashboard design exactly */
        .slicer-panel {
            width: 300px;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 220px);
            border-radius: 12px;
        }

        .slicer-section {
            margin-bottom: 25px;
        }

        .slicer-header {
            font-weight: 700;
            color: #1e293b;
            font-size: 0.9rem;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3b82f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .slicer-header:hover {
            color: #3b82f6;
        }

        .slicer-header .expand-icon {
            font-size: 0.8rem;
            transition: transform 0.3s;
        }

        .slicer-header.collapsed .expand-icon {
            transform: rotate(-90deg);
        }

        .slicer-content {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            transition: max-height 0.3s ease-out;
        }

        .slicer-content.collapsed {
            max-height: 0;
        }

        .slicer-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slicer-item:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .slicer-item.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .slicer-badge {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .slicer-item.active .slicer-badge {
            background: rgba(255,255,255,0.3);
        }

        /* Date Range Controls */
        .date-range-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 10px 0;
        }

        .date-btn {
            padding: 6px 8px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s;
        }

        .date-btn:hover {
            background: #e2e8f0;
        }

        .date-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .year-select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.85rem;
            margin: 8px 0;
            background: white;
        }

        .year-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .date-picker-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .date-input {
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.85rem;
            width: 100%;
        }

        .date-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .apply-date-btn {
            padding: 8px 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .apply-date-btn:hover {
            background: #2563eb;
        }

        .clear-all-btn {
            width: 100%;
            padding: 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
        }

        .clear-all-btn:hover {
            background: #dc2626;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-y: auto;
            max-height: calc(100vh - 220px);
        }

        /* Search Input */
        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Stats Dashboard - COLORED & COMPACT LIKE EXISTING */
        .stats-dashboard {
            margin-bottom: 20px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .stat-card {
            text-align: center;
            padding: 12px 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 2px;
            line-height: 1;
        }

        .stat-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.8rem;
            margin-bottom: 1px;
        }

        .stat-sublabel {
            font-size: 0.7rem;
            color: #64748b;
            font-weight: 500;
        }

        /* Specific stat card colors - MATCHING EXISTING VERSION */
        .stat-card:nth-child(1) .stat-number { color: #3b82f6; } /* Blue - Total */
        .stat-card:nth-child(2) .stat-number { color: #f59e0b; } /* Orange - Active */
        .stat-card:nth-child(3) .stat-number { color: #ef4444; } /* Red - Urgent */
        .stat-card:nth-child(4) .stat-number { color: #10b981; } /* Green - Completion */
        .stat-card:nth-child(5) .stat-number { color: #8b5cf6; } /* Purple - Avg Resolution */
        .stat-card:nth-child(6) .stat-number { color: #06b6d4; } /* Cyan - Last 7 Days */

        /* Results Header */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .results-info {
            font-size: 1.1rem;
            color: #1e293b;
            font-weight: 600;
        }

        .results-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .action-btn {
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .action-btn:hover {
            background: #2563eb;
        }

        .action-btn.export {
            background: #059669;
        }

        .action-btn.export:hover {
            background: #047857;
        }

        .action-btn.chart {
            background: #8b5cf6;
        }

        .action-btn.chart:hover {
            background: #7c3aed;
        }

        .items-per-page {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .items-per-page select {
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
            cursor: pointer;
        }

        /* Problems Grid */
        .problems-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 16px;
        }

        .problem-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
            cursor: pointer;
            border-left: 4px solid #e5e7eb;
        }

        .problem-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .problem-card.urgent { border-left-color: #ef4444; }
        .problem-card.high { border-left-color: #f97316; }
        .problem-card.medium { border-left-color: #eab308; }
        .problem-card.low { border-left-color: #22c55e; }

        .card-header {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
        }

        .card-top-line {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
        }

        .card-pid {
            font-weight: 700;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .card-unit {
            background: #f1f5f9;
            color: #475569;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .card-zone {
            background: #e0f2fe;
            color: #0369a1;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 12px;
        }

        .card-date {
            font-size: 0.8rem;
            color: #64748b;
        }

        .card-reporter {
            font-size: 0.8rem;
            color: #64748b;
        }

        .card-description {
            color: #64748b;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .status-badge, .priority-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-reported { background: #dbeafe; color: #1d4ed8; }
        .status-in-progress { background: #fef3c7; color: #d97706; }
        .status-completed { background: #d1fae5; color: #047857; }
        .status-on-hold { background: #fde2e8; color: #be185d; }

        .priority-urgent { background: #fecaca; color: #dc2626; }
        .priority-high { background: #fed7aa; color: #ea580c; }
        .priority-medium { background: #fef3c7; color: #d97706; }
        .priority-low { background: #bbf7d0; color: #16a34a; }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 4px;
        }

        .close-btn:hover {
            color: #374151;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .detail-value {
            color: #64748b;
            line-height: 1.5;
        }

        /* Form Modal Styles */
        .problem-details-header, .contact-info-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 12px 12px 0 0;
        }

        .contact-info-header {
            margin: 20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
        }

        .problem-details-header h3, .contact-info-header h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .form-input, .form-textarea {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            background: #f9fafb;
            color: #374151;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #6366f1;
            background: white;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            margin-top: 20px;
        }

        .action-btn.secondary {
            background: #6b7280;
        }

        .action-btn.secondary:hover {
            background: #4b5563;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-actions {
                flex-direction: column;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Chart Modal Specific */
        .chart-type-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .chart-type-btn:hover {
            background: #2563eb;
        }

        /* Pagination Controls */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .pagination-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #2563eb;
        }

        .pagination-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .page-info {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
            padding: 8px 16px;
        }

        /* Scroll Navigation Buttons */
        .scroll-navigation {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .scroll-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .scroll-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5);
        }

        @media (max-width: 768px) {
            .scroll-navigation {
                bottom: 20px;
                right: 20px;
            }

            .scroll-btn {
                padding: 10px 14px;
                font-size: 0.8rem;
            }

            .pagination-container {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard-main {
                flex-direction: column;
            }

            .slicer-panel {
                width: 100%;
                max-height: 300px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .dataset-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .results-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .results-actions {
                justify-content: center;
            }

            .problems-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .scroll-navigation {
                bottom: 20px;
                right: 20px;
            }

            .scroll-btn {
                padding: 10px 14px;
                font-size: 0.8rem;
            }

            .pagination-container {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="logo-container">
                    <img src="logo.png" alt="Lake Illawong Logo" class="logo-image">
                </div>
                <div class="header-text">
                    <h1 class="header-title">Desktop Explorer</h1>
                    <p class="header-subtitle">Advanced Problem Analytics & Reporting</p>
                </div>
            </div>
            <div class="header-divider"></div>
        </div>

        <!-- Dataset Controls -->
        <div class="dataset-controls">
            <div class="dataset-toggle">
                <button class="dataset-btn active" id="allBtn">üìÑ All Data</button>
                <button class="dataset-btn" id="currentBtn">üìä Current</button>
                <button class="dataset-btn" id="legacyBtn">üìö Legacy</button>
            </div>
            <button class="refresh-btn" onclick="loadAllData()">üîÑ Refresh Data</button>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard-main">
            <!-- Slicer Panel -->
            <div class="slicer-panel">
                <!-- Programmed Status Filter -->
                <div class="slicer-section" style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 15px;">
                    <div class="slicer-header" style="border-bottom-color: #f59e0b;">
                        üîß PROGRAMMED STATUS
                    </div>
                    <div style="font-size: 0.75rem; color: #92400e; margin-bottom: 10px; line-height: 1.4;">
                        Long-term maintenance programs (e.g., dormer windows). Click to view ONLY programmed items.
                    </div>
                    <div class="slicer-item" id="programmedSlicer" onclick="toggleProgrammedOnlyFilter()" style="cursor: pointer;">
                        <span>View Programmed Only</span>
                        <span class="slicer-badge" id="programmedCount">0</span>
                    </div>
                </div>

                <!-- Date Range Section -->
                <div class="slicer-section">
                    <div class="slicer-header collapsed" onclick="toggleSlicerSection(this)">
                        <span>üìÖ DATE RANGE</span>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="slicer-content collapsed">
                        <!-- Quick Date Buttons -->
                        <div class="date-range-controls">
                            <button class="date-btn" onclick="setDateRange('1M')">1M</button>
                            <button class="date-btn" onclick="setDateRange('3M')">3M</button>
                            <button class="date-btn" onclick="setDateRange('6M')">6M</button>
                            <button class="date-btn" onclick="setDateRange('1Y')">1Y</button>
                        </div>
                        
                        <!-- Year Dropdown -->
                        <select class="year-select" id="yearSelect" onchange="setYearFilter()">
                            <option value="">All Years</option>
                            <option value="2020">2020</option>
                            <option value="2021">2021</option>
                            <option value="2022">2022</option>
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                            <option value="2031">2031</option>
                            <option value="2032">2032</option>
                            <option value="2033">2033</option>
                            <option value="2034">2034</option>
                            <option value="2035">2035</option>
                        </select>

                        <!-- Custom Date Range -->
                        <div class="date-picker-container">
                            <input type="date" id="customStartDate" class="date-input" placeholder="Start Date">
                            <input type="date" id="customEndDate" class="date-input" placeholder="End Date">
                            <button class="apply-date-btn" onclick="applyCustomDateRange()">Apply Custom Range</button>
                        </div>
                    </div>
                </div>

                <!-- Units Section -->
                <div class="slicer-section">
                    <div class="slicer-header collapsed" onclick="toggleSlicerSection(this)">
                        <span>üè† UNITS</span>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="slicer-content collapsed">
                        <div id="unitSlicers"></div>
                    </div>
                </div>

                <!-- Priority Section -->
                <div class="slicer-section">
                    <div class="slicer-header collapsed" onclick="toggleSlicerSection(this)">
                        <span>üö® PRIORITY</span>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="slicer-content collapsed">
                        <div id="prioritySlicers"></div>
                    </div>
                </div>

                <!-- Status Section -->
                <div class="slicer-section">
                    <div class="slicer-header collapsed" onclick="toggleSlicerSection(this)">
                        <span>üìä STATUS</span>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="slicer-content collapsed">
                        <div id="statusSlicers"></div>
                    </div>
                </div>

                <!-- Zones Section -->
                <div class="slicer-section">
                    <div class="slicer-header collapsed" onclick="toggleSlicerSection(this)">
                        <span>üó∫Ô∏è ZONES</span>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="slicer-content collapsed">
                        <div id="zoneSlicers"></div>
                    </div>
                </div>

                <!-- Categories Section -->
                <div class="slicer-section">
                    <div class="slicer-header collapsed" onclick="toggleSlicerSection(this)">
                        <span>üìÅ CATEGORIES</span>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="slicer-content collapsed">
                        <div id="categorySlicers"></div>
                    </div>
                </div>

                <!-- Sub-Categories Section -->
                <div class="slicer-section">
                    <div class="slicer-header collapsed" onclick="toggleSlicerSection(this)">
                        <span>üìÇ SUB-CATEGORIES</span>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="slicer-content collapsed">
                        <div id="subCategorySlicers"></div>
                    </div>
                </div>

                <!-- Assigned To Section -->
                <div class="slicer-section">
                    <div class="slicer-header collapsed" onclick="toggleSlicerSection(this)">
                        <span>üë∑ ASSIGNED TO</span>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="slicer-content collapsed">
                        <div id="assignedToSlicers"></div>
                    </div>
                </div>

                <button class="clear-all-btn" onclick="debugClearAllFilters()" id="toggleAllBtn">üóëÔ∏è CLEAR ALL FILTERS</button>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Search -->
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="üîç Search PID, unit, description...">
                </div>

                <!-- Stats Dashboard -->
                <div class="stats-dashboard">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalProblemsCount">-</div>
                            <div class="stat-label">Total Problems</div>
                            <div class="stat-sublabel" id="totalProblemsSub">Loading...</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="activeProblemsCount">-</div>
                            <div class="stat-label">Active Problems</div>
                            <div class="stat-sublabel" id="activeProblemsSub">Not completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="urgentProblemsCount">-</div>
                            <div class="stat-label">Urgent + High</div>
                            <div class="stat-sublabel" id="urgentProblemsSub">Priority issues</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completionRate">-</div>
                            <div class="stat-label">Completion Rate</div>
                            <div class="stat-sublabel" id="completionRateSub">Overall %</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="avgResolutionDays">-</div>
                            <div class="stat-label">Avg Resolution</div>
                            <div class="stat-sublabel" id="avgResolutionSub">Days to complete</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="thisWeekCount">-</div>
                            <div class="stat-label">Last 7 Days</div>
                            <div class="stat-sublabel" id="thisWeekSub">Recent reports</div>
                        </div>
                    </div>
                </div>

                <!-- Results Header -->
                <div class="results-header">
                    <div class="results-info" id="resultsInfo">Loading...</div>
                    <div class="results-actions">
                        <div class="items-per-page">
                            <label style="font-size: 0.85rem; color: #64748b; font-weight: 500;">Show:</label>
                            <select id="itemsPerPageSelect" onchange="changeItemsPerPage()">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="all">Show All</option>
                            </select>
                        </div>
                        <button class="action-btn" id="sortToggleBtn" onclick="toggleSort()">üìÖ Newest First</button>
                        <button class="action-btn export" onclick="exportToCSV()">üìä Export CSV</button>
                        <button class="action-btn chart" onclick="generateChartReport()">üìä Generate Chart</button>
                    </div>
                </div>

                <!-- Problems Grid -->
                <div class="problems-grid" id="problemsGrid">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div>Loading problems...</div>
                    </div>
                </div>

                <!-- Pagination Controls -->
                <div class="pagination-container" id="paginationControls" style="display: none;">
                    <!-- Pagination controls will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Scroll Navigation Buttons -->
        <div class="scroll-navigation">
            <button class="scroll-btn scroll-top" onclick="scrollToTop()" title="Scroll to top">
                ‚Üë Top
            </button>
            <button class="scroll-btn scroll-bottom" onclick="scrollToBottom()" title="Scroll to bottom">
                ‚Üì Bottom
            </button>
        </div>
    </div>

    <!-- Problem Detail Modal -->
    <div class="modal hidden" id="problemModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Problem Details</div>
                <button class="close-btn" id="closeProblemModal">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Problem details will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal hidden" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìÑ Problem Report</div>
                <button class="close-btn" id="closeReportModal">√ó</button>
            </div>
            <pre id="reportText" style="white-space: pre-wrap; font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 20px; border-radius: 6px; max-height: 60vh; overflow-y: auto;"></pre>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button id="copyReportFromModal" class="action-btn export">üìã Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Chart Report Modal -->
    <div class="modal hidden" id="chartModal" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <div class="modal-header">
                <div class="modal-title">üìä Chart Report - Filtered Data</div>
                <button class="close-btn" onclick="closeChartModal()">√ó</button>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <!-- Chart Type Selector -->
                <div style="margin-bottom: 25px; padding: 20px; background: #f8fafc; border-radius: 12px;">
                    <label style="font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
                        Select Chart Type:
                    </label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="generateChart('category')" class="chart-type-btn">
                            By Category
                        </button>
                        <button onclick="generateChart('priority')" class="chart-type-btn">
                            By Priority
                        </button>
                        <button onclick="generateChart('status')" class="chart-type-btn">
                            By Status
                        </button>
                        <button onclick="generateChart('zone')" class="chart-type-btn">
                            By Zone
                        </button>
                        <button onclick="generateChart('monthly')" class="chart-type-btn">
                            By Month
                        </button>
                        <button onclick="generateChart('unit')" class="chart-type-btn">
                            By Unit (Top 10)
                        </button>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div id="chartStats" style="display: none; margin-bottom: 25px; padding: 20px; background: #f0fdf4; border-radius: 12px; border-left: 4px solid #10b981;">
                    <h3 style="margin-bottom: 15px; color: #065f46;">üìã Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Total Problems</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #059669;" id="chartTotalCount">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Categories</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #059669;" id="chartCategoryCount">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Most Common</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #059669;" id="chartTopItem">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Chart Canvas -->
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <canvas id="reportChart" style="max-height: 500px;"></canvas>
                </div>
                
                <!-- Export Options -->
                <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="downloadChartImage()" class="chart-type-btn" style="background: #059669;">
                        üíæ Download Chart
                    </button>
                    <button onclick="closeChartModal()" class="chart-type-btn" style="background: #6b7280;">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzEWNgrtuamJxLUEo_dWCm9-WxoD-zDejn6LKwV3Vt8yCHv0CArlBVtzj1ad_JM0A6N/exec';
        
        let allProblems = [];
        let filteredProblems = [];
        let currentProblem = null;
        let currentDataset = 'all';
        let currentDateFilter = null;
        let customDateRange = null;
        let sortDirection = 'desc';
        let dynamicDropdowns = {};
        let currentPage = 1;
        let itemsPerPage = 20;
        let reportChart = null;
        let currentChartData = null;

        // Filter state (matching ExecutiveDashboard pattern)
        let activeFilters = {
            date: null,
            customDateRange: null,
            priorities: [],
            statuses: [],
            zones: [],
            categories: [],
            subCategories: [],
            assignedTo: [],
            units: [],
            programmedOnly: false
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üñ•Ô∏è Desktop Explorer V2.0 - Starting...');
            
            // Event listeners
            document.getElementById('allBtn').addEventListener('click', () => switchDataset('all'));
            document.getElementById('currentBtn').addEventListener('click', () => switchDataset('current'));
            document.getElementById('legacyBtn').addEventListener('click', () => switchDataset('legacy'));
            document.getElementById('searchInput').addEventListener('input', () => setTimeout(applyFilters, 300));
            document.getElementById('closeProblemModal').addEventListener('click', closeModal);
            document.getElementById('closeReportModal').addEventListener('click', closeModal);
            document.getElementById('copyReportFromModal').addEventListener('click', copyFromModal);
            document.getElementById('problemModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
            document.getElementById('reportModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });

            // Load saved items per page preference
            const savedItemsPerPage = localStorage.getItem('explorerItemsPerPage');
            if (savedItemsPerPage) {
                document.getElementById('itemsPerPageSelect').value = savedItemsPerPage;
                changeItemsPerPage();
            }
            
            loadAllData();
            loadDynamicDropdowns();
        });

        // Toggle Slicer Section (matching ExecutiveDashboard pattern exactly)
        function toggleSlicerSection(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.expand-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
            }
        }

        // Load dynamic dropdown options
        async function loadDynamicDropdowns() {
            try {
                console.log('üéõÔ∏è Loading dynamic dropdown options...');
                const response = await makeRequest('getDropdownOptions');
                
                if (response && response.success) {
                    dynamicDropdowns = response.data || {};
                    console.log('‚úÖ Dynamic dropdowns loaded:', Object.keys(dynamicDropdowns));
                    buildSlicers();
                } else {
                    console.log('‚ö†Ô∏è Failed to load dynamic dropdowns, using fallback');
                    dynamicDropdowns = {
                        categories: ['Aircon', 'Doors', 'Electrical', 'Plumbing', 'Structural'],
                        subCategories: ['General', 'Leaking Tap', 'Lighting', 'Repair'],
                        assignedTo: ['Ben', 'Jade', 'David', 'Gardening Club']
                    };
                }
            } catch (error) {
                console.error('Error loading dynamic dropdowns:', error);
                dynamicDropdowns = {};
            }
        }

        // Build slicers - CORRECT LOGIC: Items IN filter arrays are blue (selected)
        function buildSlicers() {
            if (!allProblems || allProblems.length === 0) return;

            // Priority Slicers - blue if IN the selected list
            const priorities = {};
            allProblems.forEach(p => {
                const priority = p.problemPriority;
                if (priority && priority.trim() !== '' && priority !== 'Not Set') {
                    priorities[priority] = (priorities[priority] || 0) + 1;
                }
            });
            const priorityHTML = Object.entries(priorities).map(([priority, count]) => 
                `<div class="slicer-item ${activeFilters.priorities.includes(priority) ? 'active' : ''}" 
                      onclick="togglePriorityFilter('${priority}')">
                    <span>${priority}</span>
                    <span class="slicer-badge">${count}</span>
                </div>`
            ).join('');
            document.getElementById('prioritySlicers').innerHTML = priorityHTML;

            // Status Slicers - blue if IN the selected list
            const statuses = {};
            allProblems.forEach(p => {
                const status = p.problemStatus;
                if (status && status.trim() !== '' && status !== 'Not Set') {
                    statuses[status] = (statuses[status] || 0) + 1;
                }
            });
            const statusHTML = Object.entries(statuses).map(([status, count]) => 
                `<div class="slicer-item ${activeFilters.statuses.includes(status) ? 'active' : ''}" 
                      onclick="toggleStatusFilter('${status}')">
                    <span>${status}</span>
                    <span class="slicer-badge">${count}</span>
                </div>`
            ).join('');
            document.getElementById('statusSlicers').innerHTML = statusHTML;

            // Zone Slicers - blue if IN the selected list
            const zones = {};
            allProblems.forEach(p => {
                const zone = p.zone;
                if (zone && zone.trim() !== '' && zone !== 'Not Set') {
                    zones[zone] = (zones[zone] || 0) + 1;
                }
            });
            const zoneHTML = Object.entries(zones).map(([zone, count]) => 
                `<div class="slicer-item ${activeFilters.zones.includes(zone) ? 'active' : ''}" 
                      onclick="toggleZoneFilter('${zone}')">
                    <span>${zone}</span>
                    <span class="slicer-badge">${count}</span>
                </div>`
            ).join('');
            document.getElementById('zoneSlicers').innerHTML = zoneHTML;

            // Units Slicers - blue if IN the selected list
            const units = {};
            allProblems.forEach(p => {
                const unit = p.unitNumber;
                if (unit && unit.toString().trim() !== '' && unit !== 'Not Set') {
                    units[unit] = (units[unit] || 0) + 1;
                }
            });
            
            const sortedUnits = Object.entries(units)
                .sort((a, b) => {
                    // Extract numeric values from unit identifiers
                    const getNumericValue = (unitStr) => {
                        // Handle cases like "9", "Unit 9", "UNIT 9", etc.
                        const match = unitStr.toString().match(/(\d+)/);
                        return match ? parseInt(match[1]) : 0;
                    };
                    
                    const aNum = getNumericValue(a[0]);
                    const bNum = getNumericValue(b[0]);
                    
                    // Numeric sort: 1, 2, 3, 9, 10, 11, 12...
                    return aNum - bNum;
                });
            
            const unitHTML = sortedUnits.map(([unit, count]) => 
                `<div class="slicer-item ${activeFilters.units.includes(unit) ? 'active' : ''}" 
                      onclick="toggleUnitFilter('${unit}')">
                    <span>${unit.toString().toLowerCase().startsWith('unit') ? unit : `Unit ${unit}`}</span>
                    <span class="slicer-badge">${count}</span>
                </div>`
            ).join('');
            document.getElementById('unitSlicers').innerHTML = unitHTML;

            // Category Slicers - blue if IN the selected list
            const categories = {};
            allProblems.forEach(p => {
                const cat = p.category;
                if (cat && cat.trim() !== '' && cat !== 'Not Set') {
                    categories[cat] = (categories[cat] || 0) + 1;
                }
            });
            
            const sortedCategories = Object.entries(categories)
                .sort((a, b) => a[0].localeCompare(b[0]));
            
            const categoryHTML = sortedCategories.map(([category, count]) => 
                `<div class="slicer-item ${activeFilters.categories.includes(category) ? 'active' : ''}" 
                      onclick="toggleCategoryFilter('${category}')">
                    <span>${category}</span>
                    <span class="slicer-badge">${count}</span>
                </div>`
            ).join('');
            document.getElementById('categorySlicers').innerHTML = categoryHTML;

            // Sub-Category Slicers - blue if IN the selected list
            const subCategories = {};
            allProblems.forEach(p => {
                const subCat = p.subCategory;
                if (subCat && subCat.trim() !== '' && subCat !== 'Not Set') {
                    subCategories[subCat] = (subCategories[subCat] || 0) + 1;
                }
            });
            
            const sortedSubCategories = Object.entries(subCategories)
                .sort((a, b) => a[0].localeCompare(b[0]));
            
            const subCategoryHTML = sortedSubCategories.map(([subCategory, count]) => 
                `<div class="slicer-item ${activeFilters.subCategories.includes(subCategory) ? 'active' : ''}" 
                      onclick="toggleSubCategoryFilter('${subCategory}')">
                    <span>${subCategory}</span>
                    <span class="slicer-badge">${count}</span>
                </div>`
            ).join('');
            document.getElementById('subCategorySlicers').innerHTML = subCategoryHTML;

            // Assigned To Slicers - blue if IN the selected list
            const assignedTo = {};
            allProblems.forEach(p => {
                const assigned = p.assignedTo;
                if (assigned && assigned.trim() !== '' && assigned !== 'Not Set') {
                    assignedTo[assigned] = (assignedTo[assigned] || 0) + 1;
                }
            });
            
            const sortedAssignedTo = Object.entries(assignedTo)
                .sort((a, b) => a[0].localeCompare(b[0]));
            
            const assignedToHTML = sortedAssignedTo.map(([assigned, count]) => 
                `<div class="slicer-item ${activeFilters.assignedTo.includes(assigned) ? 'active' : ''}" 
                      onclick="toggleAssignedToFilter('${assigned}')">
                    <span>${assigned}</span>
                    <span class="slicer-badge">${count}</span>
                </div>`
            ).join('');
            document.getElementById('assignedToSlicers').innerHTML = assignedToHTML;

            // Update programmed count
            const programmedCount = allProblems.filter(p => p.isProgrammed === 'Yes' || p.isProgrammed === true).length;
            document.getElementById('programmedCount').textContent = programmedCount;
        }

        // Filter toggle functions - REVERSED LOGIC: Blue = show, White = hide
        function togglePriorityFilter(priority) {
            const index = activeFilters.priorities.indexOf(priority);
            if (index > -1) {
                // Remove from excluded list (make it blue/show)
                activeFilters.priorities.splice(index, 1);
            } else {
                // Add to excluded list (make it white/hide)
                activeFilters.priorities.push(priority);
            }
            buildSlicers();
            applyFilters();
            updateToggleButtonText();
        }

        function toggleStatusFilter(status) {
            const index = activeFilters.statuses.indexOf(status);
            if (index > -1) {
                activeFilters.statuses.splice(index, 1);
            } else {
                activeFilters.statuses.push(status);
            }
            buildSlicers();
            applyFilters();
            updateToggleButtonText();
        }

        function toggleZoneFilter(zone) {
            const index = activeFilters.zones.indexOf(zone);
            if (index > -1) {
                activeFilters.zones.splice(index, 1);
            } else {
                activeFilters.zones.push(zone);
            }
            buildSlicers();
            applyFilters();
            updateToggleButtonText();
        }

        function toggleUnitFilter(unit) {
            const index = activeFilters.units.indexOf(unit);
            if (index > -1) {
                activeFilters.units.splice(index, 1);
            } else {
                activeFilters.units.push(unit);
            }
            buildSlicers();
            applyFilters();
            updateToggleButtonText();
        }

        function toggleCategoryFilter(category) {
            const index = activeFilters.categories.indexOf(category);
            if (index > -1) {
                activeFilters.categories.splice(index, 1);
            } else {
                activeFilters.categories.push(category);
            }
            buildSlicers();
            applyFilters();
            updateToggleButtonText();
        }

        function toggleSubCategoryFilter(subCategory) {
            const index = activeFilters.subCategories.indexOf(subCategory);
            if (index > -1) {
                activeFilters.subCategories.splice(index, 1);
            } else {
                activeFilters.subCategories.push(subCategory);
            }
            buildSlicers();
            applyFilters();
            updateToggleButtonText();
        }

        function toggleAssignedToFilter(assigned) {
            const index = activeFilters.assignedTo.indexOf(assigned);
            if (index > -1) {
                activeFilters.assignedTo.splice(index, 1);
            } else {
                activeFilters.assignedTo.push(assigned);
            }
            buildSlicers();
            applyFilters();
            updateToggleButtonText();
        }

        function toggleProgrammedOnlyFilter() {
            activeFilters.programmedOnly = !activeFilters.programmedOnly;
            const element = document.getElementById('programmedSlicer');
            if (activeFilters.programmedOnly) {
                element.classList.add('active');
            } else {
                element.classList.remove('active');
            }
            applyFilters();
            updateToggleButtonText();
        }

        // Date filter functions
        function setDateRange(range) {
            // Clear existing date filter buttons
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const now = new Date();
            let startDate;

            switch(range) {
                case '1M':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                    break;
                case '3M':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                    break;
                case '6M':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
                    break;
                case '1Y':
                    startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                    break;
            }

            activeFilters.date = range;
            activeFilters.customDateRange = {
                start: startDate,
                end: now
            };
            
            applyFilters();
        }

        function setYearFilter() {
            const year = document.getElementById('yearSelect').value;
            if (year) {
                activeFilters.date = year;
                activeFilters.customDateRange = {
                    start: new Date(year, 0, 1),
                    end: new Date(year, 11, 31)
                };
            } else {
                activeFilters.date = null;
                activeFilters.customDateRange = null;
            }
            
            // Clear date button states
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
            
            applyFilters();
        }

        function applyCustomDateRange() {
            const startDate = document.getElementById('customStartDate').value;
            const endDate = document.getElementById('customEndDate').value;

            if (startDate || endDate) {
                activeFilters.customDateRange = {
                    start: startDate ? new Date(startDate) : null,
                    end: endDate ? new Date(endDate) : null
                };
                activeFilters.date = 'custom';
                
                // Clear other date controls
                document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('yearSelect').value = '';
            }

            applyFilters();
        }

        function toggleAllFilters() {
            const button = document.getElementById('toggleAllBtn');
            
            // Simple logic: always clear all filters when clicked
            // This makes the behavior predictable
            activeFilters = {
                date: null,
                customDateRange: null,
                priorities: [],
                statuses: [],
                zones: [],
                categories: [],
                subCategories: [],
                assignedTo: [],
                programmedOnly: false
            };
            
            // Clear UI states
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('yearSelect').value = '';
            document.getElementById('customStartDate').value = '';
            document.getElementById('customEndDate').value = '';
            document.getElementById('searchInput').value = '';
            
            // Clear programmed filter
            const programmedElement = document.getElementById('programmedSlicer');
            if (programmedElement) {
                programmedElement.classList.remove('active');
            }
            
            buildSlicers();
            applyFilters();
            updateToggleButtonText();
        }

        // Helper function to update button text based on current filter state
        function updateToggleButtonText() {
            const hasActiveFilters = activeFilters.priorities.length > 0 || 
                                   activeFilters.statuses.length > 0 || 
                                   activeFilters.zones.length > 0 || 
                                   activeFilters.categories.length > 0 || 
                                   activeFilters.subCategories.length > 0 || 
                                   activeFilters.assignedTo.length > 0 || 
                                   activeFilters.programmedOnly ||
                                   activeFilters.date;

        // Helper function to update button text based on current filter state
        function updateToggleButtonText() {
            const hasActiveFilters = activeFilters.priorities.length > 0 || 
                                   activeFilters.statuses.length > 0 || 
                                   activeFilters.zones.length > 0 || 
                                   activeFilters.categories.length > 0 || 
                                   activeFilters.subCategories.length > 0 || 
                                   activeFilters.assignedTo.length > 0 || 
                                   activeFilters.programmedOnly ||
                                   activeFilters.date;

            const button = document.getElementById('toggleAllBtn');
            if (hasActiveFilters) {
                button.textContent = 'üóëÔ∏è CLEAR EXCLUSIONS';
            } else {
                button.textContent = '‚úÖ ALL FILTERS ACTIVE';
            }
        }
        }

        // Dataset switching
        async function switchDataset(dataset) {
            console.log(`üìÑ Switching to ${dataset} dataset...`);
            currentDataset = dataset;
            
            // Update button states
            document.getElementById('allBtn').classList.toggle('active', dataset === 'all');
            document.getElementById('currentBtn').classList.toggle('active', dataset === 'current');
            document.getElementById('legacyBtn').classList.toggle('active', dataset === 'legacy');
            
            // Reset pagination when switching datasets
            currentPage = 1;
            
            // Show loading indicator
            const problemsGrid = document.getElementById('problemsGrid');
            problemsGrid.innerHTML = `
                <div class="loading" style="grid-column: 1 / -1;">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 16px;">Loading data...</div>
                </div>
            `;
            document.getElementById('resultsInfo').textContent = 'Loading...';
            
            if (dataset === 'all') {
                await loadAllData();
            } else if (dataset === 'current') { 
                await loadProblemsData(); 
            } else { 
                await loadLegacyData(); 
            }
        }

        // Data loading functions
        async function loadAllData() {
            try {
                console.log('üìÑ Loading combined data...');
                
                // Show loading indicator
                const problemsGrid = document.getElementById('problemsGrid');
                const resultsInfo = document.getElementById('resultsInfo');
                
                problemsGrid.innerHTML = `
                    <div class="loading" style="grid-column: 1 / -1;">
                        <div class="loading-spinner"></div>
                        <div style="margin-top: 16px;">Loading problem data...</div>
                    </div>
                `;
                resultsInfo.textContent = 'Loading data...';
                
                let allData = [];
                
                // Load current data
                const currentResponse = await makeRequest('getFaultLogData');
                if (currentResponse && currentResponse.success) {
                    allData = currentResponse.data || [];
                    console.log(`‚úÖ Loaded ${allData.length} current problems`);
                }
                
                // Load legacy data
                const legacyResponse = await makeRequest('getLegacyLogData');
                if (legacyResponse && legacyResponse.success) {
                    const legacyData = legacyResponse.data || [];
                    allData = [...allData, ...legacyData];
                    console.log(`‚úÖ Loaded ${legacyData.length} legacy problems`);
                }
                
                console.log(`‚úÖ Combined total: ${allData.length} problems`);
                
                allProblems = allData;
                
                // Set default to ALL FILTERS ACTIVE (like current Desktop Explorer)
                if (allProblems && allProblems.length > 0) {
                    const allPriorities = [...new Set(allProblems.map(p => p.problemPriority).filter(p => p !== null && p !== undefined))];
                    const allStatuses = [...new Set(allProblems.map(p => p.problemStatus).filter(s => s !== null && s !== undefined))];
                    const allZones = [...new Set(allProblems.map(p => p.zone).filter(z => z !== null && z !== undefined))];
                    const allCategories = [...new Set(allProblems.map(p => p.category).filter(c => c !== null && c !== undefined))];
                    const allSubCategories = [...new Set(allProblems.map(p => p.subCategory).filter(sc => sc !== null && sc !== undefined))];
                    const allAssignedTo = [...new Set(allProblems.map(p => p.assignedTo).filter(a => a !== null && a !== undefined))];
                    const allUnits = [...new Set(allProblems.map(p => p.unitNumber).filter(u => u !== null && u !== undefined && u.toString().trim() !== ''))];
                    
                    activeFilters = {
                        date: null,
                        customDateRange: null,
                        priorities: allPriorities,
                        statuses: allStatuses,
                        zones: allZones,
                        categories: allCategories,
                        subCategories: allSubCategories,
                        assignedTo: allAssignedTo,
                        units: allUnits,
                        programmedOnly: false
                    };
                    
                    // Set button to show it can clear filters
                    document.getElementById('toggleAllBtn').textContent = 'üóëÔ∏è CLEAR ALL FILTERS';
                }
                
                buildSlicers(); 
                applyFilters();
                
            } catch (error) {
                console.error('Error loading combined data:', error);
                showError('Failed to load combined data');
            }
        }

        async function loadLegacyData() {
            try {
                console.log('üìö Loading legacy data...');
                
                const response = await makeRequest('getLegacyLogData');
                
                if (response && response.success) {
                    allProblems = response.data || [];
                    console.log('Loaded', allProblems.length, 'legacy problems');
                    
                    // Set default to ALL FILTERS ACTIVE for legacy data
                    if (allProblems && allProblems.length > 0) {
                        const allPriorities = [...new Set(allProblems.map(p => p.problemPriority).filter(p => p && p.trim() !== '' && p !== 'Not Set'))];
                        const allStatuses = [...new Set(allProblems.map(p => p.problemStatus).filter(s => s && s.trim() !== '' && s !== 'Not Set'))];
                        const allZones = [...new Set(allProblems.map(p => p.zone).filter(z => z && z.trim() !== '' && z !== 'Not Set'))];
                        const allCategories = [...new Set(allProblems.map(p => p.category).filter(c => c && c.trim() !== '' && c !== 'Not Set'))];
                        const allSubCategories = [...new Set(allProblems.map(p => p.subCategory).filter(sc => sc && sc.trim() !== '' && sc !== 'Not Set'))];
                        const allAssignedTo = [...new Set(allProblems.map(p => p.assignedTo).filter(a => a && a.trim() !== '' && a !== 'Not Set'))];
                        
                        activeFilters = {
                            date: null,
                            customDateRange: null,
                            priorities: allPriorities,
                            statuses: allStatuses,
                            zones: allZones,
                            categories: allCategories,
                            subCategories: allSubCategories,
                            assignedTo: allAssignedTo,
                            programmedOnly: false
                        };
                        
                        // Set button to show it can clear filters
                        document.getElementById('toggleAllBtn').textContent = 'üóëÔ∏è CLEAR ALL FILTERS';
                    }
                    
                    buildSlicers();
                    applyFilters();
                } else {
                    throw new Error('Failed to load legacy data');
                }
            } catch (error) {
                console.error('Error loading legacy data:', error);
                showError('Failed to load legacy data');
            }
        }

        async function loadProblemsData() {
            try {
                console.log('üìä Loading current problems data...');
                
                const response = await makeRequest('getFaultLogData');
                
                if (response && response.success) {
                    allProblems = response.data || [];
                    console.log('Loaded', allProblems.length, 'current problems');
                    
                    // Set default to ALL FILTERS ACTIVE for current data
                    if (allProblems && allProblems.length > 0) {
                        const allPriorities = [...new Set(allProblems.map(p => p.problemPriority).filter(p => p && p.trim() !== '' && p !== 'Not Set'))];
                        const allStatuses = [...new Set(allProblems.map(p => p.problemStatus).filter(s => s && s.trim() !== '' && s !== 'Not Set'))];
                        const allZones = [...new Set(allProblems.map(p => p.zone).filter(z => z && z.trim() !== '' && z !== 'Not Set'))];
                        const allCategories = [...new Set(allProblems.map(p => p.category).filter(c => c && c.trim() !== '' && c !== 'Not Set'))];
                        const allSubCategories = [...new Set(allProblems.map(p => p.subCategory).filter(sc => sc && sc.trim() !== '' && sc !== 'Not Set'))];
                        const allAssignedTo = [...new Set(allProblems.map(p => p.assignedTo).filter(a => a && a.trim() !== '' && a !== 'Not Set'))];
                        
                        activeFilters = {
                            date: null,
                            customDateRange: null,
                            priorities: allPriorities,
                            statuses: allStatuses,
                            zones: allZones,
                            categories: allCategories,
                            subCategories: allSubCategories,
                            assignedTo: allAssignedTo,
                            programmedOnly: false
                        };
                        
                        // Set button to show it can clear filters
                        document.getElementById('toggleAllBtn').textContent = 'üóëÔ∏è CLEAR ALL FILTERS';
                    }
                    
                    buildSlicers();
                    applyFilters();
                } else {
                    throw new Error('Failed to load current data');
                }
            } catch (error) {
                console.error('Error loading current data:', error);
                showError('Failed to load current data');
            }
        }

        function clearCustomDateInputs() {
            document.getElementById('customStartDate').value = '';
            document.getElementById('customEndDate').value = '';
            document.getElementById('yearSelect').value = '';
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
        }

        // Apply filters - OR LOGIC: Problems match if they hit ANY active filter
        function applyFilters() {
            if (!allProblems) return;

            console.log('üîç Applying filters...');
            console.log('Total problems to filter:', allProblems.length);
            console.log('Active filters:', activeFilters);

            filteredProblems = allProblems.filter(problem => {
                // Search filter (still AND logic for search)
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                if (searchTerm) {
                    const searchableText = [
                        problem.internalId,
                        problem.unitNumber,
                        problem.problemDescription,
                        problem.reportedBy,
                        problem.category,
                        problem.subCategory
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) {
                        console.log('‚ùå Problem filtered out by search:', problem.internalId);
                        return false;
                    }
                }

                // Date filter (still AND logic for dates)
                if (activeFilters.customDateRange) {
                    const problemDate = new Date(problem.timestamp);
                    if (activeFilters.customDateRange.start && problemDate < activeFilters.customDateRange.start) return false;
                    if (activeFilters.customDateRange.end && problemDate > activeFilters.customDateRange.end) return false;
                }

                // Check if ANY filters are active
                const hasAnyFilters = activeFilters.priorities.length > 0 || 
                                    activeFilters.statuses.length > 0 || 
                                    activeFilters.zones.length > 0 || 
                                    activeFilters.categories.length > 0 || 
                                    activeFilters.subCategories.length > 0 || 
                                    activeFilters.assignedTo.length > 0 || 
                                    activeFilters.units.length > 0 || 
                                    activeFilters.programmedOnly;

                if (!hasAnyFilters) {
                    console.log('‚ùå No active filters - excluding problem:', problem.internalId);
                    return false; // No active filters = no results
                }

                // OR LOGIC: Problem passes if it matches ANY active filter category
                let matchesAnyFilter = false;

                // Check Priority filter
                if (activeFilters.priorities.length > 0) {
                    if (activeFilters.priorities.includes(problem.problemPriority)) {
                        console.log('‚úÖ Problem matches priority filter:', problem.internalId, 'has:', problem.problemPriority);
                        matchesAnyFilter = true;
                    }
                }

                // Check Status filter
                if (activeFilters.statuses.length > 0) {
                    if (activeFilters.statuses.includes(problem.problemStatus)) {
                        console.log('‚úÖ Problem matches status filter:', problem.internalId, 'has:', problem.problemStatus);
                        matchesAnyFilter = true;
                    }
                }

                // Check Zone filter
                if (activeFilters.zones.length > 0) {
                    if (activeFilters.zones.includes(problem.zone)) {
                        console.log('‚úÖ Problem matches zone filter:', problem.internalId, 'has:', problem.zone);
                        matchesAnyFilter = true;
                    }
                }

                // Check Units filter
                if (activeFilters.units.length > 0) {
                    if (activeFilters.units.includes(problem.unitNumber)) {
                        console.log('‚úÖ Problem matches unit filter:', problem.internalId, 'has:', problem.unitNumber);
                        matchesAnyFilter = true;
                    }
                }

                // Check Category filter
                if (activeFilters.categories.length > 0) {
                    if (activeFilters.categories.includes(problem.category)) {
                        console.log('‚úÖ Problem matches category filter:', problem.internalId, 'has:', problem.category);
                        matchesAnyFilter = true;
                    }
                }

                // Check Sub-category filter
                if (activeFilters.subCategories.length > 0) {
                    if (activeFilters.subCategories.includes(problem.subCategory)) {
                        console.log('‚úÖ Problem matches sub-category filter:', problem.internalId, 'has:', problem.subCategory);
                        matchesAnyFilter = true;
                    }
                }

                // Check Assigned to filter
                if (activeFilters.assignedTo.length > 0) {
                    if (activeFilters.assignedTo.includes(problem.assignedTo)) {
                        console.log('‚úÖ Problem matches assigned to filter:', problem.internalId, 'has:', problem.assignedTo);
                        matchesAnyFilter = true;
                    }
                }

                // Check Programmed filter
                if (activeFilters.programmedOnly) {
                    if (problem.isProgrammed === 'Yes' || problem.isProgrammed === true) {
                        console.log('‚úÖ Problem matches programmed filter:', problem.internalId);
                        matchesAnyFilter = true;
                    }
                }

                if (!matchesAnyFilter) {
                    console.log('‚ùå Problem matches no active filters:', problem.internalId);
                }

                return matchesAnyFilter;
            });

            console.log('‚úÖ Final filtered problems:', filteredProblems.length);

            // Sort filtered problems
            filteredProblems.sort((a, b) => {
                const dateA = new Date(a.timestamp);
                const dateB = new Date(b.timestamp);
                return sortDirection === 'desc' ? dateB - dateA : dateA - dateB;
            });

            updateStatistics();
            displayProblems();
        }

        // Display problems
        function displayProblems() {
            const grid = document.getElementById('problemsGrid');
            const resultsInfo = document.getElementById('resultsInfo');
            
            if (!filteredProblems || filteredProblems.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #64748b;">
                        <div style="font-size: 2rem; margin-bottom: 16px;">üîç</div>
                        <div style="font-size: 1.2rem; margin-bottom: 8px;">No problems found</div>
                        <div>Try adjusting your filters or search terms</div>
                    </div>
                `;
                resultsInfo.textContent = 'No problems found';
                return;
            }

            // Calculate pagination
            const totalProblems = filteredProblems.length;
            let problemsToShow;
            let totalPages = 1;
            
            if (itemsPerPage === 'all') {
                problemsToShow = filteredProblems;
                resultsInfo.textContent = `Showing all ${totalProblems} problems`;
            } else {
                totalPages = Math.ceil(totalProblems / itemsPerPage);
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                problemsToShow = filteredProblems.slice(startIndex, endIndex);
                resultsInfo.textContent = `Showing ${startIndex + 1}-${Math.min(endIndex, totalProblems)} of ${totalProblems} problems`;
            }

            // Generate HTML for problems
            const problemsHTML = problemsToShow.map(problem => {
                const priorityClass = (problem.problemPriority || 'medium').toLowerCase();
                const pid = getFriendlyPID(problem.internalId);
                
                return `
                    <div class="problem-card ${priorityClass}" onclick="showProblemDetails('${problem.internalId}')">
                        <div class="card-header">
                            <div class="card-top-line">
                                <div class="card-pid">${pid}</div>
                                <div class="card-unit">${problem.unitNumber || 'N/A'}</div>
                                ${problem.zone && problem.zone.trim() !== '' && problem.zone !== 'Not Set' ? 
                                    `<div class="card-zone">${problem.zone}</div>` : ''}
                            </div>
                        </div>
                        <div class="card-description">
                            ${problem.problemDescription || 'No description provided'}
                        </div>
                        <div class="card-meta">
                            ${problem.timestamp ? `<div class="card-date">üìÖ ${formatDate(problem.timestamp)}</div>` : ''}
                            ${problem.reportedBy && problem.reportedBy.trim() !== '' ? 
                                `<div class="card-reporter">üë§ ${problem.reportedBy}</div>` : ''}
                        </div>
                        <div class="card-footer">
                            <span class="status-badge status-${(problem.problemStatus || 'reported').toLowerCase().replace(/\s+/g, '-')}">
                                ${problem.problemStatus || 'Reported'}
                            </span>
                            <span class="priority-badge priority-${priorityClass}">
                                ${problem.problemPriority || 'Medium'}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = problemsHTML;

            // Update pagination controls
            updatePaginationControls(totalPages);
        }

        // Update pagination controls
        function updatePaginationControls(totalPages) {
            const paginationContainer = document.getElementById('paginationControls');
            if (!paginationContainer) return;

            if (itemsPerPage === 'all' || totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }

            paginationContainer.style.display = 'flex';
            paginationContainer.innerHTML = `
                <button class="pagination-btn" onclick="previousPage()" ${currentPage <= 1 ? 'disabled' : ''}>
                    ‚Üê Previous
                </button>
                <span class="page-info">Page ${currentPage} of ${totalPages}</span>
                <button class="pagination-btn" onclick="nextPage()" ${currentPage >= totalPages ? 'disabled' : ''}>
                    Next ‚Üí
                </button>
            `;
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayProblems();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredProblems.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayProblems();
            }
        }

        // Update statistics
        function updateStatistics() {
            if (!filteredProblems) return;

            const totalCount = filteredProblems.length;
            const activeCount = filteredProblems.filter(p => 
                p.problemStatus && !['completed', 'closed', 'resolved'].includes(p.problemStatus.toLowerCase())
            ).length;
            const urgentCount = filteredProblems.filter(p => 
                ['urgent', 'high'].includes((p.problemPriority || '').toLowerCase())
            ).length;
            
            const completedProblems = filteredProblems.filter(p => 
                ['completed', 'closed', 'resolved'].includes((p.problemStatus || '').toLowerCase())
            );
            const completedCount = completedProblems.length;
            const completionRate = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

            // Calculate average resolution time - IMPROVED WITH DEBUGGING
            let avgDays = '-';
            if (completedProblems.length > 0) {
                console.log('üîç DEBUG - Average Resolution Calculation:');
                console.log('Completed problems count:', completedProblems.length);
                
                let validCount = 0;
                let totalDays = 0;
                let invalidReasons = {
                    noTimestamp: 0,
                    noCompletionDate: 0,
                    cantParseTimestamp: 0,
                    cantParseCompletion: 0,
                    negativeOrZeroDays: 0
                };
                
                // Check first few problems to see what fields are available
                if (completedProblems.length > 0) {
                    console.log('Sample completed problem fields:', Object.keys(completedProblems[0]));
                    console.log('Sample completed problem:', completedProblems[0]);
                }
                
                completedProblems.forEach((problem, index) => {
                    // Check if dates exist - try multiple field names
                    if (!problem.timestamp) {
                        invalidReasons.noTimestamp++;
                        return;
                    }
                    
                    // Try different completion date field names
                    const completionDate = problem.completionDate || 
                                         problem.dateCompleted || 
                                         problem.resolvedDate || 
                                         problem.closedDate;
                    
                    if (!completionDate) {
                        invalidReasons.noCompletionDate++;
                        if (index < 3) console.log(`Problem ${problem.internalId} missing completion date`);
                        return;
                    }
                    
                    // Try to parse dates
                    const reportedDate = new Date(problem.timestamp);
                    const completedDate = new Date(completionDate);
                    
                    if (!reportedDate || isNaN(reportedDate.getTime())) {
                        invalidReasons.cantParseTimestamp++;
                        return;
                    }
                    if (!completedDate || isNaN(completedDate.getTime())) {
                        invalidReasons.cantParseCompletion++;
                        return;
                    }
                    
                    // Calculate days
                    const days = Math.ceil((completedDate - reportedDate) / (1000 * 60 * 60 * 24));
                    
                    // Only reject truly negative days (data errors)
                    if (days < 0) {
                        invalidReasons.negativeOrZeroDays++;
                        if (index < 3) console.log(`Problem ${problem.internalId} negative days:`, days);
                        return;
                    }
                    
                    // Count same-day completion as 1 day (legacy data handling)
                    const actualDays = days === 0 ? 1 : days;
                    
                    // Valid calculation
                    validCount++;
                    totalDays += actualDays;
                    
                    if (index < 3) {
                        console.log(`Problem ${problem.internalId}: ${actualDays} days (${reportedDate.toDateString()} ‚Üí ${completedDate.toDateString()})`);
                    }
                });
                
                console.log('Invalid reasons:', invalidReasons);
                console.log(`Valid problems for avg: ${validCount} of ${completedProblems.length}`);
                console.log(`Total days: ${totalDays}, Average: ${validCount > 0 ? Math.round(totalDays / validCount) : 0}`);
                
                avgDays = validCount > 0 ? Math.round(totalDays / validCount) : '-';
            }

            // Calculate problems in last 7 days
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const thisWeekCount = filteredProblems.filter(p => 
                new Date(p.timestamp) >= weekAgo
            ).length;

            // Update the display
            document.getElementById('totalProblemsCount').textContent = totalCount;
            document.getElementById('activeProblemsCount').textContent = activeCount;
            document.getElementById('urgentProblemsCount').textContent = urgentCount;
            document.getElementById('completionRate').textContent = completionRate + '%';
            document.getElementById('avgResolutionDays').textContent = avgDays;
            document.getElementById('thisWeekCount').textContent = thisWeekCount;

            // Update sublabels with context
            document.getElementById('totalProblemsSub').textContent = 
                filteredProblems && filteredProblems.length < allProblems.length 
                    ? 'Filtered results' 
                    : 'All problems';
            
            document.getElementById('activeProblemsSub').textContent = 
                activeCount > 0 
                    ? `${Math.round((activeCount/totalCount)*100)}% of total` 
                    : 'All complete';
            
            document.getElementById('urgentProblemsSub').textContent = 
                urgentCount > 0 
                    ? `${Math.round((urgentCount/totalCount)*100)}% of total` 
                    : 'No urgent';
            
            document.getElementById('completionRateSub').textContent = 
                `${completedCount} of ${totalCount}`;
            
            document.getElementById('avgResolutionSub').textContent = 
                avgDays !== '-' 
                    ? `Based on completed problems` 
                    : 'No completion dates';
            
            document.getElementById('thisWeekSub').textContent = 
                thisWeekCount > 0 
                    ? `${Math.round((thisWeekCount/totalCount)*100)}% of total` 
                    : 'None this week';
        }

        // Utility functions
        function getFriendlyPID(internalId) {
            if (!internalId) return 'N/A';
            
            const idStr = String(internalId);
            
            // Handle legacy format "LEGACY-319" -> "PID 319"
            if (idStr.startsWith('LEGACY-')) {
                const number = idStr.replace('LEGACY-', '');
                return `PID ${number}`;
            }
            
            // Handle legacy format "CY-318" -> "PID 318" (alternative legacy format)
            if (idStr.includes('CY-')) {
                const number = idStr.replace('CY-', '');
                return `PID ${number}`;
            }
            
            // Handle timestamp-based format "20251101-112047" -> "PID 112047"
            if (idStr.includes('-') && idStr.length > 10) {
                const parts = idStr.split('-');
                if (parts.length === 2 && parts[1].length >= 4) {
                    return `PID ${parts[1]}`;
                }
            }
            
            // Handle standard format "PID-anything" -> keep as is
            if (idStr.startsWith('PID-')) {
                return idStr;
            }
            
            // Extract just numbers from mixed formats
            const numbers = idStr.replace(/[^0-9]/g, '');
            if (numbers.length >= 3) {
                return `PID ${numbers}`;
            }
            
            // Fallback for other formats
            return `PID ${idStr}`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Not specified';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-AU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Problem details
        function showProblemDetails(internalId) {
            currentProblem = allProblems.find(p => p.internalId === internalId);
            if (!currentProblem) return;

            const modal = document.getElementById('problemModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            const pid = getFriendlyPID(currentProblem.internalId);
            title.textContent = `${pid} - ${currentProblem.unitNumber || 'N/A'}`;

            const modalContent = `
                <div class="problem-details-header">
                    <h3>üìã Problem Details</h3>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Problem ID</label>
                        <input type="text" class="form-input" value="${pid}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit Number</label>
                        <input type="text" class="form-input" value="${currentProblem.unitNumber || 'N/A'}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reported Date</label>
                        <input type="text" class="form-input" value="${formatDate(currentProblem.timestamp)}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zone</label>
                        <input type="text" class="form-input" value="${currentProblem.zone || 'Not specified'}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <input type="text" class="form-input" value="${currentProblem.problemStatus || 'Reported'}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <input type="text" class="form-input" value="${currentProblem.problemPriority || 'Medium'}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-input" value="${currentProblem.category || 'Not categorized'}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sub-Category</label>
                        <input type="text" class="form-input" value="${currentProblem.subCategory || 'Not assigned'}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assigned To</label>
                        <input type="text" class="form-input" value="${currentProblem.assignedTo || 'Not assigned'}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Completion Date</label>
                        <input type="text" class="form-input" value="${currentProblem.completionDate ? formatDate(currentProblem.completionDate) : 'Not completed'}" readonly>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Problem Description</label>
                        <textarea class="form-textarea" readonly>${currentProblem.problemDescription || 'No description provided'}</textarea>
                    </div>
                </div>

                <div class="contact-info-header">
                    <h3>üìû Contact Info</h3>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Reported By</label>
                        <input type="text" class="form-input" value="${currentProblem.reportedBy || 'Legacy Import'}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reporter Email</label>
                        <input type="text" class="form-input" value="${currentProblem.reporterEmail || 'Not provided'}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit Owner</label>
                        <input type="text" class="form-input" value="${currentProblem.unitPrimaryName || 'Not provided'}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit Contact</label>
                        <input type="text" class="form-input" value="${currentProblem.unitPrimaryPhone || 'Not provided'}" readonly>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Unit Email</label>
                        <input type="text" class="form-input" value="${currentProblem.unitPrimaryEmail || 'Not provided'}" readonly>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="action-btn" onclick="showReport()">üìÑ Generate Report</button>
                    <button class="action-btn secondary" onclick="closeModal()">Close</button>
                </div>
            `;

            body.innerHTML = modalContent;
            modal.classList.remove('hidden');
        }

        function showReport() {
            if (!currentProblem) return;
            
            const report = generateSingleProblemReport(currentProblem);
            document.getElementById('reportText').textContent = report;
            document.getElementById('reportModal').classList.remove('hidden');
        }

        function generateSingleProblemReport(problem) {
            const now = new Date();
            return `MAINTENANCE PROBLEM REPORT
${'-'.repeat(50)}

Generated: ${now.toLocaleDateString('en-AU')} at ${now.toLocaleTimeString('en-AU')}
Report Type: Individual Problem Analysis

PROBLEM IDENTIFICATION:
${'-'.repeat(25)}
Problem ID: ${getFriendlyPID(problem.internalId)}
Unit Number: ${problem.unitNumber || 'Not specified'}
Zone: ${problem.zone || 'Not specified'}

REPORTING INFORMATION:
${'-'.repeat(25)}
Reported Date: ${formatDate(problem.timestamp)}
Reported By: ${problem.reportedBy || 'Unknown'}
Reporter Email: ${problem.reporterEmail || 'Not provided'}

PROBLEM DETAILS:
${'-'.repeat(25)}
Description: ${problem.problemDescription || 'No description provided'}

MANAGEMENT STATUS:
${'-'.repeat(25)}
Current Status: ${problem.problemStatus || 'Reported'}
Priority Level: ${problem.problemPriority || 'Medium'}
Category: ${problem.category || 'Not categorized'}
Sub-Category: ${problem.subCategory || 'Not specified'}
Assigned To: ${problem.assignedTo || 'Unassigned'}
${problem.completionDate ? `Completion Date: ${formatDate(problem.completionDate)}` : 'Not completed'}

${problem.comments ? `COMMENTS:
${'-'.repeat(25)}
${problem.comments}` : ''}

END OF REPORT`;
        }

        function closeModal() {
            document.getElementById('problemModal').classList.add('hidden');
            document.getElementById('reportModal').classList.add('hidden');
        }

        function copyFromModal() {
            const text = document.getElementById('reportText').textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyReportFromModal');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard');
            });
        }

        // Chart functionality
        function generateChartReport() {
            document.getElementById('chartModal').classList.remove('hidden');
            currentChartData = filteredProblems;
            generateChart('category');
        }

        function closeChartModal() {
            document.getElementById('chartModal').classList.add('hidden');
            if (reportChart) {
                reportChart.destroy();
                reportChart = null;
            }
        }

        function generateChart(type) {
            if (!currentChartData || currentChartData.length === 0) {
                alert('No data available for chart. Apply filters first.');
                return;
            }

            const ctx = document.getElementById('reportChart').getContext('2d');
            
            if (reportChart) {
                reportChart.destroy();
            }

            let chartData, chartConfig;

            switch(type) {
                case 'category':
                    chartData = generateCategoryData();
                    chartConfig = {
                        type: 'bar',
                        data: {
                            labels: chartData.labels,
                            datasets: [{
                                label: 'Problems by Category',
                                data: chartData.data,
                                backgroundColor: '#3b82f6',
                                borderColor: '#2563eb',
                                borderWidth: 1
                            }]
                        },
                        options: getChartOptions('Problems by Category')
                    };
                    break;
                case 'priority':
                    chartData = generatePriorityData();
                    chartConfig = {
                        type: 'doughnut',
                        data: {
                            labels: chartData.labels,
                            datasets: [{
                                data: chartData.data,
                                backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e'],
                                borderColor: '#fff',
                                borderWidth: 2
                            }]
                        },
                        options: getChartOptions('Problems by Priority')
                    };
                    break;
                case 'status':
                    chartData = generateStatusData();
                    chartConfig = {
                        type: 'pie',
                        data: {
                            labels: chartData.labels,
                            datasets: [{
                                data: chartData.data,
                                backgroundColor: ['#dbeafe', '#fef3c7', '#d1fae5', '#fde2e8'],
                                borderColor: '#fff',
                                borderWidth: 2
                            }]
                        },
                        options: getChartOptions('Problems by Status')
                    };
                    break;
                case 'zone':
                    chartData = generateZoneData();
                    chartConfig = {
                        type: 'bar',
                        data: {
                            labels: chartData.labels,
                            datasets: [{
                                label: 'Problems by Zone',
                                data: chartData.data,
                                backgroundColor: '#8b5cf6',
                                borderColor: '#7c3aed',
                                borderWidth: 1
                            }]
                        },
                        options: getChartOptions('Problems by Zone')
                    };
                    break;
                case 'monthly':
                    chartData = generateMonthlyData();
                    chartConfig = {
                        type: 'line',
                        data: {
                            labels: chartData.labels,
                            datasets: [{
                                label: 'Problems by Month',
                                data: chartData.data,
                                borderColor: '#059669',
                                backgroundColor: 'rgba(5, 150, 105, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: getChartOptions('Problems by Month')
                    };
                    break;
                case 'unit':
                    chartData = generateUnitData();
                    chartConfig = {
                        type: 'bar',
                        data: {
                            labels: chartData.labels,
                            datasets: [{
                                label: 'Problems by Unit (Top 10)',
                                data: chartData.data,
                                backgroundColor: '#f59e0b',
                                borderColor: '#d97706',
                                borderWidth: 1
                            }]
                        },
                        options: getChartOptions('Problems by Unit (Top 10)')
                    };
                    break;
            }

            reportChart = new Chart(ctx, chartConfig);

            // Update chart stats
            updateChartStats(chartData);
            document.getElementById('chartStats').style.display = 'block';
        }

        function generateCategoryData() {
            const categories = {};
            currentChartData.forEach(p => {
                const cat = p.category || 'Uncategorized';
                categories[cat] = (categories[cat] || 0) + 1;
            });
            const sorted = Object.entries(categories).sort((a, b) => b[1] - a[1]);
            return {
                labels: sorted.map(item => item[0]),
                data: sorted.map(item => item[1])
            };
        }

        function generatePriorityData() {
            const priorities = {};
            currentChartData.forEach(p => {
                const priority = p.problemPriority || 'Medium';
                priorities[priority] = (priorities[priority] || 0) + 1;
            });
            const order = ['Urgent', 'High', 'Medium', 'Low'];
            const labels = [];
            const data = [];
            order.forEach(priority => {
                if (priorities[priority]) {
                    labels.push(priority);
                    data.push(priorities[priority]);
                }
            });
            return { labels, data };
        }

        function generateStatusData() {
            const statuses = {};
            currentChartData.forEach(p => {
                const status = p.problemStatus || 'Reported';
                statuses[status] = (statuses[status] || 0) + 1;
            });
            return {
                labels: Object.keys(statuses),
                data: Object.values(statuses)
            };
        }

        function generateZoneData() {
            const zones = {};
            currentChartData.forEach(p => {
                const zone = p.zone || 'Unspecified';
                zones[zone] = (zones[zone] || 0) + 1;
            });
            const sorted = Object.entries(zones).sort((a, b) => b[1] - a[1]);
            return {
                labels: sorted.map(item => item[0]),
                data: sorted.map(item => item[1])
            };
        }

        function generateMonthlyData() {
            const months = {};
            currentChartData.forEach(p => {
                if (p.timestamp) {
                    const date = new Date(p.timestamp);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    months[monthKey] = (months[monthKey] || 0) + 1;
                }
            });
            const sorted = Object.entries(months).sort();
            return {
                labels: sorted.map(item => item[0]),
                data: sorted.map(item => item[1])
            };
        }

        function generateUnitData() {
            const units = {};
            currentChartData.forEach(p => {
                const unit = p.unitNumber || 'Unknown';
                units[unit] = (units[unit] || 0) + 1;
            });
            const sorted = Object.entries(units).sort((a, b) => b[1] - a[1]).slice(0, 10);
            return {
                labels: sorted.map(item => `Unit ${item[0]}`),
                data: sorted.map(item => item[1])
            };
        }

        function getChartOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    title: {
                        display: true,
                        text: title,
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            };
        }

        function updateChartStats(chartData) {
            const total = chartData.data.reduce((sum, val) => sum + val, 0);
            const categories = chartData.labels.length;
            const maxIndex = chartData.data.indexOf(Math.max(...chartData.data));
            const topItem = chartData.labels[maxIndex];

            document.getElementById('chartTotalCount').textContent = total;
            document.getElementById('chartCategoryCount').textContent = categories;
            document.getElementById('chartTopItem').textContent = topItem;
        }

        function downloadChartImage() {
            if (!reportChart) return;
            
            const link = document.createElement('a');
            link.download = 'chart-report.png';
            link.href = reportChart.toDataURL();
            link.click();
        }

        // Other utility functions
        function toggleSort() {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
            const btn = document.getElementById('sortToggleBtn');
            btn.textContent = sortDirection === 'desc' ? 'üìÖ Newest First' : 'üìÖ Oldest First';
            applyFilters();
        }

        function changeItemsPerPage() {
            const select = document.getElementById('itemsPerPageSelect');
            itemsPerPage = select.value === 'all' ? 'all' : parseInt(select.value);
            localStorage.setItem('explorerItemsPerPage', select.value);
            currentPage = 1;
            displayProblems();
        }

        function exportToCSV() {
            if (!filteredProblems || filteredProblems.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['PID', 'Unit', 'Description', 'Status', 'Priority', 'Category', 'Date', 'Reported By'];
            const csvData = [headers];

            filteredProblems.forEach(problem => {
                csvData.push([
                    getFriendlyPID(problem.internalId),
                    problem.unitNumber || '',
                    problem.problemDescription || '',
                    problem.problemStatus || '',
                    problem.problemPriority || '',
                    problem.category || '',
                    formatDate(problem.timestamp),
                    problem.reportedBy || ''
                ]);
            });

            const csvContent = csvData.map(row => 
                row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `problems_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showError(message) {
            const grid = document.getElementById('problemsGrid');
            grid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #ef4444;">
                    <div style="font-size: 2rem; margin-bottom: 16px;">‚ö†Ô∏è</div>
                    <div style="font-size: 1.2rem; margin-bottom: 8px;">Error</div>
                    <div>${message}</div>
                    <button onclick="loadAllData()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Retry
                    </button>
                </div>
            `;
        }

        // Fixed function to match current Desktop Explorer behavior exactly
        function debugClearAllFilters() {
            console.log('üîÑ DEBUG: Button clicked');
            const button = document.getElementById('toggleAllBtn');
            const buttonText = button.textContent;
            
            console.log('Button says:', buttonText);
            console.log('Before action - activeFilters:', activeFilters);
            
            if (buttonText.includes('CLEAR ALL FILTERS')) {
                // Button says "Clear All Filters" - so CLEAR them (make all white/unselected)
                activeFilters = {
                    date: null,
                    customDateRange: null,
                    priorities: [],
                    statuses: [],
                    zones: [],
                    categories: [],
                    subCategories: [],
                    assignedTo: [],
                    units: [],
                    programmedOnly: false
                };
                button.textContent = '‚úÖ CHECK ALL FILTERS';
                console.log('Cleared all filters - slicers should be WHITE');
                
            } else if (buttonText.includes('CHECK ALL FILTERS')) {
                // Button says "Check All Filters" - so CHECK them all (make all blue/selected)
                if (allProblems && allProblems.length > 0) {
                    const allPriorities = [...new Set(allProblems.map(p => p.problemPriority).filter(p => p && p.trim() !== '' && p !== 'Not Set'))];
                    const allStatuses = [...new Set(allProblems.map(p => p.problemStatus).filter(s => s && s.trim() !== '' && s !== 'Not Set'))];
                    const allZones = [...new Set(allProblems.map(p => p.zone).filter(z => z && z.trim() !== '' && z !== 'Not Set'))];
                    const allCategories = [...new Set(allProblems.map(p => p.category).filter(c => c && c.trim() !== '' && c !== 'Not Set'))];
                    const allSubCategories = [...new Set(allProblems.map(p => p.subCategory).filter(sc => sc && sc.trim() !== '' && sc !== 'Not Set'))];
                    const allAssignedTo = [...new Set(allProblems.map(p => p.assignedTo).filter(a => a && a.trim() !== '' && a !== 'Not Set'))];
                    const allUnits = [...new Set(allProblems.map(p => p.unitNumber).filter(u => u && u.toString().trim() !== '' && u !== 'Not Set'))];
                    
                    activeFilters = {
                        date: null,
                        customDateRange: null,
                        priorities: allPriorities,
                        statuses: allStatuses,
                        zones: allZones,
                        categories: allCategories,
                        subCategories: allSubCategories,
                        assignedTo: allAssignedTo,
                        units: allUnits,
                        programmedOnly: false
                    };
                }
                button.textContent = 'üóëÔ∏è CLEAR ALL FILTERS';
                console.log('Selected all filters - slicers should be BLUE');
            }
            
            console.log('After action - activeFilters:', activeFilters);
            
            // Clear other UI states
            document.getElementById('searchInput').value = '';
            document.getElementById('yearSelect').value = '';
            document.getElementById('customStartDate').value = '';
            document.getElementById('customEndDate').value = '';
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
            
            const programmedElement = document.getElementById('programmedSlicer');
            if (programmedElement) {
                programmedElement.classList.remove('active');
            }
            
            // Rebuild everything
            buildSlicers();
            applyFilters();
            
            console.log('üîÑ DEBUG: Action complete');
        }

        // Scroll functions
        function scrollToTop() {
            document.querySelector('.content-area').scrollTop = 0;
        }

        function scrollToBottom() {
            const contentArea = document.querySelector('.content-area');
            contentArea.scrollTop = contentArea.scrollHeight;
        }

        // API request function
        async function makeRequest(action) {
            return new Promise((resolve, reject) => {
                const callbackName = 'callback_' + Math.random().toString(36).substr(2, 9);
                const script = document.createElement('script');
                const timeout = setTimeout(() => {
                    cleanup();
                    reject(new Error('Request timeout'));
                }, 30000);

                window[callbackName] = (data) => {
                    clearTimeout(timeout);
                    cleanup();
                    resolve(data);
                };

                function cleanup() {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                }

                script.src = `${WEB_APP_URL}?action=${action}&callback=${callbackName}`;
                script.onerror = () => {
                    cleanup();
                    reject(new Error('Script load error'));
                };

                document.head.appendChild(script);
            });
        }
    </script>
</body>
</html>