<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Viewer - Lake Illawong Maintenance</title>
    <style>
        :root {
            --primary-blue: #3b82f6;
            --primary-blue-dark: #2563eb;
            --gradient-bg: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            --success-green: #10b981;
            --success-bg: #f0fdf4;
            --error-red: #ef4444;
            --error-bg: #fef2f2;
            --info-purple: #8b5cf6;
            --info-bg: #faf5ff;
            --text-primary: #1e293b;
            --text-secondary: #374151;
            --text-muted: #64748b;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --border-primary: #e2e8f0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--gradient-bg); min-height: 100vh; color: var(--text-primary); line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px 30px; }





.header {
    background: transparent;  /* Changed from white rounded box */
    text-align: center;
    margin-bottom: 30px;
    padding: 20px 0;
}

.header-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 25px;
    flex-wrap: wrap;
    margin-bottom: 0;
}

.header-text {
    text-align: center;
}

.header-title {
    font-size: 2.25rem;
    font-weight: 700;
    color: white;  /* Changed from var(--text-primary) */
    margin-bottom: 8px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
}

.header-subtitle {
    font-size: 1.125rem;
    color: rgba(255, 255, 255, 0.9);  /* Changed from var(--text-muted) */
    font-weight: 500;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

        

        .search-section { background: var(--bg-primary); border-radius: 6px; padding: 30px; margin-bottom: 30px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08); }
        .search-form { display: flex; gap: 15px; align-items: end; flex-wrap: wrap; }
        .search-group { flex: 1; min-width: 200px; display: flex; flex-direction: column; gap: 8px; }
        .search-label { font-weight: 600; color: var(--text-secondary); font-size: 0.9rem; }
        .search-input { padding: 12px 16px; border: 2px solid var(--border-primary); border-radius: 8px; font-size: 1rem; transition: border-color 0.3s ease; }
        .search-input:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; border: none; display: flex; align-items: center; gap: 8px; white-space: nowrap; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3); }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-secondary); border: 2px solid var(--border-primary); }
        .btn-secondary:hover { background: var(--border-primary); }
        .filters-section { margin-top: 20px; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-primary); }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .results-section { background: var(--bg-primary); border-radius: 6px; padding: 30px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08); min-height: 400px; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border-primary); }
        .results-title { font-size: 1.5rem; font-weight: 600; color: var(--text-primary); }
        .results-count { background: var(--info-bg); color: var(--info-purple); padding: 6px 12px; border-radius: 20px; font-size: 0.875rem; font-weight: 600; }
        .export-menu { position: relative; display: inline-block; }
        .export-dropdown { position: absolute; top: 100%; right: 0; background: var(--bg-primary); border: 1px solid var(--border-primary); border-radius: 8px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); min-width: 200px; z-index: 1000; display: none; }
        .export-dropdown.show { display: block; }
        .export-option { padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--text-secondary); transition: background-color 0.3s ease; font-size: 0.9rem; }
        .export-option:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .problem-summary { background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-left: 4px solid var(--primary-blue); }
        .problem-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .summary-item { display: flex; flex-direction: column; gap: 4px; }
        .summary-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-value { font-weight: 600; color: var(--text-primary); }
        .timeline-container { position: relative; }
        .timeline-item { display: flex; margin-bottom: 20px; position: relative; }
        .timeline-item:not(:last-child)::after { content: ''; position: absolute; left: 20px; top: 50px; bottom: -20px; width: 2px; background: var(--border-primary); }
        .timeline-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 20px; flex-shrink: 0; position: relative; z-index: 1; background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark)); color: white; }
        .timeline-icon.recent { background: linear-gradient(135deg, var(--success-green), #059669); }
        .timeline-content { flex: 1; background: var(--bg-primary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-primary); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
        .timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
        .timeline-user { font-weight: 700; color: var(--primary-blue); }
        .timeline-action { color: var(--text-secondary); font-weight: 500; }
        .timeline-time { color: var(--text-muted); font-size: 0.875rem; font-weight: 500; }
        .timeline-changes { margin-top: 12px; }
        .timeline-change { margin-bottom: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; }
        .timeline-field { font-weight: 600; color: var(--text-primary); margin-bottom: 6px; font-size: 0.9rem; }
        .timeline-values { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .timeline-old-value, .timeline-new-value { padding: 4px 8px; border-radius: 4px; font-size: 0.875rem; font-weight: 500; }
        .timeline-old-value { background: var(--error-bg); color: var(--error-red); }
        .timeline-new-value { background: var(--success-bg); color: var(--success-green); }
        .timeline-arrow { color: var(--text-muted); font-weight: bold; }
        .timeline-comment-content { background: var(--info-bg); color: var(--text-primary); padding: 15px; border-radius: 8px; margin-top: 8px; border-left: 3px solid var(--info-purple); font-style: italic; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
        .status-message { padding: 16px 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid; }
        .status-error { background: var(--error-bg); border-left-color: var(--error-red); color: #dc2626; }
        @media (max-width: 768px) { .container { padding: 15px 20px; } .header-title { font-size: 1.75rem; } .search-form { flex-direction: column; } .search-group { min-width: auto; } .results-header { flex-direction: column; gap: 10px; align-items: flex-start; } .filters-grid { grid-template-columns: 1fr; } }

.logo-container {
    flex-shrink: 0;
}

.logo-image {
    width: 120px;
    height: 120px;
    object-fit: contain;
    background: transparent;
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 15px;
    }
    
    .logo-image {
        width: 100px;
        height: 100px;
    }
    
    .header-title {
        font-size: 1.75rem;
    }
    
    .header-subtitle {
        font-size: 1rem;
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
    <div class="header-content">
        <div class="logo-container">
            <img src="https://maintenanceportal2025.github.io/maintenance-portal/logo.png" alt="Lake Illawong Logo" class="logo-image">
        </div>
        <div class="header-text">
            <h1 class="header-title">Timeline Viewer</h1>
            <p class="header-subtitle">Activity History & Problem Tracking</p>
        </div>
    </div>
</div>

        <div class="search-section">
            <div class="search-form">
                <div class="search-group">
                    <label class="search-label">Search (Optional)</label>
                    <input type="text" id="searchInput" class="search-input" placeholder="Enter Problem ID (222323) or Unit Number (9)">
                </div>
                <button class="btn btn-primary" onclick="performSearch()">Search</button>
                <button class="btn btn-secondary" onclick="toggleFilters()">Filters</button>
                <button class="btn btn-secondary" onclick="clearResults()">Clear</button>
            </div>
            
            <div id="filtersSection" class="filters-section" style="display: none;">
                <h4 style="margin-bottom: 15px; color: var(--text-primary); font-weight: 600;">Filters</h4>
                <div class="filters-grid">
                    <div class="search-group">
                        <label class="search-label">Zone</label>
                        <select id="zoneFilter" class="search-input" onchange="applyFilters()">
                            <option value="">All Zones</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <label class="search-label">Status</label>
                        <select id="statusFilter" class="search-input" onchange="applyFilters()">
                            <option value="">All Status</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <label class="search-label">Priority</label>
                        <select id="priorityFilter" class="search-input" onchange="applyFilters()">
                            <option value="">All Priority</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="clearFilters()" style="font-size: 0.9rem; padding: 8px 16px;">Clear Filters</button>
            </div>
        </div>

        <div class="results-section">
            <div class="results-header">
                <h2 class="results-title">Timeline Results</h2>
                <div id="resultsCount" class="results-count" style="display: none;">0 activities found</div>
                <div class="export-menu">
                    <button class="btn btn-secondary" onclick="toggleExportMenu()" id="exportBtn" style="display: none;">Export</button>
                    <div class="export-dropdown" id="exportDropdown">
                        <div class="export-option" onclick="exportToPDF()">Download Report</div>
                        <div class="export-option" onclick="copyToClipboard()">Copy Summary</div>
                        <div class="export-option" onclick="exportToCSV()">Export CSV</div>
                    </div>
                </div>
            </div>

            <div id="resultsContent">
                <div class="empty-state">
                    <div class="empty-state-icon">🔍</div>
                    <h3>Ready to Search or Filter</h3>
                    <p>Enter a Problem ID or Unit Number to search, or use filters to browse all problems</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxtdMfxB5b1F5K401X0lJxnK2-DGkiG2zYZNukJvAHx0K1AqgPTMIdiunwS3etm0FOL/exec';
        let currentProblems = [], currentTimeline = [], filteredProblems = [];
        let allZones = new Set(), allStatuses = new Set(), allPriorities = new Set();

        document.addEventListener('DOMContentLoaded', function() {
            loadAllProblems();
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
        });

        async function loadAllProblems() {
            try {
                const response = await makeAPICall('getFaultLogData');
                if (response.success) {
                    currentProblems = response.data || [];
                    
                    // Build filter options and remove duplicates
                    currentProblems.forEach(problem => {
                        if (problem.zone) allZones.add(problem.zone);
                        if (problem.problemStatus) allStatuses.add(problem.problemStatus);
                        if (problem.problemPriority) allPriorities.add(problem.problemPriority);
                    });
                    
                    populateFilterDropdowns();
                    
                    // Show all problems by default
                    displayAllProblems();
                } else {
                    showError('Backend error: ' + (response.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Failed to load problem data. Please check your connection and try again.');
            }
        }

        async function makeAPICall(action, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                const script = document.createElement('script');
                const queryParams = new URLSearchParams({ action, callback: callbackName, ...params });
                script.src = `${API_URL}?${queryParams}`;
                
                window[callbackName] = function(response) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    resolve(response);
                };
                
                script.onerror = function() {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('Network request failed'));
                };
                
                document.head.appendChild(script);
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Request timeout'));
                    }
                }, 15000);
            });
        }

        function performSearch() {
            const searchInput = document.getElementById('searchInput').value.trim();
            
            if (!searchInput) {
                // No search term - apply filters to all data
                applyFilters();
                return;
            }
            
            // Detect search type - prioritize unit number for short numbers
            const isProblemId = /PID/i.test(searchInput) || /^\d{8}-\d{6}$/.test(searchInput);
            const is6DigitPID = /^\d{6}$/.test(searchInput);
            const isShortNumber = /^\d{1,2}$/.test(searchInput);
            
            if (isShortNumber) {
                // 1-2 digit numbers are definitely unit searches
                searchByUnit(searchInput);
            } else if (is6DigitPID) {
                // 6 digits could be PID, try PID first then unit
                if (!searchByProblemId(searchInput)) {
                    searchByUnit(searchInput);
                }
            } else if (isProblemId) {
                searchByProblemId(searchInput);
            } else if (/^\d+$/.test(searchInput)) {
                // Other numbers, try unit first then PID
                if (!searchByUnit(searchInput)) {
                    searchByProblemId(searchInput);
                }
            } else {
                // Try both for other formats
                if (!searchByProblemId(searchInput)) {
                    searchByUnit(searchInput);
                }
            }
        }

        function searchByProblemId(problemIdInput) {
            let searchTerms = [];
            
            if (problemIdInput.includes('-')) searchTerms.push(problemIdInput);
            if (problemIdInput.toUpperCase().startsWith('PID')) {
                const pidNumber = problemIdInput.replace(/^PID\s*/i, '').trim();
                searchTerms.push(pidNumber);
            }
            if (/^\d{6}$/.test(problemIdInput)) searchTerms.push(problemIdInput);
            if (searchTerms.length === 0) searchTerms.push(problemIdInput);
            
            const problem = currentProblems.find(p => {
                if (searchTerms.some(term => p.internalId === term)) return true;
                const friendlyPID = getFriendlyPID(p.internalId);
                if (searchTerms.some(term => friendlyPID.includes(term))) return true;
                if (p.internalId && p.internalId.includes('-')) {
                    const lastPart = p.internalId.split('-')[1];
                    if (searchTerms.some(term => term === lastPart)) return true;
                }
                return false;
            });

            if (problem) {
                displaySingleProblem(problem, `Problem ${getFriendlyPID(problem.internalId)}`);
                return true;
            } else {
                showError(`Problem ID "${problemIdInput}" not found. Try using the 6-digit format like "222323".`);
                return false;
            }
        }

        function searchByUnit(unitNumber) {
            // Debug: Show what unit numbers exist
            const allUnits = [...new Set(currentProblems.map(p => p.unitNumber?.toString().trim()).filter(Boolean))];
            console.log('Available units:', allUnits.sort((a, b) => parseInt(a) - parseInt(b)));
            console.log('Searching for unit:', unitNumber);
            
            const unitProblems = currentProblems.filter(p => {
                if (!p.unitNumber) return false;
                const storedUnit = p.unitNumber.toString().trim();
                const searchUnit = unitNumber.toString().trim();
                
                // Try exact match first
                if (storedUnit === searchUnit) return true;
                
                // Try matching "Unit X" with "X"
                if (storedUnit === `Unit ${searchUnit}`) return true;
                
                // Try matching "X" with "Unit X" 
                if (`Unit ${storedUnit}` === searchUnit) return true;
                
                // Extract number from "Unit X" format and compare
                const storedMatch = storedUnit.match(/Unit\s*(\d+)/i);
                if (storedMatch && storedMatch[1] === searchUnit) return true;
                
                return false;
            });
            
            if (unitProblems.length > 0) {
                displayMultipleProblems(unitProblems, `Unit ${unitNumber}`, true);
                return true;
            } else {
                // Show available units in error message - extract numbers from "Unit X" format
                const availableUnits = allUnits
                    .map(unit => {
                        const match = unit.match(/Unit\s*(\d+)/i);
                        return match ? match[1] : unit;
                    })
                    .sort((a, b) => parseInt(a) - parseInt(b))
                    .slice(0, 10);
                
                const unitList = availableUnits.length > 10 ? 
                    availableUnits.join(', ') + '...' : 
                    availableUnits.join(', ');
                showError(`No problems found for Unit ${unitNumber}. Available units with problems: ${unitList}`);
                return false;
            }
        }

        function displayAllProblems() {
            if (currentProblems.length === 0) {
                updateResults('All Problems', 0, getEmptyStateHTML());
                return;
            }
            displayMultipleProblems(currentProblems, 'All Problems', false);
        }

        function displaySingleProblem(problem, title) {
            let activities = [];
            try {
                activities = problem.activityLogParsed || JSON.parse(problem.activityLog || '[]');
            } catch (e) {
                activities = [];
            }
            
            const summaryHTML = createProblemSummary(problem);
            const timelineHTML = createTimelineHTML(activities);
            
            updateResults(`${title} Timeline`, activities.length, summaryHTML + timelineHTML);
            currentTimeline = [{ problem: problem, activities: activities }];
            filteredProblems = [problem];
        }

        function displayMultipleProblems(problems, title, fromSearch) {
            let timelineHTML = '';
            let totalActivities = 0;
            
            // Sort problems by internal ID for consistent display
            const sortedProblems = [...problems].sort((a, b) => {
                const aId = a.internalId || '';
                const bId = b.internalId || '';
                return aId.localeCompare(bId);
            });
            
            sortedProblems.forEach(problem => {
                let activities = [];
                try {
                    activities = problem.activityLogParsed || JSON.parse(problem.activityLog || '[]');
                } catch (e) {
                    activities = [];
                }
                totalActivities += activities.length;
                
                // Use consistent summary format for all displays
                timelineHTML += `
                    <div class="problem-summary" style="margin-bottom: 30px;">
                        <div class="problem-summary-grid">
                            <div class="summary-item">
                                <span class="summary-label">Problem ID</span>
                                <span class="summary-value">${getFriendlyPID(problem.internalId)}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Unit Number</span>
                                <span class="summary-value">${problem.unitNumber || 'Unknown'}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Zone</span>
                                <span class="summary-value">${problem.zone || 'Unknown'}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Status</span>
                                <span class="summary-value">${problem.problemStatus || 'Unknown'}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Priority</span>
                                <span class="summary-value">${problem.problemPriority || 'Unknown'}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Category</span>
                                <span class="summary-value">${problem.category || 'Not assigned'}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Reported Date</span>
                                <span class="summary-value">${formatDate(problem.timestamp)}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Reported By</span>
                                <span class="summary-value">${problem.reportedBy || 'Unknown'}</span>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-primary);">
                            <span class="summary-label">Description</span>
                            <div style="margin-top: 8px;">${problem.problemDescription || 'No description available'}</div>
                        </div>
                        ${createTimelineHTML(activities)}
                    </div>
                `;
            });
            
            const displayTitle = fromSearch ? `${title} Timeline (${problems.length} problems)` : 
                                problems.length === currentProblems.length ? `${title} (${problems.length} problems)` : 
                                `${title} (${problems.length} of ${currentProblems.length} problems)`;
            
            updateResults(displayTitle, totalActivities, timelineHTML);
            currentTimeline = problems.map(problem => ({ 
                problem: problem, 
                activities: problem.activityLogParsed || [] 
            }));
            filteredProblems = problems;
        }

        function createProblemSummary(problem) {
            return `
                <div class="problem-summary">
                    <div class="problem-summary-grid">
                        <div class="summary-item">
                            <span class="summary-label">Problem ID</span>
                            <span class="summary-value">${getFriendlyPID(problem.internalId)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Unit Number</span>
                            <span class="summary-value">${problem.unitNumber || 'Unknown'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Zone</span>
                            <span class="summary-value">${problem.zone || 'Unknown'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Status</span>
                            <span class="summary-value">${problem.problemStatus || 'Unknown'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Priority</span>
                            <span class="summary-value">${problem.problemPriority || 'Unknown'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Category</span>
                            <span class="summary-value">${problem.category || 'Not assigned'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Reported Date</span>
                            <span class="summary-value">${formatDate(problem.timestamp)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Reported By</span>
                            <span class="summary-value">${problem.reportedBy || 'Unknown'}</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-primary);">
                        <span class="summary-label">Description</span>
                        <div style="margin-top: 8px;">${problem.problemDescription || 'No description available'}</div>
                    </div>
                </div>
            `;
        }

        function createTimelineHTML(activities) {
            if (!activities || activities.length === 0) {
                return `<div class="empty-state"><div class="empty-state-icon">📝</div><h3>No Activity History</h3><p>No activity has been recorded for this problem yet</p></div>`;
            }
            
            const sortedActivities = [...activities].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            let timelineHTML = '<div class="timeline-container">';
            
            sortedActivities.forEach((activity, index) => {
                timelineHTML += createTimelineItem(activity, index === 0);
            });
            
            timelineHTML += '</div>';
            return timelineHTML;
        }

        function createTimelineItem(activity, isRecent) {
            const timestamp = new Date(activity.timestamp);
            const formattedTime = timestamp.toLocaleString('en-AU');
            const iconClass = isRecent ? 'recent' : '';
            
            let changesHTML = '';
            if (activity.changes && activity.changes.length > 0) {
                changesHTML = '<div class="timeline-changes">';
                activity.changes.forEach(change => {
                    if (change.field === 'Comments' && change.newValue) {
                        changesHTML += `<div class="timeline-change"><div class="timeline-field">💬 Comment Added</div><div class="timeline-comment-content">"${change.newValue}"</div></div>`;
                    } else {
                        const oldValue = change.oldValue || '(empty)';
                        const newValue = change.newValue || '(empty)';
                        changesHTML += `<div class="timeline-change"><div class="timeline-field">${change.field} Changed</div><div class="timeline-values"><span class="timeline-old-value">${oldValue}</span><span class="timeline-arrow">→</span><span class="timeline-new-value">${newValue}</span></div></div>`;
                    }
                });
                changesHTML += '</div>';
            }
            
            return `
                <div class="timeline-item">
                    <div class="timeline-icon ${iconClass}">📝</div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <span class="timeline-user">${activity.user || 'System'}</span>
                            <span class="timeline-action">${activity.action || 'Updated'}</span>
                            <span class="timeline-time">${formattedTime}</span>
                        </div>
                        ${changesHTML}
                    </div>
                </div>
            `;
        }

        function toggleFilters() {
            const filtersSection = document.getElementById('filtersSection');
            const isVisible = filtersSection.style.display !== 'none';
            filtersSection.style.display = isVisible ? 'none' : 'block';
        }

        function populateFilterDropdowns() {
            // Populate zone filter (remove duplicates)
            const zoneSelect = document.getElementById('zoneFilter');
            zoneSelect.innerHTML = '<option value="">All Zones</option>';
            Array.from(allZones).sort().forEach(zone => {
                const option = document.createElement('option');
                option.value = zone;
                option.textContent = zone;
                zoneSelect.appendChild(option);
            });

            // Populate status filter (remove duplicates)
            const statusSelect = document.getElementById('statusFilter');
            statusSelect.innerHTML = '<option value="">All Status</option>';
            Array.from(allStatuses).sort().forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusSelect.appendChild(option);
            });

            // Populate priority filter (remove duplicates)
            const prioritySelect = document.getElementById('priorityFilter');
            prioritySelect.innerHTML = '<option value="">All Priority</option>';
            Array.from(allPriorities).sort().forEach(priority => {
                const option = document.createElement('option');
                option.value = priority;
                option.textContent = priority;
                prioritySelect.appendChild(option);
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const zoneFilter = document.getElementById('zoneFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            
            let dataToFilter = searchTerm ? filteredProblems : currentProblems;
            
            let filtered = dataToFilter.filter(problem => {
                if (zoneFilter && problem.zone !== zoneFilter) return false;
                if (statusFilter && problem.problemStatus !== statusFilter) return false;
                if (priorityFilter && problem.problemPriority !== priorityFilter) return false;
                return true;
            });
            
            if (filtered.length > 0) {
                let titlePrefix = searchTerm ? 
                    (searchTerm.match(/^\d+$/) ? `Unit ${searchTerm}` : `Search: ${searchTerm}`) : 
                    'Filtered Results';
                    
                let filters = [];
                if (zoneFilter) filters.push(`Zone: ${zoneFilter}`);
                if (statusFilter) filters.push(`Status: ${statusFilter}`);
                if (priorityFilter) filters.push(`Priority: ${priorityFilter}`);
                
                const filterSummary = filters.length > 0 ? ` (${filters.join(', ')})` : '';
                const title = `${titlePrefix}${filterSummary}`;
                
                displayMultipleProblems(filtered, title, false);
            } else {
                const noResultsMsg = searchTerm ? 
                    `No problems found matching search "${searchTerm}" with applied filters` : 
                    'No problems found matching the selected filters';
                showError(noResultsMsg);
            }
        }

        function clearFilters() {
            document.getElementById('zoneFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('priorityFilter').value = '';
            
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (searchTerm) {
                // Re-run original search without filters
                performSearch();
            } else {
                // Show all problems
                displayAllProblems();
            }
        }

        function updateResults(title, count, content) {
            document.querySelector('.results-title').textContent = title;
            const countElement = document.getElementById('resultsCount');
            const exportBtn = document.getElementById('exportBtn');
            
            if (count > 0) {
                countElement.textContent = `${count} activities found`;
                countElement.style.display = 'block';
                exportBtn.style.display = 'block';
            } else {
                countElement.style.display = 'none';
                exportBtn.style.display = 'none';
            }
            
            document.getElementById('resultsContent').innerHTML = content;
        }

        function clearResults() {
            document.getElementById('searchInput').value = '';
            document.getElementById('zoneFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('priorityFilter').value = '';
            document.getElementById('filtersSection').style.display = 'none';
            
            displayAllProblems();
        }

        function showError(message) {
            updateResults('Search Error', 0, 
                `<div class="status-message status-error"><strong>Error:</strong> ${message}</div>
                <div class="empty-state">
                    <div class="empty-state-icon">❌</div>
                    <h3>No Results Found</h3>
                    <p>Please adjust your search or filter criteria and try again</p>
                </div>`
            );
        }

        function getEmptyStateHTML() {
            return `
                <div class="empty-state">
                    <div class="empty-state-icon">🔍</div>
                    <h3>Ready to Search or Filter</h3>
                    <p>Enter a Problem ID or Unit Number to search, or use filters to browse all problems</p>
                </div>
            `;
        }

        function getFriendlyPID(internalId) {
            if (!internalId) return 'PID Unknown';
            const parts = internalId.split('-');
            return parts.length === 2 ? `PID ${parts[1]}` : `PID ${internalId}`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-AU') + ' ' + date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return dateString;
            }
        }

        function toggleExportMenu() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('show');
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.export-menu')) {
                document.getElementById('exportDropdown').classList.remove('show');
            }
        });

        function exportToPDF() {
            document.getElementById('exportDropdown').classList.remove('show');
            if (currentTimeline.length === 0) {
                alert('No timeline data to export');
                return;
            }
            
            let report = 'MAINTENANCE PORTAL - TIMELINE REPORT\n' + '='.repeat(60) + '\n' + 
                `Generated: ${new Date().toLocaleString('en-AU')}\n\n`;
            
            currentTimeline.forEach(item => {
                const problem = item.problem;
                const activities = item.activities;
                
                report += `PROBLEM: ${getFriendlyPID(problem.internalId)}\n` + '-'.repeat(40) + '\n';
                report += `Unit: ${problem.unitNumber || 'Unknown'}\n`;
                report += `Zone: ${problem.zone || 'Unknown'}\n`;
                report += `Status: ${problem.problemStatus || 'Unknown'}\n`;
                report += `Priority: ${problem.problemPriority || 'Unknown'}\n`;
                report += `Description: ${problem.problemDescription || 'No description'}\n`;
                report += `Reported: ${formatDate(problem.timestamp)}\n\n`;
                
                if (activities.length > 0) {
                    report += 'ACTIVITY HISTORY:\n';
                    activities.forEach(activity => {
                        report += `\n${new Date(activity.timestamp).toLocaleString('en-AU')}\n`;
                        report += `User: ${activity.user || 'System'}\n`;
                        report += `Action: ${activity.action || 'Updated'}\n`;
                        
                        if (activity.changes && activity.changes.length > 0) {
                            activity.changes.forEach(change => {
                                if (change.field === 'Comments' && change.newValue) {
                                    report += `Comment: "${change.newValue}"\n`;
                                } else {
                                    report += `${change.field}: ${change.oldValue || '(empty)'} → ${change.newValue || '(empty)'}\n`;
                                }
                            });
                        }
                        report += '\n';
                    });
                } else {
                    report += 'No activity history available.\n';
                }
                
                report += '\n' + '='.repeat(60) + '\n\n';
            });
            
            downloadFile(report, `timeline_report_${new Date().toISOString().split('T')[0]}.txt`, 'text/plain');
            alert('Timeline report downloaded');
        }

        function exportToCSV() {
            document.getElementById('exportDropdown').classList.remove('show');
            if (currentTimeline.length === 0) {
                alert('No timeline data to export');
                return;
            }
            
            let csv = 'Problem ID,Unit,Zone,Timestamp,User,Action,Field Changed,Old Value,New Value,Comment\n';
            
            currentTimeline.forEach(item => {
                const problem = item.problem;
                const activities = item.activities;
                
                activities.forEach(activity => {
                    if (activity.changes && activity.changes.length > 0) {
                        activity.changes.forEach(change => {
                            const row = [
                                getFriendlyPID(problem.internalId),
                                problem.unitNumber || '',
                                problem.zone || '',
                                activity.timestamp,
                                activity.user || 'System',
                                activity.action || 'Updated',
                                change.field || '',
                                change.oldValue || '',
                                change.newValue || '',
                                change.field === 'Comments' ? change.newValue : ''
                            ].map(field => `"${(field || '').toString().replace(/"/g, '""')}"`).join(',');
                            csv += row + '\n';
                        });
                    }
                });
            });
            
            downloadFile(csv, `timeline_data_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            alert('Timeline data exported to CSV');
        }

        function copyToClipboard() {
            document.getElementById('exportDropdown').classList.remove('show');
            if (currentTimeline.length === 0) {
                alert('No timeline data to copy');
                return;
            }
            
            let text = 'MAINTENANCE TIMELINE SUMMARY\n===========================\n' + 
                `Generated: ${new Date().toLocaleString('en-AU')}\n\n`;
            
            currentTimeline.forEach(item => {
                const problem = item.problem;
                const activities = item.activities;
                
                text += `Problem ${getFriendlyPID(problem.internalId)} - Unit ${problem.unitNumber || 'Unknown'}\n`;
                text += `Status: ${problem.problemStatus || 'Unknown'} | Priority: ${problem.problemPriority || 'Unknown'}\n`;
                text += `Description: ${problem.problemDescription || 'No description'}\n\n`;
                
                if (activities.length > 0) {
                    text += 'Recent Activity:\n';
                    activities.slice(0, 3).forEach(activity => {
                        text += `• ${new Date(activity.timestamp).toLocaleString('en-AU')} - ${activity.user || 'System'}: ${activity.action || 'Updated'}\n`;
                    });
                    if (activities.length > 3) {
                        text += `• ... and ${activities.length - 3} more activities\n`;
                    }
                } else {
                    text += 'No activity recorded.\n';
                }
                
                text += '\n---\n\n';
            });
            
            navigator.clipboard.writeText(text).then(() => {
                alert('Timeline summary copied to clipboard');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Timeline summary copied to clipboard');
            });
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>