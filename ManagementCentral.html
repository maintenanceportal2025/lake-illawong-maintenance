<!--
=====================================================================
UNIFIED CONTACT MANAGER FRONTEND V1.1.6 - COMPLETE FIXED VERSION
=====================================================================
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Contact Manager - Simple V1.2 Connected</title>
    <style>
        :root {
            --primary-blue: #3b82f6;
            --primary-blue-dark: #1d4ed8;
            --primary-blue-light: #60a5fa;
            --success-green: #10b981;
            --warning-amber: #f59e0b;
            --error-red: #ef4444;
            --info-purple: #8b5cf6;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            
            --border-primary: #e2e8f0;
            --border-secondary: #cbd5e1;
            
            --info-bg: #f0f4ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .header-subtitle {
            font-size: 1rem;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .content {
            background: var(--bg-primary);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }

        .status-message {
            background: var(--info-bg);
            color: var(--info-purple);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--info-purple);
            font-weight: 500;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--bg-tertiary);
        }

        .tab {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            position: relative;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: var(--primary-blue);
            background: var(--bg-tertiary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-blue);
        }

        .tab:hover:not(.active) {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .action-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .btn-success {
            background: var(--success-green);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .btn-warning {
            background: var(--warning-amber);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box, .filter-select {
            padding: 12px 16px;
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        .search-box { flex: 1; min-width: 250px; }

        .table-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-primary);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--bg-tertiary);
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-primary);
        }

        .data-table td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border-secondary);
            color: var(--text-secondary);
        }

        .data-table tr:hover {
            background: var(--bg-tertiary);
        }

        .action-link {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 500;
            margin-right: 12px;
        }

        .action-link:hover {
            text-decoration: underline;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success { background: var(--success-green); }
        .toast.error { background: var(--error-red); }
        .toast.warning { background: var(--warning-amber); }
        .toast.info { background: var(--info-purple); }

        /* Modal Styles - Extracted from working version */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-secondary);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--bg-primary);
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .role-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .role-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border: 2px solid var(--border-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
        }

        .role-option:hover {
            border-color: var(--primary-blue);
            background: var(--info-bg);
        }

        .role-option input {
            margin: 0;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--border-secondary);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Dropdown Management Styles */
        .dropdown-management {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .dropdown-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-primary);
        }

        .dropdown-section h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .dropdown-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .dropdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border-primary);
        }

        .dropdown-item-actions {
            display: flex;
            gap: 8px;
        }

        .dropdown-item-actions button {
            padding: 4px 8px;
            font-size: 0.8rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .dropdown-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .dropdown-form input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-secondary);
            border-radius: 4px;
        }

        .dropdown-form button {
            padding: 8px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background: var(--primary-blue);
            color: white;
        }

        .subcategory-item {
            padding-left: 20px;
            background: var(--bg-tertiary);
        }

        .dropdown-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setup-message {
            background: var(--info-bg);
            color: var(--info-purple);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--info-purple);
            text-align: center;
        }

        .setup-button {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

.filter-select[onchange*="navigateToTab"] {
    background: var(--bg-secondary);
    border: 2px solid var(--primary-blue);
    font-weight: 500;
}

.filter-select[onchange*="navigateToTab"]:hover {
    border-color: var(--primary-blue-dark);
    background: var(--bg-tertiary);
}

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="header-title">🏢 Unified Contact Manager</h1>
            <p class="header-subtitle">V1.2 Connected - Dropdown Management</p>
        </div>

        <div class="content">
            <div class="status-message">
                🔗 <strong>Connected to UNIFIED CONTACT BACKEND</strong><br>
                Now with Dropdown Management for Categories and Sub-Categories
            </div>

<!--
=====================================================================
To find GIDs: Open your sheet, click on the tab, and look at the URL - the gid= number is what you need!
=====================================================================
-->



            
<div class="tabs" style="display: flex; justify-content: space-between; align-items: center;">
    <div class="tab-group" style="display: flex; gap: 5px;">
        <button class="tab active" onclick="showTab('contacts')">Contact Management</button>
        <button class="tab" onclick="showTab('dropdowns')">Dropdowns</button>
        <button class="tab" onclick="showTab('users')">User Accounts</button>
        <button class="tab" onclick="showTab('roles')">Role Assignment</button>
        <button class="tab" onclick="showTab('sync')">System Integration</button>
    </div>

    <div class="tab-dropdown">
        <select class="filter-select" onchange="navigateToTab(this.value)" style="min-width: 180px;">
        <option value="">🔗 Quick Navigation...</option>
	<option value="https://docs.google.com/spreadsheets/d/14u4Hl3Uluvk45ABIcgKGltX8EpBdGj1JvF_kEtZwmEE/edit#gid=0#">📋 FaultLog Tab</option>
	<option value="https://docs.google.com/spreadsheets/d/14u4Hl3Uluvk45ABIcgKGltX8EpBdGj1JvF_kEtZwmEE/edit#gid=764326103#">📋 LegacyLog Tab</option>
        <option value="https://docs.google.com/spreadsheets/d/14u4Hl3Uluvk45ABIcgKGltX8EpBdGj1JvF_kEtZwmEE/edit#gid=1448743973#">📋 UnitList Tab</option>
        <option value="https://docs.google.com/spreadsheets/d/14u4Hl3Uluvk45ABIcgKGltX8EpBdGj1JvF_kEtZwmEE/edit#gid=1690935191#">👥 User Accounts Tab</option>
	<option value="https://docs.google.com/spreadsheets/d/14u4Hl3Uluvk45ABIcgKGltX8EpBdGj1JvF_kEtZwmEE/edit#gid=1129786173#">📧 EmailList Tab</option>
        <option value="https://docs.google.com/spreadsheets/d/14u4Hl3Uluvk45ABIcgKGltX8EpBdGj1JvF_kEtZwmEE/edit#gid=426382568#">📧 EmailConfig Tab</option>
	<option value="https://docs.google.com/spreadsheets/d/14u4Hl3Uluvk45ABIcgKGltX8EpBdGj1JvF_kEtZwmEE/edit#gid=288474277#">📧 EmailTemplatesTab</option>
 	<option value="https://docs.google.com/spreadsheets/d/14u4Hl3Uluvk45ABIcgKGltX8EpBdGj1JvF_kEtZwmEE/edit#gid=1095776431#">📧 EmailLog Tab</option>
        <option value="https://docs.google.com/spreadsheets/d/14u4Hl3Uluvk45ABIcgKGltX8EpBdGj1JvF_kEtZwmEE/edit#gid=120566427#">🔽 Dropdowns Tab</option>
        <option value="https://docs.google.com/spreadsheets/d/14u4Hl3Uluvk45ABIcgKGltX8EpBdGj1JvF_kEtZwmEE/edit#gid=1142609309#">🏷️ Roles Tab</option>
    </select>
    </div>
</div>


            <div id="contacts-tab" class="tab-content active">
                <div class="action-bar">
                    <button class="btn-primary" onclick="showAddResident()">
                        ➕ Add New Contact
                    </button>
                    <button class="btn-primary" onclick="loadContacts()">
                        📊 Load Contact Data
                    </button>
                    <button class="btn-success" onclick="testBackendConnection()">
                        🧪 Test Backend Connection
                    </button>
                    <button class="btn-warning" onclick="showMessage('Export functionality ready')">
                        📤 Export Data
                    </button>
                </div>

                <div class="filters">
                    <input type="text" class="search-box" placeholder="Search contacts..." onkeyup="filterContacts()" />
                    <select class="filter-select" onchange="filterContacts()">
                        <option value="">All Stages</option>
                        <option value="Stage 1">Stage 1</option>
                        <option value="Stage 2">Stage 2</option>
                    </select>
                    <select class="filter-select" onchange="filterContacts()">
                        <option value="">All Roles</option>
                        <option value="Directors">Directors</option>
                        <option value="Zone Reps">Zone Reps</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Unit</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Zone</th>
                                <th>Stage</th>
                                <th>Roles</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contactsTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    🔧 <strong>Click "Load Contact Data" to connect to V1.2 backend</strong><br>
                                    Now with Dropdown Management capabilities
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="dropdowns-tab" class="tab-content">
    <div class="action-bar">
        <button class="btn-primary" onclick="loadDropdowns()">
            🔄 Load Dropdown Data
        </button>
        <button class="btn-success" onclick="testDropdownConnection()">
            🧪 Test Dropdown API
        </button>
        
    </div>

    

    <div class="dropdown-management" style="grid-template-columns: 1fr 1fr 1fr;">
        <!-- Categories Section -->
        <div class="dropdown-section">
            <div class="dropdown-section-header">
                <h3>Categories</h3>
            </div>
            <div class="dropdown-list" id="categoriesList">
                <!-- Categories will be loaded here -->
            </div>
            <div class="dropdown-form">
                <input type="text" id="newCategoryInput" placeholder="New category name">
                <button onclick="addCategory()">Add</button>
            </div>
        </div>

        <!-- Sub-Categories Section -->
        <div class="dropdown-section">
            <div class="dropdown-section-header">
                <h3>Sub-Categories</h3>
                <select id="categorySelector" onchange="loadSubCategories()">
                    <option value="">Select a category</option>
                    <!-- Categories will be populated here -->
                </select>
            </div>
            <div class="dropdown-list" id="subCategoriesList">
                <!-- Sub-categories will be loaded here -->
            </div>
            <div class="dropdown-form">
                <input type="text" id="newSubCategoryInput" placeholder="New sub-category name">
                <button onclick="addSubCategory()">Add</button>
            </div>
        </div>

        <!-- NEW: Assigned By Section -->
        <div class="dropdown-section">
            <div class="dropdown-section-header">
                <h3>Assigned By</h3>
            </div>
            <div class="dropdown-list" id="assignedByList">
                <!-- Assigned By will be loaded here -->
            </div>
            <div class="dropdown-form">
                <input type="text" id="newAssignedByInput" placeholder="New assigned by">
                <button onclick="addAssignedBy()">Add</button>
            </div>
        </div>
    </div>
</div>



            <div id="users-tab" class="tab-content">
                <div class="action-bar">
                    <button class="btn-primary" id="add-user-btn">➕ Add New User</button>
                    <button class="btn-success" id="test-users-btn">🧪 Test User Accounts API</button>
                    <button class="btn-warning" id="load-users-btn">👥 Load User Accounts</button>
                </div>
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    👥 <strong>User Accounts - STEP 2</strong><br>
                    Will be integrated AFTER CRUD is working
                </div>
            </div>

            <div id="roles-tab" class="tab-content">
    <div class="action-bar">
        <button class="btn-primary" onclick="loadRoles()">
            🔄 Load Roles
        </button>
        <button class="btn-success" onclick="testRolesConnection()">
            🧪 Test Roles API
        </button>
    </div>

    <!-- Add this roles management section -->
    <div class="dropdown-management" style="grid-template-columns: 1fr;">
        <div class="dropdown-section">
            <div class="dropdown-section-header">
                <h3>🏷️ System Roles</h3>
            </div>
            <div class="dropdown-list" id="rolesList">
                <!-- Roles will be loaded here -->
            </div>
            <div class="dropdown-form">
                <input type="text" id="newRoleInput" placeholder="New role name">
                <button onclick="addRole()">Add</button>
            </div>
        </div>
    </div>

    <!-- Keep the Multi-Role Management button but maybe move it -->
    <div class="action-bar" style="margin-top: 30px;">
        <button class="btn-warning" id="multi-role-btn">
            📋 Multi-Role Management (Legacy)
        </button>
    </div>
</div>

            <div id="sync-tab" class="tab-content">
                <div class="action-bar">
                    <button class="btn-primary" id="sync-ranges-btn">🔄 Test Named Range Sync</button>
                    <button class="btn-success" id="test-integration-btn">🧪 Test Full Integration</button>
                </div>
                <div style="text-align: center; padding: 60px; color: var(--text-muted);">
                    🔄 <strong>System Integration - STEP 4</strong><br>
                    Final step after all components working
                </div>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="residentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">➕ Add New Contact</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="residentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Unit Number</label>
                            <input type="text" class="form-input" id="unitNumber">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Resident Name</label>
                            <input type="text" class="form-input" id="residentName">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="email">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-input" id="phone">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Zone</label>
                            <select class="form-select" id="zone">
                                <option value="">Select Zone</option>
                                <option value="Zone 1">Zone 1</option>
                                <option value="Zone 2">Zone 2</option>
                                <option value="Zone 3">Zone 3</option>
                                <option value="Zone 4">Zone 4</option>
                                <option value="Zone 5">Zone 5</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Stage</label>
                            <select class="form-select" id="stage">
                                <option value="Stage 1">Stage 1</option>
                                <option value="Stage 2">Stage 2</option>
                            </select>
                        </div>
                        
                        <div class="form-group full-width">
                            <label class="form-label">Community Roles *</label>
                            <div class="role-grid">
                                <label class="role-option">
                                    <input type="checkbox" name="roles" value="Resident" checked>
                                    <span>Resident</span>
                                </label>
                                <label class="role-option">
                                    <input type="checkbox" name="roles" value="Director">
                                    <span>Director</span>
                                </label>
                                <label class="role-option">
                                    <input type="checkbox" name="roles" value="Management">
                                    <span>Management</span>
                                </label>
                                <label class="role-option">
                                    <input type="checkbox" name="roles" value="Residents-Committee">
                                    <span>Residents Committee</span>
                                </label>
                                <label class="role-option">
                                    <input type="checkbox" name="roles" value="Social-Committee">
                                    <span>Social Committee</span>
                                </label>
                                <label class="role-option">
                                    <input type="checkbox" name="roles" value="Chairperson">
                                    <span>Chairperson</span>
                                </label>
                                <label class="role-option">
                                    <input type="checkbox" name="roles" value="Treasurer">
                                    <span>Treasurer</span>
                                </label>
                                <label class="role-option">
                                    <input type="checkbox" name="roles" value="Secretary">
                                    <span>Secretary</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" onclick="closeModal()" style="background: var(--text-muted); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    Cancel
                </button>
                <button type="button" onclick="saveResident()" class="btn-success">
                    💾 Save Contact
                </button>
            </div>
        </div>
    </div>

    <script>





    // Configuration - CHANGED TO V1.x.x BACKEND
    const API_URL = 'https://script.google.com/macros/s/AKfycbzVF25ss7kEmhE42Sf-i_vpLIL1FpTe2AjNeb0b8MqP_eBXAxV9ghWcuwe25hdEuqBFjw/exec';

    let contactsData = [];
    let categoriesData = [];
    let subCategoriesData = [];
    let assignedByData = [];
    let sheetsCreated = false;
    let currentEditResident = null;


    // JSONP API call function - UNCHANGED
    function makeAPICall(action, params = {}) {
        return new Promise((resolve, reject) => {
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            const script = document.createElement('script');
            const queryParams = new URLSearchParams({ action, callback: callbackName, ...params });
            
            script.src = API_URL + '?' + queryParams.toString();
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                resolve(response);
            };
            
            script.onerror = function() {
                document.head.removeChild(script);
                delete window[callbackName];
                reject(new Error('Network request failed'));
            };
            
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (window[callbackName]) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('Request timeout'));
                }
            }, 15000);
        });
    }

   
    async function loadContacts() {
        try {
            showToast('Loading contacts from V1.1 backend...', 'info');
            
            // CHANGED: getUnitListData instead of getAllContacts
            const response = await makeAPICall('getUnitListData');
            
            if (response.success) {
                // CHANGED: response.residents instead of response.contacts
                contactsData = response.residents || [];
                displayContacts(contactsData);
                showToast(`✅ Loaded ${contactsData.length} contacts from V1.1 backend`, 'success');
            } else {
                throw new Error(response.error || 'Failed to load contacts');
            }
        } catch (error) {
            console.error('Load contacts error:', error);
            showToast('❌ Failed to load contacts: ' + error.message, 'error');
        }
    }

    async function testBackendConnection() {
        try {
            showToast('Testing V1.1 backend connection...', 'info');
            
            const response = await makeAPICall('testConnection');
            
            if (response.success) {
                showToast(`✅ V1.1 Backend connected: ${response.message}`, 'success');
                console.log('Backend info:', response);
            } else {
                throw new Error(response.error || 'Connection failed');
            }
        } catch (error) {
            console.error('Connection test error:', error);
            showToast('❌ Backend connection failed: ' + error.message, 'error');
        }
    }

    // Display functions - MINIMAL CHANGES
    function displayContacts(contacts) {
        const tableBody = document.getElementById('contactsTableBody');
        
        if (!contacts || contacts.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">No contacts found</td></tr>';
            return;
        }

        tableBody.innerHTML = contacts.map(contact => `
            <tr>
                <td>${contact.unitNumber || ''}</td>
                <td>${contact.residentName || ''}</td>

                <td>
  ${contact.email ? `<a href="mailto:${contact.email}" class="action-link">${contact.email}</a>` : ''}
</td>
<td>
  ${contact.phone ? `<a href="tel:${contact.phone}" class="action-link">${contact.phone}</a>` : ''}
</td>


                <td>${contact.zone || ''}</td>
                <td>${contact.stage || ''}</td>
                <td>${contact.roleTags || ''}</td>
                <td>
                    <button class="btn-primary" style="padding: 6px 12px; font-size: 0.85rem; margin-right: 8px;" onclick="editResident(${contact.rowIndex})">✏️ Edit</button>
                    <button class="btn-warning" style="padding: 6px 12px; font-size: 0.85rem;" onclick="deleteResident(${contact.rowIndex})">🗑️ Delete</button>
                </td>
            </tr>
        `).join('');
    }

    // WORKING V1.1 CRUD functions - extracted from working file
    async function showAddResident() {
        console.log('Opening Add Resident Modal...');
        
        // Load available roles from backend
        const availableRoles = await loadAvailableRoles();
        
        currentEditResident = null;
        document.getElementById('residentForm').reset();
        
        // UPDATE THE ROLE-GRID DIV WITH DYNAMIC ROLES
        const roleGrid = document.querySelector('.role-grid');
        if (roleGrid) {
            roleGrid.innerHTML = buildRoleCheckboxesHTML(availableRoles);
        }
        
        // Update modal title
        document.querySelector('.modal-title').innerHTML = '➕ Add New Contact';
        
        document.getElementById('residentModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('residentModal').classList.remove('show');
        currentEditResident = null;
    }

    function getSelectedRoles() {
        return Array.from(document.querySelectorAll('input[name="roles"]:checked'))
            .map(checkbox => checkbox.value);
    }

    async function saveResident() {
        const selectedRoles = getSelectedRoles();
        if (selectedRoles.length === 0) {
            showToast('Please select at least one role', 'warning');
            return;
        }
        
        const formData = {
            unitNumber: document.getElementById('unitNumber').value,
            residentName: document.getElementById('residentName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            zone: document.getElementById('zone').value,
            stage: document.getElementById('stage').value,
            roleTags: selectedRoles.join(', ')
        };

        // Basic validation - only check for required fields, no duplicate checking
        if (!formData.residentName) {
            showToast('Resident Name is required', 'warning');
            return;
        }

        try {
            if (currentEditResident) {
                formData.rowIndex = currentEditResident.rowIndex;
                showToast('Updating resident...', 'info');
                const response = await makeAPICall('updateResident', formData);
                if (response.success) {
                    showToast(response.message || 'Resident updated successfully', 'success');
                    closeModal();
                    loadContacts();
                } else {
                    throw new Error(response.error || 'Failed to update resident');
                }
            } else {
                showToast('Adding new resident...', 'info');
                const response = await makeAPICall('addResident', formData);
                if (response.success) {
                    showToast(response.message || 'Resident added successfully', 'success');
                    closeModal();
                    loadContacts();
                } else {
                    throw new Error(response.error || 'Failed to add resident');
                }
            }
        } catch (error) {
            console.error('Save error:', error);
            showToast('❌ Save failed: ' + error.message, 'error');
        }
    }

    async function editResident(rowIndex) {
        console.log('Opening Edit Resident Modal for rowIndex:', rowIndex);
        
        // Load available roles from backend
        const availableRoles = await loadAvailableRoles();
        
        const resident = contactsData.find(r => r.rowIndex === rowIndex);
        if (resident) {
            currentEditResident = resident;
            
            // Populate form with existing data (same as your current code)
            document.getElementById('unitNumber').value = resident.unitNumber || '';
            document.getElementById('residentName').value = resident.residentName || '';
            document.getElementById('email').value = resident.email || '';
            document.getElementById('phone').value = resident.phone || '';
            document.getElementById('zone').value = resident.zone || '';
            document.getElementById('stage').value = resident.stage || 'Stage 1';
            
            // Parse existing roles (same as your current code)
            const roles = (resident.roleTags || '').split(',').map(r => r.trim());
            
            // UPDATE THE ROLE-GRID DIV WITH DYNAMIC ROLES AND EXISTING SELECTIONS
            const roleGrid = document.querySelector('.role-grid');
            if (roleGrid) {
                roleGrid.innerHTML = buildRoleCheckboxesHTML(availableRoles, roles);
            }
            
            // Update modal title
            document.querySelector('.modal-title').innerHTML = '✏️ Edit Contact';
            
            document.getElementById('residentModal').classList.add('show');
        }
    }

    async function deleteResident(rowIndex) {
        const resident = contactsData.find(r => r.rowIndex === rowIndex);
        if (resident) {
            if (confirm(`Delete ${resident.residentName}?`)) {
                try {
                    showToast('Deleting resident...', 'info');
                    const response = await makeAPICall('deleteResident', { rowIndex: rowIndex });
                    if (response.success) {
                        showToast(response.message || 'Resident deleted successfully', 'success');
                        loadContacts(); // Reload to show changes
                    } else {
                        throw new Error(response.error || 'Failed to delete resident');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    showToast('❌ Delete failed: ' + error.message, 'error');
                }
            }
        }
    }

    // Filter function - UNCHANGED
    function filterContacts() {
        const searchTerm = document.querySelector('.search-box').value.toLowerCase();
        const stageFilter = document.querySelectorAll('.filter-select')[0].value;
        const roleFilter = document.querySelectorAll('.filter-select')[1].value;

        let filtered = contactsData;

        if (searchTerm) {
            filtered = filtered.filter(contact => 
                (contact.residentName || '').toLowerCase().includes(searchTerm) ||
                (contact.unitNumber || '').toLowerCase().includes(searchTerm) ||
                (contact.email || '').toLowerCase().includes(searchTerm)
            );
        }

        if (stageFilter) {
            filtered = filtered.filter(contact => contact.stage === stageFilter);
        }

        if (roleFilter) {
            filtered = filtered.filter(contact => 
                (contact.roleTags || '').includes(roleFilter)
            );
        }

        displayContacts(filtered);
    }

    // Utility functions - UNCHANGED
    function showTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active from all tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabName + '-tab').classList.add('active');
        
        // Add active to selected tab
        event.target.classList.add('active');
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    }

    function showMessage(message) {
        showToast(message, 'info');
    }

    // ==========================================
    // CORRECT UPDATES FOR YOUR simple_frontend_v11_connected.html
    // Based on actual code structure you provided
    // ==========================================

    // 1. ADD THIS FUNCTION TO LOAD ROLES FROM BACKEND (WITH CACHING)
    let cachedRoles = null;

    async function loadAvailableRoles() {
        if (cachedRoles) {
            console.log('Using cached roles:', cachedRoles);
            return cachedRoles;
        }
        
        console.log('Loading available roles from Roles TAB...');
        
        try {
            const response = await makeAPICall('getRoles', {});
            
            if (response.success) {
                console.log(`Loaded ${response.roles.length} roles:`, response.roles);
                cachedRoles = response.roles; // Cache the result
                return response.roles;
            } else {
                console.error('Failed to load roles:', response.error);
                return ['Resident', 'Director', 'Management', 'Residents-Committee', 'Social-Committee', 'Chairperson', 'Treasurer', 'Secretary'];
            }
        } catch (error) {
            console.error('Error loading roles:', error);
            return ['Resident', 'Director', 'Management', 'Residents-Committee', 'Social-Committee', 'Chairperson', 'Treasurer', 'Secretary'];
        }
    }

    // 2. ADD THIS FUNCTION TO BUILD ROLE CHECKBOXES (MATCHES YOUR EXACT HTML STRUCTURE)
    function buildRoleCheckboxesHTML(availableRoles, selectedRoles = []) {
        console.log('Building role checkboxes for:', availableRoles.length, 'roles');
        
        let checkboxesHTML = '';
        
        availableRoles.forEach(role => {
            const isChecked = selectedRoles.includes(role) || (role === 'Resident' && selectedRoles.length === 0);
            const checkedAttr = isChecked ? 'checked' : '';
            
            checkboxesHTML += `
                <label class="role-option">
                    <input type="checkbox" name="roles" value="${role}" ${checkedAttr}>
                    <span>${role}</span>
                </label>
            `;
        });
        
        return checkboxesHTML;
    }

    // ==========================================
    // DROPDOWN MANAGEMENT FUNCTIONS
    // ==========================================

    // EXISTING DISPLAY FUNCTIONS (UPDATED WITH FIXED DELETE CALLS)
    function displayCategories() {
        const categoriesList = document.getElementById('categoriesList');
        
        if (!categoriesData || categoriesData.length === 0) {
            categoriesList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No categories found</div>';
            return;
        }

        categoriesList.innerHTML = categoriesData.map(category => `
            <div class="dropdown-item">
                <span>${category.name}</span>
                <div class="dropdown-item-actions">
                    <button style="background: var(--warning-amber);" onclick="editCategory(${category.id}, '${category.name.replace(/'/g, "\\'")}')">Edit</button>
                    <button style="background: var(--error-red);" onclick="deleteCategoryFrontend(${category.id})">Delete</button>
                </div>
            </div>
        `).join('');
    }

    function displaySubCategories() {
        const subCategoriesList = document.getElementById('subCategoriesList');
        const selectedCategoryId = document.getElementById('categorySelector').value;
        
        const filteredSubCategories = selectedCategoryId 
            ? subCategoriesData.filter(sub => sub.categoryId == selectedCategoryId)
            : subCategoriesData;
        
        if (!filteredSubCategories || filteredSubCategories.length === 0) {
            subCategoriesList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No sub-categories found</div>';
            return;
        }

        subCategoriesList.innerHTML = filteredSubCategories.map(subCategory => `
            <div class="dropdown-item subcategory-item">
                <span>${subCategory.name}</span>
                <div class="dropdown-item-actions">
                    <button style="background: var(--warning-amber);" onclick="editSubCategory(${subCategory.id}, '${subCategory.name.replace(/'/g, "\\'")}', ${subCategory.categoryId})">Edit</button>
                    <button style="background: var(--error-red);" onclick="deleteSubCategoryFrontend(${subCategory.id})">Delete</button>
                </div>
            </div>
        `).join('');
    }

    function populateCategorySelector() {
        const categorySelector = document.getElementById('categorySelector');
        
        while (categorySelector.options.length > 1) {
            categorySelector.remove(1);
        }
        
        categoriesData.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            categorySelector.appendChild(option);
        });
    }

    function loadSubCategories() {
        displaySubCategories();
    }

    // NEW CRUD FUNCTIONS FOR DROPDOWNS


    async function loadDropdowns() {
    try {
        showToast('Loading all dropdown data...', 'info');
        
        // Load categories
        const categoriesResponse = await makeAPICall('getCategories');
        if (categoriesResponse.success) {
            categoriesData = categoriesResponse.categories || [];
            displayCategories();
            populateCategorySelector();
        } else {
            throw new Error(categoriesResponse.error || 'Failed to load categories');
        }
        
        // Load sub-categories
        const subCategoriesResponse = await makeAPICall('getSubCategories');
        if (subCategoriesResponse.success) {
            subCategoriesData = subCategoriesResponse.subCategories || [];
            displaySubCategories();
        } else {
            throw new Error(subCategoriesResponse.error || 'Failed to load sub-categories');
        }
        
        // Load assigned by
        const assignedByResponse = await makeAPICall('getAssignedBy');
        if (assignedByResponse.success) {
            assignedByData = assignedByResponse.assignedBy || [];
            displayAssignedBy();
        } else {
            throw new Error(assignedByResponse.error || 'Failed to load assigned by');
        }
        
        showToast('✅ All dropdown data loaded successfully', 'success');
        
    } catch (error) {
        console.error('Load dropdowns error:', error);
        showToast('❌ Failed to load dropdown data: ' + error.message, 'error');
    }
}


    async function addCategory() {
        const categoryName = document.getElementById('newCategoryInput').value.trim();
        
        if (!categoryName) {
            showToast('Please enter a category name', 'warning');
            return;
        }
        
        try {
            showToast('Adding category...', 'info');
            const response = await makeAPICall('addCategory', { category: categoryName });
            
            if (response.success) {
                showToast(response.message || 'Category added successfully', 'success');
                document.getElementById('newCategoryInput').value = '';
                await loadDropdowns();
            } else {
                throw new Error(response.error || 'Failed to add category');
            }
        } catch (error) {
            console.error('Add category error:', error);
            showToast('❌ Failed to add category: ' + error.message, 'error');
        }
    }

    async function addSubCategory() {
        const subCategoryName = document.getElementById('newSubCategoryInput').value.trim();
        
        if (!subCategoryName) {
            showToast('Please enter a sub-category name', 'warning');
            return;
        }
        
        try {
            showToast('Adding sub-category...', 'info');
            const response = await makeAPICall('addSubCategory', { subCategory: subCategoryName });
            
            if (response.success) {
                showToast(response.message || 'Sub-category added successfully', 'success');
                document.getElementById('newSubCategoryInput').value = '';
                await loadDropdowns();
            } else {
                throw new Error(response.error || 'Failed to add sub-category');
            }
        } catch (error) {
            console.error('Add sub-category error:', error);
            showToast('❌ Failed to add sub-category: ' + error.message, 'error');
        }
    }

    async function editCategory(id, currentName) {
        const newName = prompt('Edit category name:', currentName);
        
        if (newName === null) return;
        if (!newName.trim()) {
            showToast('Category name cannot be empty', 'warning');
            return;
        }
        
        try {
            showToast('Updating category...', 'info');
            const response = await makeAPICall('updateCategory', { id: id, name: newName });
            
            if (response.success) {
                showToast(response.message || 'Category updated successfully', 'success');
                await loadDropdowns();
            } else {
                throw new Error(response.error || 'Failed to update category');
            }
        } catch (error) {
            console.error('Update category error:', error);
            showToast('❌ Failed to update category: ' + error.message, 'error');
        }
    }

    async function editSubCategory(id, currentName, categoryId) {
        const newName = prompt('Edit sub-category name:', currentName);
        
        if (newName === null) return;
        if (!newName.trim()) {
            showToast('Sub-category name cannot be empty', 'warning');
            return;
        }
        
        try {
            showToast('Updating sub-category...', 'info');
            const response = await makeAPICall('updateSubCategory', { id: id, name: newName });
            
            if (response.success) {
                showToast(response.message || 'Sub-category updated successfully', 'success');
                await loadDropdowns();
            } else {
                throw new Error(response.error || 'Failed to update sub-category');
            }
        } catch (error) {
            console.error('Update sub-category error:', error);
            showToast('❌ Failed to update sub-category: ' + error.message, 'error');
        }
    }





// ================== CORRECTED DELETE FUNCTIONS ==================
async function deleteCategoryFrontend(categoryId) {
    console.log('Delete category called with:', categoryId, typeof categoryId);
    
    // Check if categoryId is undefined or invalid
    if (!categoryId || categoryId === 'undefined' || categoryId === 'null') {
        showToast('Error: No valid category ID provided', 'error');
        console.error('Invalid category ID:', categoryId);
        return;
    }
    
    // Convert to integer if it's a string
    const idToSend = typeof categoryId === 'string' ? parseInt(categoryId) : categoryId;
    
    // Check if conversion resulted in a valid number
    if (isNaN(idToSend)) {
        showToast('Error: Invalid category ID format', 'error');
        console.error('Category ID is not a number:', categoryId);
        return;
    }
    
    // Find the category name for confirmation message
    const category = categoriesData.find(cat => cat.id == idToSend);
    const categoryName = category ? category.name : 'this category';
    
    if (!confirm(`Are you sure you want to delete "${categoryName}"?`)) return;
    
    try {
        showToast('Deleting category...', 'info');
        console.log('Sending to backend - categoryId:', idToSend);
        
        const response = await makeAPICall('deleteCategory', { categoryId: idToSend });
        
        if (response.success) {
            showToast(response.message || 'Category deleted successfully', 'success');
            loadDropdowns(); // Reload to show changes
        } else {
            throw new Error(response.error || 'Failed to delete category');
        }
    } catch (error) {
        console.error('Delete category error:', error);
        showToast('❌ Failed to delete category: ' + error.message, 'error');
    }
}

async function deleteSubCategoryFrontend(subCategoryId) {
    console.log('Delete subcategory called with:', subCategoryId, typeof subCategoryId);
    
    // Check if subCategoryId is undefined or invalid
    if (!subCategoryId || subCategoryId === 'undefined' || subCategoryId === 'null') {
        showToast('Error: No valid subcategory ID provided', 'error');
        console.error('Invalid subcategory ID:', subCategoryId);
        return;
    }
    
    // Convert to integer if it's a string
    const idToSend = typeof subCategoryId === 'string' ? parseInt(subCategoryId) : subCategoryId;
    
    // Check if conversion resulted in a valid number
    if (isNaN(idToSend)) {
        showToast('Error: Invalid subcategory ID format', 'error');
        console.error('Subcategory ID is not a number:', subCategoryId);
        return;
    }
    
    // Find the subcategory name for confirmation message
    const subCategory = subCategoriesData.find(sub => sub.id == idToSend);
    const subCategoryName = subCategory ? subCategory.name : 'this sub-category';
    
    if (!confirm(`Are you sure you want to delete "${subCategoryName}"?`)) return;
    
    try {
        showToast('Deleting sub-category...', 'info');
        console.log('Sending to backend - subCategoryId:', idToSend);
        
        const response = await makeAPICall('deleteSubCategory', { subCategoryId: idToSend });
        
        if (response.success) {
            showToast(response.message || 'Sub-category deleted successfully', 'success');
            loadDropdowns(); // Reload to show changes
        } else {
            throw new Error(response.error || 'Failed to delete sub-category');
        }
    } catch (error) {
        console.error('Delete sub-category error:', error);
        showToast('❌ Failed to delete sub-category: ' + error.message, 'error');
    }
}

// ================== DEBUGGING FUNCTION ==================
// Add this function to help debug the HTML generation
function debugCategoryDeletion() {
    console.log('Categories data:', categoriesData);
    console.log('Subcategories data:', subCategoriesData);
    
    // Check if the display functions are working correctly
    const categoriesList = document.getElementById('categoriesList');
    const subCategoriesList = document.getElementById('subCategoriesList');
    
    console.log('Categories list HTML:', categoriesList.innerHTML);
    console.log('Subcategories list HTML:', subCategoriesList.innerHTML);
}
// ================== END OF CORRECTED FUNCTIONS ==================





async function editCategory(id, currentName) {
    const newName = prompt('Edit category name:', currentName);
    if (newName === null) return;
    
    try {
        showToast('Updating category...', 'info');
        const response = await makeAPICall('updateCategory', { id: id, name: newName });
        
        if (response.success) {
            showToast('Category updated successfully', 'success');
            loadDropdowns();
        } else {
            throw new Error(response.error || 'Failed to update category');
        }
    } catch (error) {
        console.error('Update category error:', error);
        showToast('❌ Failed to update category: ' + error.message, 'error');
    }
}

async function editSubCategory(id, currentName, categoryId) {
    const newName = prompt('Edit sub-category name:', currentName);
    if (newName === null) return;
    
    try {
        showToast('Updating sub-category...', 'info');
        const response = await makeAPICall('updateSubCategory', { id: id, name: newName });
        
        if (response.success) {
            showToast('Sub-category updated successfully', 'success');
            loadDropdowns();
        } else {
            throw new Error(response.error || 'Failed to update sub-category');
        }
    } catch (error) {
        console.error('Update sub-category error:', error);
        showToast('❌ Failed to update sub-category: ' + error.message, 'error');
    }
}
// ================== END OF MISSING FUNCTIONS ==================



// ================== ASSIGNED BY FUNCTIONS =================
async function addAssignedBy() {
    const assignedByName = document.getElementById('newAssignedByInput').value.trim();
    
    if (!assignedByName) {
        showToast('Please enter an assigned by name', 'warning');
        return;
    }
    
    try {
        showToast('Adding assigned by...', 'info');
        const response = await makeAPICall('addAssignedBy', { assignedBy: assignedByName });
        
        if (response.success) {
            showToast(response.message || 'Assigned by added successfully', 'success');
            document.getElementById('newAssignedByInput').value = '';
            await loadAssignedBy(); // Reload to show the new entry
        } else {
            throw new Error(response.error || 'Failed to add assigned by');
        }
    } catch (error) {
        console.error('Add assigned by error:', error);
        showToast('❌ Failed to add assigned by: ' + error.message, 'error');
    }
}

async function loadAssignedBy() {
    try {
        const response = await makeAPICall('getAssignedBy');
        if (response.success) {
            assignedByData = response.assignedBy || [];
            displayAssignedBy();
        } else {
            throw new Error(response.error || 'Failed to load assigned by');
        }
    } catch (error) {
        console.error('Load assigned by error:', error);
        showToast('❌ Failed to load assigned by: ' + error.message, 'error');
    }
}

function displayAssignedBy() {
    const assignedByList = document.getElementById('assignedByList');
    
    if (!assignedByData || assignedByData.length === 0) {
        assignedByList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No assigned by entries found</div>';
        return;
    }

    assignedByList.innerHTML = assignedByData.map(item => `
        <div class="dropdown-item">
            <span>${item.name}</span>
            <div class="dropdown-item-actions">
                <button style="background: var(--warning-amber);" onclick="editAssignedBy(${item.id}, '${item.name.replace(/'/g, "\\'")}')">Edit</button>
                <button style="background: var(--error-red);" onclick="deleteAssignedByFrontend(${item.id})">Delete</button>
            </div>
        </div>
    `).join('');
}

async function deleteAssignedByFrontend(assignedById) {
    console.log('Delete assigned by called with:', assignedById, typeof assignedById);
    
    // Check if assignedById is undefined or invalid
    if (!assignedById || assignedById === 'undefined' || assignedById === 'null') {
        showToast('Error: No valid assigned by ID provided', 'error');
        console.error('Invalid assigned by ID:', assignedById);
        return;
    }
    
    // Convert to integer if it's a string
    const idToSend = typeof assignedById === 'string' ? parseInt(assignedById) : assignedById;
    
    // Check if conversion resulted in a valid number
    if (isNaN(idToSend)) {
        showToast('Error: Invalid assigned by ID format', 'error');
        console.error('Assigned by ID is not a number:', assignedById);
        return;
    }
    
    // Find the assigned by name for confirmation message
    const assignedByItem = assignedByData.find(item => item.id == idToSend);
    const assignedByName = assignedByItem ? assignedByItem.name : 'this assigned by entry';
    
    if (!confirm(`Are you sure you want to delete "${assignedByName}"?`)) return;
    
    try {
        showToast('Deleting assigned by...', 'info');
        console.log('Sending to backend - assignedById:', idToSend);
        
        const response = await makeAPICall('deleteAssignedBy', { assignedById: idToSend });
        
        if (response.success) {
            showToast(response.message || 'Assigned by deleted successfully', 'success');
            await loadAssignedBy(); // Reload to show changes
        } else {
            throw new Error(response.error || 'Failed to delete assigned by');
        }
    } catch (error) {
        console.error('Delete assigned by error:', error);
        showToast('❌ Failed to delete assigned by: ' + error.message, 'error');
    }
}

async function editAssignedBy(id, currentName) {
    const newName = prompt('Edit assigned by name:', currentName);
    
    if (newName === null) return;
    if (!newName.trim()) {
        showToast('Assigned by name cannot be empty', 'warning');
        return;
    }
    
    try {
        showToast('Updating assigned by...', 'info');
        const response = await makeAPICall('updateAssignedBy', { id: id, name: newName });
        
        if (response.success) {
            showToast(response.message || 'Assigned by updated successfully', 'success');
            await loadAssignedBy();
        } else {
            throw new Error(response.error || 'Failed to update assigned by');
        }
    } catch (error) {
        console.error('Update assigned by error:', error);
        showToast('❌ Failed to update assigned by: ' + error.message, 'error');
    }
}




// ================== END ASSIGNED BY FUNCTIONS =================


// start roles

let rolesData = [];

async function loadRoles() {
    try {
        showToast('Loading roles...', 'info');
        const response = await makeAPICall('getRoles');
        
        if (response.success) {
            rolesData = response.roles || [];
            displayRoles();
            showToast(`✅ Loaded ${rolesData.length} roles`, 'success');
        } else {
            throw new Error(response.error || 'Failed to load roles');
        }
    } catch (error) {
        console.error('Load roles error:', error);
        showToast('❌ Failed to load roles: ' + error.message, 'error');
    }
}

function displayRoles() {
    const rolesList = document.getElementById('rolesList');
    
    if (!rolesData || rolesData.length === 0) {
        rolesList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No roles found</div>';
        return;
    }

    rolesList.innerHTML = rolesData.map(role => `
        <div class="dropdown-item">
            <span>${role.name}</span>
            <div class="dropdown-item-actions">
                <button style="background: var(--warning-amber);" onclick="editRole(${role.id}, '${role.name.replace(/'/g, "\\'")}')">Edit</button>
                <button style="background: var(--error-red);" onclick="deleteRoleFrontend(${role.id})">Delete</button>
            </div>
        </div>
    `).join('');
}

async function addRole() {
    const roleName = document.getElementById('newRoleInput').value.trim();
    
    if (!roleName) {
        showToast('Please enter a role name', 'warning');
        return;
    }
    
    try {
        showToast('Adding role...', 'info');
        const response = await makeAPICall('addRole', { role: roleName });
        
        if (response.success) {
            showToast(response.message || 'Role added successfully', 'success');
            document.getElementById('newRoleInput').value = '';
            await loadRoles();
        } else {
            throw new Error(response.error || 'Failed to add role');
        }
    } catch (error) {
        console.error('Add role error:', error);
        showToast('❌ Failed to add role: ' + error.message, 'error');
    }
}

async function deleteRoleFrontend(roleId) {
    // Similar to your deleteAssignedByFrontend pattern
    const role = rolesData.find(r => r.id == roleId);
    if (!role) return;
    
    if (!confirm(`Delete role "${role.name}"?`)) return;
    
    try {
        showToast('Deleting role...', 'info');
        const response = await makeAPICall('deleteRole', { roleId: roleId });
        
        if (response.success) {
            showToast(response.message || 'Role deleted successfully', 'success');
            await loadRoles();
        } else {
            throw new Error(response.error || 'Failed to delete role');
        }
    } catch (error) {
        console.error('Delete role error:', error);
        showToast('❌ Failed to delete role: ' + error.message, 'error');
    }
}

async function editRole(id, currentName) {
    const newName = prompt('Edit role name:', currentName);
    if (!newName || newName.trim() === '') return;
    
    try {
        showToast('Updating role...', 'info');
        const response = await makeAPICall('updateRole', { id: id, name: newName.trim() });
        
        if (response.success) {
            showToast('Role updated successfully', 'success');
            await loadRoles();
        } else {
            throw new Error(response.error || 'Failed to update role');
        }
    } catch (error) {
        console.error('Update role error:', error);
        showToast('❌ Failed to update role: ' + error.message, 'error');
    }
}

function testRolesConnection() {
    testDropdownConnection(); // Reuse existing function or create specific one
}

// end Roles 

function navigateToTab(url) {
    if (url) {
        window.open(url, '_blank'); // Opens in new tab
        // Reset the dropdown to default option
        event.target.value = '';
    }
}



async function testDropdownConnection() {
        try {
            showToast('Testing dropdown API connection...', 'info');
            
            const response = await makeAPICall('testDropdownConnection');
            
            if (response.success) {
                showToast(`✅ Dropdown API connected: ${response.message}`, 'success');
                console.log('Dropdown API info:', response);
            } else {
                throw new Error(response.error || 'Dropdown connection failed');
            }
        } catch (error) {
            console.error('Dropdown connection test error:', error);
            showToast('❌ Dropdown API connection failed: ' + error.message, 'error');
        }
    }

async function loadSheetLinks() {
    try {
        const response = await makeAPICall('getSheetGIDs');
        if (response.success) {
            const navigationDropdown = document.querySelector('.filter-select[onchange*="navigateToTab"]');
            if (navigationDropdown) {
                // Clear existing options except the first one
                while (navigationDropdown.options.length > 1) {
                    navigationDropdown.remove(1);
                }
                
                // Add sheets to dropdown
                response.sheets.forEach(sheet => {
                    const option = document.createElement('option');
                    option.value = sheet.url;
                    option.textContent = `📄 ${sheet.name}`;
                    navigationDropdown.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.log('Could not load dynamic sheet links, using static ones');
    }
}

// Call this on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSheetLinks();
});

function navigateToTab(url) {
    if (url) {
        // Open in current tab instead of new tab
        window.location.href = url;
        // Note: This will navigate away from your app
    }
}
    
    // Initialize - SIMPLE SETUP
    document.addEventListener('DOMContentLoaded', function() {
        // User buttons - DISABLED FOR NOW
        document.getElementById('add-user-btn').addEventListener('click', () => showToast('User functionality - STEP 2', 'warning'));
        document.getElementById('test-users-btn').addEventListener('click', () => showToast('User testing - STEP 2', 'warning'));
        document.getElementById('load-users-btn').addEventListener('click', () => showToast('User loading - STEP 2', 'warning'));
        
        // Role buttons 
        // Change the existing event listener to use your new function
document.getElementById('assign-roles-btn').addEventListener('click', () => {
    loadRoles(); // Now calls your new loadRoles function instead of showing toast
});
        document.getElementById('multi-role-btn').addEventListener('click', () => showToast('Multi-role support - Under review', 'warning'));
        
        // Sync buttons - DISABLED FOR NOW
        document.getElementById('sync-ranges-btn').addEventListener('click', () => showToast('Named range sync - STEP 4', 'warning'));
        document.getElementById('test-integration-btn').addEventListener('click', () => showToast('Integration test - STEP 4', 'warning'));

        console.log('🎯 V1.2 Connected Frontend - With Dropdown Management');
        console.log('🔗 Backend URL:', API_URL);
        
        // Auto-test connection on load
        testBackendConnection();
        
        // Modal close on click outside
        window.onclick = function(event) {
            const modal = document.getElementById('residentModal');
            if (event.target === modal) {
                closeModal();
            }
        };
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                showAddResident();
            }
        });
    });
</script>
</body>
</html>