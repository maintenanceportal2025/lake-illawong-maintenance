<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Facilities - Lake Illawong</title>
    
    <style>
        /* === UNIFIED DESIGN SYSTEM v1.4 === */
        :root {
            --primary-blue: #1e40af;
            --secondary-blue: #1e3a8a;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.9);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header matching PasswordSettings.html EXACTLY */
        .booking-header {
            background: transparent;
            text-align: center;
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .logo-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .title-container {
            text-align: left;
        }

        .booking-header h1 {
            font-size: 2.3rem;
            font-weight: 700;
            color: white;
            margin-top: 30px;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .booking-header p {
            color: white;
            font-size: .9rem;
            margin-bottom: 40px;
            opacity: 0.9;
        }

        .header-divider {
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 10%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0.3) 90%, transparent 100%);
            margin: 10px 0 40px 0;
            border-radius: 1.5px;
        }
        
        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Card styling */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        
        .card h2 {
            color: var(--primary-blue);
            font-size: 1.6rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* Form Groups */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary-blue);
            font-size: 1rem;
        }
        
        .form-group.required label::after {
            content: " *";
            color: var(--danger-color);
        }
        
        /* Input Styling */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s;
            background: white;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* Time Slot Selection */
        .time-slots {
            display: grid;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .time-slot {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-slot:hover {
            border-color: var(--accent-color);
            background: var(--light-gray);
        }
        
        .time-slot.selected {
            border-color: var(--success-color);
            background: #f0f9f4;
        }
        
        .time-slot input {
            width: auto;
            margin-right: 1rem;
            transform: scale(1.2);
        }
        
        /* Button Styling */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            text-align: center;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--accent-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }
        
        .btn-full {
            width: 100%;
        }
        
        /* Button Group */
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        @media (max-width: 768px) {
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
        
        /* Messages */
        .message {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: none;
            border-left: 4px solid;
        }
        
        .message-success {
            background: #d4edda;
            border-color: var(--success-color);
            color: #155724;
        }
        
        .message-error {
            background: #f8d7da;
            border-color: var(--danger-color);
            color: #721c24;
        }
        
        .message-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        
        /* Loading Indicator */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 0;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 1rem 1.75rem;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 12px 12px 0 0;
            font-weight: 700;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.85);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 120px;
            backdrop-filter: blur(5px);
            border-bottom: 3px solid transparent;
            position: relative;
            bottom: -1px;
        }
        
        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .nav-tab.active {
            background: var(--card-bg);
            color: var(--primary-blue);
            border-bottom: 3px solid var(--accent-color);
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
            position: relative;
            z-index: 10;
        }
        
        /* Tab icons */
        .nav-tab::before {
            content: '';
            display: inline-block;
            margin-right: 0.5rem;
            font-size: 1.2em;
            vertical-align: middle;
        }
        
        .nav-tab:nth-child(1)::before { content: 'üìÖ'; }
        .nav-tab:nth-child(2)::before { content: 'üìã'; }
        .nav-tab:nth-child(3)::before { content: 'üóìÔ∏è'; }
        .nav-tab:nth-child(4)::before { content: 'üìò'; }
        .nav-tab:nth-child(5)::before { content: 'üõ†Ô∏è'; }
        
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
                gap: 0.5rem;
                border-bottom: none;
            }
            
            .nav-tab {
                width: 100%;
                border-radius: 12px;
                padding: 1rem;
                border-bottom: 2px solid rgba(255, 255, 255, 0.1);
                text-align: left;
                margin-bottom: 0.25rem;
                bottom: 0;
            }
            
            .nav-tab.active {
                border-radius: 12px 12px 0 0;
                border-bottom: 3px solid var(--accent-color);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            .nav-tab::before {
                font-size: 1.3em;
                margin-right: 0.75rem;
            }
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* View Modes */
        .view-mode-selector {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }
        
        .view-mode-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .view-mode-buttons .btn {
            flex: 1;
            min-width: 150px;
        }
        
        /* Booking Status Badges */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .status-booked {
            background: #d4edda;
            color: #155724;
        }
        
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
            text-decoration: line-through;
        }
        
        .status-past {
            background: #e9ecef;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Cancelled booking styling */
        .booking-cancelled {
            opacity: 0.7;
            background: #f8f9fa !important;
            border-left-color: #95a5a6 !important;
        }
        
        .booking-cancelled .booking-title {
            text-decoration: line-through;
            color: #666;
        }
        
        /* Past booking styling */
        .booking-past {
            opacity: 0.8;
            background: #f8f9fa !important;
        }
        
        /* All Day Booking Checkbox */
        .all-day-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 1rem;
            padding: 1rem;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #d1e9ff;
        }
        
        .all-day-container input[type="checkbox"] {
            transform: scale(1.3);
        }
        
        .all-day-label {
            font-weight: 600;
            color: var(--primary-blue);
            cursor: pointer;
        }
        
        .all-day-times {
            margin-left: auto;
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Calendar Styles */
        .calendar-select {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            background: white;
            min-width: 120px;
        }
        
        .calendar-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        /* === GOOGLE CALENDAR STYLES === */
        .google-calendar-clubhouse {
            background: #7986cb !important;
            border-color: #7986cb !important;
            color: white !important;
        }

        .google-calendar-gazebo {
            background: #33b679 !important;
            border-color: #33b679 !important;
            color: white !important;
        }

        .google-calendar-recroom {
            background: #8e24aa !important;
            border-color: #8e24aa !important;
            color: white !important;
        }

        .google-calendar-cancelled {
            background: #f4511e !important;
            border-color: #f4511e !important;
            color: white !important;
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* === IMPROVED CALENDAR LAYOUT === */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .calendar-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid #dadce0;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #5f6368;
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            background: #f1f3f4;
            border-color: #c4c7c5;
        }

        .calendar-title {
            font-size: 1.5rem;
            font-weight: 400;
            color: #3c4043;
            margin: 0;
        }

        /* === IMPROVED CALENDAR GRID === */
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            border: 1px solid #dadce0;
            border-bottom: none;
        }

        .calendar-weekday {
            padding: 1rem;
            text-align: center;
            font-weight: 500;
            color: #5f6368;
            font-size: 0.9rem;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border: 1px solid #dadce0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        .calendar-day {
            min-height: 120px;
            padding: 0.5rem;
            border-right: 1px solid #dadce0;
            border-bottom: 1px solid #dadce0;
            background: white;
            position: relative;
            transition: background 0.2s;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.today {
            background: #e8f0fe;
        }

        .calendar-day-header {
            text-align: right;
            padding: 0.25rem;
            margin-bottom: 0.25rem;
        }

        .calendar-day-number {
            display: inline-block;
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            border-radius: 50%;
            font-size: 0.9rem;
            color: #3c4043;
        }

        .calendar-day.today .calendar-day-number {
            background: #1a73e8;
            color: white;
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: #9aa0a6;
        }

        .calendar-day.other-month .calendar-day-number {
            color: #9aa0a6;
        }

        /* === IMPROVED EVENT DISPLAY === */
        .calendar-event {
            margin: 0.25rem 0;
            padding: 0.375rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            border-left: 3px solid;
            color: white;
        }

        .calendar-event:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }

        .calendar-event-time {
            font-weight: 600;
            margin-right: 0.25rem;
            font-size: 0.75rem;
        }

        .calendar-event-title {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-event-more {
            font-size: 0.75rem;
            color: #5f6368;
            padding: 0.25rem;
            text-align: center;
            cursor: pointer;
            border-radius: 3px;
            background: #f8f9fa;
            margin-top: 0.25rem;
        }

        /* === SHOW PASSWORD TOGGLE === */
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 0.9em;
        }

        .password-container {
            position: relative;
        }

        .password-container input {
            padding-right: 40px;
            width: 100%;
        }

        /* === MOBILE RESPONSIVENESS === */
        @media (max-width: 768px) {
            .calendar-header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .calendar-nav {
                width: 100%;
                justify-content: space-between;
            }
            
            .calendar-title {
                font-size: 1.3rem;
                text-align: center;
            }
            
            .calendar-day {
                min-height: 100px;
                padding: 0.25rem;
            }
            
            .calendar-event {
                padding: 0.25rem;
                font-size: 0.7rem;
            }
            
            .calendar-day-number {
                width: 24px;
                height: 24px;
                line-height: 24px;
                font-size: 0.8rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            body {
                padding: 10px;
            }
            
            .view-mode-buttons {
                flex-direction: column;
            }
            
            .view-mode-buttons .btn {
                width: 100%;
            }
            
            .calendar-select {
                min-width: 100px;
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header matching PasswordSettings.html -->
        <div class="booking-header">
            <div class="header-content">
                <img src="logo.png" alt="Lake Illawong Logo" class="logo-image">
                <div class="title-container">
                    <h1>Book Facilities</h1>
                    <p>Reserve Clubhouse, Gazebo, or Rec Room for your events</p>
                </div>
            </div>
            <div class="header-divider"></div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('booking')">Make Booking</button>
            <button class="nav-tab" onclick="showTab('view')">View Bookings</button>
            <button class="nav-tab" onclick="showTab('calendar')">View Calendar</button>
            <button class="nav-tab" onclick="showTab('guidelines')">Guidelines</button>
            <button class="nav-tab" onclick="showTab('admin')" id="adminTabButton" style="display: none;">Admin</button>
        </div>
        
        <!-- Messages -->
        <div id="message" class="message"></div>
        
        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Processing your request...</p>
        </div>
        
        <!-- Booking Tab -->
        <div id="bookingTab" class="tab-content active">
            <!-- Quick Availability Check -->
            <div class="card" style="margin-bottom: 1.5rem; background: #f0f9ff;">
                <h2 style="color: #1e40af;">üìÖ Quick Availability Check</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label for="quickDate">Date</label>
                        <input type="date" id="quickDate" style="width: 100%;">
                    </div>
                    
                    <div class="form-group">
                        <label for="quickStartTime">Start Time</label>
                        <select id="quickStartTime" style="width: 100%;">
                            <option value="08:00">8:00 AM</option>
                            <option value="09:00">9:00 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="14:00" selected>2:00 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="16:00">4:00 PM</option>
                            <option value="17:00">5:00 PM</option>
                            <option value="18:00">6:00 PM</option>
                            <option value="19:00">7:00 PM</option>
                            <option value="20:00">8:00 PM</option>
                            <option value="21:00">9:00 PM</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="quickEndTime">End Time</label>
                        <select id="quickEndTime" style="width: 100%;">
                            <option value="09:00">9:00 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="16:00" selected>4:00 PM</option>
                            <option value="17:00">5:00 PM</option>
                            <option value="18:00">6:00 PM</option>
                            <option value="19:00">7:00 PM</option>
                            <option value="20:00">8:00 PM</option>
                            <option value="21:00">9:00 PM</option>
                            <option value="22:00">10:00 PM</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="quickCheckAvailability()" style="flex: 1;">
                        üîç Check Availability
                    </button>
                    <button class="btn btn-secondary" onclick="autoFillFromQuickCheck()" style="flex: 1;">
                        ‚úÖ Use These Times
                    </button>
                </div>
                
                <div id="quickAvailabilityResult" style="margin-top: 1rem; display: none;"></div>
            </div>

            <!-- Main Booking Form -->
            <div class="card">
                <h2>Make a Booking</h2>

                <!-- Facility Selection -->
                <div class="form-group required">
                    <label for="facility">Select Facility</label>
                    <div class="time-slots" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                        <!-- Clubhouse -->
                        <label class="time-slot">
                            <input type="radio" name="facility" value="clubhouse" checked required>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 1.5em;">üè†</div>
                                    <div>
                                        <div style="font-weight: bold; font-size: 1.1em;">Clubhouse</div>
                                        <div style="font-size: 0.9em; color: #666;">Main building</div>
                                    </div>
                                </div>
                                <div style="font-size: 0.85em; color: #555; padding-left: 2.25rem;">
                                    ‚Ä¢ Kitchen facilities<br>
                                    ‚Ä¢ Seats up to 50<br>
                                    ‚Ä¢ Air conditioned<br>
                                    ‚Ä¢ TV & sound system
                                </div>
                            </div>
                        </label>
                        
                        <!-- Gazebo -->
                        <label class="time-slot">
                            <input type="radio" name="facility" value="gazebo" required>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 1.5em;">üå≥</div>
                                    <div>
                                        <div style="font-weight: bold; font-size: 1.1em;">Gazebo</div>
                                        <div style="font-size: 0.9em; color: #666;">Outdoor area</div>
                                    </div>
                                </div>
                                <div style="font-size: 0.85em; color: #555; padding-left: 2.25rem;">
                                    ‚Ä¢ Covered outdoor space<br>
                                    ‚Ä¢ BBQ facilities<br>
                                    ‚Ä¢ Picnic tables<br>
                                    ‚Ä¢ Garden lighting
                                </div>
                            </div>
                        </label>
                        
                        <!-- Rec Room -->
                        <label class="time-slot">
                            <input type="radio" name="facility" value="recroom" required>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 1.5em;">üéÆ</div>
                                    <div>
                                        <div style="font-weight: bold; font-size: 1.1em;">Rec Room</div>
                                        <div style="font-size: 0.9em; color: #666;">Games & lounge</div>
                                    </div>
                                </div>
                                <div style="font-size: 0.85em; color: #555; padding-left: 2.25rem;">
                                    ‚Ä¢ Pool table<br>
                                    ‚Ä¢ TV lounge<br>
                                    ‚Ä¢ Board games<br>
                                    ‚Ä¢ Small kitchenette
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <form id="bookingForm">
                    <div class="form-grid">
                        <!-- Left Column -->
                        <div>
                            <!-- Event Name -->
                            <div class="form-group required">
                                <label for="eventName">Event Name</label>
                                <input type="text" id="eventName" name="eventName" 
                                       placeholder="e.g., Birthday Party, Family Gathering" required>
                            </div>
                            
                            <!-- Unit Number -->
                            <div class="form-group required">
                                <label for="unitNumber">Unit Number</label>
                                <input type="text" id="unitNumber" name="unitNumber" required>
                            </div>
                            
                            <!-- Requester Phone -->
                            <div class="form-group">
                                <label for="phone">Requester Phone</label>
                                <input type="tel" id="phone" name="phone">
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div>
                            <!-- Event Date -->
                            <div class="form-group required">
                                <label for="eventDate">Event Date</label>
                                <input type="date" id="eventDate" name="eventDate" required>
                            </div>
                            
                            <!-- Requester Name -->
                            <div class="form-group required">
                                <label for="yourName">Requester Name</label>
                                <input type="text" id="yourName" name="yourName" required>
                            </div>
                            
                            <!-- Requester Email -->
                            <div class="form-group required">
                                <label for="email">Requester Email</label>
                                <input type="email" id="email" name="email" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- All Day Booking Option -->
                    <div class="all-day-container">
                        <input type="checkbox" id="allDayBooking" name="allDayBooking" onchange="toggleAllDayBooking()">
                        <label for="allDayBooking" class="all-day-label">All Day Booking (8:00 AM - 10:00 PM)</label>
                        <div class="all-day-times">14 hours total</div>
                    </div>
                    
                    <!-- Time Slot Selection -->
                    <div class="form-group required">
                        <label>Time Slot</label>
                        <div class="time-slots">
                            <label class="time-slot">
                                <input type="radio" name="timeSlot" value="09:00-11:00" required>
                                <span>üïò Morning (9:00 AM - 11:00 AM)</span>
                            </label>
                            <label class="time-slot">
                                <input type="radio" name="timeSlot" value="14:00-16:00">
                                <span>üïë Afternoon (2:00 PM - 4:00 PM)</span>
                            </label>
                            <label class="time-slot">
                                <input type="radio" name="timeSlot" value="17:00-19:00">
                                <span>üïî Evening (5:00 PM - 7:00 PM)</span>
                            </label>
                            <label class="time-slot">
                                <input type="radio" name="timeSlot" value="custom">
                                <span>‚è∞ Custom Time</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Custom Time Fields -->
                    <div id="customTimeFields" style="display: none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="startTime">Start Time</label>
                                <input type="time" id="startTime" name="startTime" min="06:00" max="22:00">
                            </div>
                            <div class="form-group">
                                <label for="endTime">End Time</label>
                                <input type="time" id="endTime" name="endTime" min="06:00" max="22:00">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Event Type -->
                    <div class="form-group required">
                        <label for="eventType">Event Type</label>
                        <select id="eventType" name="eventType" required>
                            <option value="">Select event type</option>
                            <option value="birthday">üéÇ Birthday Party</option>
                            <option value="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Gathering</option>
                            <option value="committee">üìã Committee Meeting</option>
                            <option value="social">üíÉ Social Event</option>
                            <option value="other">üìÖ Other</option>
                        </select>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="checkAvailability()">
                            üîç Check Availability
                        </button>
                        <button type="submit" class="btn btn-primary btn-large">
                            üìÖ Confirm Booking
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- View Bookings Tab -->
        <div id="viewTab" class="tab-content">
            <div class="card">
                <h2>View Bookings</h2>
                
                <!-- View Mode Selector -->
                <div class="view-mode-selector">
                    <h3 style="margin-bottom: 1rem; color: var(--primary-blue);">Select View Mode:</h3>
                    
                    <!-- Public View (Default) -->
                    <div id="publicViewInfo" style="display: block;">
                        <p style="margin-bottom: 1rem;"><strong>Public View:</strong> Shows all bookings with limited details (facility, date, time only).</p>
                        <div class="view-mode-buttons">
                            <button class="btn btn-secondary" onclick="showPersonalView()">
                                üîê Show My Bookings
                            </button>
                            <button class="btn btn-warning" onclick="toggleAdminLogin()">
                                üõ†Ô∏è Admin Access
                            </button>
                        </div>
                    </div>
                    
                    <!-- Personal View -->
                    <div id="personalViewForm" style="display: none;">
                        <p style="margin-bottom: 1rem;"><strong>Personal View:</strong> Enter your email to view and manage your bookings.</p>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="email" id="personalEmail" placeholder="Enter your email address" style="flex: 1;">
                            <button class="btn btn-primary" onclick="loadPersonalBookings()">
                                Load My Bookings
                            </button>
                            <button class="btn btn-secondary" onclick="showPublicView()">
                                Back to Public View
                            </button>
                        </div>
                        <div id="personalEmailStatus" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
                    </div>
                    
                    <!-- Admin Login -->
                    <div id="adminLoginForm" style="display: none;">
                        <p style="margin-bottom: 1rem;"><strong>Admin Access:</strong> Enter admin password to view all bookings.</p>
                        <div class="password-container" style="display: flex; gap: 1rem; align-items: center;">
                            <input type="password" id="adminPassword" placeholder="Enter admin password" style="flex: 1;">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('adminPassword')">üëÅÔ∏è</button>
                            <button class="btn btn-warning" onclick="loginAsAdmin()">
                                Login as Admin
                            </button>
                            <button class="btn btn-secondary" onclick="showPublicView()">
                                Back to Public View
                            </button>
                        </div>
                        <div id="adminLoginStatus" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
                    </div>
                    
                    <!-- Admin View Active -->
                    <div id="adminViewActive" style="display: none;">
                        <p style="margin-bottom: 1rem;"><strong>Admin View Active:</strong> You can view and manage all bookings.</p>
                        <div class="view-mode-buttons">
                            <button class="btn btn-warning" onclick="loadAllBookings()">
                                üîÑ Refresh All Bookings
                            </button>
                            <button class="btn btn-secondary" onclick="logoutAdmin()">
                                Logout Admin Access
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Bookings Display -->
                <div id="bookingsList">
                    <!-- Bookings will be loaded here -->
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="loadBookings()">
                        üîÑ Refresh List
                    </button>
                </div>
            </div>
        </div>
        
        <!-- View Calendar Tab -->
        <div id="calendarTab" class="tab-content">
            <div class="card">
                <h2>üìÖ Facilities Calendar</h2>
                
                <!-- Calendar Display -->
                <div id="simpleCalendar">
                    <div style="text-align: center; color: #666; padding: 3rem;">
                        <div style="font-size: 3em; margin-bottom: 1rem;">üìÖ</div>
                        <h3 style="margin-bottom: 0.5rem; color: var(--primary-blue);">Facilities Calendar</h3>
                        <p style="margin-bottom: 1.5rem;">View all upcoming bookings across Clubhouse, Gazebo, and Rec Room</p>
                        <button class="btn btn-primary btn-large" onclick="loadCalendarView()">
                            <span style="font-size: 1.2em;">üîÑ</span> Load Calendar
                        </button>
                        <p style="margin-top: 1rem; font-size: 0.9em; color: #888;">
                            Shows upcoming bookings only (cancelled bookings hidden)
                        </p>
                    </div>
                </div>
                
                <!-- Legend -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                    <h4 style="margin-bottom: 0.75rem; color: var(--primary-blue);">Color Legend</h4>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 16px; height: 16px; background: #7986cb; border-radius: 4px;"></div>
                            <span style="font-size: 0.9em; font-weight: 600;">üè† Clubhouse</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 16px; height: 16px; background: #33b679; border-radius: 4px;"></div>
                            <span style="font-size: 0.9em; font-weight: 600;">üå≥ Gazebo</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 16px; height: 16px; background: #8e24aa; border-radius: 4px;"></div>
                            <span style="font-size: 0.9em; font-weight: 600;">üéÆ Rec Room</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Guidelines Tab -->
        <div id="guidelinesTab" class="tab-content">
            <div class="card">
                <h2>üè† Clubhouse Guidelines & Rules</h2>
                
                <div style="display: grid; gap: 1.5rem;">
                    <!-- Booking Rules -->
                    <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3498db;">
                        <h3 style="color: #1e40af; margin-bottom: 1rem;">üìÖ Booking Rules</h3>
                        <ul style="padding-left: 1.5rem;">
                            <li>Bookings can be made up to 90 days in advance</li>
                            <li>Maximum booking duration: 8 hours per day</li>
                            <li>Operating hours: 6:00 AM to 10:00 PM</li>
                            <li>Bookings must be made by residents only</li>
                            <li>Please cancel if you cannot attend</li>
                        </ul>
                    </div>
                    
                    <!-- Usage Guidelines -->
                    <div style="background: #f0fff4; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #27ae60;">
                        <h3 style="color: #166534; margin-bottom: 1rem;">‚úÖ Usage Guidelines</h3>
                        <ul style="padding-left: 1.5rem;">
                            <li>Leave the clubhouse clean and tidy</li>
                            <li>Return furniture to original positions</li>
                            <li>Dispose of all rubbish properly</li>
                            <li>Turn off all lights and appliances after use</li>
                            <li>Report any damage to management immediately</li>
                        </ul>
                    </div>
                    
                    <!-- Noise & Conduct -->
                    <div style="background: #fff7ed; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #f39c12;">
                        <h3 style="color: #92400e; margin-bottom: 1rem;">üîä Noise & Conduct</h3>
                        <ul style="padding-left: 1.5rem;">
                            <li>Respect quiet hours: 8:00 PM to 8:00 AM</li>
                            <li>Keep noise at reasonable levels</li>
                            <li>Be considerate of nearby residents</li>
                            <li>No amplified music after 8:00 PM</li>
                            <li>Maximum capacity: 30 people</li>
                        </ul>
                    </div>
                    
                    <!-- Important Reminders -->
                    <div style="background: #fef2f2; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #e74c3c;">
                        <h3 style="color: #991b1b; margin-bottom: 1rem;">‚ö†Ô∏è Important Reminders</h3>
                        <ul style="padding-left: 1.5rem;">
                            <li>You are responsible for your guests</li>
                            <li>No smoking inside the clubhouse</li>
                            <li>Alcohol consumption must be responsible</li>
                            <li>Fire exits must remain clear at all times</li>
                            <li>Emergency contact: [Your Contact Number]</li>
                        </ul>
                    </div>
                    
                    <!-- Contact Information -->
                    <div style="background: #faf5ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                        <h3 style="color: #5b21b6; margin-bottom: 1rem;">üìû Contact & Support</h3>
                        <div style="display: grid; gap: 0.75rem;">
                            <div>
                                <strong>Booking Issues:</strong>
                                <div>Email: management@lakeillawong.example.com</div>
                            </div>
                            <div>
                                <strong>Emergencies:</strong>
                                <div>Phone: 000 (Emergency Services)</div>
                            </div>
                            <div>
                                <strong>Maintenance:</strong>
                                <div>Contact building management</div>
                            </div>
                            <div>
                                <strong>Lost Property:</strong>
                                <div>Check with security or management</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Simple footer note -->
                <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #dee2e6; text-align: center; color: #666;">
                    <p>These guidelines help ensure the clubhouse remains a pleasant space for all residents.</p>
                    <p>Thank you for your cooperation! üôè</p>
                </div>
            </div>
        </div>
        
        <!-- Admin Tab -->
        <div id="adminTab" class="tab-content">
            <div class="card">
                <h2>üõ†Ô∏è Admin Panel</h2>
                
                <!-- Admin Login Section (shown only if NOT logged in) -->
                <div id="adminLoginSection" style="display: none;">
                    <div style="background: #f0f9ff; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #3498db;">
                        <h3 style="color: #1e40af; margin-bottom: 1rem;">üîê Admin Login</h3>
                        <p style="margin-bottom: 1.5rem;">You are already logged in as admin via View Bookings.</p>
                        <p style="margin-bottom: 1.5rem; font-weight: 600;">To access admin tools, please:</p>
                        <ol style="margin-left: 1.5rem; margin-bottom: 1.5rem;">
                            <li>Go to "View Bookings" tab</li>
                            <li>Click "Admin Access" button</li>
                            <li>Enter admin password</li>
                        </ol>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="showTab('view')">
                                Go to View Bookings
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Admin Dashboard (shown if already logged in) -->
                <div id="adminDashboard">
                    <!-- Status Bar -->
                    <div style="background: #d4edda; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #28a745;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>üõ†Ô∏è Admin Mode Active</strong>
                                <div style="font-size: 0.9em; margin-top: 0.25rem;">Logged in via View Bookings</div>
                            </div>
                            <button class="btn btn-secondary btn-small" onclick="logoutAdmin()">
                                üö™ Logout
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--primary-blue);">‚ö° Quick Actions</h3>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="showAdminQuickCreate()">
                                ‚ûï Quick Create
                            </button>
                            <button class="btn btn-warning" onclick="showRecurringEventModal()">
                                üîÑ Recurring Event
                            </button>
                            <button class="btn btn-danger" onclick="showAdminBlockTime()">
                                ‚õî Block Time
                            </button>
                        </div>
                    </div>

                    <!-- Quick Create Form (always visible for simplicity) -->
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid #dee2e6;">
                        <h4 style="color: var(--primary-blue); margin-bottom: 1rem;">‚ûï Quick Create Booking</h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="adminFacility">Facility</label>
                                <select id="adminFacility" style="width: 100%;">
                                    <option value="clubhouse">üè† Clubhouse</option>
                                    <option value="gazebo">üå≥ Gazebo</option>
                                    <option value="recroom">üéÆ Rec Room</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="adminEventName">Event Name</label>
                                <input type="text" id="adminEventName" placeholder="e.g., Committee Meeting" style="width: 100%;">
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="adminDate">Date</label>
                                <input type="date" id="adminDate" style="width: 100%;">
                            </div>
                            
                            <div class="form-group">
                                <label for="adminStartTime">Start Time</label>
                                <input type="time" id="adminStartTime" value="14:00" style="width: 100%;">
                            </div>
                            
                            <div class="form-group">
                                <label for="adminEndTime">End Time</label>
                                <input type="time" id="adminEndTime" value="16:00" style="width: 100%;">
                            </div>
                        </div>
                        
                        <div class="btn-group" style="margin-top: 1.5rem;">
                            <button class="btn btn-secondary" onclick="clearAdminForm()">
                                Clear
                            </button>
                            <button class="btn btn-primary" onclick="createAdminBooking()">
                                Create Booking
                            </button>
                        </div>
                    </div>

                    <!-- Admin Calendar View -->
                    <div style="margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="color: var(--primary-blue); margin: 0;">üìÖ Admin Calendar</h3>
                        </div>
                        
                        <!-- Calendar Display -->
                        <div id="adminCalendar" style="min-height: 400px; padding: 1.5rem; background: white; border-radius: 8px; border: 1px solid #dee2e6;">
                            <div style="text-align: center; color: #666; padding: 3rem;">
                                <div style="font-size: 3em; margin-bottom: 1rem;">üìÖ</div>
                                <h3 style="margin-bottom: 0.5rem; color: var(--primary-blue);">Admin Calendar</h3>
                                <p style="margin-bottom: 1.5rem;">View all active bookings across facilities</p>
                                <p style="margin-bottom: 1.5rem; font-size: 0.9em; color: #888; font-style: italic;">Cancelled bookings are hidden from calendar view</p>
                                <button class="btn btn-primary btn-large" onclick="loadAdminCalendar()">
                                    <span style="font-size: 1.2em;">üîÑ</span> Load Calendar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Legend -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                            <h4 style="margin-bottom: 0.75rem; color: var(--primary-blue);">Color Legend</h4>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 16px; height: 16px; background: #7986cb; border-radius: 4px;"></div>
                                    <span style="font-size: 0.9em; font-weight: 600;">üè† Clubhouse</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 16px; height: 16px; background: #33b679; border-radius: 4px;"></div>
                                    <span style="font-size: 0.9em; font-weight: 600;">üå≥ Gazebo</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 16px; height: 16px; background: #8e24aa; border-radius: 4px;"></div>
                                    <span style="font-size: 0.9em; font-weight: 600;">üéÆ Rec Room</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Bookings Management -->
                    <div style="margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="color: var(--primary-blue); margin: 0;">üìã Recent Bookings</h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="adminBookingFilter" class="calendar-select" onchange="loadAdminBookings()" style="min-width: 150px;">
                                    <option value="upcoming">Upcoming</option>
                                    <option value="past">Past</option>
                                    <option value="all">All</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <button class="btn btn-secondary btn-small" onclick="loadAdminBookings()">
                                    üîÑ Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div id="adminBookingsList">
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 1rem;"></div>
                                Loading bookings...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Simple Statistics -->
                    <div>
                        <h3 style="margin-bottom: 1rem; color: var(--primary-blue);">üìä Quick Stats</h3>
                        <div id="simpleAdminStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.8em; margin-bottom: 0.25rem; font-weight: bold;">--</div>
                                <div style="font-size: 0.9em; color: #666;">Total</div>
                            </div>
                            <div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.8em; margin-bottom: 0.25rem; font-weight: bold; color: #28a745;">--</div>
                                <div style="font-size: 0.9em; color: #666;">Upcoming</div>
                            </div>
                            <div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.8em; margin-bottom: 0.25rem; font-weight: bold; color: #6c757d;">--</div>
                                <div style="font-size: 0.9em; color: #666;">Past</div>
                            </div>
                            <div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.8em; margin-bottom: 0.25rem; font-weight: bold; color: #dc3545;">--</div>
                                <div style="font-size: 0.9em; color: #666;">Cancelled</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recurring Event Modal -->
        <div id="recurringEventModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; width: 90%; max-width: 500px; border-radius: 12px; padding: 2rem; max-height: 90vh; overflow-y: auto;">
                <h3 style="margin-bottom: 1.5rem; color: var(--primary-blue);">üîÑ Create Recurring Event</h3>
                
                <div class="form-group">
                    <label for="recurringEventName">Event Name</label>
                    <input type="text" id="recurringEventName" placeholder="e.g., Weekly Committee Meeting" style="width: 100%;">
                </div>
                
                <div class="form-group">
                    <label for="recurringFacility">Facility</label>
                    <select id="recurringFacility" class="calendar-select" style="width: 100%;">
                        <option value="clubhouse">üè† Clubhouse</option>
                        <option value="gazebo">üå≥ Gazebo</option>
                        <option value="recroom">üéÆ Rec Room</option>
                    </select>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="recurringStartDate">Start Date</label>
                        <input type="date" id="recurringStartDate" style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label for="recurringEndDate">End Date (Optional)</label>
                        <input type="date" id="recurringEndDate" style="width: 100%;">
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="recurringStartTime">Start Time</label>
                        <input type="time" id="recurringStartTime" value="19:00" style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label for="recurringEndTime">End Time</label>
                        <input type="time" id="recurringEndTime" value="20:30" style="width: 100%;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="recurringPattern">Recurrence Pattern</label>
                    <select id="recurringPattern" class="calendar-select" style="width: 100%;" onchange="toggleRecurringOptions()">
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-weekly (Every 2 weeks)</option>
                        <option value="monthly">Monthly (Same day of month)</option>
                        <option value="monthly-weekday">Monthly (Same weekday)</option>
                    </select>
                </div>
                
                <div id="weeklyOptions" style="display: block;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--primary-blue);">Days of Week</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                            <input type="checkbox" name="recurringDays" value="1"> Monday
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                            <input type="checkbox" name="recurringDays" value="2"> Tuesday
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                            <input type="checkbox" name="recurringDays" value="3"> Wednesday
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                            <input type="checkbox" name="recurringDays" value="4"> Thursday
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                            <input type="checkbox" name="recurringDays" value="5"> Friday
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                            <input type="checkbox" name="recurringDays" value="6"> Saturday
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                            <input type="checkbox" name="recurringDays" value="0"> Sunday
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="recurringOccurrences">Number of Occurrences</label>
                    <input type="number" id="recurringOccurrences" min="1" max="52" value="12" style="width: 100%;">
                </div>
                
                <div class="btn-group" style="margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="hideRecurringEventModal()" style="flex: 1;">
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="createRecurringEvents()" style="flex: 1;">
                        Create Series
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>

// ===== CACHE IMPLEMENTATION =====
let bookingCache = new Map();  // Stores fetched booking data
let cacheTimestamps = new Map(); // Stores when data was cached
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds
// ===== END CACHE =====


    // ========== CONFIGURATION ==========
    var BACKEND_URL = 'https://script.google.com/macros/s/AKfycbwHwXWJdSpRP6j3CJVDWSZ_n6vEBjEhpA9wZv1AunaGsCfKPBaIGnzrexJe_8asf6PF/exec';
    
    // **IMPORTANT**: Default password - will be updated from Password Manager
    var ADMIN_PASSWORD = 'admin2024'; 
    
    // Password Manager API - THIS IS THE CENTRAL PASSWORD SYSTEM
    var PASSWORD_API = 'https://script.google.com/macros/s/AKfycbyu0RdVfmlQEnr1wi5tfkPi-tGNLzKcs5H3R9DAnKXzZROwqEPhnCvpNq3CsjKGeaxXwA/exec';
    
    // ========== GLOBAL STATE ==========
    var currentTab = 'booking';
    var currentViewMode = 'public'; // 'public', 'personal', 'admin'
    var userEmail = '';
    var isAdmin = false;
    var adminLoggedIn = false;
    var allBookings = []; // Store all bookings for admin view
    var currentCalendarMonth = new Date().getMonth();
    var currentCalendarYear = new Date().getFullYear();
    
    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîê Booking System v2.0 - Enhanced Calendar Version');
        
        // Set date restrictions for main form
        var today = new Date();
        var dateInput = document.getElementById('eventDate');
        dateInput.min = today.toISOString().split('T')[0];
        
        var maxDate = new Date();
        maxDate.setDate(today.getDate() + 90);
        dateInput.max = maxDate.toISOString().split('T')[0];
        
        // Default main form to tomorrow
        var tomorrow = new Date();
        tomorrow.setDate(today.getDate() + 1);
        dateInput.value = tomorrow.toISOString().split('T')[0];
        
        // Set quick check date to tomorrow too
        var quickDateInput = document.getElementById('quickDate');
        if (quickDateInput) {
            quickDateInput.min = today.toISOString().split('T')[0];
            quickDateInput.max = maxDate.toISOString().split('T')[0];
            quickDateInput.value = tomorrow.toISOString().split('T')[0];
        }
        
        // Set recurring event start date to tomorrow
        document.getElementById('recurringStartDate').valueAsDate = tomorrow;
        
        // Handle custom time selection
        document.querySelectorAll('input[name="timeSlot"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                var customFields = document.getElementById('customTimeFields');
                if (this.value === 'custom') {
                    customFields.style.display = 'block';
                } else {
                    customFields.style.display = 'none';
                }
                
                // Update styling
                document.querySelectorAll('.time-slot').forEach(function(slot) {
                    slot.classList.remove('selected');
                });
                this.closest('.time-slot').classList.add('selected');
            });
        });
        
        // Form submission
        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitBooking();
        });
        
        // Load initial bookings (public view)
        loadBookings();
        
        // Try to load saved email from localStorage
        var savedEmail = localStorage.getItem('lakeIllawongBookingEmail');
        if (savedEmail) {
            document.getElementById('personalEmail').value = savedEmail;
        }
        
        // Update admin tab visibility
        updateAdminTabVisibility();
        
        // Update admin panel based on login
        updateAdminPanelBasedOnLogin();
        
        // LOAD PASSWORD FROM CENTRAL PASSWORD MANAGER ON STARTUP
        loadBookingPasswordFromManager();
    });
    
    // ========== CENTRALIZED PASSWORD MANAGER INTEGRATION ==========
    
    // Load current booking system password from Password Manager
    function loadBookingPasswordFromManager() {
        console.log('üì° Loading booking system password from Central Password Manager...');
        
        const callbackName = `booking_pass_callback_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        window[callbackName] = function(data) {
            console.log('üì° Password Manager callback received:', data);
            
            // Clean up callback regardless of success
            delete window[callbackName];
            
            if (data.success && data.passwords && data.passwords.booking) {
                ADMIN_PASSWORD = data.passwords.booking;
                console.log('‚úÖ Booking password loaded from Password Manager:', ADMIN_PASSWORD);
                showMessage('‚úÖ Admin password loaded from Central Password Manager', 'success');
            } else {
                console.warn('‚ö†Ô∏è Using default booking password');
                showMessage('‚ö†Ô∏è Using default password', 'warning');
            }
        };
        
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(7);
        const scriptUrl = `${PASSWORD_API}?action=getPasswords&callback=${callbackName}&_t=${timestamp}&r=${random}`;
        
        const script = document.createElement('script');
        script.src = scriptUrl;
        
        script.onerror = function() {
            console.warn('‚ö†Ô∏è Password API unavailable, using default password');
            if (window[callbackName]) {
                delete window[callbackName];
            }
            showMessage('‚ö†Ô∏è Using default password (API unavailable)', 'warning');
        };
        
        setTimeout(() => {
            if (window[callbackName]) {
                console.warn('‚è∞ Timeout waiting for Password Manager response');
                delete window[callbackName];
            }
        }, 5000);
        
        document.head.appendChild(script);
    }
    
    function updateAdminPanelBasedOnLogin() {
        var loginSection = document.getElementById('adminLoginSection');
        var dashboard = document.getElementById('adminDashboard');
        
        if (loginSection && dashboard) {
            if (adminLoggedIn) {
                loginSection.style.display = 'none';
                dashboard.style.display = 'block';
                console.log('‚úÖ Admin already logged in, showing dashboard');
            } else {
                loginSection.style.display = 'block';
                dashboard.style.display = 'none';
                console.log('üîê Admin not logged in, showing login section');
            }
        }
    }
    
    // ========== SHOW PASSWORD TOGGLE ==========
    function togglePasswordVisibility(inputId) {
        var passwordInput = document.getElementById(inputId);
        var toggleButton = passwordInput.nextElementSibling;
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleButton.textContent = 'üôà';
        } else {
            passwordInput.type = 'password';
            toggleButton.textContent = 'üëÅÔ∏è';
        }
    }
    
    // ========== ENHANCED CALENDAR FUNCTIONS ==========
    
    function loadCalendarView() {
        console.log('üìÖ Loading enhanced calendar view...');
        showLoading(true);
        
        // Get current month/year (no dropdowns in this version)
        var month = currentCalendarMonth;
        var year = currentCalendarYear;
        
        callAPI('getBookings', {}, function(response) {
console.log('üì° CALENDAR API RESPONSE:', response);
  console.log('Has success?', response.success);
  console.log('Has bookings?', !!response.bookings);
  console.log('Bookings count?', response.bookings ? response.bookings.length : 0);
  console.log('Response keys:', Object.keys(response));
            showLoading(false);
            
            if (response.success && response.bookings) {
    console.log('üìä Calling createGoogleStyleCalendar with', response.bookings.length, 'bookings');
    createGoogleStyleCalendar(month, year, 'all', response.bookings, false);
  } else {
    console.error('‚ùå Calendar API failed:', response);
    showCalendarError(false);
  }
});
    }

    
    function loadAdminCalendar() {
        console.log('üìÖ Loading admin calendar view...');
        showLoading(true);
        
        var month = currentCalendarMonth;
        var year = currentCalendarYear;
        var facilityFilter = 'all'; // Default to all facilities
        
        callAPI('getBookings', {}, function(response) {
            showLoading(false);
            
            if (response.success && response.bookings) {
                createGoogleStyleCalendar(month, year, facilityFilter, response.bookings, true);
            } else {
                showCalendarError(true);
            }
        });
    }
    
    function createGoogleStyleCalendar(month, year, facilityFilter, bookings, isAdmin) {

console.log('üé® createGoogleStyleCalendar called');
  console.log('  Month:', month, 'Year:', year);
  console.log('  Bookings received:', bookings.length);
  console.log('  First booking:', bookings[0] ? bookings[0].bookingId : 'none');
console.log('üé® createGoogleStyleCalendar ENTER');
  console.log('  Month:', month, 'Year:', year);
  console.log('  Bookings received:', Array.isArray(bookings), 'length:', bookings.length);
  console.log('  First 2 bookings:', bookings.slice(0, 2).map(b => ({id: b.bookingId, status: b.status})));


        var container = isAdmin ? document.getElementById('adminCalendar') : document.getElementById('simpleCalendar');
        if (!container) return;
        
        // Filter bookings - EXCLUDE CANCELLED from ALL calendar views
        var filteredBookings = filterBookingsForCalendar(bookings, facilityFilter, isAdmin);
        
        // Get calendar data
        var calendarData = getCalendarData(month, year);
        
        // Build calendar HTML
        var html = buildCalendarHeader(month, year, isAdmin, facilityFilter);
        html += buildCalendarGrid(calendarData, filteredBookings, isAdmin);
        
        container.innerHTML = html;
        
        // Add event listeners for navigation
        addCalendarNavigationListeners(isAdmin);
    }
    
    function filterBookingsForCalendar(bookings, facilityFilter, isAdmin) {
        var filtered = bookings;
        
        // Filter by facility
        if (facilityFilter !== 'all') {
            filtered = filtered.filter(function(booking) {
                return booking.facility === facilityFilter;
            });
        }
        
        // IMPORTANT: EXCLUDE CANCELLED BOOKINGS from ALL calendar views
        filtered = filtered.filter(function(booking) {
            return booking.status !== 'Cancelled';
        });
        
        // For resident view: show ALL non-cancelled
if (!isAdmin) {
    // Show all non-cancelled (both past and future)
    // No date filtering
}
        
        console.log('üìÖ Calendar filtered to', filtered.length, 'active bookings (cancelled excluded)');
        return filtered;
    }
    
    function getCalendarData(month, year) {
        var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                         'July', 'August', 'September', 'October', 'November', 'December'];
        
        var firstDay = new Date(year, month, 1);
        var lastDay = new Date(year, month + 1, 0);
        var daysInMonth = lastDay.getDate();
        var firstDayOfWeek = firstDay.getDay(); // 0 = Sunday
        
        // Get previous month days to fill grid
        var prevMonthLastDay = new Date(year, month, 0).getDate();
        var prevMonthDays = [];
        for (var i = firstDayOfWeek - 1; i >= 0; i--) {
            prevMonthDays.push(prevMonthLastDay - i);
        }
        
        // Get next month days to fill grid
        var totalCells = 42; // 6 rows * 7 days
        var daysSoFar = prevMonthDays.length + daysInMonth;
        var nextMonthDays = totalCells - daysSoFar;
        var nextMonthDayNumbers = [];
        for (var i = 1; i <= nextMonthDays; i++) {
            nextMonthDayNumbers.push(i);
        }
        
        return {
            monthName: monthNames[month],
            year: year,
            month: month,
            daysInMonth: daysInMonth,
            firstDayOfWeek: firstDayOfWeek,
            prevMonthDays: prevMonthDays,
            nextMonthDays: nextMonthDayNumbers,
            today: new Date()
        };
    }
    
    function buildCalendarHeader(month, year, isAdmin, facilityFilter) {
        var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                         'July', 'August', 'September', 'October', 'November', 'December'];
        
        var html = '<div class="calendar-header">';
        html += '<div class="calendar-nav">';
        html += '<button class="calendar-nav-btn" onclick="navigateCalendar(-1, ' + isAdmin + ')">‚Äπ</button>';
        html += '<h2 class="calendar-title">' + monthNames[month] + ' ' + year + '</h2>';
        html += '<button class="calendar-nav-btn" onclick="navigateCalendar(1, ' + isAdmin + ')">‚Ä∫</button>';
        html += '</div>';
        
        // Quick navigation dropdowns for desktop
        html += '<div style="display: flex; gap: 0.5rem; align-items: center;">';
        
        if (!isAdmin) {
            html += '<select id="calendarFacility" class="calendar-select" onchange="loadCalendarView()" style="min-width: 150px;">';
            html += '<option value="all">All Facilities</option>';
            html += '<option value="clubhouse">üè† Clubhouse</option>';
            html += '<option value="gazebo">üå≥ Gazebo</option>';
            html += '<option value="recroom">üéÆ Rec Room</option>';
            html += '</select>';
            html += '<button class="btn btn-secondary btn-small" onclick="goToTodayCalendar(' + isAdmin + ')">Today</button>';
        } else {
            html += '<select id="adminCalendarFacility" class="calendar-select" onchange="loadAdminCalendar()" style="min-width: 150px;">';
            html += '<option value="all">All Facilities</option>';
            html += '<option value="clubhouse">üè† Clubhouse</option>';
            html += '<option value="gazebo">üå≥ Gazebo</option>';
            html += '<option value="recroom">üéÆ Rec Room</option>';
            html += '</select>';
            html += '<button class="btn btn-secondary btn-small" onclick="goToTodayCalendar(' + isAdmin + ')">Today</button>';
        }
        
        html += '</div>';
        html += '</div>';
        
        // Add info note for admin about cancelled bookings
        if (isAdmin) {
            html += '<div style="margin: 0.5rem 0; padding: 0.5rem; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107; font-size: 0.85rem;">';
            html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
            html += '<span>‚ÑπÔ∏è</span>';
            html += '<span>Cancelled bookings are hidden from calendar view. Check "Recent Bookings" table for complete history.</span>';
            html += '</div>';
            html += '</div>';
        }
        
        return html;
    }
    
    function buildCalendarGrid(calendarData, bookings, isAdmin) {

console.log('üìä buildCalendarGrid called');
  console.log('  Days in month:', calendarData.daysInMonth);
  console.log('  Total bookings to distribute:', bookings.length);


        var weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        var today = calendarData.today;
        
        var html = '<div class="calendar-weekdays">';
        weekdays.forEach(function(day) {
            html += '<div class="calendar-weekday">' + day + '</div>';
        });
        html += '</div>';
        
        html += '<div class="calendar-days">';
        
        // Previous month days
        calendarData.prevMonthDays.forEach(function(day) {
            var date = new Date(calendarData.year, calendarData.month - 1, day);
            html += buildDayCell(date, [], true, today, isAdmin);
        });
        
        // Current month days
        for (var day = 1; day <= calendarData.daysInMonth; day++) {
            var date = new Date(calendarData.year, calendarData.month, day);
            var dayBookings = getBookingsForDate(bookings, date);
            var isToday = isSameDay(date, today);
            html += buildDayCell(date, dayBookings, false, today, isAdmin);
        }
        
        // Next month days
        calendarData.nextMonthDays.forEach(function(day, index) {
            var date = new Date(calendarData.year, calendarData.month + 1, day);
            html += buildDayCell(date, [], true, today, isAdmin);
        });
        
        html += '</div>';
        
        return html;
    }
    
    function buildDayCell(date, dayBookings, isOtherMonth, today, isAdmin) {


console.log('üìÖ buildDayCell for:', date.toDateString(), 
              'Bookings:', dayBookings.length);
  
  if (dayBookings.length > 0) {
    console.log('  üìå HAS BOOKINGS:', dayBookings.map(b => b.bookingId));
  }

        var day = date.getDate();
        var month = date.getMonth();
        var year = date.getFullYear();
        var isToday = isSameDay(date, today);
        var isPast = date < new Date() && !isSameDay(date, new Date());
        var dateString = date.toISOString().split('T')[0];
        
        var cellClass = 'calendar-day';
        if (isOtherMonth) cellClass += ' other-month';
        if (isToday) cellClass += ' today';
        
        var html = '<div class="' + cellClass + '" data-date="' + dateString + '">';
        html += '<div class="calendar-day-header">';
        html += '<span class="calendar-day-number">' + day + '</span>';
        html += '</div>';
        
        // Show bookings for this day
        if (dayBookings.length > 0) {
            // Sort by start time
            dayBookings.sort(function(a, b) {
                return new Date(a.start) - new Date(b.start);
            });
            
            // For admin: show up to 4 events, for residents: show all
            var maxToShow = isAdmin ? 4 : 6;
            var bookingsToShow = dayBookings.slice(0, maxToShow);
            
            bookingsToShow.forEach(function(booking) {
                html += buildEventElement(booking, isAdmin);
            });
            
            // Show "more" indicator if there are more bookings
            if (dayBookings.length > maxToShow) {
                html += '<div class="calendar-event-more" onclick="showDayDetails(\'' + dateString + '\', ' + isAdmin + ')" title="Click to see all events">';
                html += '+' + (dayBookings.length - maxToShow) + ' more';
                html += '</div>';
            }
        }
        
        html += '</div>';
        return html;
    }
    
    function buildEventElement(booking, isAdmin) {

console.log('üõ†Ô∏è Building event for:', booking.bookingId, booking.title);
  
  var startTime = new Date(booking.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});


        var startTime = new Date(booking.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Google Calendar colors
        var colorClass = 'google-calendar-' + booking.facility;
        
        var title = (booking.title || booking.purpose || 'Booking').substring(0, 20);
        if ((booking.title || booking.purpose || 'Booking').length > 20) title += '...';
        
        var html = '<div class="calendar-event ' + colorClass + '" onclick="showEnhancedBookingDetails(\'' + booking.bookingId + '\', ' + isAdmin + ')" title="' + (booking.title || booking.purpose || 'Booking') + '">';
        html += '<div class="calendar-event-time">' + startTime + '</div>';
        html += '<div class="calendar-event-title">' + title + '</div>';
        html += '</div>';
        
        return html;
    }


    
function getBookingsForDate(bookings, date) {
  // Get local date components (what the user sees on calendar)
  const targetYear = date.getFullYear();
  const targetMonth = date.getMonth();
  const targetDay = date.getDate();
  
  // Filter bookings
  return bookings.filter(booking => {
    if (!booking.date) return false;
    
    try {
      // Parse booking date
      const bookingDate = new Date(booking.date);
      
      // Create a date at midnight in LOCAL timezone for comparison
      const bookingLocalMidnight = new Date(
        bookingDate.getFullYear(),
        bookingDate.getMonth(),
        bookingDate.getDate()
      );
      
      const targetLocalMidnight = new Date(targetYear, targetMonth, targetDay);
      
      // Compare timestamps (timezone neutral)
      return bookingLocalMidnight.getTime() === targetLocalMidnight.getTime();
      
    } catch (e) {
      return false;
    }
  });
}
    
    function isSameDay(date1, date2) {
        return date1.getDate() === date2.getDate() && 
               date1.getMonth() === date2.getMonth() && 
               date1.getFullYear() === date2.getFullYear();
    }
    
    function navigateCalendar(direction, isAdmin) {
        currentCalendarMonth += direction;
        
        if (currentCalendarMonth < 0) {
            currentCalendarMonth = 11;
            currentCalendarYear--;
        } else if (currentCalendarMonth > 11) {
            currentCalendarMonth = 0;
            currentCalendarYear++;
        }
        
        // Reload calendar view
        if (!isAdmin) {
            loadCalendarView();
        } else {
            loadAdminCalendar();
        }
    }
    
    function goToTodayCalendar(isAdmin) {
        var today = new Date();
        currentCalendarMonth = today.getMonth();
        currentCalendarYear = today.getFullYear();
        
        if (!isAdmin) {
            loadCalendarView();
        } else {
            loadAdminCalendar();
        }
    }
    
    function showDayDetails(dateString, isAdmin) {
        callAPI('getBookings', {}, function(response) {
            if (response.success && response.bookings) {
                var dayBookings = response.bookings.filter(function(booking) {
                    var bookingDate = new Date(booking.start).toISOString().split('T')[0];
                    return bookingDate === dateString;
                });
                
                // Filter out cancelled bookings for display
                dayBookings = dayBookings.filter(function(booking) {
                    return booking.status !== 'Cancelled';
                });
                
                if (dayBookings.length > 0) {
                    showDayModal(dayBookings, dateString, isAdmin);
                }
            }
        });
    }
    
    function showDayModal(bookings, dateString, isAdmin) {
        var date = new Date(dateString);
        var formattedDate = date.toLocaleDateString('en-AU', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        var html = '<div id="dayModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">';
        html += '<div style="background: white; width: 90%; max-width: 500px; border-radius: 12px; padding: 2rem; max-height: 90vh; overflow-y: auto;">';
        html += '<h3 style="margin-bottom: 1.5rem; color: var(--primary-blue);">üìÖ ' + formattedDate + '</h3>';
        
        if (bookings.length === 0) {
            html += '<p style="text-align: center; color: #666; padding: 2rem;">No bookings for this day.</p>';
        } else {
            html += '<div style="display: grid; gap: 1rem;">';
            bookings.forEach(function(booking) {
                var startTime = new Date(booking.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                var endTime = new Date(booking.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                var facilityIcon = booking.facility === 'clubhouse' ? 'üè†' : 
                                  booking.facility === 'gazebo' ? 'üå≥' : 'üéÆ';
                
                html += '<div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid ' + 
                        (booking.facility === 'clubhouse' ? '#7986cb' : booking.facility === 'gazebo' ? '#33b679' : '#8e24aa') + ';">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">';
                html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
                html += '<span style="font-size: 1.2em;">' + facilityIcon + '</span>';
                html += '<span style="font-weight: 600;">' + (booking.title || booking.purpose || 'Booking') + '</span>';
                html += '</div>';
                html += '</div>';
                html += '<div style="color: #666; font-size: 0.9rem;">' + startTime + ' - ' + endTime + '</div>';
                html += '<div style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">' + (booking.residentName || '') + '</div>';
                html += '</div>';
            });
            html += '</div>';
        }
        
        html += '<div class="btn-group" style="margin-top: 2rem;">';
        html += '<button class="btn btn-secondary" onclick="closeDayModal()" style="flex: 1;">Close</button>';
        html += '</div>';
        html += '</div></div>';
        
        // Remove existing modal
        var existingModal = document.getElementById('dayModal');
        if (existingModal) existingModal.remove();
        
        // Add new modal
        document.body.insertAdjacentHTML('beforeend', html);
    }
    
    function closeDayModal() {
        var modal = document.getElementById('dayModal');
        if (modal) modal.remove();
    }
    
    function showEnhancedBookingDetails(bookingId, isAdmin) {
  console.log('üöÄ FAST MODAL: Fetching single booking', bookingId);
  
  // üî• NEW: Fetch only the booking we need, not all bookings
  callAPI('getBooking', { 
    bookingId: bookingId 
  }, function(response) {
    if (response.success && response.booking) {
      console.log('‚úÖ FAST MODAL: Booking found, showing modal');
      showEnhancedBookingModal(response.booking, isAdmin);
    } else {
      console.log('‚ö†Ô∏è FAST MODAL: Booking not found');
      // Optional: Show a message to the user
      showMessage('Booking not found or has been cancelled', 'info');
    }
  });
}
    
    function showEnhancedBookingModal(booking, isAdmin) {
        var startTime = new Date(booking.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        var endTime = new Date(booking.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        var date = new Date(booking.start).toLocaleDateString('en-AU', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        var facilityName = booking.facility === 'clubhouse' ? 'Clubhouse' : 
                         booking.facility === 'gazebo' ? 'Gazebo' : 'Rec Room';
        var facilityIcon = booking.facility === 'clubhouse' ? 'üè†' : 
                          booking.facility === 'gazebo' ? 'üå≥' : 'üéÆ';
        
        var isCancelled = booking.status === 'Cancelled';
        var isPast = new Date(booking.end) < new Date();
        
        var modalHtml = 
            '<div id="enhancedBookingModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">' +
            '<div style="background: white; width: 90%; max-width: 500px; border-radius: 12px; padding: 2rem; max-height: 90vh; overflow-y: auto;">' +
            '<h3 style="margin-bottom: 1.5rem; color: var(--primary-blue);">üìÖ Booking Details</h3>' +
            
            '<div style="margin-bottom: 1.5rem;">' +
            '<div style="font-weight: bold; font-size: 1.2em; margin-bottom: 0.5rem; color: #333;">' + (booking.title || booking.purpose || 'Booking') + '</div>' +
            '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">' +
            '<span style="font-size: 1.3em;">' + facilityIcon + '</span>' +
            '<span style="font-weight: 600; color: var(--primary-blue);">' + facilityName + '</span>' +
            (isCancelled ? '<span style="background: #f8d7da; color: #721c24; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8em; margin-left: auto;">CANCELLED</span>' : '') +
            '</div>' +
            '</div>' +
            
            '<div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">' +
            '<div style="display: grid; gap: 1rem;">' +
            '<div>' +
            '<div style="font-size: 0.9em; color: #666; margin-bottom: 0.25rem;">Date & Time</div>' +
            '<div style="font-weight: 600;">' + date + '</div>' +
            '<div>' + startTime + ' - ' + endTime + '</div>' +
            '</div>' +
            
            '<div>' +
            '<div style="font-size: 0.9em; color: #666; margin-bottom: 0.25rem;">Requestor</div>' +
            '<div style="font-weight: 600;">' + (booking.residentName || 'N/A') + '</div>' +
            '<div style="font-size: 0.9em; color: #666;">' + (booking.residentEmail || '') + '</div>' +
            '</div>' +
            
            (booking.unitNumber ? 
            '<div>' +
            '<div style="font-size: 0.9em; color: #666; margin-bottom: 0.25rem;">Unit Number</div>' +
            '<div style="font-weight: 600;">' + booking.unitNumber + '</div>' +
            '</div>' : '') +
            
            '</div>' +
            '</div>' +
            
            '<div style="background: #e8f4fd; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; font-size: 0.9em; color: #555;">' +
            '<div style="margin-bottom: 0.25rem; font-weight: 600;">Booking ID:</div>' +
            '<div style="word-break: break-all;">' + booking.bookingId + '</div>' +
            '</div>';
        
        // Action buttons
        modalHtml += '<div class="btn-group">';
        
        if (isAdmin && !isCancelled && !isPast) {
            modalHtml += '<button class="btn btn-danger" onclick="adminCancelBooking(\'' + booking.bookingId + '\'); closeEnhancedBookingModal();">Cancel Booking</button>';
        } else if (!isAdmin && !isCancelled && !isPast && booking.residentEmail === userEmail) {
            modalHtml += '<button class="btn btn-secondary" onclick="cancelBooking(\'' + booking.bookingId + '\'); closeEnhancedBookingModal();">Cancel Booking</button>';
        }
        
        modalHtml += '<button class="btn btn-secondary" onclick="closeEnhancedBookingModal()">Close</button>';
        modalHtml += '</div>';
        
        modalHtml += '</div>' +
                    '</div>';
        
        // Remove existing modal
        var existingModal = document.getElementById('enhancedBookingModal');
        if (existingModal) existingModal.remove();
        
        // Add new modal
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    function closeEnhancedBookingModal() {
        var modal = document.getElementById('enhancedBookingModal');
        if (modal) modal.remove();
    }
    
    function showCalendarError(isAdmin) {
        var container = isAdmin ? document.getElementById('adminCalendar') : document.getElementById('simpleCalendar');
        if (!container) return;
        
        container.innerHTML = 
            '<div style="text-align: center; padding: 3rem; color: #666;">' +
            '<div style="font-size: 4em; margin-bottom: 1rem;">üìÖ</div>' +
            '<h3 style="color: var(--danger-color); margin-bottom: 1rem;">Could not load calendar</h3>' +
            '<p style="margin-bottom: 1.5rem;">Please try again later.</p>' +
            '<button class="btn btn-primary" onclick="' + (isAdmin ? 'loadAdminCalendar()' : 'loadCalendarView()') + '">üîÑ Try Again</button>' +
            '</div>';
    }
    
    function addCalendarNavigationListeners(isAdmin) {
        // Touch/swipe support for mobile
        var calendarContainer = document.querySelector('.calendar-days');
        if (calendarContainer) {
            var startX = 0;
            var endX = 0;
            
            calendarContainer.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
            });
            
            calendarContainer.addEventListener('touchend', function(e) {
                endX = e.changedTouches[0].clientX;
                var diff = startX - endX;
                
                if (Math.abs(diff) > 50) { // Minimum swipe distance
                    if (diff > 0) {
                        navigateCalendar(1, isAdmin); // Swipe left = next month
                    } else {
                        navigateCalendar(-1, isAdmin); // Swipe right = previous month
                    }
                }
            });
        }
    }
    
    // ========== RECURRING EVENTS FUNCTIONS ==========
    function showRecurringEventModal() {
        document.getElementById('recurringEventModal').style.display = 'flex';
    }
    
    function hideRecurringEventModal() {
        document.getElementById('recurringEventModal').style.display = 'none';
    }
    
    function toggleRecurringOptions() {
        var pattern = document.getElementById('recurringPattern').value;
        document.getElementById('weeklyOptions').style.display = 
            (pattern === 'weekly' || pattern === 'biweekly') ? 'block' : 'none';
    }
    
    function createRecurringEvents() {
        var eventName = document.getElementById('recurringEventName').value;
        var facility = document.getElementById('recurringFacility').value;
        var startDate = document.getElementById('recurringStartDate').value;
        var endDate = document.getElementById('recurringEndDate').value;
        var startTime = document.getElementById('recurringStartTime').value;
        var endTime = document.getElementById('recurringEndTime').value;
        var pattern = document.getElementById('recurringPattern').value;
        var occurrences = parseInt(document.getElementById('recurringOccurrences').value);
        
        if (!eventName || !facility || !startDate || !startTime || !endTime) {
            showMessage('Please fill in all required fields', 'error');
            return;
        }
        
        // Get selected days for weekly patterns
        var selectedDays = [];
        if (pattern === 'weekly' || pattern === 'biweekly') {
            document.querySelectorAll('input[name="recurringDays"]:checked').forEach(function(checkbox) {
                selectedDays.push(parseInt(checkbox.value));
            });
            
            if (selectedDays.length === 0) {
                showMessage('Please select at least one day for weekly patterns', 'error');
                return;
            }
        }
        
        // Show confirmation
        if (!confirm('This will create ' + occurrences + ' recurring bookings. Continue?')) {
            return;
        }
        
        showLoading(true);
        showMessage('üîÑ Creating recurring events...', 'info');
        
        // Calculate dates based on pattern
        var dates = calculateRecurringDates(startDate, pattern, occurrences, selectedDays, endDate);
        
        // Create bookings for each date
        var bookingsCreated = 0;
        var totalBookings = dates.length;
        
        function createNextBooking() {
            if (bookingsCreated >= totalBookings) {
                // All bookings created
                showLoading(false);
                showMessage('‚úÖ Created ' + bookingsCreated + ' recurring bookings!', 'success');
                hideRecurringEventModal();
                loadAdminBookings();
                loadAdminCalendar();
                return;
            }
            
            var currentDate = dates[bookingsCreated];
            createRecurringBooking(eventName, facility, currentDate, startTime, endTime, bookingsCreated + 1, function() {
                bookingsCreated++;
                
                // Update progress
                showMessage('üîÑ Creating recurring events... (' + bookingsCreated + '/' + totalBookings + ')', 'info');
                
                // Create next booking with a small delay to avoid overwhelming the server
                setTimeout(createNextBooking, 500);
            });
        }
        
        // Start creating bookings
        createNextBooking();
    }
    
    function calculateRecurringDates(startDate, pattern, occurrences, selectedDays, endDate) {
        var dates = [];
        var currentDate = new Date(startDate);
        var endDateTime = endDate ? new Date(endDate) : null;
        
        var weekCount = 0;
        
        while (dates.length < occurrences) {
            if (endDateTime && currentDate > endDateTime) {
                break; // Stop if we've passed the end date
            }
            
            var dateToAdd = null;
            
            switch(pattern) {
                case 'weekly':
                    // For weekly, check if current day is in selected days
                    var dayOfWeek = currentDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
                    if (selectedDays.includes(dayOfWeek)) {
                        dateToAdd = new Date(currentDate);
                    }
                    break;
                    
                case 'biweekly':
                    // For biweekly, check every 2 weeks
                    if (weekCount % 2 === 0) {
                        var dayOfWeek = currentDate.getDay();
                        if (selectedDays.includes(dayOfWeek)) {
                            dateToAdd = new Date(currentDate);
                        }
                    }
                    break;
                    
                case 'monthly':
                    // Monthly - same day of month
                    dateToAdd = new Date(currentDate);
                    // Move to next month for next iteration
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    break;
                    
                case 'monthly-weekday':
                    // Monthly - same weekday (e.g., "first Tuesday")
                    var baseDay = new Date(startDate).getDay();
                    var currentDay = currentDate.getDay();
                    
                    if (currentDay === baseDay) {
                        dateToAdd = new Date(currentDate);
                        // Move to next month for next iteration
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                    break;
            }
            
            if (dateToAdd) {
                dates.push(dateToAdd.toISOString().split('T')[0]);
            }
            
            // Move to next day (except for monthly patterns which already moved to next month)
            if (pattern !== 'monthly' && pattern !== 'monthly-weekday') {
                currentDate.setDate(currentDate.getDate() + 1);
                
                // Update week count for biweekly (when we hit Sunday)
                if (pattern === 'biweekly' && currentDate.getDay() === 0) {
                    weekCount++;
                }
            }
        }
        
        // If we didn't get enough dates, add some more
        while (dates.length < occurrences && dates.length > 0) {
            var lastDate = new Date(dates[dates.length - 1]);
            if (pattern === 'weekly' || pattern === 'biweekly') {
                lastDate.setDate(lastDate.getDate() + 7);
            } else {
                lastDate.setMonth(lastDate.getMonth() + 1);
            }
            dates.push(lastDate.toISOString().split('T')[0]);
        }
        
        return dates.slice(0, occurrences); // Return only the requested number
    }
    
    function createRecurringBooking(eventName, facility, date, startTime, endTime, occurrenceNumber, callback) {
        var bookingTitle = eventName + ' (Recurring #' + occurrenceNumber + ')';
        
        callAPI('createBooking', {
            facility: facility,
            title: bookingTitle,
            unitNumber: 'ADMIN',
            phone: '',
            date: date,
            startTime: startTime,
            endTime: endTime,
            residentName: 'Admin',
            residentEmail: 'irc.mtceteam+Admin@gmail.com',
            eventType: 'committee',
            purpose: eventName
        }, function(response) {
            if (response.success) {
                console.log('‚úÖ Created recurring booking #' + occurrenceNumber + ' for ' + date);
                if (callback) callback();
            } else {
                console.error('‚ùå Failed to create recurring booking #' + occurrenceNumber, response.error);
                if (callback) callback(); // Continue anyway
            }
        });
    }
    
    // ========== ADMIN FUNCTIONS ==========
    function adminLogin() {
        var password = document.getElementById('adminTabPassword').value;
        
        if (password === ADMIN_PASSWORD) {
            adminLoggedIn = true;
            
            document.getElementById('adminLoginSection').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            
            updateAdminTabVisibility();
            
            var today = new Date();
            var tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            
            document.getElementById('adminDate').valueAsDate = tomorrow;
            document.getElementById('recurringStartDate').valueAsDate = tomorrow;
            
            loadAdminBookings();
            
            showMessage('‚úÖ Admin access granted', 'success');
            
        } else {
            showMessage('‚ùå Invalid password', 'error');
        }
    }
    
    function adminLogout() {
        adminLoggedIn = false;
        
        document.getElementById('adminLoginSection').style.display = 'block';
        document.getElementById('adminDashboard').style.display = 'none';
        document.getElementById('adminTabPassword').value = '';
        
        updateAdminTabVisibility();
        showMessage('üëã Admin access ended', 'info');
        
        if (currentTab === 'admin') {
            showTab('booking');
        }
    }
    
    function createAdminBooking() {
        var facility = document.getElementById('adminFacility').value;
        var eventName = document.getElementById('adminEventName').value;
        var date = document.getElementById('adminDate').value;
        var startTime = document.getElementById('adminStartTime').value;
        var endTime = document.getElementById('adminEndTime').value;
        
        if (!facility || !eventName || !date || !startTime || !endTime) {
            showMessage('Please fill in all fields', 'error');
            return;
        }
        
        checkForConflicts(facility, date, startTime, endTime, function(conflicts) {
            if (conflicts.length > 0) {
                var conflictMessage = '‚ö†Ô∏è Time conflict detected!\n\n';
                conflictMessage += 'Conflicts with existing bookings:\n\n';
                
                conflicts.forEach(function(conflict, index) {
                    conflictMessage += (index + 1) + '. ' + conflict.title + '\n';
                    conflictMessage += '   ' + conflict.start + ' - ' + conflict.end + '\n';
                    conflictMessage += '   ' + (conflict.facility === 'clubhouse' ? 'üè† Clubhouse' : 
                                               conflict.facility === 'gazebo' ? 'üå≥ Gazebo' : 'üéÆ Rec Room') + '\n';
                    conflictMessage += '   Requestor: ' + conflict.residentName + '\n\n';
                });
                
                conflictMessage += 'Do you still want to create this booking?';
                
                if (!confirm(conflictMessage)) {
                    return; // User cancelled
                }
            }
            
            showLoading(true);
            
            callAPI('createBooking', {
                facility: facility,
                title: eventName,
                unitNumber: 'ADMIN',
                phone: '',
                date: date,
                startTime: startTime,
                endTime: endTime,
                residentName: 'Admin',
                residentEmail: 'admin@lakeillawong.com',
                eventType: 'other',
                purpose: eventName
            }, function(response) {
                showLoading(false);
                if (response.success) {
                    showMessage('‚úÖ Admin booking created successfully!', 'success');
                    
                    document.getElementById('adminEventName').value = '';
                    
                    loadAdminBookings();
                    loadAdminCalendar();
                    loadCalendarView();
                    
                } else {
                    showMessage('‚ùå Error: ' + (response.error || 'Unknown error'), 'error');
                }
            });
        });
    }
    
    function loadAdminBookings() {
        showLoading(true);
        
        callAPI('getBookings', {}, function(response) {
            showLoading(false);
            
            if (response.success && response.bookings) {
                var bookings = response.bookings;
                var filter = document.getElementById('adminBookingFilter').value;
                
                var filteredBookings = bookings;
                var now = new Date();
                
                switch(filter) {
                    case 'upcoming':
                        filteredBookings = bookings.filter(function(b) {
                            return new Date(b.end) > now && b.status !== 'Cancelled';
                        });
                        break;
                    case 'past':
                        filteredBookings = bookings.filter(function(b) {
                            return new Date(b.end) < now && b.status !== 'Cancelled';
                        });
                        break;
                    case 'cancelled':
                        filteredBookings = bookings.filter(function(b) {
                            return b.status === 'Cancelled';
                        });
                        break;
                }
                
                filteredBookings.sort(function(a, b) {
                    return new Date(b.start) - new Date(a.start);
                });
                
                displayAdminBookings(filteredBookings);
                updateSimpleStats(bookings);
                
            } else {
                document.getElementById('adminBookingsList').innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: #666;">' +
                    '<p>‚ùå Could not load bookings</p>' +
                    '</div>';
            }
        });
    }
    
    function displayAdminBookings(bookings) {
        var container = document.getElementById('adminBookingsList');
        if (!container) return;
        
        if (!bookings || bookings.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No bookings found.</div>';
            return;
        }
        
        var html = '<div style="display: grid; gap: 1rem;">';
        
        // Group bookings by status for better organization
        var upcomingBookings = [];
        var pastBookings = [];
        var cancelledBookings = [];
        
        var now = new Date();
        bookings.forEach(function(booking) {
            var isCancelled = booking.status === 'Cancelled';
            var isPast = new Date(booking.end) < now;
            
            if (isCancelled) {
                cancelledBookings.push(booking);
            } else if (isPast) {
                pastBookings.push(booking);
            } else {
                upcomingBookings.push(booking);
            }
        });
        
        // Show upcoming bookings first
        if (upcomingBookings.length > 0) {
            html += '<div style="margin-bottom: 1.5rem;">';
            html += '<h4 style="margin-bottom: 1rem; color: var(--primary-blue); padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color);">‚è∞ Upcoming Bookings</h4>';
            
            upcomingBookings.forEach(function(booking) {
                html += renderAdminBookingCard(booking);
            });
            html += '</div>';
        }
        
        // Show past bookings
        if (pastBookings.length > 0) {
            html += '<div style="margin-bottom: 1.5rem; opacity: 0.8;">';
            html += '<h4 style="margin-bottom: 1rem; color: #666; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color);">üìÖ Past Bookings</h4>';
            
            pastBookings.forEach(function(booking) {
                html += renderAdminBookingCard(booking);
            });
            html += '</div>';
        }
        
        // Show cancelled bookings in their own section
        if (cancelledBookings.length > 0) {
            html += '<div style="margin-bottom: 1.5rem; opacity: 0.7;">';
            html += '<h4 style="margin-bottom: 1rem; color: #666; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color);">‚ùå Cancelled Bookings</h4>';
            
            cancelledBookings.forEach(function(booking) {
                html += renderAdminBookingCard(booking);
            });
            html += '</div>';
        }
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    function renderAdminBookingCard(booking) {
        var startTime = new Date(booking.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        var endTime = new Date(booking.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        var date = new Date(booking.start).toLocaleDateString('en-AU', {
            weekday: 'short',
            month: 'short',
            day: 'numeric'
        });
        
        var isCancelled = booking.status === 'Cancelled';
        var isPast = new Date(booking.end) < new Date();
        
        var facilityIcon = booking.facility === 'clubhouse' ? 'üè†' : 
                          booking.facility === 'gazebo' ? 'üå≥' : 'üéÆ';
        
        var html = '<div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid ' + 
                    (isCancelled ? '#e74c3c' : isPast ? '#95a5a6' : '#3498db') + ';' +
                    (isCancelled ? ' opacity: 0.7;' : '') + '">';
        
        html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">';
        html += '<div>';
        html += '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">';
        html += '<span style="font-size: 1.1em;">' + facilityIcon + '</span>';
        html += '<span style="font-weight: 600;">' + (booking.title || booking.purpose || 'Booking') + '</span>';
        if (isCancelled) {
            html += '<span style="font-size: 0.8em; background: #f8d7da; color: #721c24; padding: 0.15rem 0.4rem; border-radius: 4px;">Cancelled</span>';
        }
        html += '</div>';
        html += '<div style="font-size: 0.9em; color: #666;">' + date + ' ‚Ä¢ ' + startTime + ' - ' + endTime + '</div>';
        html += '</div>';
        
        if (!isCancelled && !isPast) {
            html += '<button class="btn btn-danger btn-small" onclick="adminCancelBooking(\'' + booking.bookingId + '\')">Cancel</button>';
        }
        html += '</div>';
        
        html += '<div style="font-size: 0.85em; color: #666; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">';
        html += '<div><strong>' + (booking.residentName || 'N/A') + '</strong> ‚Ä¢ ' + (booking.residentEmail || '') + '</div>';
        if (booking.unitNumber && booking.unitNumber !== 'ADMIN') {
            html += '<div>Unit: ' + booking.unitNumber + '</div>';
        }
        html += '</div>';
        
        html += '</div>';
        return html;
    }
    
    function updateSimpleStats(bookings) {
        var statsDiv = document.getElementById('simpleAdminStats');
        if (!statsDiv || !bookings) return;
        
        var now = new Date();
        var totalBookings = bookings.length;
        var upcomingBookings = bookings.filter(function(b) {
            return new Date(b.end) > now && b.status !== 'Cancelled';
        }).length;
        var pastBookings = bookings.filter(function(b) {
            return new Date(b.end) < now && b.status !== 'Cancelled';
        }).length;
        var cancelledBookings = bookings.filter(function(b) {
            return b.status === 'Cancelled';
        }).length;
        
        statsDiv.innerHTML = 
            '<div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer;" onclick="document.getElementById(\'adminBookingFilter\').value=\'all\';loadAdminBookings()">' +
            '<div style="font-size: 1.8em; margin-bottom: 0.25rem; font-weight: bold;">' + totalBookings + '</div>' +
            '<div style="font-size: 0.9em; color: #666;">Total</div>' +
            '</div>' +
            '<div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer;" onclick="document.getElementById(\'adminBookingFilter\').value=\'upcoming\';loadAdminBookings()">' +
            '<div style="font-size: 1.8em; margin-bottom: 0.25rem; font-weight: bold; color: #28a745;">' + upcomingBookings + '</div>' +
            '<div style="font-size: 0.9em; color: #666;">Upcoming</div>' +
            '</div>' +
            '<div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer;" onclick="document.getElementById(\'adminBookingFilter\').value=\'past\';loadAdminBookings()">' +
            '<div style="font-size: 1.8em; margin-bottom: 0.25rem; font-weight: bold; color: #6c757d;">' + pastBookings + '</div>' +
            '<div style="font-size: 0.9em; color: #666;">Past</div>' +
            '</div>' +
            '<div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer;" onclick="document.getElementById(\'adminBookingFilter\').value=\'cancelled\';loadAdminBookings()">' +
            '<div style="font-size: 1.8em; margin-bottom: 0.25rem; font-weight: bold; color: #dc3545;">' + cancelledBookings + '</div>' +
            '<div style="font-size: 0.9em; color: #666;">Cancelled</div>' +
            '</div>';
    }
    
    // Helper function for admin to cancel bookings
    function adminCancelBooking(bookingId) {
        if (!confirm('Cancel this booking as admin?')) return;
        
        showLoading(true);
        
        callAPI('cancelBooking', {
            bookingId: bookingId,
            reason: 'Admin cancellation'
        }, function(response) {
            showLoading(false);
            if (response.success) {
                showMessage('‚úÖ Booking cancelled', 'success');
                loadAdminBookings();
                loadCalendarView();
                loadAdminCalendar();
            } else {
                showMessage('‚ùå Error cancelling booking: ' + (response.error || 'Unknown error'), 'error');
            }
        });
    }
    
    // ========== TAB NAVIGATION ==========
    function showTab(tabName) {
        if (tabName === 'admin' && !adminLoggedIn) {
            showMessage('Please log in as admin to access admin panel', 'info');
            return;
        }
        
        document.querySelectorAll('.nav-tab').forEach(function(tab) {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(function(content) {
            content.classList.remove('active');
        });
        
        var tabIndex = ['booking','view','calendar','guidelines','admin'].indexOf(tabName) + 1;
        var tabSelector = `.nav-tab:nth-child(${tabIndex})`;
        document.querySelector(tabSelector).classList.add('active');
        document.getElementById(tabName + 'Tab').classList.add('active');
        currentTab = tabName;
        
        if (tabName === 'admin') {
            updateAdminPanelBasedOnLogin();
        }
        
        if (tabName === 'view') {
            loadBookings();
        } else if (tabName === 'calendar') {
            setTimeout(() => {
                if (document.getElementById('simpleCalendar').innerHTML.includes('üìÖ')) {
                    loadCalendarView();
                }
            }, 300);
        } else if (tabName === 'admin' && adminLoggedIn) {
            var today = new Date();
            var tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            if (document.getElementById('adminDate')) {
                document.getElementById('adminDate').valueAsDate = tomorrow;
            }
            
            setTimeout(function() {
                loadAdminBookings();
                loadAdminCalendar();
            }, 300);
        }
    }
    
    // ========== ADMIN TAB VISIBILITY ==========
    function updateAdminTabVisibility() {
        var adminTabButton = document.getElementById('adminTabButton');
        if (adminTabButton) {
            adminTabButton.style.display = adminLoggedIn ? 'flex' : 'none';
        }
    }
    
    // ========== ALL DAY BOOKING ==========
    function toggleAllDayBooking() {
        var allDayCheckbox = document.getElementById('allDayBooking');
        var customRadio = document.querySelector('input[name="timeSlot"][value="custom"]');
        var customFields = document.getElementById('customTimeFields');
        
        if (allDayCheckbox.checked) {
            if (customRadio) {
                customRadio.checked = true;
                customRadio.dispatchEvent(new Event('change'));
                document.getElementById('startTime').value = '08:00';
                document.getElementById('endTime').value = '22:00';
                customFields.style.display = 'block';
            }
            
            document.querySelectorAll('input[name="timeSlot"]:not([value="custom"])').forEach(function(radio) {
                radio.disabled = true;
                radio.closest('.time-slot').style.opacity = '0.5';
                radio.closest('.time-slot').style.cursor = 'not-allowed';
            });
        } else {
            document.querySelectorAll('input[name="timeSlot"]:not([value="custom"])').forEach(function(radio) {
                radio.disabled = false;
                radio.closest('.time-slot').style.opacity = '1';
                radio.closest('.time-slot').style.cursor = 'pointer';
            });
            
            if (customRadio && customRadio.checked) {
                var firstRadio = document.querySelector('input[name="timeSlot"]:not([value="custom"])');
                if (firstRadio) {
                    firstRadio.checked = true;
                    firstRadio.dispatchEvent(new Event('change'));
                }
            }
        }
    }
    
    // ========== VIEW MODE MANAGEMENT ==========
    function showPublicView() {
        currentViewMode = 'public';
        userEmail = '';
        isAdmin = false;
        adminLoggedIn = false;
        
        document.getElementById('publicViewInfo').style.display = 'block';
        document.getElementById('personalViewForm').style.display = 'none';
        document.getElementById('adminLoginForm').style.display = 'none';
        document.getElementById('adminViewActive').style.display = 'none';
        
        document.getElementById('personalEmail').value = '';
        document.getElementById('adminPassword').value = '';
        
        updateAdminTabVisibility();
        
        loadBookings();
    }
    
    function showPersonalView() {
        document.getElementById('publicViewInfo').style.display = 'none';
        document.getElementById('personalViewForm').style.display = 'block';
        document.getElementById('adminLoginForm').style.display = 'none';
        document.getElementById('adminViewActive').style.display = 'none';
        
        document.getElementById('personalEmail').focus();
    }
    
    function toggleAdminLogin() {
        document.getElementById('publicViewInfo').style.display = 'none';
        document.getElementById('personalViewForm').style.display = 'none';
        document.getElementById('adminLoginForm').style.display = 'block';
        document.getElementById('adminViewActive').style.display = 'none';
        
        document.getElementById('adminPassword').focus();
    }
    
    function loadPersonalBookings() {
        var email = document.getElementById('personalEmail').value.trim();
        if (!email) {
            document.getElementById('personalEmailStatus').innerHTML = 
                '<span style="color: var(--danger-color);">Please enter your email address</span>';
            return;
        }
        
        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            document.getElementById('personalEmailStatus').innerHTML = 
                '<span style="color: var(--danger-color);">Please enter a valid email address</span>';
            return;
        }
        
        localStorage.setItem('lakeIllawongBookingEmail', email);
        
        currentViewMode = 'personal';
        userEmail = email;
        isAdmin = false;
        adminLoggedIn = false;
        
        document.getElementById('personalEmailStatus').innerHTML = 
            '<span style="color: var(--success-color);">Loading your bookings...</span>';
        
        updateAdminTabVisibility();
        
        loadBookings();
    }
    
    function loginAsAdmin() {
        var password = document.getElementById('adminPassword').value;
        
        if (password === ADMIN_PASSWORD) {
            currentViewMode = 'admin';
            userEmail = '';
            isAdmin = true;
            adminLoggedIn = true;
            
            updateAdminTabVisibility();
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('adminViewActive').style.display = 'block';
            document.getElementById('adminLoginStatus').innerHTML = 
                '<span style="color: var(--success-color);">Admin access granted</span>';
            
            document.getElementById('adminPassword').value = '';
            
            loadBookings();
            
            showMessage('‚úÖ Admin access granted. You can now access the Admin tab.', 'success');
            
        } else {
            document.getElementById('adminLoginStatus').innerHTML = 
                '<span style="color: var(--danger-color);">Incorrect password</span>';
        }
    }
    
    function logoutAdmin() {
        currentViewMode = 'public';
        userEmail = '';
        isAdmin = false;
        adminLoggedIn = false;
        
        updateAdminTabVisibility();
        showPublicView();
        
        if (document.getElementById('adminDashboard').style.display !== 'none') {
            document.getElementById('adminLoginSection').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('adminTabPassword').value = '';
        }
        
        showMessage('üëã Admin access ended', 'info');
    }
    
    function loadAllBookings() {
        loadBookings();
    }
    
    // ========== LOAD BOOKINGS ==========
   


// ========== LOAD BOOKINGS ==========
function loadBookings(forceRefresh = false) {
    console.log('loadBookings called, forceRefresh:', forceRefresh);
    
    // ===== CACHE CHECK =====
    const now = Date.now();
    if (!forceRefresh && cachedBookingsData && (now - bookingsCacheTime) < BOOKINGS_CACHE_TIME) {
        console.log('üì¶ Using cached bookings data');
        allBookings = cachedBookingsData;
        
        // Continue with your existing rendering logic
        var bookingsList = document.getElementById('bookingsList');
        if (!bookingsList) return;
        
        if (cachedBookingsData && cachedBookingsData.length > 0) {
            allBookings = cachedBookingsData;
            
            var filteredBookings = cachedBookingsData;
            
            if (currentViewMode === 'personal' && userEmail) {
                filteredBookings = cachedBookingsData.filter(function(booking) {
                    return booking.residentEmail && 
                           booking.residentEmail.toLowerCase() === userEmail.toLowerCase();
                });
            }
            
            filteredBookings.sort(function(a, b) {
                return new Date(b.start) - new Date(a.start);
            });
            
            var nowTime = new Date();
            var upcomingBookings = [];
            var pastBookings = [];
            
            filteredBookings.forEach(function(booking) {
                var bookingDate = new Date(booking.start);
                if (bookingDate >= nowTime) {
                    upcomingBookings.push(booking);
                } else {
                    pastBookings.push(booking);
                }
            });
            
            upcomingBookings.sort(function(a, b) {
                return new Date(a.start) - new Date(b.start);
            });
            
            var html = '';
            
            if (currentViewMode === 'public') {
                html += '<div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">';
                html += '<p><strong>Public View:</strong> Showing facility availability only. No personal details are shown.</p>';
                html += '<p style="margin-top: 0.5rem; font-size: 0.9em;">To view and manage your bookings, click "Show My Bookings" above.</p>';
                html += '</div>';
            } else if (currentViewMode === 'personal') {
                html += '<div style="background: #d4edda; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #28a745;">';
                html += '<p><strong>Personal View:</strong> Showing your bookings only. Email: ' + userEmail + '</p>';
                if (upcomingBookings.length === 0) {
                    html += '<p style="margin-top: 0.5rem; font-size: 0.9em;">You have no upcoming bookings.</p>';
                }
                html += '</div>';
            } else if (currentViewMode === 'admin') {
                html += '<div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #ffc107;">';
                html += '<p><strong>Admin View:</strong> Showing all bookings. You can manage any booking.</p>';
                html += '<p style="margin-top: 0.5rem; font-size: 0.9em;">Total bookings: ' + filteredBookings.length + '</p>';
                html += '</div>';
            }
            
            if (upcomingBookings.length > 0) {
                html += '<h3 style="margin-bottom: 1rem; color: var(--primary-blue);">Upcoming Bookings</h3>';
                html += '<div style="display: grid; gap: 1rem; margin-bottom: 2rem;">';
                
                upcomingBookings.forEach(function(booking) {
                    html += renderBookingCard(booking);
                });
                
                html += '</div>';
            }
            
            if ((currentViewMode === 'personal' || currentViewMode === 'admin') && pastBookings.length > 0) {
                html += '<h3 style="margin-bottom: 1rem; color: #666; border-top: 1px solid #dee2e6; padding-top: 1.5rem;">Past Bookings</h3>';
                html += '<div style="display: grid; gap: 1rem; opacity: 0.8;">';
                
                pastBookings.forEach(function(booking) {
                    html += renderBookingCard(booking);
                });
                
                html += '</div>';
            }
            
            if (filteredBookings.length === 0) {
                if (currentViewMode === 'personal') {
                    html += '<div style="text-align: center; padding: 3rem; color: #666;">';
                    html += '<div style="font-size: 2em; margin-bottom: 1rem;">üì≠</div>';
                    html += '<p style="font-size: 1.1em; margin-bottom: 0.5rem;">No bookings found for ' + userEmail + '</p>';
                    html += '<p>Make a booking using the "Make Booking" tab.</p>';
                    html += '</div>';
                } else {
                    html += '<p style="text-align: center; color: #666; padding: 2rem;">No bookings found.</p>';
                }
            }
            
            bookingsList.innerHTML = html;
            
            setTimeout(function() {
                document.querySelectorAll('.cancel-btn').forEach(function(button) {
                    button.addEventListener('click', function() {
                        var bookingId = this.getAttribute('data-booking-id');
                        if (bookingId) {
                            cancelBooking(bookingId);
                        }
                    });
                });
            }, 100);
            
        } else {
            bookingsList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No bookings found.</p>';
        }
        
        return; // Exit here - don't make API call
    }
    // ===== END CACHE CHECK =====
    
    console.log('üîÑ Fetching fresh bookings data from server');
    showLoading(true);
    
    callAPI('getBookings', {}, function(response) {
        showLoading(false);
        
        console.log('üìä Booking response:', response);
        
        var bookingsList = document.getElementById('bookingsList');
        if (!bookingsList) return;
        
        if (response.success && response.bookings && response.bookings.length > 0) {
            // ===== UPDATE CACHE =====
            cachedBookingsData = response.bookings;
            bookingsCacheTime = now;
            console.log('üíæ Cached', response.bookings.length, 'bookings');
            // ===== END UPDATE CACHE =====
            
            allBookings = response.bookings;
            
            var filteredBookings = response.bookings;
            
            if (currentViewMode === 'personal' && userEmail) {
                filteredBookings = response.bookings.filter(function(booking) {
                    return booking.residentEmail && 
                           booking.residentEmail.toLowerCase() === userEmail.toLowerCase();
                });
            }
            
            filteredBookings.sort(function(a, b) {
                return new Date(b.start) - new Date(a.start);
            });
            
            var nowTime = new Date();
            var upcomingBookings = [];
            var pastBookings = [];
            
            filteredBookings.forEach(function(booking) {
                var bookingDate = new Date(booking.start);
                if (bookingDate >= nowTime) {
                    upcomingBookings.push(booking);
                } else {
                    pastBookings.push(booking);
                }
            });
            
            upcomingBookings.sort(function(a, b) {
                return new Date(a.start) - new Date(b.start);
            });
            
            var html = '';
            
            if (currentViewMode === 'public') {
                html += '<div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">';
                html += '<p><strong>Public View:</strong> Showing facility availability only. No personal details are shown.</p>';
                html += '<p style="margin-top: 0.5rem; font-size: 0.9em;">To view and manage your bookings, click "Show My Bookings" above.</p>';
                html += '</div>';
            } else if (currentViewMode === 'personal') {
                html += '<div style="background: #d4edda; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #28a745;">';
                html += '<p><strong>Personal View:</strong> Showing your bookings only. Email: ' + userEmail + '</p>';
                if (upcomingBookings.length === 0) {
                    html += '<p style="margin-top: 0.5rem; font-size: 0.9em;">You have no upcoming bookings.</p>';
                }
                html += '</div>';
            } else if (currentViewMode === 'admin') {
                html += '<div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #ffc107;">';
                html += '<p><strong>Admin View:</strong> Showing all bookings. You can manage any booking.</p>';
                html += '<p style="margin-top: 0.5rem; font-size: 0.9em;">Total bookings: ' + filteredBookings.length + '</p>';
                html += '</div>';
            }
            
            if (upcomingBookings.length > 0) {
                html += '<h3 style="margin-bottom: 1rem; color: var(--primary-blue);">Upcoming Bookings</h3>';
                html += '<div style="display: grid; gap: 1rem; margin-bottom: 2rem;">';
                
                upcomingBookings.forEach(function(booking) {
                    html += renderBookingCard(booking);
                });
                
                html += '</div>';
            }
            
            if ((currentViewMode === 'personal' || currentViewMode === 'admin') && pastBookings.length > 0) {
                html += '<h3 style="margin-bottom: 1rem; color: #666; border-top: 1px solid #dee2e6; padding-top: 1.5rem;">Past Bookings</h3>';
                html += '<div style="display: grid; gap: 1rem; opacity: 0.8;">';
                
                pastBookings.forEach(function(booking) {
                    html += renderBookingCard(booking);
                });
                
                html += '</div>';
            }
            
            if (filteredBookings.length === 0) {
                if (currentViewMode === 'personal') {
                    html += '<div style="text-align: center; padding: 3rem; color: #666;">';
                    html += '<div style="font-size: 2em; margin-bottom: 1rem;">üì≠</div>';
                    html += '<p style="font-size: 1.1em; margin-bottom: 0.5rem;">No bookings found for ' + userEmail + '</p>';
                    html += '<p>Make a booking using the "Make Booking" tab.</p>';
                    html += '</div>';
                } else {
                    html += '<p style="text-align: center; color: #666; padding: 2rem;">No bookings found.</p>';
                }
            }
            
            bookingsList.innerHTML = html;
            
            setTimeout(function() {
                document.querySelectorAll('.cancel-btn').forEach(function(button) {
                    button.addEventListener('click', function() {
                        var bookingId = this.getAttribute('data-booking-id');
                        if (bookingId) {
                            cancelBooking(bookingId);
                        }
                    });
                });
            }, 100);
            
        } else {
            bookingsList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No bookings found.</p>';
        }
    });
}
// ========== END LOAD BOOKINGS ==========
    
    // ========== RENDER BOOKING CARD ==========
    function renderBookingCard(booking) {
        var startTime = new Date(booking.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        var endTime = new Date(booking.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        var date = new Date(booking.start).toLocaleDateString('en-AU', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        
        var bookingDate = new Date(booking.start);
        var now = new Date();
        var isPast = bookingDate < now;
        var isCancelled = booking.status === 'Cancelled';
        
        var facility = booking.facility || 'clubhouse';
        var facilityIcon = 'üè†';
        var borderColor = '#3498db';
        
        if (facility === 'gazebo') {
            facilityIcon = 'üå≥';
            borderColor = '#27ae60';
        } else if (facility === 'recroom') {
            facilityIcon = 'üéÆ';
            borderColor = '#9b59b6';
        }
        
        var facilityName = booking.facilityName || 
                         (facility === 'clubhouse' ? 'Clubhouse' : 
                          facility === 'gazebo' ? 'Gazebo' : 
                          'Rec Room');
        
        var eventTitle = booking.title || 
                        booking.purpose || 
                        booking.description || 
                        'Event Booking';
        
        var html = '';
        
        if (currentViewMode === 'public') {
            var statusBadge = '';
            var statusIcon = '‚úÖ';
            
            if (isCancelled) {
                statusBadge = '<span class="status-badge status-cancelled">CANCELLED</span>';
                statusIcon = '‚ùå';
            } else if (isPast) {
                statusBadge = '<span class="status-badge status-past">PAST</span>';
                statusIcon = '‚è∞';
            } else {
                statusBadge = '<span class="status-badge status-booked">BOOKED</span>';
                statusIcon = '‚úÖ';
            }
            
            html += '<div style="background: white; border-left: 4px solid ' + borderColor + '; padding: 1rem; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);' + (isCancelled ? ' opacity: 0.6;' : '') + '">';
            
            html += '<div style="display: flex; align-items: center; justify-content: space-between;">';
            html += '<div>';
            html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
            html += '<span style="font-size: 1.2em;">' + facilityIcon + '</span>';
            html += '<span style="font-weight: bold;">' + facilityName + '</span>';
            html += statusBadge;
            html += '</div>';
            html += '<div style="color: #666; font-size: 0.9rem; margin-top: 0.25rem;">';
            html += '<span>' + date + '</span>';
            html += '<span style="margin: 0 0.5rem;">‚Ä¢</span>';
            html += '<span>' + startTime + ' - ' + endTime + '</span>';
            html += '</div>';
            html += '</div>';
            
            html += '<div style="font-size: 1.5em;">' + statusIcon + '</div>';
            html += '</div>';
            
            html += '</div>';
            return html;
        }
        
        var additionalClass = '';
        if (isCancelled) {
            additionalClass = 'booking-cancelled';
        } else if (isPast) {
            additionalClass = 'booking-past';
        }
        
        html += '<div style="background: white; border-left: 4px solid ' + borderColor + '; padding: 1rem; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);" class="' + additionalClass + '">';
        
        html += '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">';
        html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
        html += '<span style="font-size: 1.2em;">' + facilityIcon + '</span>';
        html += '<span style="font-weight: bold; font-size: 0.95em;">' + facilityName + '</span>';
        
        if (isCancelled) {
            html += '<span class="status-badge status-cancelled">CANCELLED</span>';
        } else if (isPast) {
            html += '<span class="status-badge status-past">PAST</span>';
        } else {
            html += '<span class="status-badge status-booked">UPCOMING</span>';
        }
        html += '</div>';
        
        if (currentViewMode === 'admin') {
            html += '<span style="background: #fff3cd; color: #856404; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8em; font-weight: bold;">üõ†Ô∏è ADMIN VIEW</span>';
        }
        html += '</div>';
        
        var titleClass = isCancelled ? 'booking-title' : '';
        html += '<div style="font-weight: bold; margin-bottom: 0.75rem; font-size: 1.1em;" class="' + titleClass + '">' + eventTitle + '</div>';
        
        html += '<div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; line-height: 1.4;">';
        html += '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">';
        html += '<span style="font-size: 0.9em;">üìÖ</span>';
        html += '<span>' + date + '</span>';
        html += '</div>';
        html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
        html += '<span style="font-size: 0.9em;">üïê</span>';
        html += '<span>' + startTime + ' - ' + endTime + '</span>';
        html += '</div>';
        html += '</div>';
        
        if (currentViewMode === 'personal' || currentViewMode === 'admin') {
            html += '<div style="background: #f8f9fa; padding: 0.75rem; border-radius: 4px; margin-bottom: 0.75rem;">';
            html += '<div style="font-size: 0.9em; color: #555;">';
            
            html += '<div><strong>Requestor:</strong> ' + (booking.residentName || 'N/A') + '</div>';
            
            if (currentViewMode === 'admin') {
                html += '<div><strong>Email:</strong> ' + (booking.residentEmail || 'N/A') + '</div>';
                
                if (booking.unitNumber && booking.unitNumber !== 'N/A') {
                    html += '<div><strong>Unit:</strong> ' + booking.unitNumber + '</div>';
                }
            }
            
            html += '</div>';
            html += '</div>';
        }
        
        if (booking.bookingId) {
            html += '<div style="font-size: 0.8em; color: #888; margin-bottom: 0.75rem; background: #f8f9fa; padding: 0.4rem 0.6rem; border-radius: 4px; word-break: break-all;">';
            html += 'Booking ID: ' + booking.bookingId;
            html += '</div>';
        }
        
        if (!isCancelled && !isPast) {
            var showCancelButton = false;
            var cancelButtonStyle = '';
            
            if (currentViewMode === 'admin') {
                showCancelButton = true;
                cancelButtonStyle = 'btn-danger';
            } else if (currentViewMode === 'personal' && booking.residentEmail && 
                      booking.residentEmail.toLowerCase() === userEmail.toLowerCase()) {
                showCancelButton = true;
                cancelButtonStyle = 'btn-secondary';
            }
            
            if (showCancelButton) {
                html += '<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">';
                html += '<button class="btn btn-small ' + cancelButtonStyle + ' cancel-btn" data-booking-id="' + booking.bookingId + '" style="width: 100%;">';
                html += '‚ùå Cancel Booking';
                html += '</button>';
                html += '</div>';
            }
        }
        
        html += '</div>';
        return html;
    }
    
    // ========== CONFLICT CHECKING ==========
    function checkForConflicts(facility, date, startTime, endTime, callback) {
        console.log('üîç Checking for conflicts:', { facility, date, startTime, endTime });
        
        var requestedStart = new Date(date + 'T' + startTime);
        var requestedEnd = new Date(date + 'T' + endTime);
        
        callAPI('getBookings', {}, function(response) {
            if (response.success && response.bookings) {
                var conflicts = [];
                
                response.bookings.forEach(function(booking) {
                    if (booking.status === 'Cancelled') return;
                    
                    if (booking.facility !== facility && facility !== 'all') return;
                    
                    var bookingStart = new Date(booking.start);
                    var bookingEnd = new Date(booking.end);
                    
                    if (requestedStart < bookingEnd && requestedEnd > bookingStart) {
                        conflicts.push({
                            title: booking.title || booking.purpose || 'Booking',
                            start: bookingStart.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                            end: bookingEnd.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                            facility: booking.facility,
                            residentName: booking.residentName
                        });
                    }
                });
                
                if (typeof callback === 'function') {
                    callback(conflicts);
                }
            } else {
                console.error('‚ùå Failed to check conflicts');
                if (typeof callback === 'function') {
                    callback([]);
                }
            }
        });
    }
    
    // ========== BOOKING FUNCTIONS ==========
    function checkAvailability() {
        var facility = document.querySelector('input[name="facility"]:checked')?.value;
        var date = document.getElementById('eventDate').value;
        var timeSlot = document.querySelector('input[name="timeSlot"]:checked')?.value;
        
        if (!facility || !date || !timeSlot) {
            showMessage('Please fill in all required fields', 'error');
            return;
        }
        
        showLoading(true);
        
        var startTime, endTime;
        if (timeSlot === 'custom') {
            startTime = document.getElementById('startTime').value;
            endTime = document.getElementById('endTime').value;
            if (!startTime || !endTime) {
                showMessage('Please enter custom start and end times', 'error');
                showLoading(false);
                return;
            }
        } else {
            var times = timeSlot.split('-');
            startTime = times[0];
            endTime = times[1];
        }
        
        callAPI('checkAvailability', {
            facility: facility,
            date: date,
            startTime: startTime,
            endTime: endTime
        }, function(response) {
            showLoading(false);
            if (response.success) {
                if (response.available) {
                    showMessage('‚úÖ This time slot is available!', 'success');
                } else {
                    showMessage('‚ùå This time slot is not available', 'error');
                }
            } else {
                showMessage('‚ùå Error checking availability: ' + (response.error || 'Unknown error'), 'error');
            }
        });
    }
    
    function submitBooking() {
    var facility = document.querySelector('input[name="facility"]:checked')?.value;
    var eventName = document.getElementById('eventName').value;
    var unitNumber = document.getElementById('unitNumber').value;
    var phone = document.getElementById('phone').value;
    var eventDate = document.getElementById('eventDate').value;
    var yourName = document.getElementById('yourName').value;
    var email = document.getElementById('email').value;
    var timeSlot = document.querySelector('input[name="timeSlot"]:checked')?.value;
    var eventType = document.getElementById('eventType').value;
    var allDay = document.getElementById('allDayBooking').checked;
    
    if (!facility || !eventName || !unitNumber || !eventDate || !yourName || !email || !timeSlot || !eventType) {
        showMessage('Please fill in all required fields', 'error');
        return;
    }
    
    var startTime, endTime;
    if (timeSlot === 'custom') {
        startTime = document.getElementById('startTime').value;
        endTime = document.getElementById('endTime').value;
        if (!startTime || !endTime) {
            showMessage('Please enter custom start and end times', 'error');
            return;
        }
    } else {
        var times = timeSlot.split('-');
        startTime = times[0];
        endTime = times[1];
    }
    
    if (allDay) {
        startTime = '08:00';
        endTime = '22:00';
    }
    
    showLoading(true);
    
    callAPI('createBooking', {
        facility: facility,
        title: eventName,
        unitNumber: unitNumber,
        phone: phone,
        date: eventDate,
        startTime: startTime,
        endTime: endTime,
        residentName: yourName,
        residentEmail: email,
        eventType: eventType,
        purpose: eventName
    }, function(response) {
        showLoading(false);
        if (response.success) {
            // ===== CLEAR CACHE =====
            cachedBookingsData = null;
            bookingsCacheTime = 0;
            console.log('üßπ Cache cleared after new booking');
            // ===== END CLEAR CACHE =====
            
            showMessage('‚úÖ Booking created successfully! Booking ID: ' + response.bookingId, 'success');
            document.getElementById('bookingForm').reset();
            var tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('eventDate').valueAsDate = tomorrow;
            document.getElementById('allDayBooking').checked = false;
            loadBookings(true); // Changed to force refresh
            loadCalendarView();
        } else {
            showMessage('‚ùå Error creating booking: ' + (response.error || 'Unknown error'), 'error');
        }
    });
}
    
    function cancelBooking(bookingId) {
    var reason = prompt('Please enter a reason for cancellation:');
    if (reason === null) return;
    
    if (!reason.trim()) {
        showMessage('Cancellation reason is required', 'error');
        return;
    }
    
    showLoading(true);
    
    callAPI('cancelBooking', {
        bookingId: bookingId,
        reason: reason
    }, function(response) {
        showLoading(false);
        if (response.success) {
            // ===== CLEAR CACHE =====
            cachedBookingsData = null;
            bookingsCacheTime = 0;
            console.log('üßπ Cache cleared after booking cancellation');
            // ===== END CLEAR CACHE =====
            
            showMessage('‚úÖ Booking cancelled successfully', 'success');
            loadBookings(true); // CHANGED: Added true parameter
            loadCalendarView();
        } else {
            showMessage('‚ùå Error cancelling booking: ' + (response.error || 'Unknown error'), 'error');
        }
    });
}
    
    // ========== HELPER FUNCTIONS ==========
    function showLoading(show) {
        var loading = document.getElementById('loading');
        if (loading) {
            loading.style.display = show ? 'block' : 'none';
        }
    }
    
    function showMessage(text, type) {
        var message = document.getElementById('message');
        if (message) {
            message.textContent = text;
            message.className = 'message message-' + type;
            message.style.display = 'block';
            
            setTimeout(function() {
                message.style.display = 'none';
            }, 5000);
        }
    }
    
    function callAPI(action, data, callback) {
        showLoading(true);
        
        var now = Date.now();
        Object.keys(window).forEach(function(key) {
            if (key.startsWith('callback_') || key.startsWith('booking_pass_callback_')) {
                var match = key.match(/callback_(\d+)/);
                if (match) {
                    var timestamp = parseInt(match[1]);
                    if (now - timestamp > 30000) {
                        delete window[key];
                        console.log('üßπ Cleaned up stale callback:', key);
                    }
                }
            }
        });
        
        var url = BACKEND_URL + '?action=' + encodeURIComponent(action);
        
        Object.keys(data).forEach(function(key) {
            if (data[key] !== undefined && data[key] !== null) {
                url += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(data[key]);
            }
        });
        
        url += '&_t=' + Date.now();
        
        console.log('üì° API Call:', { action: action, url: url });
        
        var callbackName = 'callback_' + Date.now() + '_' + Math.random().toString(36).substr(2);
        window[callbackName] = function(response) {
            console.log('üì° API Response for', action, ':', response);
            showLoading(false);
            if (callback) callback(response);
            delete window[callbackName];
        };
        
        url += '&callback=' + callbackName;
        
        var script = document.createElement('script');
        script.src = url;
        script.onerror = function() {
            console.error('‚ùå API Error: Failed to load script for', action);
            showLoading(false);
            showMessage('‚ùå Failed to connect to server. Please try again.', 'error');
            if (callback) callback({success: false, error: 'Network error'});
        };
        
        var timeoutId = setTimeout(function() {
            console.warn('‚è∞ API Timeout for', action);
            showLoading(false);
            if (callback) callback({success: false, error: 'Request timeout'});
            delete window[callbackName];
        }, 10000);
        
        script.onload = function() {
            clearTimeout(timeoutId);
        };
        
        document.head.appendChild(script);
    }
    
    // ========== QUICK ACTIONS ==========
    function showAdminQuickCreate() {
        var form = document.querySelector('#adminTab .form-grid');
        if (form) {
            form.scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    function clearAdminForm() {
        document.getElementById('adminEventName').value = '';
        document.getElementById('adminDate').valueAsDate = new Date();
        document.getElementById('adminStartTime').value = '14:00';
        document.getElementById('adminEndTime').value = '16:00';
        showMessage('Form cleared', 'info');
    }
    
    function showAdminBlockTime() {
        var facility = 'clubhouse';
        var reason = prompt('Reason for blocking time (e.g., Maintenance, Cleaning, Private Event):');
        
        if (!reason) return;
        
        var tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        if (document.getElementById('adminFacility')) {
            document.getElementById('adminFacility').value = facility;
        }
        if (document.getElementById('adminEventName')) {
            document.getElementById('adminEventName').value = 'üö´ BLOCKED: ' + reason;
        }
        if (document.getElementById('adminDate')) {
            document.getElementById('adminDate').valueAsDate = tomorrow;
        }
        if (document.getElementById('adminStartTime')) {
            document.getElementById('adminStartTime').value = '08:00';
        }
        if (document.getElementById('adminEndTime')) {
            document.getElementById('adminEndTime').value = '22:00';
        }
        
        showMessage('‚úÖ Block time form filled. Review and click "Create Booking".', 'info');
        
        var form = document.querySelector('#adminTab .form-grid');
        if (form) {
            form.scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    // ========== QUICK CHECK FUNCTIONS ==========
    function quickCheckAvailability() {
        var date = document.getElementById('quickDate').value;
        var startTime = document.getElementById('quickStartTime').value;
        var endTime = document.getElementById('quickEndTime').value;
        
        if (!date || !startTime || !endTime) {
            showMessage('Please fill in all fields', 'error');
            return;
        }
        
        showLoading(true);
        
        var facilities = ['clubhouse', 'gazebo', 'recroom'];
        var availableFacilities = [];
        var checksCompleted = 0;
        
        facilities.forEach(function(facility) {
            callAPI('checkAvailability', {
                facility: facility,
                date: date,
                startTime: startTime,
                endTime: endTime
            }, function(response) {
                checksCompleted++;
                
                if (response.success && response.available) {
                    availableFacilities.push(facility);
                }
                
                if (checksCompleted === facilities.length) {
                    showLoading(false);
                    displayQuickAvailabilityResult(date, startTime, endTime, availableFacilities);
                }
            });
        });
    }
    
    function displayQuickAvailabilityResult(date, startTime, endTime, availableFacilities) {
        var resultDiv = document.getElementById('quickAvailabilityResult');
        if (!resultDiv) return;
        
        var dateObj = new Date(date);
        var formattedDate = dateObj.toLocaleDateString('en-AU', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        var html = '<div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 1rem;">';
        html += '<h4 style="margin-bottom: 0.5rem; color: var(--primary-blue);">Availability for ' + formattedDate + '</h4>';
        html += '<p style="margin-bottom: 1rem; color: #666;">' + startTime + ' - ' + endTime + '</p>';
        
        if (availableFacilities.length === 0) {
            html += '<div style="color: var(--danger-color); margin-bottom: 1rem;">‚ùå No facilities available for this time slot.</div>';
        } else {
            html += '<div style="color: var(--success-color); margin-bottom: 1rem;">‚úÖ Available facilities:</div>';
            html += '<div style="display: grid; gap: 0.5rem;">';
            
            availableFacilities.forEach(function(facility) {
                var facilityName = facility === 'clubhouse' ? 'üè† Clubhouse' : 
                                 facility === 'gazebo' ? 'üå≥ Gazebo' : 'üéÆ Rec Room';
                html += '<div style="background: white; padding: 0.75rem; border-radius: 6px; border-left: 4px solid var(--success-color);">';
                html += facilityName + ' - <span style="color: var(--success-color); font-weight: 600;">Available</span>';
                html += '</div>';
            });
            
            html += '</div>';
        }
        
        html += '</div>';
        
        resultDiv.innerHTML = html;
        resultDiv.style.display = 'block';
    }
    
    function autoFillFromQuickCheck() {
        var date = document.getElementById('quickDate').value;
        var startTime = document.getElementById('quickStartTime').value;
        var endTime = document.getElementById('quickEndTime').value;
        
        if (!date || !startTime || !endTime) {
            showMessage('Please check availability first', 'error');
            return;
        }
        
        document.getElementById('eventDate').value = date;
        
        var customRadio = document.querySelector('input[name="timeSlot"][value="custom"]');
        if (customRadio) {
            customRadio.checked = true;
            customRadio.dispatchEvent(new Event('change'));
            document.getElementById('startTime').value = startTime;
            document.getElementById('endTime').value = endTime;
        }
        
        document.getElementById('quickAvailabilityResult').style.display = 'none';
        
        showMessage('‚úÖ Times filled into booking form!', 'success');
    }

    
</script>
</body>
</html>