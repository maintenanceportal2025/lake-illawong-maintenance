<!--
=================================================================
MAINTENANCE PORTAL v2.3 - CRITICAL LIVE DATA SYNC FIX
=================================================================

üö® CRITICAL UPDATE: Fixed Google Sheets API sync functionality

üìã CHANGES MADE:
- Fixed handleSaveChanges() function using POST + JSON instead of GET + URL params
- Added proper error handling and user feedback for save operations  
- Implemented data source awareness (only syncs when live data detected)
- Enhanced date formatting to handle both input and API formats
- Improved visual feedback with different save state indicators

‚úÖ ISSUES RESOLVED:
- Live data updates now properly sync back to Google Sheets
- Save button provides clear feedback (Saving... ‚Üí Saved to Sheets! ‚Üí Ready)
- Error handling prevents data loss if sync fails
- Works correctly with both live and sample data modes

üéØ DEPLOYMENT TARGET:
- GitHub Repo: maintenanceportal2025
- Auto-deploys to: timely-haupia-9c75dc.netlify.app
- Replaces: Previous index.html completely

üß™ TESTING CHECKLIST:
1. Login with password 'maint2025'
2. Verify live data loads (should show "üü¢ Live Data (X problems loaded)")
3. Open any problem record
4. Make a test change (e.g., update priority or comments)
5. Click 'Save Changes' - should show "‚úÖ Saved to Sheets!"
6. Verify change persists after refresh/reload

‚ö†Ô∏è CRITICAL: This fixes the main blocking issue preventing live updates.
All other portal features (reports, filtering, navigation) remain intact.

Status: Ready for immediate deployment and testing
Priority: HIGH - Core functionality fix
=================================================================
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Portal v2.3 - Live Data</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Login Styles */
        .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 400px; width: 100%; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-title { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .login-subtitle { color: #666; margin-bottom: 20px; }
        .data-status { margin-bottom: 15px; padding: 10px; border-radius: 5px; font-size: 12px; text-align: center; }
        .data-status.loading { background: #e3f2fd; color: #1976d2; }
        .data-status.live { background: #e8f5e8; color: #2e7d32; }
        .data-status.sample { background: #fff3e0; color: #f57c00; }
        .data-status.error { background: #ffebee; color: #c62828; }
        .warning-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; }
        .warning-text { color: #856404; font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .form-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 5px rgba(37,99,235,0.3); }
        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .version-info { font-size: 12px; color: #666; text-align: center; margin-top: 20px; }
        
        /* Main Portal Styles */
        .header { background: #2563eb; color: white; padding: 20px; }
        .header-title { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
        .header-subtitle { font-size: 16px; opacity: 0.9; }
        .search-bar { background: white; padding: 20px; border-bottom: 1px solid #e5e7eb; }
        .search-container { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; }
        .search-input { flex: 1; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; }
        .search-btn { padding: 12px 24px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .filters { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 16px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 20px; cursor: pointer; transition: all 0.2s; }
        .filter-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        .filter-btn:hover { background: #f3f4f6; }
        .filter-btn.active:hover { background: #1d4ed8; }
        
        /* Problem Cards */
        .problems-container { padding: 20px; }
        .problems-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .problems-title { font-size: 20px; font-weight: bold; color: #1f2937; }
        /* NEW: Report actions styling */
        .report-actions { display: flex; gap: 10px; }
        .problem-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; }
        .problem-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: #2563eb; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .card-pid { font-size: 18px; font-weight: bold; color: #1f2937; }
        .card-unit { color: #6b7280; margin-left: 8px; }
        .card-badges { display: flex; gap: 8px; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .badge-urgent { background: #fef2f2; color: #dc2626; }
        .badge-high { background: #fff7ed; color: #ea580c; }
        .badge-medium { background: #fefce8; color: #ca8a04; }
        .badge-low { background: #f0fdf4; color: #16a34a; }
        .badge-reported { background: #eff6ff; color: #2563eb; }
        .badge-inprogress { background: #fff7ed; color: #ea580c; }
        .badge-completed { background: #f0fdf4; color: #16a34a; }
        .badge-onhold { background: #faf5ff; color: #9333ea; }
        .badge-cancelled { background: #f9fafb; color: #6b7280; }
        .card-description { color: #374151; margin-bottom: 12px; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #6b7280; }
        
        /* Editor Styles */
        .editor-header { background: #2563eb; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .back-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .back-btn:hover { background: rgba(255,255,255,0.3); }
        .editor-actions { display: flex; gap: 10px; }
        .editor-content { padding: 20px; }
        .section { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .section-title { font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .form-full { grid-column: span 2; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-select { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e"); background-position: right 8px center; background-repeat: no-repeat; background-size: 16px; }
        .notification-field { border: 2px solid #f97316; }
        .notification-warning { background: #fff7ed; border-left: 4px solid #f97316; padding: 12px; margin-bottom: 16px; border-radius: 4px; }
        .notification-warning-text { color: #c2410c; font-size: 14px; font-weight: 500; }
        .save-indicator { padding: 8px 12px; background: #f0fdf4; color: #16a34a; border-radius: 6px; font-size: 14px; }
        
        /* Loading Spinner */
        .spinner { border: 3px solid #f3f4f6; border-top: 3px solid #2563eb; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 90vw; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: bold; color: #1f2937; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; }
        .close-btn:hover { color: #374151; }
        .modal-actions { display: flex; gap: 12px; margin-top: 20px; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .form-row { grid-template-columns: 1fr; }
            .form-full { grid-column: span 1; }
            .search-container { flex-direction: column; align-items: stretch; }
            .filters { justify-content: center; }
            .card-header { flex-direction: column; align-items: flex-start; gap: 8px; }
            .card-badges { margin-left: 0; }
            .editor-header { flex-direction: column; gap: 15px; }
            .editor-actions { width: 100%; justify-content: center; }
            .report-actions { flex-direction: column; width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-header">
                <h1 class="login-title">Maintenance Portal</h1>
                <p class="login-subtitle">Fault Management System v2.3</p>
                
                <!-- Data Source Status Indicator -->
                <div id="dataStatus" class="data-status loading">
                    <div class="spinner"></div> Loading system data...
                </div>
                
                <div class="warning-box">
                    <p class="warning-text">‚ö†Ô∏è Maintenance Team Access Only</p>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Password:</label>
                <div style="position: relative;">
                    <input type="password" id="passwordInput" class="form-input" placeholder="Enter maintenance password">
                    <button type="button" id="togglePassword" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #6b7280;">üëÅÔ∏è</button>
                </div>
            </div>
            
            <button id="loginBtn" class="btn btn-primary" style="width: 100%;">Access Portal</button>
            
            <div class="version-info">
                Version 2.3 ‚Ä¢ Live Google Sheets Integration
            </div>
        </div>
    </div>

    <!-- Main Portal -->
    <div id="mainPortal" class="hidden">
        <!-- Problem List View -->
        <div id="listView">
            <div class="header">
                <h1 class="header-title">Maintenance Portal</h1>
                <p class="header-subtitle">Fault Management System</p>
            </div>
            
            <div class="search-bar">
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="PID 110716">
                    <button id="searchBtn" class="search-btn">Search</button>
                </div>
                
                <div class="filters">
                    <button class="filter-btn active" data-filter="All Problems">All Problems</button>
                    <button class="filter-btn" data-filter="Reported">Reported</button>
                    <button class="filter-btn" data-filter="In Progress">In Progress</button>
                    <button class="filter-btn" data-filter="On Hold">On Hold</button>
                    <button class="filter-btn" data-filter="Completed">Completed</button>
                    <button class="filter-btn" data-filter="Cancelled">Cancelled</button>
                </div>
            </div>
            
            <div class="problems-container">
                <div class="problems-header">
                    <h2 id="problemsTitle" class="problems-title">All Problems (0)</h2>
                    <!-- NEW: Report action buttons -->
                    <div class="report-actions">
                        <button id="viewListReportBtn" class="btn btn-secondary">üëÅÔ∏è View Report</button>
                        <button id="copyListReportBtn" class="btn btn-success">üìã Copy Report</button>
                    </div>
                </div>
                <div id="problemsList"></div>
            </div>
        </div>

        <!-- Problem Editor View -->
        <div id="editorView" class="hidden">
            <div class="editor-header">
                <button id="backBtn" class="back-btn">
                    ‚Üê Back to Problems
                </button>
                <div class="editor-actions">
                    <button id="viewReportBtn" class="btn btn-secondary">üëÅÔ∏è View Report</button>
                    <button id="copyDetailReportBtn" class="btn btn-success">üìã Copy Report</button>
                    <button id="saveChangesBtn" class="btn btn-primary">üíæ Save Changes</button>
                </div>
            </div>
            
            <div class="editor-content">
                <!-- Section 1: Problem Details -->
                <div class="section">
                    <h3 class="section-title">üè† Problem Details</h3>
                    <div class="form-row">
                        <div>
                            <label class="form-label">Reported Date</label>
                            <input type="date" id="reportedDate" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">Unit Number</label>
                            <input type="text" id="unitNumber" class="form-input" placeholder="A-201">
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label class="form-label">Reported By</label>
                            <input type="text" id="reportedBy" class="form-input" placeholder="John Smith">
                        </div>
                        <div>
                            <label class="form-label">Zone</label>
                            <select id="zone" class="form-input form-select">
                                <option value="">Select Zone</option>
                                <option value="Zone A">Zone A</option>
                                <option value="Zone B">Zone B</option>
                                <option value="Zone C">Zone C</option>
                                <option value="Zone D">Zone D</option>
                                <option value="Zone E">Zone E</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label class="form-label">Resident Name</label>
                            <input type="text" id="residentName" class="form-input" placeholder="John Smith">
                        </div>
                        <div>
                            <label class="form-label">Resident Mobile</label>
                            <input type="tel" id="residentMobile" class="form-input" placeholder="0412345678">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-full">
                            <label class="form-label">Problem Description</label>
                            <textarea id="problemDescription" class="form-input form-textarea" placeholder="Detailed description of the issue"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Problem Assignment -->
                <div class="section">
                    <h3 class="section-title">‚öôÔ∏è Problem Assignment</h3>
                    <div class="form-row">
                        <div>
                            <label class="form-label">Category</label>
                            <select id="category" class="form-input form-select">
                                <option value="">Select Category</option>
                                <option value="Plumbing">Plumbing</option>
                                <option value="Electrical">Electrical</option>
                                <option value="HVAC">HVAC</option>
                                <option value="Appliances">Appliances</option>
                                <option value="Structural">Structural</option>
                                <option value="Security">Security</option>
                                <option value="Landscaping">Landscaping</option>
                                <option value="General">General</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Sub-Category</label>
                            <input type="text" id="subCategory" class="form-input" placeholder="Faucet Repair">
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label class="form-label">Assigned To</label>
                            <select id="assignedTo" class="form-input form-select">
                                <option value="">Select Technician</option>
                                <option value="Mike Johnson">Mike Johnson</option>
                                <option value="Sarah Wilson">Sarah Wilson</option>
                                <option value="David Brown">David Brown</option>
                                <option value="Lisa Chen">Lisa Chen</option>
                                <option value="Tom Davis">Tom Davis</option>
                            </select>
                        </div>
                        <div class="form-full">
                            <label class="form-label">Internal Comments</label>
                            <textarea id="internalComments" class="form-input form-textarea" placeholder="Internal notes and comments"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Resident Notification Fields -->
                <div class="section">
                    <h3 class="section-title">üîî Resident Notification Fields</h3>
                    <div class="notification-warning">
                        <p class="notification-warning-text">‚ö†Ô∏è Changes to the fields below may trigger notifications to residents</p>
                    </div>
                    <div class="form-row">
                        <div>
                            <label class="form-label">Priority</label>
                            <select id="priority" class="form-input form-select notification-field">
                                <option value="">Select Priority</option>
                                <option value="Urgent">Urgent</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Status</label>
                            <select id="problemStatus" class="form-input form-select notification-field">
                                <option value="">Select Status</option>
                                <option value="Reported">Reported</option>
                                <option value="In Progress">In Progress</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label class="form-label">Completion Date</label>
                            <input type="date" id="completionDate" class="form-input notification-field">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Reports -->
    <div id="modalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Problem Report</h3>
                <button id="closeModal" class="close-btn">√ó</button>
            </div>
            <div id="modalBody" style="white-space: pre-wrap; font-family: monospace; font-size: 14px; line-height: 1.5;"></div>
            <div class="modal-actions">
                <button id="copyReportBtn" class="btn btn-primary">üìã Copy to Clipboard</button>
                <button id="closeModalBtn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ LIVE DATA INTEGRATION - V2.3 (PRESERVED FROM WORKING VERSION)
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxFcoYqb5e5Wg6Z94uyC3h5pY2BShSkqImXfb9p9OzDIBNcsOYKbEeKm7CWaNLw-skx/exec';
        
        // Sample data fallback
        const sampleFaultLogData = [
            {
                reportedDate: '15/01/2025', unitNumber: 'A-201', reportedBy: 'John Smith',
                problemDescription: 'Kitchen faucet leaking continuously, water damage to cabinet below',
                zone: 'Zone A', residentName: 'John Smith', residentMobile: '0412345678',
                internalId: '20250616-110716', problemStatus: 'Reported', priority: 'Urgent',
                internalComments: 'Requires immediate attention', category: 'Plumbing', subCategory: 'Faucet Repair',
                assignedTo: 'Mike Johnson', completionDate: ''
            },
            {
                reportedDate: '14/01/2025', unitNumber: 'B-105', reportedBy: 'Sarah Johnson',
                problemDescription: 'Air conditioning unit not cooling properly, temperature not reaching set point',
                zone: 'Zone B', residentName: 'Sarah Johnson', residentMobile: '0423456789',
                internalId: '20250612-143022', problemStatus: 'In Progress', priority: 'High',
                internalComments: 'Technician scheduled for tomorrow', category: 'HVAC', subCategory: 'AC Repair',
                assignedTo: 'David Brown', completionDate: ''
            },
            {
                reportedDate: '12/01/2025', unitNumber: 'C-302', reportedBy: 'David Wilson',
                problemDescription: 'Bathroom exhaust fan making loud grinding noise',
                zone: 'Zone C', residentName: 'David Wilson', residentMobile: '0434567890',
                internalId: '20250610-092345', problemStatus: 'Completed', priority: 'Medium',
                internalComments: 'Fan motor replaced successfully', category: 'Electrical', subCategory: 'Fan Repair',
                assignedTo: 'Lisa Chen', completionDate: '13/01/2025'
            },
            {
                reportedDate: '10/01/2025', unitNumber: 'D-404', reportedBy: 'Lisa Chen',
                problemDescription: 'Front door lock sticking, key difficult to turn',
                zone: 'Zone D', residentName: 'Lisa Chen', residentMobile: '0445678901',
                internalId: '20250608-165530', problemStatus: 'On Hold', priority: 'Low',
                internalComments: 'Waiting for replacement lock parts', category: 'Security', subCategory: 'Lock Repair',
                assignedTo: 'Tom Davis', completionDate: ''
            },
            {
                reportedDate: '08/01/2025', unitNumber: 'E-506', reportedBy: 'Mark Taylor',
                problemDescription: 'Living room light fixture flickering intermittently',
                zone: 'Zone E', residentName: 'Mark Taylor', residentMobile: '0456789012',
                internalId: '20250608-133421', problemStatus: 'Cancelled', priority: 'Low',
                internalComments: 'Resident fixed the issue themselves', category: 'Electrical', subCategory: 'Lighting',
                assignedTo: '', completionDate: ''
            }
        ];

        // Global state
        let problems = [...sampleFaultLogData];
        let filteredProblems = [...problems];
        let selectedProblem = null;
        let currentFilter = 'All Problems';
        let isAuthenticated = false;
        let loginAttempts = 0;
        let isLocked = false;
        let hasChanges = false;
        let dataSource = 'sample';

        // ‚úÖ LOAD LIVE DATA ON STARTUP (PRESERVED FROM WORKING VERSION)
        async function loadFaultLogData() {
            const statusElement = document.getElementById('dataStatus');
            statusElement.innerHTML = '<div class="spinner"></div> Loading live data...';
            statusElement.className = 'data-status loading';

            try {
                console.log('üöÄ Attempting to load live data from:', WEB_APP_URL);
                
                const apiUrl = `${WEB_APP_URL}?action=getFaultLogData`;
                console.log('üìû Full API call:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('üì° Response status:', response.status);
                
                const data = await response.json();
                console.log('üìä Response data:', data);
                
                if (data.success && data.problems) {
                    problems = data.problems;
                    dataSource = 'live';
                    statusElement.innerHTML = `üü¢ Live Data (${data.count} problems loaded)`;
                    statusElement.className = 'data-status live';
                    console.log(`‚úÖ Loaded ${data.count} problems from FaultLog`);
                } else {
                    console.warn('‚ö†Ô∏è API returned success=false, using sample data:', data.message);
                    problems = [...sampleFaultLogData];
                    dataSource = 'sample';
                    statusElement.innerHTML = '‚ö†Ô∏è Sample Data (API connection failed)';
                    statusElement.className = 'data-status sample';
                }
            } catch (error) {
                console.error('‚ùå Error loading FaultLog data:', error);
                console.log('üìã Using sample data as fallback');
                problems = [...sampleFaultLogData];
                dataSource = 'sample';
                statusElement.innerHTML = '‚ö†Ô∏è Sample Data (Connection error)';
                statusElement.className = 'data-status error';
            }
            
            filteredProblems = [...problems];
            updateProblemsDisplay();
        }

        // Extract PID from internal ID
        function extractPID(internalId) {
            if (!internalId || typeof internalId !== 'string') return 'N/A';
            const parts = internalId.split('-');
            if (parts.length >= 2) {
                return parts[1]; // Return the time part directly (e.g., '110716')
            }
            return internalId.slice(-6);
        }

        // Login functionality
        function handleLogin() {
            const password = document.getElementById('passwordInput').value;
            
            if (isLocked) {
                alert('Too many failed attempts. Please wait before trying again.');
                return;
            }

            if (password === 'maint2025') {
                isAuthenticated = true;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainPortal').classList.remove('hidden');
                updateProblemsDisplay();
                loginAttempts = 0;
            } else {
                loginAttempts++;
                
                if (loginAttempts >= 3) {
                    isLocked = true;
                    setTimeout(() => {
                        isLocked = false;
                        loginAttempts = 0;
                    }, 30000);
                    alert('Too many failed attempts. Account locked for 30 seconds.');
                } else {
                    alert(`Incorrect password. ${3 - loginAttempts} attempts remaining.`);
                }
                document.getElementById('passwordInput').value = '';
            }
        }

        // Filter and search functionality
        function filterProblems() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            filteredProblems = problems.filter(problem => {
                const matchesSearch = !searchQuery || 
                    extractPID(problem.internalId).toLowerCase().includes(searchQuery) ||
                    problem.unitNumber.toLowerCase().includes(searchQuery) ||
                    problem.problemDescription.toLowerCase().includes(searchQuery) ||
                    problem.reportedBy.toLowerCase().includes(searchQuery);
                
                const matchesFilter = currentFilter === 'All Problems' || 
                    problem.problemStatus === currentFilter;
                
                return matchesSearch && matchesFilter;
            });
            
            updateProblemsDisplay();
        }

        // Update problems display
        function updateProblemsDisplay() {
            const problemsList = document.getElementById('problemsList');
            const problemsTitle = document.getElementById('problemsTitle');
            
            const count = filteredProblems.length;
            problemsTitle.textContent = `${currentFilter} (${count})`;
            
            if (count === 0) {
                problemsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No problems found</div>';
                return;
            }
            
            problemsList.innerHTML = filteredProblems.map(problem => {
                const pid = extractPID(problem.internalId);
                const priorityClass = `badge-${problem.priority?.toLowerCase() || 'medium'}`;
                const statusClass = `badge-${problem.problemStatus?.toLowerCase().replace(' ', '') || 'reported'}`;
                
                return `
                    <div class="problem-card" onclick="handleProblemClick('${problem.internalId}')">
                        <div class="card-header">
                            <div>
                                <span class="card-pid">PID ${pid}</span>
                                <span class="card-unit">‚Ä¢ ${problem.unitNumber} ‚Ä¢ ${problem.zone}</span>
                            </div>
                            <div class="card-badges">
                                <span class="badge ${priorityClass}">${problem.priority || 'Medium'}</span>
                                <span class="badge ${statusClass}">${problem.problemStatus || 'Reported'}</span>
                            </div>
                        </div>
                        <div class="card-description">${problem.problemDescription}</div>
                        <div class="card-footer">
                            <span>üë§ ${problem.reportedBy}</span>
                            <span>üìÖ ${problem.reportedDate}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Handle problem card click
        function handleProblemClick(internalId) {
            selectedProblem = problems.find(p => p.internalId === internalId);
            if (!selectedProblem) return;
            
            // Populate form fields
            document.getElementById('reportedDate').value = formatDateForInput(selectedProblem.reportedDate);
            document.getElementById('unitNumber').value = selectedProblem.unitNumber || '';
            document.getElementById('reportedBy').value = selectedProblem.reportedBy || '';
            document.getElementById('zone').value = selectedProblem.zone || '';
            document.getElementById('residentName').value = selectedProblem.residentName || '';
            document.getElementById('residentMobile').value = selectedProblem.residentMobile || '';
            document.getElementById('problemDescription').value = selectedProblem.problemDescription || '';
            document.getElementById('priority').value = selectedProblem.priority || '';
            document.getElementById('problemStatus').value = selectedProblem.problemStatus || '';
            document.getElementById('category').value = selectedProblem.category || '';
            document.getElementById('subCategory').value = selectedProblem.subCategory || '';
            document.getElementById('assignedTo').value = selectedProblem.assignedTo || '';
            document.getElementById('completionDate').value = formatDateForInput(selectedProblem.completionDate);
            document.getElementById('internalComments').value = selectedProblem.internalComments || '';
            
            // Switch to editor view
            document.getElementById('listView').classList.add('hidden');
            document.getElementById('editorView').classList.remove('hidden');
            hasChanges = false;
        }

        // Handle save changes - FIXED API SYNC
        async function handleSaveChanges() {
            if (!selectedProblem) return;
            
            // Get updated values from form
            const updatedProblem = {
                ...selectedProblem,
                reportedDate: formatDateForAPI(document.getElementById('reportedDate').value) || selectedProblem.reportedDate,
                unitNumber: document.getElementById('unitNumber').value || selectedProblem.unitNumber,
                reportedBy: document.getElementById('reportedBy').value || selectedProblem.reportedBy,
                zone: document.getElementById('zone').value || selectedProblem.zone,
                residentName: document.getElementById('residentName').value || selectedProblem.residentName,
                residentMobile: document.getElementById('residentMobile').value || selectedProblem.residentMobile,
                problemDescription: document.getElementById('problemDescription').value || selectedProblem.problemDescription,
                priority: document.getElementById('priority').value || selectedProblem.priority,
                problemStatus: document.getElementById('problemStatus').value || selectedProblem.problemStatus,
                category: document.getElementById('category').value || selectedProblem.category,
                subCategory: document.getElementById('subCategory').value || selectedProblem.subCategory,
                assignedTo: document.getElementById('assignedTo').value || selectedProblem.assignedTo,
                completionDate: formatDateForAPI(document.getElementById('completionDate').value) || selectedProblem.completionDate,
                internalComments: document.getElementById('internalComments').value || selectedProblem.internalComments
            };
            
            // Update local data immediately
            const index = problems.findIndex(p => p.internalId === selectedProblem.internalId);
            if (index !== -1) {
                problems[index] = updatedProblem;
                selectedProblem = updatedProblem;
            }
            
            // Show saving indicator
            const saveBtn = document.getElementById('saveChangesBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '‚è≥ Saving...';
            saveBtn.disabled = true;
            
            // Only attempt API sync if we have live data
            if (dataSource === 'live') {
                try {
                    // Create the update payload
                    const updateData = {
                        action: 'updateProblem',
                        internalId: updatedProblem.internalId,
                        reportedDate: updatedProblem.reportedDate,
                        unitNumber: updatedProblem.unitNumber,
                        reportedBy: updatedProblem.reportedBy,
                        zone: updatedProblem.zone,
                        residentName: updatedProblem.residentName,
                        residentMobile: updatedProblem.residentMobile,
                        problemDescription: updatedProblem.problemDescription,
                        priority: updatedProblem.priority,
                        problemStatus: updatedProblem.problemStatus,
                        category: updatedProblem.category,
                        subCategory: updatedProblem.subCategory,
                        assignedTo: updatedProblem.assignedTo,
                        completionDate: updatedProblem.completionDate,
                        internalComments: updatedProblem.internalComments
                    };
                    
                    console.log('üîÑ Syncing changes to Google Sheets...', updateData);
                    
                    // Use POST request with JSON payload
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updateData)
                    });
                    
                    const result = await response.json();
                    console.log('‚úÖ Sync response:', result);
                    
                    if (result.success) {
                        // Success feedback
                        saveBtn.innerHTML = '‚úÖ Saved to Sheets!';
                        saveBtn.style.backgroundColor = '#10b981';
                        
                        setTimeout(() => {
                            saveBtn.innerHTML = originalText;
                            saveBtn.style.backgroundColor = '';
                            saveBtn.disabled = false;
                        }, 2000);
                        
                        hasChanges = false;
                        filterProblems(); // Refresh display
                    } else {
                        throw new Error(result.message || 'Update failed');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Sync error:', error);
                    
                    // Error feedback but don't lose local changes
                    saveBtn.innerHTML = '‚ö†Ô∏è Saved Locally';
                    saveBtn.style.backgroundColor = '#f59e0b';
                    
                    setTimeout(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.style.backgroundColor = '';
                        saveBtn.disabled = false;
                    }, 3000);
                    
                    // Don't show alert for now - just log the error
                    console.warn('Changes saved locally but not synced to Google Sheets');
                    hasChanges = false;
                    filterProblems();
                }
            } else {
                // Sample data mode - just save locally
                saveBtn.innerHTML = '‚úÖ Saved Locally';
                saveBtn.style.backgroundColor = '#10b981';
                
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.backgroundColor = '';
                    saveBtn.disabled = false;
                }, 2000);
                
                hasChanges = false;
                filterProblems();
            }
        }

        // NEW: Generate problem reports
        function generateListReport() {
            const now = new Date();
            const reportDate = now.toLocaleDateString('en-AU');
            const reportTime = now.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });

            let report = `MAINTENANCE PORTAL - PROBLEMS LIST REPORT\n\n`;
            report += `Generated: ${reportDate} at ${reportTime}\n`;
            report += `Filter: ${currentFilter}\n`;
            report += `Data Source: ${dataSource === 'live' ? 'Live Google Sheets' : 'Sample Data'}\n`;
            report += `Total Problems: ${filteredProblems.length}\n\n`;
            report += `${'='.repeat(60)}\n\n`;

            filteredProblems.forEach((problem, index) => {
                const pid = extractPID(problem.internalId);
                report += `${index + 1}. PID ${pid} - ${problem.unitNumber}\n`;
                report += `   Priority: ${problem.priority} | Status: ${problem.problemStatus}\n`;
                report += `   Description: ${problem.problemDescription}\n`;
                report += `   Reported By: ${problem.reportedBy} | Date: ${problem.reportedDate}\n`;
                if (problem.assignedTo) {
                    report += `   Assigned To: ${problem.assignedTo}\n`;
                }
                report += `\n`;
            });

            report += `${'='.repeat(60)}\n`;
            report += `Report generated by Maintenance Portal v2.3`;

            return report;
        }

        function generateDetailReport() {
            if (!selectedProblem) return '';
            
            const pid = extractPID(selectedProblem.internalId);
            const now = new Date();
            const reportDate = now.toLocaleDateString('en-AU');
            const reportTime = now.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });

            return `MAINTENANCE PORTAL - PROBLEM DETAIL REPORT

Generated: ${reportDate} at ${reportTime}

PROBLEM DETAILS:
===============
PID: ${pid}
Unit: ${selectedProblem.unitNumber} ‚Ä¢ ${selectedProblem.zone}
Reported Date: ${selectedProblem.reportedDate}
Reported By: ${selectedProblem.reportedBy}
Resident Name: ${selectedProblem.residentName}
Resident Mobile: ${selectedProblem.residentMobile}

Problem Description: 
${selectedProblem.problemDescription}

PROBLEM ASSIGNMENT:
==================
Category: ${selectedProblem.category || 'Not assigned'}
Sub-Category: ${selectedProblem.subCategory || 'Not assigned'}
Assigned To: ${selectedProblem.assignedTo || 'Unassigned'}

Internal Comments: 
${selectedProblem.internalComments || 'None'}

RESIDENT NOTIFICATION FIELDS:
============================
Priority: ${selectedProblem.priority}
Status: ${selectedProblem.problemStatus}
Completion Date: ${selectedProblem.completionDate || 'Not completed'}

${'='.repeat(60)}
Report generated by Maintenance Portal v2.3`;
        }

        // NEW: Show report modal
        function showReport(type) {
            const report = type === 'list' ? generateListReport() : generateDetailReport();
            document.getElementById('modalBody').textContent = report;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        // NEW: Copy report to clipboard
        async function copyReport(type) {
            const report = type === 'list' ? generateListReport() : generateDetailReport();
            try {
                await navigator.clipboard.writeText(report);
                
                // Visual feedback
                const button = type === 'list' ? 
                    document.getElementById('copyListReportBtn') : 
                    document.getElementById('copyReportBtn');
                
                if (button) {
                    const originalText = button.innerHTML;
                    button.innerHTML = '‚úÖ Copied!';
                    button.style.backgroundColor = '#10b981';
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.backgroundColor = '';
                    }, 2000);
                }
            } catch (err) {
                console.error('Failed to copy report:', err);
                alert('‚ùå Failed to copy report. Please select and copy manually.');
            }
        }

        // Utility functions
        function formatDateForInput(dateStr) {
            if (!dateStr) return '';
            // Convert DD/MM/YYYY to YYYY-MM-DD for input[type="date"]
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            return dateStr;
        }

        function formatDateForAPI(dateStr) {
            if (!dateStr) return '';
            // Handle both input formats: YYYY-MM-DD and DD/MM/YYYY
            if (dateStr.includes('-')) {
                // Convert YYYY-MM-DD to DD/MM/YYYY for API
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    return `${parts[2]}/${parts[1]}/${parts[0]}`;
                }
            }
            // Already in DD/MM/YYYY format or other format
            return dateStr;
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        function goBack() {
            document.getElementById('editorView').classList.add('hidden');
            document.getElementById('listView').classList.remove('hidden');
            filterProblems(); // Refresh the list
        }

        function togglePassword() {
            const input = document.getElementById('passwordInput');
            const btn = document.getElementById('togglePassword');
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load data on startup
            loadFaultLogData();

            // Login functionality
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            document.getElementById('togglePassword').addEventListener('click', togglePassword);

            // Search functionality
            document.getElementById('searchBtn').addEventListener('click', filterProblems);
            document.getElementById('searchInput').addEventListener('input', filterProblems);

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.getAttribute('data-filter');
                    filterProblems();
                });
            });

            // NEW: List view report buttons
            document.getElementById('viewListReportBtn').addEventListener('click', () => showReport('list'));
            document.getElementById('copyListReportBtn').addEventListener('click', () => copyReport('list'));

            // Editor functionality
            document.getElementById('backBtn').addEventListener('click', goBack);
            document.getElementById('saveChangesBtn').addEventListener('click', handleSaveChanges);
            document.getElementById('viewReportBtn').addEventListener('click', () => showReport('detail'));
            document.getElementById('copyDetailReportBtn').addEventListener('click', () => copyReport('detail'));

            // Modal functionality
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('copyReportBtn').addEventListener('click', () => copyReport('detail'));
            document.getElementById('modalOverlay').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });

            // Track changes in form fields
            const formFields = [
                'reportedDate', 'unitNumber', 'reportedBy', 'zone', 'residentName', 
                'residentMobile', 'problemDescription', 'priority', 'problemStatus', 
                'category', 'subCategory', 'assignedTo', 'completionDate', 'internalComments'
            ];
            
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => { hasChanges = true; });
                    field.addEventListener('change', () => { hasChanges = true; });
                }
            });
        });

        // Make functions globally available
        window.handleProblemClick = handleProblemClick;
    </script>
</body>
</html>
