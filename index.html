<!--
=================================================================
MAINTENANCE PORTAL v2.3 - CORRECTED WITH SIMPLE POP-UP SYSTEM
=================================================================
PART 1: HTML STRUCTURE WITH LOGOUT BUTTON ADDED
=================================================================
STATUS: ‚úÖ CORRECTED VERSION BASED ON WORKING V2.3
DATE: July 9, 2025

üéØ FIXES IN THIS VERSION:
- ‚úÖ Added logout button to main app header
- ‚úÖ Fixed DOM element references to match actual structure
- ‚úÖ Added missing pop-up notification modal HTML
- ‚úÖ Mobile number leading 0 preserved (will fix in JS)
- ‚úÖ Reported Date made read-only (will fix in JS)
- ‚úÖ Simple pop-up system for order change notifications

üîî POP-UP SYSTEM:
- Polls every 45 seconds for order changes
- Shows persistent modal when changes detected
- User choice: "Log Out Now" or "Dismiss for Now"
- Modal stays until user dismisses it
=================================================================
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Portal v2.3 - Corrected with Pop-up System</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Login Styles */
        .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 400px; width: 100%; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-title { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .login-subtitle { color: #666; margin-bottom: 20px; }
        .data-status { margin-bottom: 15px; padding: 10px; border-radius: 5px; font-size: 12px; text-align: center; }
        .data-status.loading { background: #e3f2fd; color: #1976d2; }
        .data-status.live { background: #e8f5e8; color: #2e7d32; }
        .data-status.sample { background: #fff3e0; color: #f57c00; }
        .data-status.error { background: #ffebee; color: #c62828; }
        .warning-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; }
        .warning-text { color: #856404; font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .form-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 5px rgba(37,99,235,0.3); }
        .form-input:disabled { background: #f9fafb; color: #6b7280; }
        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 500; }
        .btn-primary { background: #2563eb; color: white; width: 100%; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        
        .btn-logout { background: #6b7280; color: white; margin-left: 10px; }
        .btn-logout:hover { background: #4b5563; }

        .error-message { color: #dc2626; font-size: 14px; margin-top: 10px; text-align: center; }
        
        /* Main App Styles */
        .header { background: #2563eb; color: white; padding: 20px 0; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .header p { color: #dbeafe; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .back-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        .back-btn:hover { background: rgba(255,255,255,0.3); }
        
        /* Search and Filters */
        .search-section { margin: 30px 0; }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-input { flex: 1; padding: 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .search-btn { background: #2563eb; color: white; padding: 15px 25px; border: none; border-radius: 5px; cursor: pointer; }
        
        /* Problem Cards */
        .problems-list { display: flex; flex-direction: column; gap: 15px; }
        .problem-card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            cursor: pointer; 
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        .problem-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .problem-card.dragging { 
            border: 2px solid #fb923c !important;
            transform: rotate(3deg);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0.9;
        }
        .problem-card.drag-target { 
            border: 2px dashed #fb923c !important; 
            background: #fff7ed;
        }
        .problem-card.drop-zone {
            transition: all 0.2s ease;
        }
        
        /* Card Content */
        .card-top-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .card-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-right {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .pid-text {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .unit-text {
            font-size: 14px;
            color: #666;
        }
        .date-text {
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .date-text::before {
            content: "üìÖ";
            font-size: 16px;
        }
        .card-badges {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .problem-description { color: #333; margin: 10px 0; line-height: 1.5; }
        
        /* Badges */
        .badge { padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 500; }
        .badge-urgent { background: #fee2e2; color: #991b1b; }
        .badge-high { background: #fed7aa; color: #9a3412; }
        .badge-medium { background: #fef3c7; color: #92400e; }
        .badge-low { background: #dcfce7; color: #166534; }
        .badge-reported { background: #dbeafe; color: #1e40af; }
        .badge-progress { background: #fed7aa; color: #ea580c; }
        .badge-completed { background: #dcfce7; color: #16a34a; }
        .badge-hold { background: #f3e8ff; color: #7c3aed; }
        .badge-cancelled { background: #f3f4f6; color: #374151; }
        .badge-open { background: #e0f2fe; color: #0277bd; }
        
        body.dragging {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
        }
        
        /* Loading and Error States */
        .loading-spinner { 
            display: inline-block; 
            width: 20px; 
            height: 20px; 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #2563eb; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .no-data { text-align: center; padding: 40px; color: #666; }
        .no-data h3 { margin-bottom: 10px; color: #999; }
        
        /* Editor Form */
        .editor { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .section { margin-bottom: 30px; }
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-field { margin-bottom: 15px; }
        .form-field.full-width { grid-column: 1 / -1; }
        .textarea { resize: vertical; min-height: 80px; }
        .notification-section .section-title { color: #ea580c; background: #fff7ed; margin: -30px -30px 20px -30px; padding: 15px 30px; }
        .notification-warning { background: #fff7ed; border-left: 4px solid #fb923c; padding: 15px; margin-bottom: 20px; color: #9a3412; }
        .orange-border { border: 2px solid #fdba74 !important; }
        .save-btn { background: #16a34a; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; float: right; }
        .save-btn:hover { background: #15803d; }
        
        /* Report Buttons */
        .report-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .report-btn { display: block; width: 100%; margin-bottom: 10px; padding: 15px; background: #2563eb; color: white; text-decoration: none; text-align: center; border-radius: 5px; border: none; cursor: pointer; }
        .report-btn:hover { background: #1d4ed8; }
        .report-btn.green { background: #16a34a; }
        .report-btn.green:hover { background: #15803d; }
        
        /* Modal Styles */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
        .report-text { font-family: monospace; white-space: pre-wrap; font-size: 14px; line-height: 1.5; }
        
        
        
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .order-change-modal .btn-group { flex-direction: column; }
            .order-change-modal .btn { width: 100%; }
            .header-content { flex-direction: column; gap: 10px; }
            .header-right { justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-header">
                <h1 class="login-title">Maintenance Portal</h1>
                <p class="login-subtitle">Fault Management System v2.3</p>
                
                <!-- Data Status Indicator -->
                <div id="dataStatus" class="data-status loading">
                    <div class="loading-spinner"></div> Loading data...
                </div>
            </div>
            
            <div class="warning-box">
                <p class="warning-text">
                    <strong>üîí Maintenance Team Access Only</strong><br>
                    This section is restricted to authorized maintenance personnel
                </p>
            </div>
            
            <div class="form-group">
                <label class="form-label">Enter Maintenance Access Code</label>
                <div style="position: relative;">
                    <input type="password" id="passwordInput" class="form-input" placeholder="Enter access code" style="padding-right: 45px;">
                    <button type="button" id="togglePassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #666;">
                        üëÅÔ∏è
                    </button>
                </div>
            </div>
            
            <button id="loginBtn" class="btn btn-primary">Access Portal</button>
            
            <div id="errorMessage" class="error-message hidden"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="hidden">
        <!-- LIST VIEW -->
        <div id="listView">
            <div class="header">
                <div class="container">
                    <div class="header-content">
                        <div>
                            <h1>Maintenance Portal</h1>
                            <p>Fault Management System</p>
                        </div>
                        <!-- ‚úÖ ADDED: Logout Button -->
                       <div class="header-right">
    <button id="refreshOrderBtn" class="btn btn-secondary">üîÑ Refresh Order</button>
    <button id="logoutBtn" class="btn btn-logout">üö™ Logout</button>
</div>
                    </div>
                </div>
            </div>
            
            <div class="container">
                <div class="search-section">
                    <h2>Search by Problem ID (PID)</h2>
                    <div class="search-box">
                        <input type="text" id="searchInput" class="search-input" placeholder="PID 110716">
                        <button id="searchBtn" class="search-btn">Search</button>
                    </div>
                </div>
                
                <h3 id="resultsCount">All Problems (0)</h3>
                
                <div class="report-section">
                    <button id="viewListReport" class="report-btn">üìÑ View Report</button>
                    <button id="copyListReport" class="report-btn green">üìã Copy Report</button>
                </div>
                
                <div id="problemsList" class="problems-list">
                    <!-- Problems will be inserted here -->
                </div>
            </div>
        </div>

        <!-- EDITOR VIEW -->
        <div id="editorView" class="hidden">
            <div class="header">
                <div class="container">
                    <div class="header-content">
                        <div>
                            <h1>Problem Editor</h1>
                            <p id="editorPID">PID 110716</p>
                        </div>

                        
                        <div class="header-right">
    <button id="backBtn" class="back-btn">‚Üê Back to List</button>
    <button id="refreshOrderBtnEditor" class="btn btn-secondary">üîÑ Refresh Order</button>
    <button id="logoutBtnEditor" class="btn btn-logout">üö™ Logout</button>
</div>
                        
                    </div>
                </div>
            </div>
            
            <div class="container">
                <div class="report-section">
                    <button id="viewDetailReport" class="report-btn">üìÑ View Report</button>
                    <button id="copyDetailReport" class="report-btn green">üìã Copy Report</button>
                </div>
                
                <div class="editor">
                    <!-- Problem Details Section -->
                    <div class="section">
                        <h3 class="section-title">Problem Details</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="form-label">Reported Date</label>
                                <!-- ‚úÖ FIXED: Made readonly to prevent timestamp override -->
                                <input type="text" id="reportedDate" class="form-input" readonly title="This field is read-only to preserve original timestamp">
                            </div>
                            <div class="form-field">
                                <label class="form-label">Unit Number</label>
                                <input type="text" id="unitNumber" class="form-input">
                            </div>
                            <div class="form-field">
                                <label class="form-label">Reported By</label>
                                <input type="text" id="reportedBy" class="form-input">
                            </div>
                            <div class="form-field">
                                <label class="form-label">Zone</label>
                                <select id="zone" class="form-input">
                                    <option value="">Select Zone</option>
                                    <option value="Zone A">Zone A</option>
                                    <option value="Zone B">Zone B</option>
                                    <option value="Zone C">Zone C</option>
                                    <option value="Zone D">Zone D</option>
                                    <option value="Zone E">Zone E</option>
                                    <option value="Zone F">Zone F</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="form-label">Resident Name</label>
                                <input type="text" id="residentName" class="form-input">
                            </div>
                            <div class="form-field">
                                <label class="form-label">Resident Mobile</label>
                                <input type="tel" id="residentMobile" class="form-input" placeholder="0412345678">
                            </div>
                            <div class="form-field full-width">
                                <label class="form-label">Problem Description</label>
                                <textarea id="problemDescription" class="form-input textarea"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Management Details Section -->
                    <div class="section">
                        <h3 class="section-title" style="background: #f0fdf4; color: #166534; margin: -30px -30px 20px -30px; padding: 15px 30px;">Management Details</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="form-label">Category</label>
                                <select id="category" class="form-input">
                                    <option value="">Select Category</option>
                                    <option value="Plumbing">Plumbing</option>
                                    <option value="HVAC">HVAC</option>
                                    <option value="Electrical">Electrical</option>
                                    <option value="Security">Security</option>
                                    <option value="General">General</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="form-label">Sub-Category</label>
                                <select id="subCategory" class="form-input">
                                    <option value="">Select Sub-Category</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="form-label">Assigned To</label>
                                <select id="assignedTo" class="form-input">
                                    <option value="">Select Assignee</option>
                                    <option value="Mike Wilson">Mike Wilson</option>
                                    <option value="Tom Brown">Tom Brown</option>
                                    <option value="Steve Davis">Steve Davis</option>
                                    <option value="Anna White">Anna White</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="form-label">Internal Comments</label>
                                <textarea id="internalComments" class="form-input textarea" placeholder="Add internal notes..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Notification Fields Section -->
                    <div class="section notification-section">
                        <h3 class="section-title">Resident Notification Fields</h3>
                        <div class="notification-warning">
                            <strong>‚ö†Ô∏è Changes to the fields below may trigger notifications to residents</strong>
                        </div>
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="form-label">Priority</label>
                                <select id="priority" class="form-input orange-border">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Urgent">Urgent</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="form-label">Status</label>
                                <select id="problemStatus" class="form-input orange-border">
                                    <option value="Reported">Reported</option>
                                    <option value="Open">Open</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="On Hold">On Hold</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label class="form-label">Completion Date</label>
                                <input type="date" id="completionDate" class="form-input orange-border">
                            </div>
                        </div>
                    </div>

                    <button id="Btn" class="save-btn">üíæ Save Changes</button>
                    <div style="clear: both;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- REPORT MODAL -->
    <div id="reportModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Report Preview</h3>
                <button id="closeReportModal" class="close-btn">√ó</button>
            </div>
            <div class="report-text" id="reportText"></div>
            <div style="margin-top: 20px;">
                <button id="copyModalReport" class="btn btn-primary">üìã Copy Report</button>
            </div>
        </div>
    </div>

    

    <script>

/* ===================================================================
           PART 2: JAVASCRIPT CONFIGURATION AND STATE MANAGEMENT
 ================================================================= */

        // Configuration
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwbXAKuE3sH9xnRFVpuCWsW97W_USNcjgSVmgPcWmTFrwU9TA0QEK8V32NH9gNwCAat/exec';
        const MAINTENANCE_PASSWORD = "maint2025";
        
        

        // Global State
        let isAuthenticated = false;
        let currentView = 'list'; // 'list' or 'editor'
        let currentProblem = null;
        let problems = [];
        let filteredProblems = [];
        let searchTerm = '';
        let dataConnectionStatus = 'loading'; // 'loading', 'live', 'sample', 'error'
        
        // Login Security
        let loginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 3;
        let lockoutUntil = null;
        
        // Drag and Drop State
        let isDragging = false;
        let draggedElement = null;
        let draggedIndex = -1;
        let touchStartTime = 0;
        let touchStartPos = { x: 0, y: 0 };
        let longPressTimer = null;
        let isLongPress = false;

        // Sample Data with ‚úÖ FIXED mobile numbers (preserved leading 0)
        const sampleData = [
            {
                internalId: '20250115-110716',
                reportedDate: '15/01/2025',
                unitNumber: 'A-201',
                reportedBy: 'John Smith',
                zone: 'Zone A',
                residentName: 'John Smith',
                residentMobile: '0412345678', // ‚úÖ Fixed: preserved leading 0
                problemDescription: 'Kitchen faucet leaking continuously, water damage to cabinet below',
                category: 'Plumbing',
                subCategory: 'Faucet/Tap',
                assignedTo: '',
                comments: 'Requires immediate attention',
                problemStatus: 'Reported',
                problemPriority: 'Urgent',
                completionDate: '',
                sortOrder: 1
            },
            {
                internalId: '20250114-143022',
                reportedDate: '14/01/2025',
                unitNumber: 'B-105',
                reportedBy: 'Sarah Johnson',
                zone: 'Zone B',
                residentName: 'Sarah Johnson',
                residentMobile: '0423456789', // ‚úÖ Fixed: preserved leading 0
                problemDescription: 'Air conditioning unit not cooling properly, temperature not reaching set point',
                category: 'HVAC',
                subCategory: 'Air Conditioning',
                assignedTo: 'Mike Wilson',
                comments: 'Scheduled for tomorrow morning',
                problemStatus: 'In Progress',
                problemPriority: 'High',
                completionDate: '',
                sortOrder: 2
            },
            {
                internalId: '20250112-092345',
                reportedDate: '12/01/2025',
                unitNumber: 'C-302',
                reportedBy: 'David Wilson',
                zone: 'Zone C',
                residentName: 'David Wilson',
                residentMobile: '0434567890', // ‚úÖ Fixed: preserved leading 0
                problemDescription: 'Bathroom exhaust fan making loud grinding noise',
                category: 'Electrical',
                subCategory: 'Fan',
                assignedTo: 'Tom Brown',
                comments: 'Parts ordered, waiting for delivery',
                problemStatus: 'Completed',
                problemPriority: 'Medium',
                completionDate: '13/01/2025',
                sortOrder: 3
            },
            {
                internalId: '20250110-165530',
                reportedDate: '10/01/2025',
                unitNumber: 'D-404',
                reportedBy: 'Lisa Chen',
                zone: 'Zone D',
                residentName: 'Lisa Chen',
                residentMobile: '0445678901', // ‚úÖ Fixed: preserved leading 0
                problemDescription: 'Front door lock sticking, key difficult to turn',
                category: 'Security',
                subCategory: 'Door Lock',
                assignedTo: '',
                comments: 'Waiting for locksmith availability',
                problemStatus: 'On Hold',
                problemPriority: 'Low',
                completionDate: '',
                sortOrder: 4
            },
            {
                internalId: '20250108-084512',
                reportedDate: '08/01/2025',
                unitNumber: 'A-103',
                reportedBy: 'Robert Taylor',
                zone: 'Zone A',
                residentName: 'Robert Taylor',
                residentMobile: '0456789012', // ‚úÖ Fixed: preserved leading 0
                problemDescription: 'Kitchen window handle broken, cannot open window',
                category: 'General',
                subCategory: 'Window',
                assignedTo: 'Mike Wilson',
                comments: 'Replacement handle installed',
                problemStatus: 'Completed',
                problemPriority: 'Medium',
                completionDate: '09/01/2025',
                sortOrder: 5
            }
        ];


        // Utility Functions
        function showDataStatus(status, message) {
            const statusDiv = document.getElementById('dataStatus');
            if (!statusDiv) return;
            
            statusDiv.className = `data-status ${status}`;
            
            switch (status) {
                case 'loading':
                    statusDiv.innerHTML = '<div class="loading-spinner"></div> ' + message;
                    break;
                case 'live':
                    statusDiv.innerHTML = 'üü¢ ' + message;
                    break;
                case 'sample':
                    statusDiv.innerHTML = 'üìä ' + message;
                    break;
                case 'error':
                    statusDiv.innerHTML = '‚ùå ' + message;
                    break;
            }
        }

        function showError(message, duration = 5000) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, duration);
            }
        }

        function getPIDFromInternalId(internalId) {
            if (!internalId) return '';
            const parts = internalId.split('-');
            return parts.length > 1 ? parts[1] : internalId;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            // Keep DD/MM/YYYY format as-is
            return dateStr;
        }

        function updateCounts() {
    const count = filteredProblems.length;
    const countElement = document.getElementById('resultsCount');
    if (countElement && count > 0) {
        countElement.textContent = `All Problems (${count})`;
    }
}

        // DOM Element References
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const listView = document.getElementById('listView');
        const editorView = document.getElementById('editorView');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutBtnEditor = document.getElementById('logoutBtnEditor');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const problemsList = document.getElementById('problemsList');
        const togglePassword = document.getElementById('togglePassword');
        const backBtn = document.getElementById('backBtn');
        const saveChangesBtn = document.getElementById('saveChangesBtn');
        
        

        // Report Modal Elements
        const reportModal = document.getElementById('reportModal');
        const closeReportModal = document.getElementById('closeReportModal');
        const reportText = document.getElementById('reportText');
        const copyModalReport = document.getElementById('copyModalReport');
        const viewListReport = document.getElementById('viewListReport');
        const copyListReport = document.getElementById('copyListReport');
        const viewDetailReport = document.getElementById('viewDetailReport');
        const copyDetailReport = document.getElementById('copyDetailReport');


/* ===================================================================
           PART 3: AUTHENTICATION AND DATA LOADING FUNCTIONS
           ================================================================= */

        // Authentication Functions
        function handleLogin(e) {
            if (e) e.preventDefault();
            
            // Check lockout
            if (lockoutUntil && Date.now() < lockoutUntil) {
                const remaining = Math.ceil((lockoutUntil - Date.now()) / 1000);
                showError(`Too many failed attempts. Try again in ${remaining} seconds.`);
                return;
            }
            
            const password = passwordInput.value.trim();
            
            if (password === MAINTENANCE_PASSWORD) {
                // Successful login
                loginAttempts = 0;
                lockoutUntil = null;
                isAuthenticated = true;
                
                // Hide login, show main app
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                
                // Load data and start monitoring
                loadProblemsData();
            
                
            } else {
                // Failed login
                loginAttempts++;
                
                if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                    lockoutUntil = Date.now() + (30 * 1000); // 30 second lockout
                    showError('Too many failed attempts. Access locked for 30 seconds.');
                } else {
                    const remaining = MAX_LOGIN_ATTEMPTS - loginAttempts;
                    showError(`Incorrect password. ${remaining} attempt${remaining === 1 ? '' : 's'} remaining.`);
                }
                
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function logout() {
            console.log('üö™ Logging out...');
            
           // Hide any open modals
hideReportModal();
            
            // Reset state
            isAuthenticated = false;
            currentView = 'list';
            currentProblem = null;
            problems = [];
            filteredProblems = [];
            searchTerm = '';
            
            // Reset UI
            mainApp.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            showView('list');
            
            // Clear and focus password field
            passwordInput.value = '';
            passwordInput.focus();
            
            // Reset data status
           // showDataStatus('loading', 'Loading data...');

            // Check data status instead of resetting
            checkDataAvailability();
            
            console.log('üëã Logout complete');
        }

        // Data Loading Functions
        async function loadProblemsData() {
            console.log('üì° Loading problems data...');
            showDataStatus('loading', 'Loading live data...');
            
            try {
                // Attempt to load live data
                const callbackName = 'loadDataCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(response) {
                
    try {
        if (response && response.success && response.problems && response.problems.length > 0) {
            // ‚úÖ FIX: Process live data with mobile number correction


            
            problems = response.problems.map((problem, index) => {
    return {
        ...problem,
        sortOrder: problem.sortOrder || (index + 1),
        // ‚úÖ FIX: Map backend field names to portal expectations
        problemPriority: problem.priority || 'Medium',
        comments: problem.internalComments || '',
        // ‚úÖ FIX: Ensure mobile numbers preserve leading 0
        residentMobile: problem.residentMobile && 
            typeof problem.residentMobile === 'string' && 
            !problem.residentMobile.startsWith('0') && 
            problem.residentMobile.length === 10 ? 
            '0' + problem.residentMobile : problem.residentMobile
    };
});



            
                            
                            // Sort by order
                            problems.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
                            
                            dataConnectionStatus = 'live';
                            showDataStatus('live', `Live Data - ${problems.length} problems loaded`);
                            
                            console.log('‚úÖ Live data loaded successfully:', problems.length, 'problems');
                            
                            
                        } else {
                            // Fall back to sample data
                            loadSampleData();
                        }
                        
                        // Apply search and render
                        applySearchFilter();
                        renderProblems();

                
                        
                    } catch (error) {
                        console.error('‚ùå Error processing live data:', error);
                        loadSampleData();
                        applySearchFilter();
                        renderProblems();
        
                    }
                    
                    // Cleanup
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                //script.src = `${WEB_APP_URL}?action=getProblems&callback=${callbackName}&_=${Date.now()}`;

                script.src = `${WEB_APP_URL}?action=getFaultLogData&callback=${callbackName}&_=${Date.now()}`;


                
                document.head.appendChild(script);
                
                // Fallback timeout
                setTimeout(() => {
                    if (document.head.contains(script)) {
                        console.log('‚è∞ Live data load timeout, using sample data');
                        document.head.removeChild(script);
                        delete window[callbackName];
                        
                        if (problems.length === 0) {
                            loadSampleData();
                            applySearchFilter();
                            renderProblems();
                        }
                    }
                }, 8000);
                
            } catch (error) {
                console.error('‚ùå Error loading live data:', error);
                loadSampleData();
                applySearchFilter();
                renderProblems();
            }
        }

        function loadSampleData() {
            console.log('üìä Loading sample data...');
            
            problems = [...sampleData];
            dataConnectionStatus = 'sample';
            showDataStatus('sample', `Sample Data - ${problems.length} problems loaded`);
            
            console.log('‚úÖ Sample data loaded:', problems.length, 'problems');
        }

        // Search and Filter Functions
        function handleSearch() {
            searchTerm = searchInput.value.trim().toLowerCase();
            applySearchFilter();
            renderProblems();
            
            console.log('üîç Search applied:', searchTerm || '(none)');
        }

        function applySearchFilter() {
    // First filter out completed/cancelled by default
    let baseProblems = problems.filter(problem => {
        const status = problem.problemStatus.toLowerCase();
        return status !== 'completed' && status !== 'cancelled';
    });
    
    if (!searchTerm) {
        filteredProblems = baseProblems;
    } else {
        filteredProblems = baseProblems.filter(problem => {              
                    const pid = getPIDFromInternalId(problem.internalId).toLowerCase();
                    const description = (problem.problemDescription || '').toLowerCase();
                    const unit = (problem.unitNumber || '').toLowerCase();
                    const resident = (problem.residentName || '').toLowerCase();
                    
                    return pid.includes(searchTerm) || 
                           description.includes(searchTerm) || 
                           unit.includes(searchTerm) || 
                           resident.includes(searchTerm);
                });
            }
            
            updateCounts();
        }

        // Save Functions
        async function saveChanges() {
            if (!currentProblem) {
                showError('No problem selected to save');
                return;
            }
            
            console.log('üíæ Saving changes for problem:', currentProblem.internalId);
            
            try {
                // Collect form data
                const updatedProblem = {
                    ...currentProblem,
                    unitNumber: document.getElementById('unitNumber').value.trim(),
                    reportedBy: document.getElementById('reportedBy').value.trim(),
                    zone: document.getElementById('zone').value,
                    residentName: document.getElementById('residentName').value.trim(),
                    residentMobile: document.getElementById('residentMobile').value.trim(),
                    problemDescription: document.getElementById('problemDescription').value.trim(),
                    category: document.getElementById('category').value,
                    subCategory: document.getElementById('subCategory').value,
                    assignedTo: document.getElementById('assignedTo').value,
                    comments: document.getElementById('internalComments').value.trim(),
                    problemPriority: document.getElementById('priority').value,
                    problemStatus: document.getElementById('problemStatus').value,
                    completionDate: document.getElementById('completionDate').value
                };
                
                // ‚úÖ CRITICAL: Do NOT modify reportedDate to preserve original timestamp
                // The reportedDate field is now readonly in HTML
                
                // Update local data
                const problemIndex = problems.findIndex(p => p.internalId === currentProblem.internalId);
                if (problemIndex !== -1) {
                    problems[problemIndex] = updatedProblem;
                    currentProblem = updatedProblem;
                }
                
                // Save to backend if live data
                if (dataConnectionStatus === 'live') {
                    await saveProblemToBackend(updatedProblem);
                }
                
                // Update display
                populateEditor(updatedProblem);
                
                // Show success message
                const saveBtn = document.getElementById('saveChangesBtn');
                if (saveBtn) {
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = '‚úÖ Saved!';
                    saveBtn.style.background = '#059669';
                    
                    setTimeout(() => {
                        saveBtn.textContent = originalText;
                        saveBtn.style.background = '#16a34a';
                    }, 2000);
                }
                
                console.log('‚úÖ Changes saved successfully');
                
            } catch (error) {
                console.error('‚ùå Error saving changes:', error);
                showError('Error saving changes. Please try again.');
            }
        }

        async function saveProblemToBackend(problem) {
            console.log('üîç WEB_APP_URL value:', WEB_APP_URL);
    console.log('üîç WEB_APP_URL type:', typeof WEB_APP_URL);
    return new Promise((resolve, reject) => {
        const callbackName = 'saveCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = function(response) {
            document.head.removeChild(script);
            delete window[callbackName];
            
            if (response && response.success) {
                console.log('‚úÖ Problem saved to backend successfully');
                resolve(response);
            } else {
                console.error('‚ùå Backend save failed:', response);
                reject(new Error(response ? response.error : 'Save failed'));
            }
        };
        
        // Build individual parameters instead of JSON object
        const params = new URLSearchParams({
            action: 'updateProblem',
            callback: callbackName,
            internalId: problem.internalId,
            unitNumber: problem.unitNumber || '',
            reportedBy: problem.reportedBy || '',
            zone: problem.zone || '',
            residentName: problem.residentName || '',
            residentMobile: problem.residentMobile || '',
            problemDescription: problem.problemDescription || '',
            priority: problem.problemPriority || '',
            status: problem.problemStatus || '',
            comments: problem.comments || '',
            completionDate: problem.completionDate || '',
            assignedTo: problem.assignedTo || '',
            category: problem.category || '',
            subCategory: problem.subCategory || ''
        });
        
        script.src = `${WEB_APP_URL}?${params.toString()}`;
        document.head.appendChild(script);
        
        // Timeout
        setTimeout(() => {
            if (document.head.contains(script)) {
                document.head.removeChild(script);
                delete window[callbackName];
                reject(new Error('Save timeout'));
            }
        }, 10000);
    });
}

        // View Management
        function showView(view) {
            currentView = view;
            
            if (view === 'list') {
                listView.classList.remove('hidden');
                editorView.classList.add('hidden');
                currentProblem = null;
            } else if (view === 'editor') {
                listView.classList.add('hidden');
                editorView.classList.remove('hidden');
            }
        }

        function showProblemEditor(problem) {
            currentProblem = problem;
            showView('editor');
            populateEditor(problem);
            
            const pid = getPIDFromInternalId(problem.internalId);
            document.getElementById('editorPID').textContent = `PID ${pid}`;
            
            console.log('üìù Editor opened for problem:', pid);
        }

        function populateEditor(problem) {
            if (!problem) return;
            
            // Problem Details (readonly fields)
            document.getElementById('reportedDate').value = formatDate(problem.reportedDate);
            document.getElementById('unitNumber').value = problem.unitNumber || '';
            document.getElementById('reportedBy').value = problem.reportedBy || '';
            document.getElementById('zone').value = problem.zone || '';
            document.getElementById('residentName').value = problem.residentName || '';
            document.getElementById('residentMobile').value = problem.residentMobile || '';
            document.getElementById('problemDescription').value = problem.problemDescription || '';
            
            // Management Details
            document.getElementById('category').value = problem.category || '';
            document.getElementById('subCategory').value = problem.subCategory || '';
            document.getElementById('assignedTo').value = problem.assignedTo || '';
            document.getElementById('internalComments').value = problem.comments || '';
            
            // Notification Fields
            document.getElementById('priority').value = problem.problemPriority || 'Medium';
            document.getElementById('problemStatus').value = problem.problemStatus || 'Reported';
            document.getElementById('completionDate').value = problem.completionDate || '';
            
            // Update sub-category options based on category
            updateSubCategoryOptions();
        }

        function updateSubCategoryOptions() {
            const category = document.getElementById('category').value;
            const subCategorySelect = document.getElementById('subCategory');
            const currentValue = subCategorySelect.value;
            
            // Clear existing options
            subCategorySelect.innerHTML = '<option value="">Select Sub-Category</option>';
            
            // Add category-specific options
            const subCategories = {
                'Plumbing': ['Faucet/Tap', 'Toilet', 'Shower', 'Pipe Leak', 'Drainage', 'Other'],
                'HVAC': ['Air Conditioning', 'Heating', 'Ventilation', 'Thermostat', 'Ductwork', 'Other'],
                'Electrical': ['Lighting', 'Power Outlet', 'Switch', 'Fan', 'Wiring', 'Other'],
                'Security': ['Door Lock', 'Window Lock', 'Intercom', 'Key', 'Access Control', 'Other'],
                'General': ['Window', 'Door', 'Wall', 'Floor', 'Ceiling', 'Other']
            };
            
            if (subCategories[category]) {
                subCategories[category].forEach(subCat => {
                    const option = document.createElement('option');
                    option.value = subCat;
                    option.textContent = subCat;
                    if (subCat === currentValue) {
                        option.selected = true;
                    }
                    subCategorySelect.appendChild(option);
                });
            }
        }


/* ===================================================================
           PART 4: PROBLEM LIST RENDERING AND DRAG & DROP FUNCTIONS
 ===================================================================== */

        // Problem List Rendering
        function renderProblems() {
            const container = problemsList;
            if (!container) return;
            
            // Clear existing content
            container.innerHTML = '';
            
            if (!filteredProblems || filteredProblems.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>No problems found</h3>
                        <p>Try adjusting your search terms</p>
                    </div>
                `;
                return;
            }
            
            // Sort by sortOrder for display
            const sortedProblems = [...filteredProblems].sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
            
            sortedProblems.forEach((problem, index) => {
                const card = createProblemCard(problem, index);
                container.appendChild(card);
            });
            
            console.log('üé® Rendered', sortedProblems.length, 'problem cards');
        }

        function createProblemCard(problem, index) {
            const card = document.createElement('div');
            card.className = 'problem-card';
            card.dataset.index = index;
            card.dataset.internalId = problem.internalId;
            
            const pid = getPIDFromInternalId(problem.internalId);
            const priorityClass = `badge-${problem.problemPriority.toLowerCase()}`;
            const statusClass = `badge-${problem.problemStatus.toLowerCase().replace(/\s+/g, '-')}`;
            
            card.innerHTML = `
                <div class="card-top-line">
                    <div class="card-left">
                        <span class="pid-text">PID ${pid}</span>
                        <span class="unit-text">${problem.unitNumber} ‚Ä¢ ${problem.zone}</span>
                    </div>
                    <div class="card-right">
                        <span class="date-text">${formatDate(problem.reportedDate)}</span>
                    </div>
                </div>
                <div class="problem-description">${problem.problemDescription}</div>
                <div class="card-badges">
                    <span class="badge ${priorityClass}">${problem.problemPriority}</span>
                    <span class="badge ${statusClass}">${problem.problemStatus}</span>
                    <span style="margin-left: auto; color: #666; font-size: 14px;">üë§ ${problem.residentName}</span>
                </div>
            `;
            
            // Add event listeners
            addCardEventListeners(card, problem, index);
            
            return card;
        }

        function addCardEventListeners(card, problem, index) {
            // Click to edit (avoid during drag)
            card.addEventListener('click', (e) => {
                if (!isDragging) {
                    showProblemEditor(problem);
                }
            });
            
            // Desktop drag events
            card.addEventListener('mousedown', (e) => {
                if (e.button === 0) { // Left mouse button
                    startDrag(card, index, e.clientX, e.clientY);
                }
            });
            
            // Mobile touch events
            card.addEventListener('touchstart', handleTouchStart, { passive: false });
            card.addEventListener('touchmove', handleTouchMove, { passive: false });
            card.addEventListener('touchend', handleTouchEnd, { passive: false });
        }

        // Drag and Drop Functions
        function startDrag(element, index, startX, startY) {
            isDragging = true;
            draggedElement = element;
            draggedIndex = index;
            
            element.classList.add('dragging');
            document.body.classList.add('dragging');
            
            // Add drop zones to other cards
            document.querySelectorAll('.problem-card').forEach((card, cardIndex) => {
                if (cardIndex !== index) {
                    card.classList.add('drop-zone');
                }
            });
            
            // Add mouse move and up events for desktop
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            
            console.log('üéØ Drag started for index:', index);
        }

        function handleMouseMove(e) {
            if (!isDragging || !draggedElement) return;
            
            updateDragTarget(e.clientX, e.clientY);
        }

        function handleMouseUp(e) {
            if (isDragging) {
                endDrag(e.clientX, e.clientY);
            }
        }

        function handleTouchStart(e) {
            const touch = e.touches[0];
            touchStartTime = Date.now();
            touchStartPos = { x: touch.clientX, y: touch.clientY };
            isLongPress = false;
            
            // Start long press timer for mobile drag
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                const card = e.currentTarget;
                const index = parseInt(card.dataset.index);
                startDrag(card, index, touch.clientX, touch.clientY);
                
                // Vibrate if available
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }, 600); // 600ms for long press
        }

        function handleTouchMove(e) {
            if (longPressTimer && !isLongPress) {
                // Cancel long press if moved too much
                const touch = e.touches[0];
                const deltaX = Math.abs(touch.clientX - touchStartPos.x);
                const deltaY = Math.abs(touch.clientY - touchStartPos.y);
                
                if (deltaX > 10 || deltaY > 10) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            }
            
            if (isDragging) {
                e.preventDefault();
                const touch = e.touches[0];
                updateDragTarget(touch.clientX, touch.clientY);
            }
        }

        function handleTouchEnd(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            
            if (isDragging) {
                const touch = e.changedTouches[0];
                endDrag(touch.clientX, touch.clientY);
            } else if (!isLongPress && Date.now() - touchStartTime < 500) {
                // Short tap - open editor
                const card = e.currentTarget;
                const internalId = card.dataset.internalId;
                const problem = filteredProblems.find(p => p.internalId === internalId);
                if (problem) {
                    showProblemEditor(problem);
                }
            }
        }

        function updateDragTarget(clientX, clientY) {
            if (!isDragging) return;
            
            // Clear existing drag targets
            document.querySelectorAll('.problem-card').forEach(card => {
                card.classList.remove('drag-target');
            });
            
            // Find element under cursor/finger
            const elementBelow = document.elementFromPoint(clientX, clientY);
            const targetCard = elementBelow ? elementBelow.closest('.problem-card') : null;
            
            if (targetCard && targetCard !== draggedElement) {
                targetCard.classList.add('drag-target');
            }
        }

        function endDrag(clientX, clientY) {
            if (!isDragging || !draggedElement) return;
            
            console.log('üéØ Ending drag operation');
            
            // Find drop target
            const elementBelow = document.elementFromPoint(clientX, clientY);
            const dropTarget = elementBelow ? elementBelow.closest('.problem-card') : null;
            
            if (dropTarget && dropTarget !== draggedElement) {
                const dropIndex = parseInt(dropTarget.dataset.index);
                reorderProblems(draggedIndex, dropIndex);
            }
            
            // Cleanup drag state
            cleanupDrag();
        }

        function reorderProblems(fromIndex, toIndex) {
            if (fromIndex === toIndex) return;
            
            console.log('üîÑ Reordering problems from index', fromIndex, 'to', toIndex);
            
            // Create new order for filtered problems
            const reorderedProblems = [...filteredProblems];
            const [movedProblem] = reorderedProblems.splice(fromIndex, 1);
            reorderedProblems.splice(toIndex, 0, movedProblem);
            
            // Update sort order values
            reorderedProblems.forEach((problem, index) => {
                problem.sortOrder = index + 1;
            });
            
            // Update main problems array
            reorderedProblems.forEach(problem => {
                const mainIndex = problems.findIndex(p => p.internalId === problem.internalId);
                if (mainIndex !== -1) {
                    problems[mainIndex] = problem;
                }
            });
            
            // Update filtered array
            filteredProblems = reorderedProblems;
            
            // Save order to backend if live data
console.log('üîç Data connection status:', dataConnectionStatus);
if (dataConnectionStatus === 'live') {
    console.log('üîç Calling saveSortOrderToBackend...');
    saveSortOrderToBackend();
} else {
    console.log('‚ùå Not saving - data connection is not live');
}
            
            

          // Re-render
          renderProblems();

        // Update hash for change detection
        lastOrderHash = calculateOrderHash();

            
            
            console.log('‚úÖ Problem order updated');
        }

        async function saveSortOrderToBackend() {
            try {
                const orderData = problems.map((problem, index) => ({
                    internalId: problem.internalId,
                    order: problem.sortOrder || (index + 1)
                    
                    //sortOrder: problem.sortOrder || (index + 1)

                    
                }));
                
                const callbackName = 'sortOrderCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(response) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    
                    if (response && response.success) {
    console.log('‚úÖ Sort order saved to backend');
} else {
    console.error('‚ùå Failed to save sort order:', response);
}
};
                
                //const orderDataJson = encodeURIComponent(JSON.stringify(orderData));
                //script.src = `${WEB_APP_URL}?action=updateSortOrder&orderData=${orderDataJson}&callback=${callbackName}&_=${Date.now()}`;


                const orderDataJson = encodeURIComponent(JSON.stringify(orderData));
console.log('üîç Sending order data:', orderData);
console.log('üîç JSON string:', JSON.stringify(orderData));
script.src = `${WEB_APP_URL}?action=updateSortOrder&orderData=${orderDataJson}&callback=${callbackName}&_=${Date.now()}`;

                
                document.head.appendChild(script);
                
                // Cleanup timeout
                setTimeout(() => {
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                    }
                }, 10000);
                
            } catch (error) {
                console.error('‚ùå Error saving sort order:', error);
            }
        }

        function cleanupDrag() {
            // Remove event listeners
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
            
            // Clear drag classes
            document.querySelectorAll('.problem-card').forEach(card => {
                card.classList.remove('dragging', 'drop-zone', 'drag-target');
            });
            
            document.body.classList.remove('dragging');
            
            // Reset drag state
            isDragging = false;
            draggedElement = null;
            draggedIndex = -1;
            isLongPress = false;
            
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        // Card Click Handler (for when not dragging)
        function handleCardClick(problem) {
            if (!isDragging) {
                showProblemEditor(problem);
            }
        }


/* ===================================================================
           PART 5: REPORT GENERATION AND EVENT LISTENERS (FINAL PART)
           ================================================================= */

        // Report Generation Functions
        function generateListReport() {
            const now = new Date();
            const searchText = searchTerm ? ` (Search: "${searchTerm}")` : '';
            
            const report = `MAINTENANCE PORTAL - FAULT MANAGEMENT REPORT

Generated: ${now.toLocaleDateString('en-AU')} at ${now.toLocaleTimeString('en-AU')}
Data Source: ${dataConnectionStatus === 'live' ? 'üü¢ Live Google Sheets' : 'üìä Sample Data'}
Filter Applied: All Problems${searchText}
Total Problems: ${filteredProblems.length}

${'='.repeat(80)}

${filteredProblems.map((problem, index) => {
    const pid = getPIDFromInternalId(problem.internalId);
    return `PROBLEM ${index + 1}: PID ${pid}
${'-'.repeat(40)}
Unit: ${problem.unitNumber} (${problem.zone})
Resident: ${problem.residentName}
Mobile: ${problem.residentMobile}
Reported: ${problem.reportedDate} by ${problem.reportedBy}
Priority: ${problem.problemPriority} | Status: ${problem.problemStatus}
Category: ${problem.category || 'Not specified'}
Sub-Category: ${problem.subCategory || 'Not specified'}
Assigned To: ${problem.assignedTo || 'Unassigned'}
${problem.completionDate ? `Completed: ${problem.completionDate}` : ''}

Description:
${problem.problemDescription}

Internal Comments:
${problem.comments || 'None'}

`;
}).join('\n')}

${'='.repeat(80)}
End of Report - Generated by Maintenance Portal v2.3
`;

            return report;
        }

        function generateDetailReport() {
            if (!currentProblem) return 'No problem selected';
            
            const now = new Date();
            const pid = getPIDFromInternalId(currentProblem.internalId);
            
            const report = `MAINTENANCE PORTAL - DETAILED PROBLEM REPORT

Generated: ${now.toLocaleDateString('en-AU')} at ${now.toLocaleTimeString('en-AU')}
Data Source: ${dataConnectionStatus === 'live' ? 'üü¢ Live Google Sheets' : 'üìä Sample Data'}

${'='.repeat(80)}

PROBLEM DETAILS - PID ${pid}
${'='.repeat(80)}

BASIC INFORMATION:
- Internal ID: ${currentProblem.internalId}
- Unit Number: ${currentProblem.unitNumber}
- Zone: ${currentProblem.zone}
- Reported Date: ${currentProblem.reportedDate}
- Reported By: ${currentProblem.reportedBy}

RESIDENT INFORMATION:
- Name: ${currentProblem.residentName}
- Mobile: ${currentProblem.residentMobile}

PROBLEM DETAILS:
- Description: ${currentProblem.problemDescription}
- Category: ${currentProblem.category || 'Not specified'}
- Sub-Category: ${currentProblem.subCategory || 'Not specified'}
- Priority: ${currentProblem.problemPriority}
- Status: ${currentProblem.problemStatus}
- Assigned To: ${currentProblem.assignedTo || 'Unassigned'}
- Completion Date: ${currentProblem.completionDate || 'Not completed'}

INTERNAL COMMENTS:
${currentProblem.comments || 'None'}

${'='.repeat(80)}
End of Report - Generated by Maintenance Portal v2.3
`;

            return report;
        }

        // Modal Functions
        function showReportModal(reportContent) {
            if (reportModal && reportText) {
                reportText.textContent = reportContent;
                reportModal.classList.remove('hidden');
            }
        }

        function hideReportModal() {
            if (reportModal) {
                reportModal.classList.add('hidden');
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showError('Report copied to clipboard!', 2000);
                }).catch(() => {
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showError('Report copied to clipboard!', 2000);
            } catch (err) {
                showError('Unable to copy to clipboard. Please select text manually.', 3000);
            }
            
            document.body.removeChild(textArea);
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Login Events
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
            }
            
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            }
            
            if (togglePassword) {
                togglePassword.addEventListener('click', () => {
                    const type = passwordInput.type === 'password' ? 'text' : 'password';
                    passwordInput.type = type;
                    togglePassword.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
                });
            }
            
            // Logout Events
if (logoutBtn) {
    logoutBtn.addEventListener('click', logout);
}

if (logoutBtnEditor) {
    logoutBtnEditor.addEventListener('click', logout);
}

// Refresh Order Events
const refreshOrderBtn = document.getElementById('refreshOrderBtn');
const refreshOrderBtnEditor = document.getElementById('refreshOrderBtnEditor');

if (refreshOrderBtn) {
    refreshOrderBtn.addEventListener('click', refreshOrder);
}

if (refreshOrderBtnEditor) {
    refreshOrderBtnEditor.addEventListener('click', refreshOrder);
}


            
            
            // Navigation Events
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    showView('list');
                    applySearchFilter();
                    renderProblems();
                });
            }
            
            // Search Events
            if (searchBtn) {
                searchBtn.addEventListener('click', handleSearch);
            }
            
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleSearch();
                    }
                });
                
                // Real-time search as user types (debounced)
                let searchTimeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        handleSearch();
                    }, 300);
                });
            }
            
            // Editor Events
            if (saveChangesBtn) {
                saveChangesBtn.addEventListener('click', saveChanges);
            }
            
            // Category change event
            const categorySelect = document.getElementById('category');
            if (categorySelect) {
                categorySelect.addEventListener('change', updateSubCategoryOptions);
            }
            
            // Report Events
            if (viewListReport) {
                viewListReport.addEventListener('click', () => {
                    const report = generateListReport();
                    showReportModal(report);
                });
            }
            
            if (copyListReport) {
                copyListReport.addEventListener('click', () => {
                    const report = generateListReport();
                    copyToClipboard(report);
                });
            }
            
            if (viewDetailReport) {
                viewDetailReport.addEventListener('click', () => {
                    const report = generateDetailReport();
                    showReportModal(report);
                });
            }
            
            if (copyDetailReport) {
                copyDetailReport.addEventListener('click', () => {
                    const report = generateDetailReport();
                    copyToClipboard(report);
                });
            }
            
            // Report Modal Events
            if (closeReportModal) {
                closeReportModal.addEventListener('click', hideReportModal);
            }
            
            if (copyModalReport) {
                copyModalReport.addEventListener('click', () => {
                    const report = reportText ? reportText.textContent : '';
                    copyToClipboard(report);
                });
            }
            
            
            
            // Close modals when clicking outside
            if (reportModal) {
                reportModal.addEventListener('click', (e) => {
                    if (e.target === reportModal) {
                        hideReportModal();
                    }
                });
            }
            
            
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Escape key closes modals
                if (e.key === 'Escape') {
                    if (!reportModal.classList.contains('hidden')) {
                        hideReportModal();
                    }
                }
                
                // Ctrl/Cmd + S saves in editor
                if ((e.ctrlKey || e.metaKey) && e.key === 's' && currentView === 'editor') {
                    e.preventDefault();
                    saveChanges();
                }
            });
            
            console.log('‚úÖ Event listeners setup complete');
        }

        // Application Initialization
        function initializeApp() {
            console.log('üöÄ Initializing Maintenance Portal v2.3...');
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize display
            showDataStatus('loading', 'Loading data...');
            showView('list');
            
            // Focus password input
            if (passwordInput) {
                passwordInput.focus();
            }
            
           // Initialize empty for cleaner loading
problems = [];
filteredProblems = [];
updateCounts();

        // Check live data availability for login screen status
        checkDataAvailability();
            
            console.log('‚úÖ Maintenance Portal v2.3 initialized successfully');
            
            console.log('üéØ Features active:');
            console.log('   ‚úÖ Fixed mobile number leading zero preservation');
            console.log('   ‚úÖ Fixed date override prevention in editor');
            console.log('   ‚úÖ Clean drag & drop with mobile support');
            console.log('   ‚úÖ Live Google Sheets integration');
            console.log('   ‚úÖ Logout buttons in both views');
            console.log('   ‚úÖ Professional problem editor');
            console.log('   ‚úÖ Comprehensive report generation');
        }

        // Start the application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

       

        function checkDataAvailability() {
    const callbackName = 'dataCheckCallback_' + Date.now();
    
    window[callbackName] = function(response) {
        if (response && response.success && response.problems && response.problems.length > 0) {
            showDataStatus('live', `Live Data Available - ${response.problems.length} problems`);
        } else {
            showDataStatus('sample', 'Using Sample Data');
        }
        
        // Cleanup
        const script = document.querySelector(`script[src*="${callbackName}"]`);
        if (script) document.head.removeChild(script);
        delete window[callbackName];
    };
    
    const script = document.createElement('script');
    script.src = `${WEB_APP_URL}?action=getFaultLogData&callback=${callbackName}&_=${Date.now()}`;
    document.head.appendChild(script);
}

        function refreshOrder() {
    console.log('üîÑ Refreshing problem order...');
    
    // Show loading state
    const refreshBtns = document.querySelectorAll('#refreshOrderBtn, #refreshOrderBtnEditor');
    refreshBtns.forEach(btn => {
        btn.textContent = 'üîÑ Refreshing...';
        btn.disabled = true;
    });
    
    // Reload problems data
    loadProblemsData();
    
    // Reset button state after a short delay
    setTimeout(() => {
        refreshBtns.forEach(btn => {
            btn.textContent = 'üîÑ Refresh Order';
            btn.disabled = false;
        });
    }, 2000);
}
        function calculateOrderHash() {
    if (!problems || problems.length === 0) return 0;
    
    // Create hash from problem order
    const orderString = problems
        .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0))
        .map(p => p.internalId)
        .join('|');
    
    let hash = 0;
    for (let i = 0; i < orderString.length; i++) {
        const char = orderString.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return hash;
}

        </script>
    </body>
</html>
