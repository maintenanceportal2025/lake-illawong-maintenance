<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Facilities - Lake Illawong</title>
    
    <!-- Your Residents Portal styling -->
    <style>
        /* === UNIFIED DESIGN SYSTEM v1.4 === */
        :root {
            --primary-blue: #1e40af;
            --secondary-blue: #1e3a8a;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.9);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* NEW: Header matching PasswordSettings.html EXACTLY */
        .booking-header {
            background: transparent;
            text-align: center;
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .logo-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .title-container {
            text-align: left;
        }

        .booking-header h1 {
            font-size: 2.3rem;
            font-weight: 700;
            color: white;
            margin-top: 30px;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .booking-header p {
            color: white;
            font-size: .9rem;
            margin-bottom: 40px;
            opacity: 0.9;
        }

        .header-divider {
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 10%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0.3) 90%, transparent 100%);
            margin: 10px 0 40px 0;
            border-radius: 1.5px;
        }
        
        /* Main Container - card-based layout */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Card styling - matches your portal cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        
        .card h2 {
            color: var(--primary-blue);
            font-size: 1.6rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        /* Form Grid - responsive */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* Form Groups */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary-blue);
            font-size: 1rem;
        }
        
        .form-group.required label::after {
            content: " *";
            color: var(--danger-color);
        }
        
        /* Input Styling */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s;
            background: white;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* Time Slot Selection */
        .time-slots {
            display: grid;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .time-slot {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-slot:hover {
            border-color: var(--accent-color);
            background: var(--light-gray);
        }
        
        .time-slot.selected {
            border-color: var(--success-color);
            background: #f0f9f4;
        }
        
        .time-slot input {
            width: auto;
            margin-right: 1rem;
            transform: scale(1.2);
        }
        
        /* Button Styling - matches your portal */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            text-align: center;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--accent-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }
        
        .btn-full {
            width: 100%;
        }
        
        /* Button Group */
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        @media (max-width: 768px) {
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
        
        /* Messages - matches your system */
        .message {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: none;
            border-left: 4px solid;
        }
        
        .message-success {
            background: #d4edda;
            border-color: var(--success-color);
            color: #155724;
        }
        
        .message-error {
            background: #f8d7da;
            border-color: var(--danger-color);
            color: #721c24;
        }
        
        .message-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        
        /* Loading Indicator */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Calendar Preview */
        .calendar-preview {
            background: var(--light-gray);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .calendar-embed {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 6px;
        }
        
        /* Navigation Tabs - IMPROVED */
        .nav-tabs {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 0;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 1rem 1.75rem;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 12px 12px 0 0;
            font-weight: 700;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.85);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 120px;
            backdrop-filter: blur(5px);
            border-bottom: 3px solid transparent;
            position: relative;
            bottom: -1px;
        }
        
        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .nav-tab.active {
            background: var(--card-bg);
            color: var(--primary-blue);
            border-bottom: 3px solid var(--accent-color);
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
            position: relative;
            z-index: 10;
        }
        
        /* Tab icons */
        .nav-tab::before {
            content: '';
            display: inline-block;
            margin-right: 0.5rem;
            font-size: 1.2em;
            vertical-align: middle;
        }
        
        /* Add icons to each tab (optional) */
        .nav-tab:nth-child(1)::before { content: 'üìÖ'; } /* Make Booking */
        .nav-tab:nth-child(2)::before { content: 'üìã'; } /* View Bookings */
        .nav-tab:nth-child(3)::before { content: 'üóìÔ∏è'; } /* View Calendar */
        .nav-tab:nth-child(4)::before { content: 'üìò'; } /* Guidelines */
        .nav-tab:nth-child(5)::before { content: 'üõ†Ô∏è'; } /* Admin */
        
        /* Mobile Responsiveness for Tabs */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
                gap: 0.5rem;
                border-bottom: none;
            }
            
            .nav-tab {
                width: 100%;
                border-radius: 12px;
                padding: 1rem;
                border-bottom: 2px solid rgba(255, 255, 255, 0.1);
                text-align: left;
                margin-bottom: 0.25rem;
                bottom: 0;
            }
            
            .nav-tab.active {
                border-radius: 12px 12px 0 0;
                border-bottom: 3px solid var(--accent-color);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            .nav-tab::before {
                font-size: 1.3em;
                margin-right: 0.75rem;
            }
        }
        
        /* Small screen adjustments */
        @media (max-width: 480px) {
            .nav-tab {
                padding: 0.875rem;
                font-size: 1rem;
            }
            
            .nav-tab::before {
                font-size: 1.2em;
                margin-right: 0.5rem;
            }
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* View Modes */
        .view-mode-selector {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }
        
        .view-mode-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .view-mode-buttons .btn {
            flex: 1;
            min-width: 150px;
        }
        
        /* Booking Status Badges */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .status-booked {
            background: #d4edda;
            color: #155724;
        }
        
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
            text-decoration: line-through;
        }
        
        .status-past {
            background: #e9ecef;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Cancelled booking styling */
        .booking-cancelled {
            opacity: 0.7;
            background: #f8f9fa !important;
            border-left-color: #95a5a6 !important;
        }
        
        .booking-cancelled .booking-title {
            text-decoration: line-through;
            color: #666;
        }
        
        /* Past booking styling */
        .booking-past {
            opacity: 0.8;
            background: #f8f9fa !important;
        }
        
        /* All Day Booking Checkbox */
        .all-day-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 1rem;
            padding: 1rem;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #d1e9ff;
        }
        
        .all-day-container input[type="checkbox"] {
            transform: scale(1.3);
        }
        
        .all-day-label {
            font-weight: 600;
            color: var(--primary-blue);
            cursor: pointer;
        }
        
        .all-day-times {
            margin-left: auto;
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Calendar Styles */
        .calendar-select {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            background: white;
            min-width: 120px;
        }
        
        .calendar-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .calendar-day {
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            min-height: 120px;
        }
        
        .calendar-day-header {
            font-weight: bold;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .calendar-event {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            border-left: 3px solid;
        }
        
        .calendar-event-clubhouse {
            background: #e3f2fd;
            border-left-color: #3498db;
        }
        
        .calendar-event-gazebo {
            background: #e8f5e9;
            border-left-color: #27ae60;
        }
        
        .calendar-event-recroom {
            background: #f3e5f5;
            border-left-color: #9b59b6;
        }
        
        .calendar-event-cancelled {
            background: #f8d7da;
            border-left-color: #e74c3c;
            opacity: 0.7;
            text-decoration: line-through;
        }
        
        .calendar-event-time {
            font-weight: 600;
            color: #555;
            margin-right: 0.5rem;
        }
        
        .calendar-event-facility {
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            body {
                padding: 10px;
            }
            
            .view-mode-buttons {
                flex-direction: column;
            }
            
            .view-mode-buttons .btn {
                width: 100%;
            }
            
            .calendar-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-select {
                min-width: 100px;
                padding: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .calendar-select {
                min-width: auto;
                flex: 1;
            }
        }
        
        /* NEW: Password management styles matching PasswordSettings */
        .admin-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .admin-section h3 {
            color: var(--primary-blue);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .admin-section p {
            color: #666;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }
        
        .password-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 0.5rem;
        }
        
        .password-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .toggle-password {
            padding: 12px 15px;
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s ease;
        }
        
        .toggle-password:hover {
            background: #e2e8f0;
        }
        
        .password-strength {
            margin-top: 8px;
            font-size: 0.85rem;
        }
        
        .strength-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }
        
        .strength-fill {
            height: 100%;
            transition: all 0.3s ease;
            border-radius: 2px;
        }
        
        .strength-weak { width: 25%; background: #ef4444; }
        .strength-fair { width: 50%; background: #f59e0b; }
        .strength-good { width: 75%; background: #10b981; }
        .strength-strong { width: 100%; background: #059669; }
        
        .strength-text {
            font-size: 0.85rem;
            margin-top: 4px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- NEW: Header matching PasswordSettings.html -->
        <div class="booking-header">
            <div class="header-content">
                <img src="logo.png" alt="Lake Illawong Logo" class="logo-image">
                <div class="title-container">
                    <h1>Book Facilities</h1>
                    <p>Reserve Clubhouse, Gazebo, or Rec Room for your events</p>
                </div>
            </div>
            <div class="header-divider"></div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('booking')">Make Booking</button>
            <button class="nav-tab" onclick="showTab('view')">View Bookings</button>
            <button class="nav-tab" onclick="showTab('calendar')">View Calendar</button>
            <button class="nav-tab" onclick="showTab('guidelines')">Guidelines</button>
            <button class="nav-tab" onclick="showTab('admin')" id="adminTabButton" style="display: none;">Admin</button>
        </div>
        
        <!-- Messages -->
        <div id="message" class="message"></div>
        
        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Processing your request...</p>
        </div>
        
        <!-- Booking Tab -->
        <div id="bookingTab" class="tab-content active">
            <!-- Quick Availability Check -->
            <div class="card" style="margin-bottom: 1.5rem; background: #f0f9ff;">
                <h2 style="color: #1e40af;">üìÖ Quick Availability Check</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label for="quickDate">Date</label>
                        <input type="date" id="quickDate" style="width: 100%;">
                    </div>
                    
                    <div class="form-group">
                        <label for="quickStartTime">Start Time</label>
                        <select id="quickStartTime" style="width: 100%;">
                            <option value="08:00">8:00 AM</option>
                            <option value="09:00">9:00 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="14:00" selected>2:00 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="16:00">4:00 PM</option>
                            <option value="17:00">5:00 PM</option>
                            <option value="18:00">6:00 PM</option>
                            <option value="19:00">7:00 PM</option>
                            <option value="20:00">8:00 PM</option>
                            <option value="21:00">9:00 PM</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="quickEndTime">End Time</label>
                        <select id="quickEndTime" style="width: 100%;">
                            <option value="09:00">9:00 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="16:00" selected>4:00 PM</option>
                            <option value="17:00">5:00 PM</option>
                            <option value="18:00">6:00 PM</option>
                            <option value="19:00">7:00 PM</option>
                            <option value="20:00">8:00 PM</option>
                            <option value="21:00">9:00 PM</option>
                            <option value="22:00">10:00 PM</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="quickCheckAvailability()" style="flex: 1;">
                        üîç Check Availability
                    </button>
                    <button class="btn btn-secondary" onclick="autoFillFromQuickCheck()" style="flex: 1;">
                        ‚úÖ Use These Times
                    </button>
                </div>
                
                <div id="quickAvailabilityResult" style="margin-top: 1rem; display: none;"></div>
            </div>

            <!-- Main Booking Form -->
            <div class="card">
                <h2>Make a Booking</h2>

                <!-- Facility Selection -->
                <div class="form-group required">
                    <label for="facility">Select Facility</label>
                    <div class="time-slots" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                        <!-- Clubhouse -->
                        <label class="time-slot">
                            <input type="radio" name="facility" value="clubhouse" checked required>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 1.5em;">üè†</div>
                                    <div>
                                        <div style="font-weight: bold; font-size: 1.1em;">Clubhouse</div>
                                        <div style="font-size: 0.9em; color: #666;">Main building</div>
                                    </div>
                                </div>
                                <div style="font-size: 0.85em; color: #555; padding-left: 2.25rem;">
                                    ‚Ä¢ Kitchen facilities<br>
                                    ‚Ä¢ Seats up to 50<br>
                                    ‚Ä¢ Air conditioned<br>
                                    ‚Ä¢ TV & sound system
                                </div>
                            </div>
                        </label>
                        
                        <!-- Gazebo -->
                        <label class="time-slot">
                            <input type="radio" name="facility" value="gazebo" required>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 1.5em;">üå≥</div>
                                    <div>
                                        <div style="font-weight: bold; font-size: 1.1em;">Gazebo</div>
                                        <div style="font-size: 0.9em; color: #666;">Outdoor area</div>
                                    </div>
                                </div>
                                <div style="font-size: 0.85em; color: #555; padding-left: 2.25rem;">
                                    ‚Ä¢ Covered outdoor space<br>
                                    ‚Ä¢ BBQ facilities<br>
                                    ‚Ä¢ Picnic tables<br>
                                    ‚Ä¢ Garden lighting
                                </div>
                            </div>
                        </label>
                        
                        <!-- Rec Room -->
                        <label class="time-slot">
                            <input type="radio" name="facility" value="recroom" required>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 1.5em;">üéÆ</div>
                                    <div>
                                        <div style="font-weight: bold; font-size: 1.1em;">Rec Room</div>
                                        <div style="font-size: 0.9em; color: #666;">Games & lounge</div>
                                    </div>
                                </div>
                                <div style="font-size: 0.85em; color: #555; padding-left: 2.25rem;">
                                    ‚Ä¢ Pool table<br>
                                    ‚Ä¢ TV lounge<br>
                                    ‚Ä¢ Board games<br>
                                    ‚Ä¢ Small kitchenette
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <form id="bookingForm">
                    <div class="form-grid">
                        <!-- Left Column -->
                        <div>
                            <!-- Event Name -->
                            <div class="form-group required">
                                <label for="eventName">Event Name</label>
                                <input type="text" id="eventName" name="eventName" 
                                       placeholder="e.g., Birthday Party, Family Gathering" required>
                            </div>
                            
                            <!-- Unit Number -->
                            <div class="form-group required">
                                <label for="unitNumber">Unit Number</label>
                                <input type="text" id="unitNumber" name="unitNumber" required>
                            </div>
                            
                            <!-- Requester Phone -->
                            <div class="form-group">
                                <label for="phone">Requester Phone</label>
                                <input type="tel" id="phone" name="phone">
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div>
                            <!-- Event Date -->
                            <div class="form-group required">
                                <label for="eventDate">Event Date</label>
                                <input type="date" id="eventDate" name="eventDate" required>
                            </div>
                            
                            <!-- Requester Name -->
                            <div class="form-group required">
                                <label for="yourName">Requester Name</label>
                                <input type="text" id="yourName" name="yourName" required>
                            </div>
                            
                            <!-- Requester Email -->
                            <div class="form-group required">
                                <label for="email">Requester Email</label>
                                <input type="email" id="email" name="email" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- All Day Booking Option -->
                    <div class="all-day-container">
                        <input type="checkbox" id="allDayBooking" name="allDayBooking" onchange="toggleAllDayBooking()">
                        <label for="allDayBooking" class="all-day-label">All Day Booking (8:00 AM - 10:00 PM)</label>
                        <div class="all-day-times">14 hours total</div>
                    </div>
                    
                    <!-- Time Slot Selection -->
                    <div class="form-group required">
                        <label>Time Slot</label>
                        <div class="time-slots">
                            <label class="time-slot">
                                <input type="radio" name="timeSlot" value="09:00-11:00" required>
                                <span>üïò Morning (9:00 AM - 11:00 AM)</span>
                            </label>
                            <label class="time-slot">
                                <input type="radio" name="timeSlot" value="14:00-16:00">
                                <span>üïë Afternoon (2:00 PM - 4:00 PM)</span>
                            </label>
                            <label class="time-slot">
                                <input type="radio" name="timeSlot" value="17:00-19:00">
                                <span>üïî Evening (5:00 PM - 7:00 PM)</span>
                            </label>
                            <label class="time-slot">
                                <input type="radio" name="timeSlot" value="custom">
                                <span>‚è∞ Custom Time</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Custom Time Fields -->
                    <div id="customTimeFields" style="display: none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="startTime">Start Time</label>
                                <input type="time" id="startTime" name="startTime" min="06:00" max="22:00">
                            </div>
                            <div class="form-group">
                                <label for="endTime">End Time</label>
                                <input type="time" id="endTime" name="endTime" min="06:00" max="22:00">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Event Type -->
                    <div class="form-group required">
                        <label for="eventType">Event Type</label>
                        <select id="eventType" name="eventType" required>
                            <option value="">Select event type</option>
                            <option value="birthday">üéÇ Birthday Party</option>
                            <option value="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Gathering</option>
                            <option value="committee">üìã Committee Meeting</option>
                            <option value="social">üíÉ Social Event</option>
                            <option value="other">üìÖ Other</option>
                        </select>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="checkAvailability()">
                            üîç Check Availability
                        </button>
                        <button type="submit" class="btn btn-primary btn-large">
                            üìÖ Confirm Booking
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- View Bookings Tab -->
        <div id="viewTab" class="tab-content">
            <div class="card">
                <h2>View Bookings</h2>
                
                <!-- View Mode Selector -->
                <div class="view-mode-selector">
                    <h3 style="margin-bottom: 1rem; color: var(--primary-blue);">Select View Mode:</h3>
                    
                    <!-- Public View (Default) -->
                    <div id="publicViewInfo" style="display: block;">
                        <p style="margin-bottom: 1rem;"><strong>Public View:</strong> Shows all bookings with limited details (facility, date, time only).</p>
                        <div class="view-mode-buttons">
                            <button class="btn btn-secondary" onclick="showPersonalView()">
                                üîê Show My Bookings
                            </button>
                            <button class="btn btn-warning" onclick="toggleAdminLogin()">
                                üõ†Ô∏è Admin Access
                            </button>
                        </div>
                    </div>
                    
                    <!-- Personal View -->
                    <div id="personalViewForm" style="display: none;">
                        <p style="margin-bottom: 1rem;"><strong>Personal View:</strong> Enter your email to view and manage your bookings.</p>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="email" id="personalEmail" placeholder="Enter your email address" style="flex: 1;">
                            <button class="btn btn-primary" onclick="loadPersonalBookings()">
                                Load My Bookings
                            </button>
                            <button class="btn btn-secondary" onclick="showPublicView()">
                                Back to Public View
                            </button>
                        </div>
                        <div id="personalEmailStatus" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
                    </div>
                    
                    <!-- Admin Login -->
                    <div id="adminLoginForm" style="display: none;">
                        <p style="margin-bottom: 1rem;"><strong>Admin Access:</strong> Enter admin password to view all bookings.</p>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="password" id="adminPassword" placeholder="Enter admin password" style="flex: 1;">
                            <button class="btn btn-warning" onclick="loginAsAdmin()">
                                Login as Admin
                            </button>
                            <button class="btn btn-secondary" onclick="showPublicView()">
                                Back to Public View
                            </button>
                        </div>
                        <div id="adminLoginStatus" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
                    </div>
                    
                    <!-- Admin View Active -->
                    <div id="adminViewActive" style="display: none;">
                        <p style="margin-bottom: 1rem;"><strong>Admin View Active:</strong> You can view and manage all bookings.</p>
                        <div class="view-mode-buttons">
                            <button class="btn btn-warning" onclick="loadAllBookings()">
                                üîÑ Refresh All Bookings
                            </button>
                            <button class="btn btn-secondary" onclick="logoutAdmin()">
                                Logout Admin Access
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Bookings Display -->
                <div id="bookingsList">
                    <!-- Bookings will be loaded here -->
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="loadBookings()">
                        üîÑ Refresh List
                    </button>
                </div>
            </div>
        </div>
        
        <!-- View Calendar Tab - SIMPLE CUSTOM CALENDAR -->
        <div id="calendarTab" class="tab-content">
            <div class="card">
                <h2>üìÖ Facilities Calendar</h2>
                
                <!-- Calendar Controls -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="loadCalendarView()" style="min-width: 140px;">
                            <span style="font-size: 1.1em;">üîÑ</span> Load Calendar
                        </button>
                        
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <select id="calendarMonth" class="calendar-select" onchange="loadCalendarView()">
                                <option value="0">January</option>
                                <option value="1">February</option>
                                <option value="2">March</option>
                                <option value="3">April</option>
                                <option value="4">May</option>
                                <option value="5">June</option>
                                <option value="6">July</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">October</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                            </select>
                            
                            <select id="calendarYear" class="calendar-select" onchange="loadCalendarView()">
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                            
                            <select id="calendarFacility" class="calendar-select" onchange="loadCalendarView()">
                                <option value="all">All Facilities</option>
                                <option value="clubhouse">üè† Clubhouse</option>
                                <option value="gazebo">üå≥ Gazebo</option>
                                <option value="recroom">üéÆ Rec Room</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-secondary" onclick="goToToday()" style="margin-left: auto;">
                            <span style="font-size: 1.1em;">üìÖ</span> Today
                        </button>
                    </div>
                    
                    <!-- Legend -->
                    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; padding: 0.75rem; background: #f8f9fa; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; background: #3498db; border-radius: 2px;"></div>
                            <span style="font-size: 0.9em; font-weight: 600;">üè† Clubhouse</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; background: #27ae60; border-radius: 2px;"></div>
                            <span style="font-size: 0.9em; font-weight: 600;">üå≥ Gazebo</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; background: #9b59b6; border-radius: 2px;"></div>
                            <span style="font-size: 0.9em; font-weight: 600;">üéÆ Rec Room</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto;">
                            <div style="width: 12px; height: 12px; background: #f8d7da; border-radius: 2px; border: 1px solid #721c24;"></div>
                            <span style="font-size: 0.9em; font-weight: 600;">Cancelled</span>
                        </div>
                    </div>
                </div>
                
                <!-- Calendar Display -->
                <div id="simpleCalendar" style="min-height: 400px; padding: 1.5rem; background: white; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="text-align: center; color: #666; padding: 3rem;">
                        <div style="font-size: 3em; margin-bottom: 1rem;">üìÖ</div>
                        <h3 style="margin-bottom: 0.5rem; color: var(--primary-blue);">Facilities Calendar</h3>
                        <p style="margin-bottom: 1.5rem;">View all bookings across Clubhouse, Gazebo, and Rec Room</p>
                        <button class="btn btn-primary btn-large" onclick="loadCalendarView()">
                            <span style="font-size: 1.2em;">üîÑ</span> Load Calendar
                        </button>
                        <p style="margin-top: 1rem; font-size: 0.9em; color: #888;">
                            Shows upcoming and recent bookings
                        </p>
                    </div>
                </div>
                
                <!-- Info Panel -->
                <div style="margin-top: 1.5rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary-blue);">üí° Using the Calendar</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #555; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2em;">üîç</span> Check Availability
                            </div>
                            <div style="font-size: 0.9em; color: #666; line-height: 1.5;">
                                1. Select month and facility<br>
                                2. See booked times in color<br>
                                3. Use "Make Booking" tab to book<br>
                                4. Cancel if plans change
                            </div>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #555; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2em;">üè†</span> Facility Colors
                            </div>
                            <div style="font-size: 0.9em; color: #666; line-height: 1.5;">
                                ‚Ä¢ <span style="color: #3498db;">Blue</span>: Clubhouse<br>
                                ‚Ä¢ <span style="color: #27ae60;">Green</span>: Gazebo<br>
                                ‚Ä¢ <span style="color: #9b59b6;">Purple</span>: Rec Room<br>
                                ‚Ä¢ <span style="color: #e74c3c;">Red</span>: Cancelled
                            </div>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #555; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2em;">üì±</span> Mobile Friendly
                            </div>
                            <div style="font-size: 0.9em; color: #666; line-height: 1.5;">
                                ‚Ä¢ Works on all devices<br>
                                ‚Ä¢ Quick loading<br>
                                ‚Ä¢ No external dependencies<br>
                                ‚Ä¢ Secure and private
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Guidelines Tab -->
        <div id="guidelinesTab" class="tab-content">
            <div class="card">
                <h2>üè† Clubhouse Guidelines & Rules</h2>
                
                <div style="display: grid; gap: 1.5rem;">
                    <!-- Booking Rules -->
                    <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3498db;">
                        <h3 style="color: #1e40af; margin-bottom: 1rem;">üìÖ Booking Rules</h3>
                        <ul style="padding-left: 1.5rem;">
                            <li>Bookings can be made up to 90 days in advance</li>
                            <li>Maximum booking duration: 8 hours per day</li>
                            <li>Operating hours: 6:00 AM to 10:00 PM</li>
                            <li>Bookings must be made by residents only</li>
                            <li>Please cancel if you cannot attend</li>
                        </ul>
                    </div>
                    
                    <!-- Usage Guidelines -->
                    <div style="background: #f0fff4; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #27ae60;">
                        <h3 style="color: #166534; margin-bottom: 1rem;">‚úÖ Usage Guidelines</h3>
                        <ul style="padding-left: 1.5rem;">
                            <li>Leave the clubhouse clean and tidy</li>
                            <li>Return furniture to original positions</li>
                            <li>Dispose of all rubbish properly</li>
                            <li>Turn off all lights and appliances after use</li>
                            <li>Report any damage to management immediately</li>
                        </ul>
                    </div>
                    
                    <!-- Noise & Conduct -->
                    <div style="background: #fff7ed; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #f39c12;">
                        <h3 style="color: #92400e; margin-bottom: 1rem;">üîä Noise & Conduct</h3>
                        <ul style="padding-left: 1.5rem;">
                            <li>Respect quiet hours: 8:00 PM to 8:00 AM</li>
                            <li>Keep noise at reasonable levels</li>
                            <li>Be considerate of nearby residents</li>
                            <li>No amplified music after 8:00 PM</li>
                            <li>Maximum capacity: 30 people</li>
                        </ul>
                    </div>
                    
                    <!-- Important Reminders -->
                    <div style="background: #fef2f2; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #e74c3c;">
                        <h3 style="color: #991b1b; margin-bottom: 1rem;">‚ö†Ô∏è Important Reminders</h3>
                        <ul style="padding-left: 1.5rem;">
                            <li>You are responsible for your guests</li>
                            <li>No smoking inside the clubhouse</li>
                            <li>Alcohol consumption must be responsible</li>
                            <li>Fire exits must remain clear at all times</li>
                            <li>Emergency contact: [Your Contact Number]</li>
                        </ul>
                    </div>
                    
                    <!-- Contact Information -->
                    <div style="background: #faf5ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                        <h3 style="color: #5b21b6; margin-bottom: 1rem;">üìû Contact & Support</h3>
                        <div style="display: grid; gap: 0.75rem;">
                            <div>
                                <strong>Booking Issues:</strong>
                                <div>Email: management@lakeillawong.example.com</div>
                            </div>
                            <div>
                                <strong>Emergencies:</strong>
                                <div>Phone: 000 (Emergency Services)</div>
                            </div>
                            <div>
                                <strong>Maintenance:</strong>
                                <div>Contact building management</div>
                            </div>
                            <div>
                                <strong>Lost Property:</strong>
                                <div>Check with security or management</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Simple footer note -->
                <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #dee2e6; text-align: center; color: #666;">
                    <p>These guidelines help ensure the clubhouse remains a pleasant space for all residents.</p>
                    <p>Thank you for your cooperation! üôè</p>
                </div>
            </div>
        </div>
        
        <!-- Admin Tab -->
        <div id="adminTab" class="tab-content">
            <div class="card">
                <h2>üõ†Ô∏è Admin Panel</h2>
                
                <!-- Admin Login Section (shown by default) -->
                <div id="adminLoginSection">
                    <div style="background: #fff3cd; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #ffc107;">
                        <h3 style="color: #856404; margin-bottom: 1rem;">Admin Access Required</h3>
                        <p style="margin-bottom: 1.5rem;">This panel is for administrators only. Please enter the admin password to continue.</p>
                        
                        <div style="max-width: 400px;">
                            <div class="form-group">
                                <label for="adminTabPassword">Admin Password</label>
                                <input type="password" id="adminTabPassword" placeholder="Enter admin password" 
                                       style="width: 100%; padding: 0.75rem; font-size: 1.1rem;">
                            </div>
                            
                            <div class="btn-group" style="margin-top: 1.5rem;">
                                <button class="btn btn-warning" onclick="adminLogin()" style="flex: 1;">
                                    üîê Login as Admin
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Admin Dashboard (hidden until login) -->
                <div id="adminDashboard" style="display: none;">
                    <!-- Status Bar -->
                    <div id="adminStatusBar" style="background: #d4edda; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #28a745;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>üõ†Ô∏è Admin Mode Active</strong>
                                <div style="font-size: 0.9em; margin-top: 0.25rem;">Logged in as: <span id="adminUserName">Administrator</span></div>
                            </div>
                            <button class="btn btn-secondary btn-small" onclick="adminLogout()">
                                üö™ Logout
                            </button>
                        </div>
                    </div>
                    
                    <!-- NEW: Password Management Section -->
                    <div class="admin-section">
                        <h3>üîê Password Management</h3>
                        <p>Change admin password for the booking system (shared with Admin Portal)</p>
                        
                        <div class="form-group">
                            <label for="currentBookingPassword">Current Admin Password</label>
                            <div class="password-input-group">
                                <input type="password" id="currentBookingPassword" class="password-input" placeholder="Enter current password">
                                <button class="toggle-password" onclick="togglePassword('currentBookingPassword', this)">üëÅÔ∏è</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="newBookingPassword">New Admin Password</label>
                            <div class="password-input-group">
                                <input type="password" id="newBookingPassword" class="password-input" placeholder="Enter new password (min 6 characters)" 
                                       oninput="checkBookingPasswordStrength()">
                                <button class="toggle-password" onclick="togglePassword('newBookingPassword', this)">üëÅÔ∏è</button>
                            </div>
                            <div class="password-strength">
                                <div class="strength-bar">
                                    <div class="strength-fill" id="bookingStrengthFill"></div>
                                </div>
                                <div class="strength-text" id="bookingStrengthText"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmBookingPassword">Confirm New Password</label>
                            <input type="password" id="confirmBookingPassword" class="password-input" placeholder="Confirm new password">
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="updateBookingPassword()">
                                üîÑ Update Password
                            </button>
                            <button class="btn btn-secondary" onclick="generateBookingPassword()">
                                üé≤ Generate Secure Password
                            </button>
                        </div>
                        
                        <div id="bookingPasswordMessage" class="message" style="margin-top: 1rem;"></div>
                        
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; font-size: 0.85rem; color: #666;">
                            <strong>üí° Note:</strong> This password is shared with the Admin Portal. Changing it here will affect admin access across all portals.
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--primary-blue);">‚ö° Quick Actions</h3>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="showCreateEventModal()">
                                ‚ûï Add Event
                            </button>
                            <button class="btn btn-warning" onclick="showBlockTimeModal()">
                                ‚õî Block Time
                            </button>
                            <button class="btn btn-secondary" onclick="loadAllEvents()">
                                üîÑ Refresh Events
                            </button>
                            <button class="btn btn-success" onclick="showReports()">
                                üìä View Reports
                            </button>
                        </div>
                    </div>
                    
                    <!-- Calendar Status Dashboard -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--primary-blue);">üìÖ Calendar Status</h3>
                        <div id="calendarStatus" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <!-- Calendar status cards will be loaded here -->
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 1rem;"></div>
                                Loading calendar status...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upcoming Events -->
                    <div style="margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="color: var(--primary-blue); margin: 0;">üìã Upcoming Events (Next 30 Days)</h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="adminFacilityFilter" class="calendar-select" onchange="loadAllEvents()" style="min-width: 150px;">
                                    <option value="all">All Facilities</option>
                                    <option value="clubhouse">üè† Clubhouse</option>
                                    <option value="gazebo">üå≥ Gazebo</option>
                                    <option value="recroom">üéÆ Rec Room</option>
                                </select>
                                <select id="adminViewType" class="calendar-select" onchange="loadAllEvents()" style="min-width: 120px;">
                                    <option value="list">List View</option>
                                    <option value="calendar">Calendar View</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="adminEventsList">
                            <!-- Events will be loaded here -->
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 1rem;"></div>
                                Loading events...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistics -->
                    <div>
                        <h3 style="margin-bottom: 1rem; color: var(--primary-blue);">üìä Quick Statistics</h3>
                        <div id="adminStatistics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="background: #e8f4fd; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; margin-bottom: 0.5rem;">üìÖ</div>
                                <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 0.25rem;">--</div>
                                <div style="font-size: 0.9em; color: #666;">Total Events</div>
                            </div>
                            <div style="background: #e8f4fd; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; margin-bottom: 0.5rem;">üè†</div>
                                <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 0.25rem;">--</div>
                                <div style="font-size: 0.9em; color: #666;">Clubhouse</div>
                            </div>
                            <div style="background: #e8f4fd; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; margin-bottom: 0.5rem;">üå≥</div>
                                <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 0.25rem;">--</div>
                                <div style="font-size: 0.9em; color: #666;">Gazebo</div>
                            </div>
                            <div style="background: #e8f4fd; padding: 1.5rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; margin-bottom: 0.5rem;">üéÆ</div>
                                <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 0.25rem;">--</div>
                                <div style="font-size: 0.9em; color: #666;">Rec Room</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Create Event Modal -->
<div id="createEventModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; width: 90%; max-width: 500px; border-radius: 12px; padding: 2rem; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 1.5rem; color: var(--primary-blue);">‚ûï Create Event</h3>
        
        <div class="form-group">
            <label for="adminEventFacility">Select Facility</label>
            <select id="adminEventFacility" class="calendar-select" style="width: 100%;">
                <option value="clubhouse">üè† Clubhouse</option>
                <option value="gazebo">üå≥ Gazebo</option>
                <option value="recroom">üéÆ Rec Room</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="adminEventTitle">Event Title</label>
            <input type="text" id="adminEventTitle" placeholder="e.g., Committee Meeting, Maintenance" style="width: 100%;">
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label for="adminEventDate">Date</label>
                <input type="date" id="adminEventDate" style="width: 100%;">
            </div>
            <div class="form-group">
                <label for="adminEventStartTime">Start Time</label>
                <input type="time" id="adminEventStartTime" style="width: 100%;">
            </div>
            <div class="form-group">
                <label for="adminEventEndTime">End Time</label>
                <input type="time" id="adminEventEndTime" style="width: 100%;">
            </div>
        </div>
        
        <div class="form-group">
            <label for="adminEventDescription">Description (Optional)</label>
            <textarea id="adminEventDescription" placeholder="Event details, notes, etc." rows="3" style="width: 100%;"></textarea>
        </div>
        
        <div class="btn-group" style="margin-top: 2rem;">
            <button class="btn btn-secondary" onclick="hideCreateEventModal()" style="flex: 1;">
                Cancel
            </button>
            <button class="btn btn-primary" onclick="createAdminEvent()" style="flex: 1;">
                Create Event
            </button>
        </div>
    </div>
</div>

    <script>
    // ========== CONFIGURATION ==========
    var BACKEND_URL = 'https://script.google.com/macros/s/AKfycbwHwXWJdSpRP6j3CJVDWSZ_n6vEBjEhpA9wZv1AunaGsCfKPBaIGnzrexJe_8asf6PF/exec';
    var ADMIN_PASSWORD = 'admin2024'; // Changed from committee2024
    
    // NEW: Password Manager API (same as PasswordSettings.html)
    var PASSWORD_API = 'https://script.google.com/macros/s/AKfycbyu0RdVfmlQEnr1wi5tfkPi-tGNLzKcs5H3R9DAnKXzZROwqEPhnCvpNq3CsjKGeaxXwA/exec';
    
    // ========== GLOBAL STATE ==========
    var currentTab = 'booking';
    var currentViewMode = 'public'; // 'public', 'personal', 'admin'
    var userEmail = '';
    var isAdmin = false;
    var adminLoggedIn = false;
    
    // ========== TAB NAVIGATION ==========
    function showTab(tabName) {
        // ADMIN CHECK
        if (tabName === 'admin' && !adminLoggedIn) {
            showMessage('Please log in as admin to access admin panel', 'info');
            return;
        }
        
        // Update tabs
        document.querySelectorAll('.nav-tab').forEach(function(tab) {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(function(content) {
            content.classList.remove('active');
        });
        
        // Activate selected tab
        var tabIndex = ['booking','view','calendar','guidelines','admin'].indexOf(tabName) + 1;
        var tabSelector = `.nav-tab:nth-child(${tabIndex})`;
        document.querySelector(tabSelector).classList.add('active');
        document.getElementById(tabName + 'Tab').classList.add('active');
        currentTab = tabName;
        
        // Load data if needed
        if (tabName === 'view') {
            loadBookings();
        } else if (tabName === 'calendar') {
            setTimeout(() => {
                if (document.getElementById('simpleCalendar').innerHTML.includes('üìÖ')) {
                    loadCalendarView();
                }
            }, 300);
        } else if (tabName === 'admin' && adminLoggedIn) {
            loadCalendarStatus();
            loadAllEvents();
        }
    }
    
    // ========== ADMIN TAB VISIBILITY ==========
    function updateAdminTabVisibility() {
        var adminTabButton = document.getElementById('adminTabButton');
        if (adminTabButton) {
            adminTabButton.style.display = adminLoggedIn ? 'flex' : 'none';
        }
    }
    
    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîê Booking System v1.0 - Password Manager Integrated');
        
        // Set date restrictions for main form
        var today = new Date();
        var dateInput = document.getElementById('eventDate');
        dateInput.min = today.toISOString().split('T')[0];
        
        var maxDate = new Date();
        maxDate.setDate(today.getDate() + 90);
        dateInput.max = maxDate.toISOString().split('T')[0];
        
        // Default main form to tomorrow
        var tomorrow = new Date();
        tomorrow.setDate(today.getDate() + 1);
        dateInput.value = tomorrow.toISOString().split('T')[0];
        
        // Set quick check date to tomorrow too
        var quickDateInput = document.getElementById('quickDate');
        if (quickDateInput) {
            quickDateInput.min = today.toISOString().split('T')[0];
            quickDateInput.max = maxDate.toISOString().split('T')[0];
            quickDateInput.value = tomorrow.toISOString().split('T')[0];
        }
        
        // Set calendar to current month
        var currentMonth = today.getMonth();
        document.getElementById('calendarMonth').value = currentMonth;
        
        // Handle custom time selection
        document.querySelectorAll('input[name="timeSlot"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                var customFields = document.getElementById('customTimeFields');
                if (this.value === 'custom') {
                    customFields.style.display = 'block';
                } else {
                    customFields.style.display = 'none';
                }
                
                // Update styling
                document.querySelectorAll('.time-slot').forEach(function(slot) {
                    slot.classList.remove('selected');
                });
                this.closest('.time-slot').classList.add('selected');
            });
        });
        
        // Form submission
        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitBooking();
        });
        
        // Load initial bookings (public view)
        loadBookings();
        
        // Try to load saved email from localStorage
        var savedEmail = localStorage.getItem('lakeIllawongBookingEmail');
        if (savedEmail) {
            document.getElementById('personalEmail').value = savedEmail;
        }
        
        // Update admin tab visibility
        updateAdminTabVisibility();
        
        // Setup password strength checking
        document.getElementById('newBookingPassword').addEventListener('input', checkBookingPasswordStrength);
    });
    
    // ========== PASSWORD MANAGEMENT FUNCTIONS ==========
    
    // Toggle password visibility
    function togglePassword(inputId, button) {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
            input.type = 'text';
            button.textContent = 'üôà';
        } else {
            input.type = 'password';
            button.textContent = 'üëÅÔ∏è';
        }
    }
    
    // Check password strength
    function checkBookingPasswordStrength() {
        const password = document.getElementById('newBookingPassword').value;
        const strengthFill = document.getElementById('bookingStrengthFill');
        const strengthText = document.getElementById('bookingStrengthText');
        
        if (!password) {
            strengthFill.className = 'strength-fill';
            strengthText.textContent = '';
            return;
        }
        
        let score = 0;
        let feedback = '';
        
        // Reset classes
        strengthFill.className = 'strength-fill';
        
        if (password.length >= 6) score++;
        if (password.length >= 8) score++;
        if (/[A-Z]/.test(password)) score++;
        if (/[0-9]/.test(password)) score++;
        
        if (score === 1) {
            strengthFill.classList.add('strength-weak');
            feedback = 'Weak - Too simple';
            strengthText.style.color = '#ef4444';
        } else if (score === 2) {
            strengthFill.classList.add('strength-fair');
            feedback = 'Fair - Could be stronger';
            strengthText.style.color = '#f59e0b';
        } else if (score === 3) {
            strengthFill.classList.add('strength-good');
            feedback = 'Good - Strong password';
            strengthText.style.color = '#10b981';
        } else {
            strengthFill.classList.add('strength-strong');
            feedback = 'Excellent - Very secure password';
            strengthText.style.color = '#059669';
        }
        
        strengthText.textContent = feedback;
    }
    
    // Generate random password
    function generateBookingPassword() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let password = '';
        for (let i = 0; i < 10; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        
        const input = document.getElementById('newBookingPassword');
        input.value = password;
        input.type = 'text'; // Show generated password
        
        // Update strength indicator
        checkBookingPasswordStrength();
        
        // Auto-fill confirm field
        document.getElementById('confirmBookingPassword').value = password;
        document.getElementById('confirmBookingPassword').type = 'text';
        
        showBookingPasswordMessage('‚úÖ Secure password generated! Both fields filled.', 'success');
    }
    
    // Update booking system admin password
    function updateBookingPassword() {
        const currentPass = document.getElementById('currentBookingPassword').value;
        const newPass = document.getElementById('newBookingPassword').value;
        const confirmPass = document.getElementById('confirmBookingPassword').value;
        const messageDiv = document.getElementById('bookingPasswordMessage');
        
        // Validation
        if (!currentPass || !newPass || !confirmPass) {
            showBookingPasswordMessage('All fields are required', 'error');
            return;
        }
        
        if (newPass !== confirmPass) {
            showBookingPasswordMessage('New passwords do not match', 'error');
            return;
        }
        
        if (newPass.length < 6) {
            showBookingPasswordMessage('Password must be at least 6 characters', 'error');
            return;
        }
        
        // First validate current password
        validateCurrentPassword(currentPass, function(isValid) {
            if (!isValid) {
                showBookingPasswordMessage('Current password is incorrect', 'error');
                return;
            }
            
            // Update password via Password Manager API
            const callbackName = `booking_pass_callback_${Date.now()}`;
            
            window[callbackName] = function(data) {
                if (data.success) {
                    showBookingPasswordMessage('‚úÖ Booking system password updated successfully! Shared with Admin Portal.', 'success');
                    
                    // Update local admin password variable
                    ADMIN_PASSWORD = newPass;
                    
                    // Clear form
                    document.getElementById('currentBookingPassword').value = '';
                    document.getElementById('newBookingPassword').value = '';
                    document.getElementById('confirmBookingPassword').value = '';
                    
                    // Reset strength indicator
                    document.getElementById('bookingStrengthFill').className = 'strength-fill';
                    document.getElementById('bookingStrengthText').textContent = '';
                    
                    // Show success in main message area too
                    showMessage('üîê Admin password updated successfully', 'success');
                } else {
                    showBookingPasswordMessage('‚ùå Failed to update password: ' + (data.error || 'Unknown error'), 'error');
                }
                delete window[callbackName];
            };
            
            const script = document.createElement('script');
            script.src = `${PASSWORD_API}?action=updatePassword&portal=admin&newPassword=${encodeURIComponent(newPass)}&updatedBy=BookingSystem&callback=${callbackName}`;
            script.onerror = function() {
                showBookingPasswordMessage('Failed to connect to password service', 'error');
                delete window[callbackName];
            };
            document.head.appendChild(script);
        });
    }
    
    // Validate current password with Password Manager
    function validateCurrentPassword(password, callback) {
        const callbackName = `validate_pass_callback_${Date.now()}`;
        
        window[callbackName] = function(data) {
            callback(data.success && data.isValid);
            delete window[callbackName];
        };
        
        const script = document.createElement('script');
        script.src = `${PASSWORD_API}?action=validatePassword&portal=admin&password=${encodeURIComponent(password)}&callback=${callbackName}`;
        document.head.appendChild(script);
    }
    
    // Show password message
    function showBookingPasswordMessage(message, type) {
        const element = document.getElementById('bookingPasswordMessage');
        element.textContent = message;
        element.className = `message message-${type}`;
        element.style.display = 'block';
        
        setTimeout(() => {
            element.style.display = 'none';
        }, 5000);
    }
    
    // ========== ALL DAY BOOKING ==========
    function toggleAllDayBooking() {
        var allDayCheckbox = document.getElementById('allDayBooking');
        var customRadio = document.querySelector('input[name="timeSlot"][value="custom"]');
        var customFields = document.getElementById('customTimeFields');
        
        if (allDayCheckbox.checked) {
            // Set custom time slot and fill with 8am-10pm
            if (customRadio) {
                customRadio.checked = true;
                customRadio.dispatchEvent(new Event('change'));
                document.getElementById('startTime').value = '08:00';
                document.getElementById('endTime').value = '22:00';
                customFields.style.display = 'block';
            }
            
            // Disable other time slot options
            document.querySelectorAll('input[name="timeSlot"]:not([value="custom"])').forEach(function(radio) {
                radio.disabled = true;
                radio.closest('.time-slot').style.opacity = '0.5';
                radio.closest('.time-slot').style.cursor = 'not-allowed';
            });
        } else {
            // Re-enable time slot options
            document.querySelectorAll('input[name="timeSlot"]:not([value="custom"])').forEach(function(radio) {
                radio.disabled = false;
                radio.closest('.time-slot').style.opacity = '1';
                radio.closest('.time-slot').style.cursor = 'pointer';
            });
            
            // If custom was selected just for all-day, reset to first option
            if (customRadio && customRadio.checked) {
                var firstRadio = document.querySelector('input[name="timeSlot"]:not([value="custom"])');
                if (firstRadio) {
                    firstRadio.checked = true;
                    firstRadio.dispatchEvent(new Event('change'));
                }
            }
        }
    }
    
    // ========== VIEW MODE MANAGEMENT ==========
    function showPublicView() {
        currentViewMode = 'public';
        userEmail = '';
        isAdmin = false;
        adminLoggedIn = false;
        
        // Update UI
        document.getElementById('publicViewInfo').style.display = 'block';
        document.getElementById('personalViewForm').style.display = 'none';
        document.getElementById('adminLoginForm').style.display = 'none';
        document.getElementById('adminViewActive').style.display = 'none';
        
        // Clear fields
        document.getElementById('personalEmail').value = '';
        document.getElementById('adminPassword').value = '';
        
        // Update admin tab
        updateAdminTabVisibility();
        
        // Load public bookings
        loadBookings();
    }
    
    function showPersonalView() {
        // Show personal view form
        document.getElementById('publicViewInfo').style.display = 'none';
        document.getElementById('personalViewForm').style.display = 'block';
        document.getElementById('adminLoginForm').style.display = 'none';
        document.getElementById('adminViewActive').style.display = 'none';
        
        // Focus on email field
        document.getElementById('personalEmail').focus();
    }
    
    function toggleAdminLogin() {
        // Show admin login form
        document.getElementById('publicViewInfo').style.display = 'none';
        document.getElementById('personalViewForm').style.display = 'none';
        document.getElementById('adminLoginForm').style.display = 'block';
        document.getElementById('adminViewActive').style.display = 'none';
        
        // Focus on password field
        document.getElementById('adminPassword').focus();
    }
    
    function loadPersonalBookings() {
        var email = document.getElementById('personalEmail').value.trim();
        if (!email) {
            document.getElementById('personalEmailStatus').innerHTML = 
                '<span style="color: var(--danger-color);">Please enter your email address</span>';
            return;
        }
        
        // Validate email format
        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            document.getElementById('personalEmailStatus').innerHTML = 
                '<span style="color: var(--danger-color);">Please enter a valid email address</span>';
            return;
        }
        
        // Save email to localStorage for convenience
        localStorage.setItem('lakeIllawongBookingEmail', email);
        
        // Set current view mode
        currentViewMode = 'personal';
        userEmail = email;
        isAdmin = false;
        adminLoggedIn = false;
        
        // Update UI
        document.getElementById('personalEmailStatus').innerHTML = 
            '<span style="color: var(--success-color);">Loading your bookings...</span>';
        
        // Update admin tab
        updateAdminTabVisibility();
        
        // Load personal bookings
        loadBookings();
    }
    
    function loginAsAdmin() {
        var password = document.getElementById('adminPassword').value;
        
        if (password === ADMIN_PASSWORD) {
            // Admin login successful - SET ALL ADMIN FLAGS
            currentViewMode = 'admin';
            userEmail = '';
            isAdmin = true;
            adminLoggedIn = true;
            
            // Update UI in View Bookings tab
            updateAdminTabVisibility();
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('adminViewActive').style.display = 'block';
            document.getElementById('adminLoginStatus').innerHTML = 
                '<span style="color: var(--success-color);">Admin access granted</span>';
            
            // Clear password field for security
            document.getElementById('adminPassword').value = '';
            
            // Load all bookings in admin view
            loadBookings();
            
            // Show success message
            showMessage('‚úÖ Admin access granted. You can now access the Admin tab.', 'success');
            
        } else {
            document.getElementById('adminLoginStatus').innerHTML = 
                '<span style="color: var(--danger-color);">Incorrect password</span>';
        }
    }
    
    function logoutAdmin() {
        // Reset ALL admin states completely
        currentViewMode = 'public';
        userEmail = '';
        isAdmin = false;
        adminLoggedIn = false;
        
        // Update UI in View Bookings tab
        updateAdminTabVisibility();
        showPublicView();
        
        // ALSO logout from Admin tab if it's open
        if (document.getElementById('adminDashboard').style.display !== 'none') {
            document.getElementById('adminLoginSection').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('adminTabPassword').value = '';
        }
        
        // Show message
        showMessage('üëã Admin access ended', 'info');
    }
    
    function loadAllBookings() {
        loadBookings();
    }
    
    // ========== LOAD BOOKINGS ==========
    function loadBookings() {
        showLoading(true);
        
        callAPI('getBookings', {}, function(response) {
            showLoading(false);
            
            console.log('üìä Booking response:', response);
            
            var bookingsList = document.getElementById('bookingsList');
            if (!bookingsList) return;
            
            if (response.success && response.bookings && response.bookings.length > 0) {
                // Filter bookings based on view mode
                var filteredBookings = response.bookings;
                
                if (currentViewMode === 'personal' && userEmail) {
                    filteredBookings = response.bookings.filter(function(booking) {
                        return booking.residentEmail && 
                               booking.residentEmail.toLowerCase() === userEmail.toLowerCase();
                    });
                }
                
                // Sort by date (most recent first)
                filteredBookings.sort(function(a, b) {
                    return new Date(b.start) - new Date(a.start);
                });
                
                // Separate upcoming and past bookings
                var now = new Date();
                var upcomingBookings = [];
                var pastBookings = [];
                
                filteredBookings.forEach(function(booking) {
                    var bookingDate = new Date(booking.start);
                    if (bookingDate >= now) {
                        upcomingBookings.push(booking);
                    } else {
                        pastBookings.push(booking);
                    }
                });
                
                // Sort upcoming by date (soonest first)
                upcomingBookings.sort(function(a, b) {
                    return new Date(a.start) - new Date(b.start);
                });
                
                var html = '';
                
                // Show view mode info
                if (currentViewMode === 'public') {
                    html += '<div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">';
                    html += '<p><strong>Public View:</strong> Showing facility availability only. No personal details are shown.</p>';
                    html += '<p style="margin-top: 0.5rem; font-size: 0.9em;">To view and manage your bookings, click "Show My Bookings" above.</p>';
                    html += '</div>';
                } else if (currentViewMode === 'personal') {
                    html += '<div style="background: #d4edda; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #28a745;">';
                    html += '<p><strong>Personal View:</strong> Showing your bookings only. Email: ' + userEmail + '</p>';
                    if (upcomingBookings.length === 0) {
                        html += '<p style="margin-top: 0.5rem; font-size: 0.9em;">You have no upcoming bookings.</p>';
                    }
                    html += '</div>';
                } else if (currentViewMode === 'admin') {
                    html += '<div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #ffc107;">';
                    html += '<p><strong>Admin View:</strong> Showing all bookings. You can manage any booking.</p>';
                    html += '<p style="margin-top: 0.5rem; font-size: 0.9em;">Total bookings: ' + filteredBookings.length + '</p>';
                    html += '</div>';
                }
                
                // Show upcoming bookings
                if (upcomingBookings.length > 0) {
                    html += '<h3 style="margin-bottom: 1rem; color: var(--primary-blue);">Upcoming Bookings</h3>';
                    html += '<div style="display: grid; gap: 1rem; margin-bottom: 2rem;">';
                    
                    upcomingBookings.forEach(function(booking) {
                        html += renderBookingCard(booking);
                    });
                    
                    html += '</div>';
                }
                
                // Show past bookings (only in personal/admin views)
                if ((currentViewMode === 'personal' || currentViewMode === 'admin') && pastBookings.length > 0) {
                    html += '<h3 style="margin-bottom: 1rem; color: #666; border-top: 1px solid #dee2e6; padding-top: 1.5rem;">Past Bookings</h3>';
                    html += '<div style="display: grid; gap: 1rem; opacity: 0.8;">';
                    
                    pastBookings.forEach(function(booking) {
                        html += renderBookingCard(booking);
                    });
                    
                    html += '</div>';
                }
                
                if (filteredBookings.length === 0) {
                    if (currentViewMode === 'personal') {
                        html += '<div style="text-align: center; padding: 3rem; color: #666;">';
                        html += '<div style="font-size: 2em; margin-bottom: 1rem;">üì≠</div>';
                        html += '<p style="font-size: 1.1em; margin-bottom: 0.5rem;">No bookings found for ' + userEmail + '</p>';
                        html += '<p>Make a booking using the "Make Booking" tab.</p>';
                        html += '</div>';
                    } else {
                        html += '<p style="text-align: center; color: #666; padding: 2rem;">No bookings found.</p>';
                    }
                }
                
                bookingsList.innerHTML = html;
            } else {
                bookingsList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No bookings found.</p>';
            }
        });
    }
    
    // ========== RENDER BOOKING CARD ==========
    function renderBookingCard(booking) {
        var startTime = new Date(booking.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        var endTime = new Date(booking.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        var date = new Date(booking.start).toLocaleDateString('en-AU', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        
        // Determine if booking is past or upcoming
        var bookingDate = new Date(booking.start);
        var now = new Date();
        var isPast = bookingDate < now;
        var isCancelled = booking.status === 'Cancelled';
        
        // Determine facility details
        var facility = booking.facility || 'clubhouse';
        var facilityIcon = 'üè†';
        var borderColor = '#3498db';
        
        if (facility === 'gazebo') {
            facilityIcon = 'üå≥';
            borderColor = '#27ae60';
        } else if (facility === 'recroom') {
            facilityIcon = 'üéÆ';
            borderColor = '#9b59b6';
        }
        
        var facilityName = booking.facilityName || 
                         (facility === 'clubhouse' ? 'Clubhouse' : 
                          facility === 'gazebo' ? 'Gazebo' : 
                          'Rec Room');
        
        // GET THE CORRECT EVENT TITLE
        // Priority: title > purpose > description > "Event"
        var eventTitle = booking.title || 
                        booking.purpose || 
                        booking.description || 
                        'Event Booking';
        
        var html = '';
        
        // Public view - limited information
        if (currentViewMode === 'public') {
            var statusBadge = '';
            var statusIcon = '‚úÖ';
            
            if (isCancelled) {
                statusBadge = '<span class="status-badge status-cancelled">CANCELLED</span>';
                statusIcon = '‚ùå';
            } else if (isPast) {
                statusBadge = '<span class="status-badge status-past">PAST</span>';
                statusIcon = '‚è∞';
            } else {
                statusBadge = '<span class="status-badge status-booked">BOOKED</span>';
                statusIcon = '‚úÖ';
            }
            
            html += '<div style="background: white; border-left: 4px solid ' + borderColor + '; padding: 1rem; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);' + (isCancelled ? ' opacity: 0.6;' : '') + '">';
            
            html += '<div style="display: flex; align-items: center; justify-content: space-between;">';
            html += '<div>';
            html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
            html += '<span style="font-size: 1.2em;">' + facilityIcon + '</span>';
            html += '<span style="font-weight: bold;">' + facilityName + '</span>';
            html += statusBadge;
            html += '</div>';
            html += '<div style="color: #666; font-size: 0.9rem; margin-top: 0.25rem;">';
            html += '<span>' + date + '</span>';
            html += '<span style="margin: 0 0.5rem;">‚Ä¢</span>';
            html += '<span>' + startTime + ' - ' + endTime + '</span>';
            html += '</div>';
            html += '</div>';
            
            html += '<div style="font-size: 1.5em;">' + statusIcon + '</div>';
            html += '</div>';
            
            html += '</div>';
            return html;
        }
        
        // Personal/Admin view - full information
        var additionalClass = '';
        if (isCancelled) {
            additionalClass = 'booking-cancelled';
        } else if (isPast) {
            additionalClass = 'booking-past';
        }
        
        html += '<div style="background: white; border-left: 4px solid ' + borderColor + '; padding: 1rem; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);" class="' + additionalClass + '">';
        
        // Facility header
        html += '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">';
        html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
        html += '<span style="font-size: 1.2em;">' + facilityIcon + '</span>';
        html += '<span style="font-weight: bold; font-size: 0.95em;">' + facilityName + '</span>';
        
        // STATUS BADGE
        if (isCancelled) {
            html += '<span class="status-badge status-cancelled">CANCELLED</span>';
        } else if (isPast) {
            html += '<span class="status-badge status-past">PAST</span>';
        } else {
            html += '<span class="status-badge status-booked">UPCOMING</span>';
        }
        html += '</div>';
        
        // Admin indicator
        if (currentViewMode === 'admin') {
            html += '<span style="background: #fff3cd; color: #856404; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8em; font-weight: bold;">üõ†Ô∏è ADMIN VIEW</span>';
        }
        html += '</div>';
        
        // Event title
        var titleClass = isCancelled ? 'booking-title' : '';
        html += '<div style="font-weight: bold; margin-bottom: 0.75rem; font-size: 1.1em;" class="' + titleClass + '">' + eventTitle + '</div>';
        
        // Date and time
        html += '<div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; line-height: 1.4;">';
        html += '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">';
        html += '<span style="font-size: 0.9em;">üìÖ</span>';
        html += '<span>' + date + '</span>';
        html += '</div>';
        html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
        html += '<span style="font-size: 0.9em;">üïê</span>';
        html += '<span>' + startTime + ' - ' + endTime + '</span>';
        html += '</div>';
        html += '</div>';
        
        // Personal details (only in personal/admin views)
        if (currentViewMode === 'personal' || currentViewMode === 'admin') {
            html += '<div style="background: #f8f9fa; padding: 0.75rem; border-radius: 4px; margin-bottom: 0.75rem;">';
            html += '<div style="font-size: 0.9em; color: #555;">';
            
            // Show requestor
            html += '<div><strong>Requestor:</strong> ' + (booking.residentName || 'N/A') + '</div>';
            
            if (currentViewMode === 'admin') {
                html += '<div><strong>Email:</strong> ' + (booking.residentEmail || 'N/A') + '</div>';
                
                // Show unit number if available
                if (booking.unitNumber && booking.unitNumber !== 'N/A') {
                    html += '<div><strong>Unit:</strong> ' + booking.unitNumber + '</div>';
                }
            }
            
            html += '</div>';
            html += '</div>';
        }
        
        // Booking ID
        if (booking.bookingId) {
            html += '<div style="font-size: 0.8em; color: #888; margin-bottom: 0.75rem; background: #f8f9fa; padding: 0.4rem 0.6rem; border-radius: 4px; word-break: break-all;">';
            html += 'Booking ID: ' + booking.bookingId;
            html += '</div>';
        }
        
        // CANCEL BUTTON - Only show for upcoming, non-cancelled bookings with permission
        if (!isCancelled && !isPast) {
            var showCancelButton = false;
            var cancelButtonStyle = '';
            
            if (currentViewMode === 'admin') {
                showCancelButton = true;
                cancelButtonStyle = 'btn-danger';
            } else if (currentViewMode === 'personal' && booking.residentEmail && 
                      booking.residentEmail.toLowerCase() === userEmail.toLowerCase()) {
                showCancelButton = true;
                cancelButtonStyle = 'btn-secondary';
            }
            
            if (showCancelButton) {
                html += '<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">';
                html += '<button class="btn btn-small ' + cancelButtonStyle + ' cancel-btn" data-booking-id="' + booking.bookingId + '" style="width: 100%;">';
                html += '‚ùå Cancel Booking';
                html += '</button>';
                html += '</div>';
            }
        }
        
        html += '</div>';
        return html;
    }
    
    // ========== CALENDAR VIEW ==========
    function loadCalendarView() {
        const month = parseInt(document.getElementById('calendarMonth').value);
        const year = parseInt(document.getElementById('calendarYear').value);
        const facility = document.getElementById('calendarFacility').value;
        
        showLoading(true);
        
        callAPI('getBookings', {}, function(response) {
            showLoading(false);
            
            if (response.success && response.bookings && response.bookings.length > 0) {
                displayCalendar(response.bookings, month, year, facility);
            } else {
                document.getElementById('simpleCalendar').innerHTML = 
                    `<div style="text-align: center; padding: 3rem; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 1rem;">üì≠</div>
                        <h3 style="margin-bottom: 0.5rem;">No Bookings Found</h3>
                        <p>No bookings for the selected period.</p>
                    </div>`;
            }
        });
    }
    
    function displayCalendar(bookings, month, year, facilityFilter) {
        // Filter bookings for selected month/year and facility
        const filteredBookings = bookings.filter(booking => {
            const date = new Date(booking.start);
            const monthMatch = month === -1 || date.getMonth() === month;
            const yearMatch = date.getFullYear() === year;
            const facilityMatch = facilityFilter === 'all' || booking.facility === facilityFilter;
            return monthMatch && yearMatch && facilityMatch;
        });
        
        // Sort by date
        filteredBookings.sort((a, b) => new Date(a.start) - new Date(b.start));
        
        // Group by date
        const bookingsByDate = {};
        filteredBookings.forEach(booking => {
            const date = new Date(booking.start);
            const dateStr = date.toLocaleDateString('en-AU', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            if (!bookingsByDate[dateStr]) {
                bookingsByDate[dateStr] = {
                    date: date,
                    dateStr: dateStr,
                    bookings: []
                };
            }
            bookingsByDate[dateStr].bookings.push(booking);
        });
        
        // Sort dates
        const sortedDates = Object.values(bookingsByDate).sort((a, b) => a.date - b.date);
        
        // Display
        if (sortedDates.length === 0) {
            document.getElementById('simpleCalendar').innerHTML = 
                `<div style="text-align: center; padding: 3rem; color: #666;">
                    <div style="font-size: 3em; margin-bottom: 1rem;">üìÖ</div>
                    <h3 style="margin-bottom: 0.5rem;">No Bookings for ${getMonthName(month)} ${year}</h3>
                    <p>Select a different month or facility.</p>
                </div>`;
            return;
        }
        
        let html = '<div class="calendar-grid">';
        
        sortedDates.forEach(dayData => {
            html += `<div class="calendar-day">
                        <div class="calendar-day-header">${dayData.dateStr}</div>
                        <div>`;
            
            // Sort bookings by time
            dayData.bookings.sort((a, b) => new Date(a.start) - new Date(b.start));
            
            dayData.bookings.forEach(booking => {
                const startTime = new Date(booking.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const endTime = new Date(booking.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const facility = booking.facility || 'clubhouse';
                const facilityName = booking.facilityName || 
                                   (facility === 'clubhouse' ? 'Clubhouse' : 
                                    facility === 'gazebo' ? 'Gazebo' : 'Rec Room');
                const isCancelled = booking.status === 'Cancelled';
                
                // Get event title
                const eventTitle = booking.title || booking.purpose || booking.description || 'Booking';
                
                let eventClass = `calendar-event calendar-event-${facility}`;
                if (isCancelled) {
                    eventClass += ' calendar-event-cancelled';
                }
                
                html += `<div class="${eventClass}">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <div>
                                    <span class="calendar-event-time">${startTime} - ${endTime}</span>
                                    <span class="calendar-event-facility">${facilityName}</span>
                                </div>
                                ${isCancelled ? '<span style="color: #e74c3c; font-weight: 600;">CANCELLED</span>' : ''}
                            </div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${eventTitle}</div>
                            <div style="font-size: 0.85em; color: #666;">
                                ${booking.residentName || ''}
                            </div>
                        </div>`;
            });
            
            html += '</div></div>';
        });
        
        html += '</div>';
        
        // Add summary
        const summary = `<div style="margin-bottom: 1.5rem; padding: 1rem; background: #e8f4fd; border-radius: 6px; border-left: 4px solid #3498db;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">üìä Summary for ${getMonthName(month)} ${year}</div>
                            <div style="display: flex; gap: 1rem; font-size: 0.9em;">
                                <span>Total bookings: ${filteredBookings.length}</span>
                                <span>‚Ä¢</span>
                                <span>Dates shown: ${sortedDates.length}</span>
                                ${facilityFilter !== 'all' ? `<span>‚Ä¢</span><span>Facility: ${document.getElementById('calendarFacility').selectedOptions[0].text}</span>` : ''}
                            </div>
                        </div>`;
        
        document.getElementById('simpleCalendar').innerHTML = summary + html;
    }
    
    function getMonthName(monthIndex) {
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
        return months[monthIndex];
    }
    
    function goToToday() {
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        
        document.getElementById('calendarMonth').value = currentMonth;
        document.getElementById('calendarYear').value = currentYear;
        
        loadCalendarView();
    }
    
    // ========== BOOKING CANCELLATION ==========
    function showCancelConfirmation(bookingId) {
        showLoading(true);
        
        callAPI('getBookingDetails', {
            bookingId: bookingId
        }, function(response) {
            showLoading(false);
            
            if (response.success && response.booking) {
                var booking = response.booking;
                var message = 'Are you sure you want to cancel this booking?\n\n' +
                             'Facility: ' + booking.facilityName + '\n' +
                             'Event: ' + booking.title + '\n' +
                             'Date: ' + booking.date + '\n' +
                             'Time: ' + booking.startTime + ' - ' + booking.endTime + '\n' +
                             'Booking ID: ' + booking.bookingId + '\n\n' +
                             'This action cannot be undone.';
                
                if (confirm(message)) {
                    cancelBooking(bookingId);
                }
            } else {
                if (confirm('Cancel booking ' + bookingId + '?\n\nThis action cannot be undone.')) {
                    cancelBooking(bookingId);
                }
            }
        });
    }
    
    function cancelBooking(bookingId) {
        if (!bookingId) {
            showMessage('Error: No booking ID provided', 'error');
            return;
        }
        
        showLoading(true);
        
        callAPI('cancelBooking', {
            bookingId: bookingId
        }, function(response) {
            showLoading(false);
            
            if (response.success) {
                showMessage('‚úÖ Booking cancelled successfully. A confirmation email has been sent.', 'success');
                loadBookings();
                if (currentTab === 'calendar') {
                    loadCalendarView();
                }
            } else {
                showMessage('‚ùå Error: ' + (response.error || 'Failed to cancel booking'), 'error');
            }
        });
    }
    
    // ========== CHECK AVAILABILITY ==========
    function checkAvailability() {
        var formData = getFormData();
        if (!formData) return;
        
        showLoading(true);
        hideMessage();
        
        callAPI('checkAvailability', {
            date: formData.date,
            startTime: formData.startTime,
            endTime: formData.endTime,
            facility: formData.facility
        }, function(response) {
            showLoading(false);
            
            if (response.success) {
                if (response.available) {
                    showMessage('‚úÖ This time slot is available!', 'success');
                } else {
                    showMessage('‚ùå This time slot is already booked.', 'error');
                    if (response.conflictingEvents && response.conflictingEvents.length > 0) {
                        var conflict = response.conflictingEvents[0];
                        showMessage('Conflict with: ' + conflict.title, 'error');
                    }
                }
            } else {
                showMessage('Error: ' + response.error, 'error');
            }
        });
    }
    
    // ========== SUBMIT BOOKING ==========
    function submitBooking() {
        var formData = getFormData();
        if (!formData) return;
        
        showLoading(true);
        hideMessage();
        
        callAPI('createBooking', formData, function(response) {
            showLoading(false);
            
            if (response.success) {
                showMessage('‚úÖ Booking confirmed! Booking ID: ' + response.bookingId + '. Check your email for details.', 'success');
                document.getElementById('bookingForm').reset();
                
                // Save email for easy access later
                if (formData.residentEmail) {
                    localStorage.setItem('lakeIllawongBookingEmail', formData.residentEmail);
                }
                
                loadBookings();
                if (currentTab === 'calendar') {
                    loadCalendarView();
                }
            } else {
                showMessage('‚ùå Error: ' + response.error, 'error');
            }
        });
    }
    
    // ========== GET FORM DATA ==========
    function getFormData() {
        console.log('üîç getFormData() called');
        
        var form = document.getElementById('bookingForm');
        var formData = new FormData(form);
        var data = Object.fromEntries(formData);
        
        console.log('Raw form data:', data);
        
        // Validate required fields
        if (!data.yourName || data.yourName.trim() === '') {
            showMessage('Please enter your name', 'error');
            return null;
        }
        
        if (!data.email || data.email.trim() === '') {
            showMessage('Please enter your email', 'error');
            return null;
        }
        
        if (!data.eventDate || data.eventDate.trim() === '') {
            showMessage('Please select a date', 'error');
            return null;
        }
        
        if (!data.unitNumber || data.unitNumber.trim() === '') {
            showMessage('Please enter your unit number', 'error');
            return null;
        }
        
        // Check if All Day booking is selected
        var allDayBooking = document.getElementById('allDayBooking').checked;
        
        // Handle time slot
        var startTime, endTime;
        if (allDayBooking) {
            // All Day booking: 8am to 10pm
            startTime = '08:00';
            endTime = '22:00';
        } else if (data.timeSlot === 'custom') {
            if (!data.startTime || !data.endTime) {
                showMessage('Please specify custom start and end times', 'error');
                return null;
            }
            startTime = data.startTime;
            endTime = data.endTime;
        } else {
            var times = data.timeSlot.split('-');
            startTime = times[0];
            endTime = times[1];
        }
        
        // Get selected facility
        var facility = 'clubhouse';
        var facilityRadio = document.querySelector('input[name="facility"]:checked');
        if (facilityRadio) {
            facility = facilityRadio.value;
        }
        
        // Get event name (fallback to "Event" if empty)
        var eventName = data.eventName ? data.eventName.trim() : 'Event';
        if (eventName === '') eventName = 'Event';
        
        console.log('Selected facility:', facility);
        console.log('Event name:', eventName);
        console.log('Unit number:', data.unitNumber);
        
        // Mapped backend data - EXACT FIELD NAMES NEEDED BY BACKEND
        var backendData = {
            facility: facility,
            residentName: data.yourName.trim(),
            residentEmail: data.email.trim(),
            residentPhone: data.phone ? data.phone.trim() : '',
            unitNumber: data.unitNumber.trim(),  // Ensure this is included
            date: data.eventDate,
            startTime: startTime,
            endTime: endTime,
            purpose: eventName + (data.eventType ? ' (' + data.eventType + ')' : ''),
            // Add eventTitle for consistency with admin events
            eventTitle: eventName
        };
        
        console.log('‚úÖ Mapped backend data:', backendData);
        return backendData;
    }
    
    // ========== QUICK AVAILABILITY CHECK ==========
    function quickCheckAvailability() {
        var date = document.getElementById('quickDate').value;
        var startTime = document.getElementById('quickStartTime').value;
        var endTime = document.getElementById('quickEndTime').value;
        
        // Get selected facility from main form
        var facility = 'clubhouse';
        var facilityRadio = document.querySelector('input[name="facility"]:checked');
        if (facilityRadio) {
            facility = facilityRadio.value;
        }
        
        if (!date) {
            alert('Please select a date');
            return;
        }
        
        if (startTime >= endTime) {
            alert('End time must be after start time');
            return;
        }
        
        // Show loading
        var resultDiv = document.getElementById('quickAvailabilityResult');
        resultDiv.innerHTML = '<div style="text-align: center; padding: 1rem;"><div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div> Checking availability...</div>';
        resultDiv.style.display = 'block';
        
        // Call backend WITH FACILITY
        callAPI('checkAvailability', {
            date: date,
            startTime: startTime,
            endTime: endTime,
            facility: facility
        }, function(response) {
            console.log('Availability response:', response);
            
            if (response.success) {
                if (response.available) {
                    // FULLY AVAILABLE
                    resultDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 1rem; border-radius: 6px; border-left: 4px solid #28a745;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">‚úÖ ${response.facilityName || 'Facility'} AVAILABLE!</div>
                        <div>The ${response.facilityName || 'facility'} is available on ${formatDate(date)} from ${formatTime(startTime)} to ${formatTime(endTime)}.</div>
                        <div style="margin-top: 0.5rem; font-size: 0.9em;">
                            <button class="btn btn-primary" onclick="autoFillFromQuickCheck()" style="padding: 0.5rem 1rem; font-size: 0.9em;">
                                üìÖ Book This Slot
                            </button>
                        </div>
                    </div>
                    `;
                } else {
                    // NOT AVAILABLE
                    let conflictHtml = '';
                    if (response.conflicts && response.conflicts.length > 0) {
                        conflictHtml = `<div style="margin-top: 0.5rem; font-size: 0.9em;">
                            <strong>Conflicts with:</strong>
                            <ul style="margin: 0.25rem 0; padding-left: 1.5rem;">`;
                        response.conflicts.forEach(conflict => {
                            conflictHtml += `<li>${conflict.title} (${conflict.time})</li>`;
                        });
                        conflictHtml += '</ul></div>';
                    }
                    
                    resultDiv.innerHTML = `
                    <div style="background: #fff3cd; color: #856404; padding: 1rem; border-radius: 6px; border-left: 4px solid #ffc107;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">‚ùå NOT AVAILABLE</div>
                        <div>${response.facilityName || 'The facility'} is not available for ${formatTime(startTime)} - ${formatTime(endTime)}.</div>
                        ${conflictHtml}
                        <div style="margin-top: 0.5rem; font-size: 0.9em;">
                            <button class="btn btn-secondary" onclick="document.getElementById('quickStartTime').focus()" style="padding: 0.5rem 1rem; font-size: 0.9em; margin-right: 0.5rem;">
                                ‚úèÔ∏è Adjust Times
                            </button>
                            <button class="btn btn-primary" onclick="quickCheckAvailability()" style="padding: 0.5rem 1rem; font-size: 0.9em;">
                                üîç Check Again
                            </button>
                        </div>
                    </div>
                    `;
                }
            } else {
                // ERROR
                let errorMessage = response.error || response.message || 'Unknown error occurred';
                
                resultDiv.innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 6px; border-left: 4px solid #dc3545;">
                    <div style="font-weight: bold;">‚ùå Error Checking Availability</div>
                    <div>${errorMessage}</div>
                    <div style="margin-top: 0.5rem; font-size: 0.9em;">
                        <button class="btn btn-secondary" onclick="quickCheckAvailability()" style="padding: 0.5rem 1rem; font-size: 0.9em;">
                            Try Again
                        </button>
                    </div>
                </div>
                `;
            }
        });
    }
    
    // ========== HELPER FUNCTIONS ==========
    function formatDate(dateStr) {
        var date = new Date(dateStr + 'T00:00:00');
        return date.toLocaleDateString('en-AU', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
    
    function formatTime(timeStr) {
        var [hours, minutes] = timeStr.split(':');
        var hour = parseInt(hours);
        var suffix = hour >= 12 ? 'PM' : 'AM';
        var displayHour = hour > 12 ? hour - 12 : hour;
        if (displayHour === 0) displayHour = 12;
        return displayHour + ':' + minutes + ' ' + suffix;
    }
    
    function autoFillFromQuickCheck() {
        var date = document.getElementById('quickDate').value;
        var startTime = document.getElementById('quickStartTime').value;
        var endTime = document.getElementById('quickEndTime').value;
        
        if (!date) {
            alert('Please check availability first');
            return;
        }
        
        // Check if this is an All Day booking (8am-10pm)
        var isAllDay = (startTime === '08:00' && endTime === '22:00');
        
        // Fill main form date
        document.getElementById('eventDate').value = date;
        
        if (isAllDay) {
            // Set All Day checkbox
            document.getElementById('allDayBooking').checked = true;
            toggleAllDayBooking();
        } else {
            // Fill custom time slot
            var customRadio = document.querySelector('input[name="timeSlot"][value="custom"]');
            if (customRadio) {
                customRadio.checked = true;
                customRadio.dispatchEvent(new Event('change'));
                document.getElementById('startTime').value = startTime;
                document.getElementById('endTime').value = endTime;
            }
        }
        
        // Scroll to main form
        document.getElementById('bookingForm').scrollIntoView({ behavior: 'smooth' });
        
        // Focus on first field
        document.getElementById('eventName').focus();
        
        // Show success message
        showMessage('Form filled with selected time slot!', 'success');
    }
    
    // ========== IMPROVED API CALL ==========
    function callAPI(action, data, callback) {
        console.log('üìû callAPI called for action:', action);
        console.log('Data:', data);
        
        // Generate a unique callback name
        var callbackName = 'callback_' + new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9);
        console.log('Callback name:', callbackName);
        
        // Define the callback on window BEFORE creating the script
        window[callbackName] = function(response) {
            console.log('üéØ Callback received for', callbackName, ':', response);
            
            // Clean up
            delete window[callbackName];
            
            // Call the original callback
            if (typeof callback === 'function') {
                callback(response);
            }
        };
        
        // Build URL with proper encoding
        var url = BACKEND_URL + '?action=' + encodeURIComponent(action) + '&callback=' + callbackName;
        
        // Add data parameters
        for (var key in data) {
            if (data[key] !== undefined && data[key] !== null && data[key] !== '') {
                url += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(data[key]);
            }
        }
        
        console.log('üåê URL:', url);
        
        // Create script element
        var script = document.createElement('script');
        script.src = url;
        script.id = 'jsonp_' + callbackName;
        
        // Add error handling
        script.onerror = function(error) {
            console.error('‚ùå Script load error for', callbackName, ':', error);
            
            // Clean up
            var scriptEl = document.getElementById('jsonp_' + callbackName);
            if (scriptEl && scriptEl.parentNode) {
                scriptEl.parentNode.removeChild(scriptEl);
            }
            
            delete window[callbackName];
            
            // Return error to callback
            if (typeof callback === 'function') {
                callback({ 
                    success: false, 
                    error: 'Network error or server unavailable',
                    message: 'Failed to load data from server. Please check your connection.'
                });
            }
        };
        
        // Add timeout
        var timeoutId = setTimeout(function() {
            console.error('‚è∞ Timeout for callback:', callbackName);
            
            var scriptEl = document.getElementById('jsonp_' + callbackName);
            if (scriptEl && scriptEl.parentNode) {
                scriptEl.parentNode.removeChild(scriptEl);
            }
            
            if (window[callbackName]) {
                delete window[callbackName];
            }
            
            if (typeof callback === 'function') {
                callback({ 
                    success: false, 
                    error: 'Request timeout',
                    message: 'The server took too long to respond. Please try again.'
                });
            }
        }, 15000); // 15 second timeout
        
        // Update callback to clear timeout
        var originalCallback = window[callbackName];
        window[callbackName] = function(response) {
            clearTimeout(timeoutId);
            originalCallback(response);
        };
        
        // Add to body
        document.body.appendChild(script);
        console.log('üìÑ Script element appended:', script.id);
        
        // Also clean up script element after it loads (in case callback is called)
        script.onload = function() {
            console.log('‚úÖ Script loaded:', script.id);
            // Script cleanup will happen in the callback
        };
    }
    
    // ========== UI HELPERS ==========
    function showMessage(text, type) {
        var messageEl = document.getElementById('message');
        messageEl.textContent = text;
        messageEl.className = 'message message-' + type;
        messageEl.style.display = 'block';
        
        // Auto-hide success messages
        if (type === 'success') {
            setTimeout(hideMessage, 8000);
        }
    }
    
    function hideMessage() {
        document.getElementById('message').style.display = 'none';
    }
    
    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
    
    // Handle cancel button clicks
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('cancel-btn')) {
            var bookingId = e.target.getAttribute('data-booking-id');
            showCancelConfirmation(bookingId);
        }
    });
    
    // ========== ADMIN FUNCTIONS ==========
    function adminLogin() {
        var password = document.getElementById('adminTabPassword').value;
        
        if (password === ADMIN_PASSWORD) {
            // Admin login successful - SET ALL ADMIN FLAGS
            adminLoggedIn = true;
            currentViewMode = 'admin';
            isAdmin = true;
            
            // Show admin dashboard
            document.getElementById('adminLoginSection').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            
            // Update UI
            updateAdminTabVisibility();
            
            // Load admin data
            loadCalendarStatus();
            loadAllEvents();
            
            // Show success message
            showMessage('‚úÖ Admin access granted', 'success');
            
            // Clear password field for security
            document.getElementById('adminTabPassword').value = '';
            
        } else {
            showMessage('‚ùå Invalid password', 'error');
        }
    }
    
    function adminLogout() {
        // Reset ALL admin states completely
        currentViewMode = 'public';
        userEmail = '';
        isAdmin = false;
        adminLoggedIn = false;
        
        // Show login section in Admin tab
        document.getElementById('adminLoginSection').style.display = 'block';
        document.getElementById('adminDashboard').style.display = 'none';
        
        // Clear password field
        document.getElementById('adminTabPassword').value = '';
        
        // Update UI
        updateAdminTabVisibility();
        
        // ALSO logout from View Bookings tab if needed
        if (document.getElementById('adminViewActive').style.display !== 'none') {
            showPublicView();
        }
        
        // Switch to booking tab
        showTab('booking');
        
        showMessage('üëã Admin access ended', 'info');
    }
    
    function loadCalendarStatus() {
        if (!adminLoggedIn) return;
        
        console.log('üîç Loading calendar status...');
        
        callAPI('adminGetCalendarList', { adminPassword: ADMIN_PASSWORD }, function(response) {
            console.log('üìä Calendar status response:', response);
            
            if (response.success && response.calendars) {
                var html = '';
                
                response.calendars.forEach(function(calendar) {
                    var statusColor = calendar.canEdit ? '#28a745' : '#dc3545';
                    var statusIcon = calendar.canEdit ? '‚úÖ' : '‚ùå';
                    var eventText = calendar.eventsCount + ' event' + (calendar.eventsCount !== 1 ? 's' : '');
                    
                    html += `
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border-left: 4px solid ${statusColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 0.25rem;">${calendar.facilityName}</div>
                                <div style="font-size: 0.9em; color: #666;">${calendar.name}</div>
                            </div>
                            <div style="font-size: 1.5em;">${statusIcon}</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9em;">
                            <div style="color: #666;">Events:</div>
                            <div style="text-align: right; font-weight: 600;">${eventText}</div>
                            
                            <div style="color: #666;">Timezone:</div>
                            <div style="text-align: right;">${calendar.timezone || 'N/A'}</div>
                            
                            <div style="color: #666;">Status:</div>
                            <div style="text-align: right; color: ${statusColor}; font-weight: 600;">
                                ${calendar.canEdit ? 'Access OK' : 'No Access'}
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                            <button class="btn btn-small" onclick="viewCalendarEvents('${calendar.facility}')" style="width: 100%;" ${!calendar.canEdit ? 'disabled' : ''}>
                                üëÅÔ∏è View Events
                            </button>
                        </div>
                    </div>
                    `;
                });
                
                document.getElementById('calendarStatus').innerHTML = html;
            } else {
                console.error('‚ùå Failed to load calendar status:', response);
                
                var errorMsg = response.error || response.message || 'Unknown error occurred';
                var debugInfo = '';
                
                // Add debug info if available
                if (response.debug) {
                    debugInfo = `<div style="margin-top: 0.5rem; font-size: 0.8em; color: #666;">Debug: ${response.debug}</div>`;
                }
                
                document.getElementById('calendarStatus').innerHTML = `
                <div style="background: #fff3cd; color: #856404; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <div style="font-size: 2em; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Failed to load calendar status</div>
                    <div style="margin-bottom: 0.5rem;">${errorMsg}</div>
                    ${debugInfo}
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-warning btn-small" onclick="loadCalendarStatus()">
                            üîÑ Retry
                        </button>
                    </div>
                </div>
                `;
            }
        });
    }
    
    function loadAllEvents() {
        if (!adminLoggedIn) return;
        
        showLoading(true);
        
        var facility = document.getElementById('adminFacilityFilter').value;
        var viewType = document.getElementById('adminViewType').value;
        
        var params = {
            adminPassword: ADMIN_PASSWORD,
            startDate: new Date().toISOString().split('T')[0],
            endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
        };
        
        if (facility !== 'all') {
            params.facility = facility;
        }
        
        callAPI('adminGetAllEvents', params, function(response) {
            showLoading(false);
            
            if (response.success && response.events) {
                displayAdminEvents(response.events, viewType);
                updateStatistics(response.events);
            } else {
                document.getElementById('adminEventsList').innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 2rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 0.5rem;">‚ùå</div>
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Failed to load events</div>
                    <div>${response.error || 'Unknown error'}</div>
                </div>
                `;
            }
        });
    }
    
    function displayAdminEvents(events, viewType) {
        if (viewType === 'calendar') {
            displayAdminCalendarView(events);
        } else {
            displayAdminListView(events);
        }
    }
    
    function displayAdminListView(events) {
        if (events.length === 0) {
            document.getElementById('adminEventsList').innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #666; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 3em; margin-bottom: 1rem;">üì≠</div>
                <h4 style="margin-bottom: 0.5rem; color: var(--primary-blue);">No Events Found</h4>
                <p>No events scheduled for the selected period.</p>
                <button class="btn btn-primary" onclick="showCreateEventModal()" style="margin-top: 1rem;">
                    ‚ûï Add First Event
                </button>
            </div>
            `;
            return;
        }
        
        var html = '<div style="display: grid; gap: 1rem;">';
        
        events.forEach(function(event) {
            var startTime = new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            var endTime = new Date(event.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            var date = new Date(event.start).toLocaleDateString('en-AU', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            var facilityIcon = 'üè†';
            var borderColor = '#3498db';
            
            if (event.facility === 'gazebo') {
                facilityIcon = 'üå≥';
                borderColor = '#27ae60';
            } else if (event.facility === 'recroom') {
                facilityIcon = 'üéÆ';
                borderColor = '#9b59b6';
            }
            
            html += `
            <div style="background: white; border-left: 4px solid ${borderColor}; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                            <span style="font-size: 1.2em;">${facilityIcon}</span>
                            <span style="font-weight: bold;">${event.facilityName}</span>
                            <span style="background: #e8f4fd; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8em; font-weight: bold;">
                                ${event.createdBy || 'Booking'}
                            </span>
                        </div>
                        <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 0.5rem;">${event.title || 'Untitled Event'}</div>
                    </div>
                    
                    <div class="btn-group" style="gap: 0.5rem;">
                        <button class="btn btn-small btn-warning" onclick="editAdminEvent('${event.id}', '${event.calendarId}')">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteAdminEvent('${event.id}', '${event.calendarId}', '${event.title}')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
                
                <div style="color: #666; font-size: 0.9rem; margin-bottom: 1rem; line-height: 1.4;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                        <span style="font-size: 0.9em;">üìÖ</span>
                        <span>${date}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 0.9em;">üïê</span>
                        <span>${startTime} - ${endTime}</span>
                    </div>
                </div>
                
                ${event.description ? `
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9em; color: #555;">
                    ${event.description.replace(/\n/g, '<br>')}
                </div>
                ` : ''}
                
                <div style="font-size: 0.8em; color: #888; background: #f8f9fa; padding: 0.5rem 0.75rem; border-radius: 4px;">
                    <div><strong>Event ID:</strong> ${event.id.substring(0, 20)}...</div>
                    <div><strong>Calendar:</strong> ${event.calendarId.substring(0, 20)}...</div>
                    ${event.residentName ? `<div><strong>Requestor:</strong> ${event.residentName}</div>` : ''}
                    ${event.residentEmail ? `<div><strong>Email:</strong> ${event.residentEmail}</div>` : ''}
                    ${event.unitNumber ? `<div><strong>Unit:</strong> ${event.unitNumber}</div>` : ''}
                </div>
            </div>
            `;
        });
        
        html += '</div>';
        document.getElementById('adminEventsList').innerHTML = html;
    }
    
    function updateStatistics(events) {
        var total = events.length;
        var clubhouse = events.filter(e => e.facility === 'clubhouse').length;
        var gazebo = events.filter(e => e.facility === 'gazebo').length;
        var recroom = events.filter(e => e.facility === 'recroom').length;
        
        document.getElementById('adminStatistics').innerHTML = `
        <div style="background: #e8f4fd; padding: 1.5rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; margin-bottom: 0.5rem;">üìÖ</div>
            <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 0.25rem;">${total}</div>
            <div style="font-size: 0.9em; color: #666;">Total Events</div>
        </div>
        <div style="background: #e8f4fd; padding: 1.5rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; margin-bottom: 0.5rem;">üè†</div>
            <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 0.25rem;">${clubhouse}</div>
            <div style="font-size: 0.9em; color: #666;">Clubhouse</div>
        </div>
        <div style="background: #e8f4fd; padding: 1.5rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; margin-bottom: 0.5rem;">üå≥</div>
            <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 0.25rem;">${gazebo}</div>
            <div style="font-size: 0.9em; color: #666;">Gazebo</div>
        </div>
        <div style="background: #e8f4fd; padding: 1.5rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; margin-bottom: 0.5rem;">üéÆ</div>
            <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 0.25rem;">${recroom}</div>
            <div style="font-size: 0.9em; color: #666;">Rec Room</div>
        </div>
        `;
    }
    
    // Modal functions
    function showCreateEventModal() {
        var today = new Date();
        document.getElementById('adminEventDate').value = today.toISOString().split('T')[0];
        document.getElementById('adminEventStartTime').value = '09:00';
        document.getElementById('adminEventEndTime').value = '11:00';
        document.getElementById('adminEventTitle').value = '';
        document.getElementById('adminEventDescription').value = '';
        
        document.getElementById('createEventModal').style.display = 'flex';
    }
    
    function hideCreateEventModal() {
        document.getElementById('createEventModal').style.display = 'none';
    }
    
    function createAdminEvent() {
        var facility = document.getElementById('adminEventFacility').value;
        var title = document.getElementById('adminEventTitle').value.trim();
        var date = document.getElementById('adminEventDate').value;
        var startTime = document.getElementById('adminEventStartTime').value;
        var endTime = document.getElementById('adminEventEndTime').value;
        var description = document.getElementById('adminEventDescription').value.trim();
        
        if (!title) {
            showMessage('Please enter an event title', 'error');
            return;
        }
        
        if (!date) {
            showMessage('Please select a date', 'error');
            return;
        }
        
        if (startTime >= endTime) {
            showMessage('End time must be after start time', 'error');
            return;
        }
        
        showLoading(true);
        
        callAPI('adminCreateEvent', {
            adminPassword: ADMIN_PASSWORD,
            facility: facility,
            eventTitle: title,
            date: date,
            startTime: startTime,
            endTime: endTime,
            description: description,
            adminName: 'Admin',
            adminEmail: 'admin@lakeillawong.example.com'
        }, function(response) {
            showLoading(false);
            
            if (response.success) {
                showMessage(`‚úÖ Event created in ${response.facility}! Booking ID: ${response.bookingId}`, 'success');
                hideCreateEventModal();
                loadAllEvents();
                loadCalendarStatus();
            } else {
                showMessage('‚ùå Failed to create event: ' + (response.error || response.message), 'error');
            }
        });
    }
    
    function deleteAdminEvent(eventId, calendarId, eventTitle) {
        if (!confirm(`Are you sure you want to delete this event?\n\n"${eventTitle}"\n\nThis action cannot be undone.`)) {
            return;
        }
        
        showLoading(true);
        
        callAPI('adminDeleteEvent', {
            adminPassword: ADMIN_PASSWORD,
            eventId: eventId,
            calendarId: calendarId
        }, function(response) {
            showLoading(false);
            
            if (response.success) {
                showMessage('‚úÖ Event deleted successfully', 'success');
                loadAllEvents();
            } else {
                showMessage('‚ùå Failed to delete event: ' + (response.error || response.message), 'error');
            }
        });
    }
    
    function editAdminEvent(eventId, calendarId) {
        showMessage('‚ö†Ô∏è Event editing not yet implemented', 'info');
    }
    
    function viewCalendarEvents(facility) {
        document.getElementById('adminFacilityFilter').value = facility;
        loadAllEvents();
    }
    
    function showReports() {
        showMessage('üìä Reports feature coming soon', 'info');
    }
    
    function showBlockTimeModal() {
        showMessage('‚õî Time blocking feature coming soon', 'info');
    }
    
    function displayAdminCalendarView(events) {
        // Simple list view for now
        displayAdminListView(events);
    }
    
    </script>
</body>
</html>