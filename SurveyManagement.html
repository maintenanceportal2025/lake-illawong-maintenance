<!--
=====================================================================
LAKE ILLAWONG MANAGEMENT SYSTEM - SURVEY MANAGEMENT
=====================================================================
PURPOSE: Administrative survey creation, management, and results analysis
PORTAL: Admin Portal Module
VERSION: 1.0
LAST UPDATED: January 18, 2026
BACKEND API: SurveyModule.js V1.0
DESIGN SYSTEM: Lake Illawong Unified v1.4
- Terminology: "Survey" standard
- Header: Transparent with logo
- Colors: Primary gradient page background
- Layout: White content cards on gradient
- API Protocol: JSONP (GET) + Fetch (POST)
AUTHENTICATION: None (accessed via authenticated Admin Portal)
DEPENDENCIES: SurveyModule.js V1.0
RELATED FILES: AdminPortal.html, CommunitySurveys.html
=====================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Management - Lake Illawong</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(90deg, #1e40af 0%, #1e3a8a 100%);
            min-height: 100vh;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* HEADER */
        .header {
            background: transparent;
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .logo-container {
            flex-shrink: 0;
        }

        .logo-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            padding: 5px;
        }

        .header-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
        }

        .header-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: white;
            margin: 0 0 5px 0;
            line-height: 1.1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header-subtitle {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            margin: 0;
        }

        .header-divider {
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            margin-top: 15px;
        }

        /* NAVIGATION */
        .nav-header {
            background: white;
            padding: 20px 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .nav-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .btn-secondary:hover {
            background: #f8fafc;
        }

        /* VIEWS */
        .view-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            min-height: 400px;
        }

        /* SURVEY LIST */
        .survey-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: #f1f5f9;
            color: #64748b;
            border: 2px solid #e2e8f0;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .survey-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .survey-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .survey-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
        }

        .survey-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .survey-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .survey-description {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .survey-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #64748b;
        }

        .survey-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .survey-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .survey-actions button {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .btn-view {
            background: #f1f5f9;
            color: #667eea;
            border: 1px solid #e2e8f0;
        }

        .btn-view:hover {
            background: #e2e8f0;
        }

        .btn-activate {
            background: #d1fae5;
            color: #047857;
            border: 1px solid #10b981;
        }

        .btn-close {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #ef4444;
        }

        /* STATUS BADGES */
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-draft {
            background: #f3f4f6;
            color: #6b7280;
        }

        .status-active {
            background: #d1fae5;
            color: #047857;
        }

        .status-closed {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-archived {
            background: #fde2e8;
            color: #be185d;
        }

        /* CREATE SURVEY FORM */
        .form-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .section-description {
            color: #64748b;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .form-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .form-hint {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }

        .required {
            color: #ef4444;
        }

        /* QUESTION BUILDER */
        .questions-container {
            margin-top: 25px;
        }

        .question-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1rem;
        }

        .question-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .btn-icon:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .btn-delete {
            color: #ef4444;
        }

        .btn-delete:hover {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .options-container {
            margin-top: 15px;
        }

        .option-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .option-input-group input {
            flex: 1;
        }

        .btn-add-option {
            background: #f1f5f9;
            color: #667eea;
            border: 1px solid #e2e8f0;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            margin-top: 8px;
        }

        .btn-add-option:hover {
            background: #e2e8f0;
        }

        .add-question-btn {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            color: #667eea;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .add-question-btn:hover {
            background: #f1f5f9;
            border-color: #667eea;
        }

        /* RESULTS VIEW */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .summary-label {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .question-result {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .question-result-header {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
        }

        .question-type-badge {
            display: inline-block;
            background: #ede9fe;
            color: #7c3aed;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .answer-bar {
            margin-bottom: 12px;
        }

        .answer-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .answer-count {
            color: #667eea;
            font-weight: 700;
        }

        .progress-bar {
            background: #e2e8f0;
            height: 30px;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .text-responses {
            max-height: 400px;
            overflow-y: auto;
        }

        .text-response {
            background: #f8fafc;
            border-left: 3px solid #667eea;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 6px;
        }

        .response-text {
            color: #1e293b;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .response-meta {
            font-size: 0.85rem;
            color: #64748b;
        }

        .rating-display {
            text-align: center;
            margin: 20px 0;
        }

        .rating-value {
            font-size: 3rem;
            font-weight: 700;
            color: #667eea;
        }

        .rating-stars {
            font-size: 2rem;
            color: #fbbf24;
            margin-top: 10px;
        }

        /* LOADING STATE */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #64748b;
            font-size: 1.1rem;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .empty-state-description {
            font-size: 1rem;
            margin-bottom: 25px;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* SUCCESS MESSAGE */
        .success-message {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #047857;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ERROR MESSAGE */
        .error-message {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #dc2626;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .header-text {
                align-items: center;
                text-align: center;
            }

            .header-title {
                font-size: 1.8rem;
            }

            .logo-image {
                width: 70px;
                height: 70px;
            }

            .survey-grid {
                grid-template-columns: 1fr;
            }

            .nav-header {
                flex-direction: column;
                align-items: stretch;
            }

            .nav-actions {
                flex-direction: column;
            }

            .results-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="header-content">
                <div class="logo-container">
                    <img src="logo.png" alt="Lake Illawong Logo" class="logo-image">
                </div>
                <div class="header-text">
                    <h1 class="header-title">Survey Management</h1>
                    <p class="header-subtitle">Community survey creation and analysis</p>
                </div>
            </div>
            <div class="header-divider"></div>
        </div>

        <!-- NAVIGATION -->
        <div class="nav-header">
            <div class="nav-actions">
                <button class="btn-primary" onclick="showView('list')">
                    üìä Survey List
                </button>
                <button class="btn-primary" onclick="showView('create')">
                    ‚ûï Create Survey
                </button>
                <button class="btn-secondary" onclick="window.location.href='AdminPortal.html'">
                    ‚Üê Back to Admin Portal
                </button>
            </div>
        </div>

        <!-- SURVEY LIST VIEW -->
        <div id="listView" class="view-container">
            <div class="survey-filters">
                <button class="filter-btn active" data-filter="all" onclick="filterSurveys('all')">
                    All Surveys
                </button>
                <button class="filter-btn" data-filter="Draft" onclick="filterSurveys('Draft')">
                    Drafts
                </button>
                <button class="filter-btn" data-filter="Active" onclick="filterSurveys('Active')">
                    Active
                </button>
                <button class="filter-btn" data-filter="Closed" onclick="filterSurveys('Closed')">
                    Closed
                </button>
            </div>

            <div id="surveyList" class="survey-grid">
                <div class="loading-message">
                    <div class="loading-spinner"></div>
                    <div>Loading surveys...</div>
                </div>
            </div>
        </div>

        <!-- CREATE SURVEY VIEW -->
        <div id="createView" class="view-container hidden">
            <div class="form-section">
                <h2 class="section-title">Create New Survey</h2>
                <p class="section-description">Build a community survey to gather feedback from residents</p>

                <div id="createMessage"></div>

                <div class="form-group">
                    <label class="form-label">Survey Title <span class="required">*</span></label>
                    <input type="text" id="surveyTitle" class="form-input" placeholder="e.g., 2026 Community Satisfaction Survey">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="surveyDescription" class="form-textarea" placeholder="Briefly describe the purpose of this survey..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Survey Settings</label>
                    
                    <div class="form-checkbox-group">
                        <input type="checkbox" id="isAnonymous" class="form-checkbox" checked>
                        <label for="isAnonymous">Anonymous responses (recommended for honest feedback)</label>
                    </div>

                    <div class="form-checkbox-group">
                        <input type="checkbox" id="allowMultiple" class="form-checkbox">
                        <label for="allowMultiple">Allow multiple responses per resident</label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Thank You Message</label>
                    <textarea id="thankYouMessage" class="form-textarea" placeholder="Message shown after survey completion...">Thank you for taking the time to provide your valuable feedback!</textarea>
                </div>
            </div>

            <div class="form-section">
                <h2 class="section-title">Questions</h2>
                <p class="section-description">Add questions to your survey (minimum 1 required)</p>

                <div id="questionsContainer" class="questions-container">
                    <!-- Questions will be added here -->
                </div>

                <button class="add-question-btn" onclick="addQuestion()">
                    ‚ûï Add Question
                </button>
            </div>

            <div class="form-section" style="margin-top: 30px;">
                <button class="btn-primary" onclick="saveSurvey()" style="width: 200px;">
                    üíæ Save Survey
                </button>
                <button class="btn-secondary" onclick="showView('list')" style="width: 150px; margin-left: 12px;">
                    Cancel
                </button>
            </div>
        </div>

        <!-- RESULTS VIEW -->
        <div id="resultsView" class="view-container hidden">
            <div class="results-header">
                <div>
                    <h2 id="resultsTitle" class="section-title">Survey Results</h2>
                    <p id="resultsSubtitle" class="section-description"></p>
                </div>
                <button class="btn-secondary" onclick="showView('list')">
                    ‚Üê Back to List
                </button>
            </div>

            <div id="resultsSummary" class="results-summary">
                <!-- Summary cards will be added here -->
            </div>

            <div id="resultsContent">
                <!-- Question results will be added here -->
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const SURVEY_API_URL = 'https://script.google.com/macros/s/AKfycbzuEJAfYZI-5Ak21iRVc1dfAEJooGS4xbxBTrY6ob-1BpXov5shp6HXF4gUowXhzlgH/exec'; // Update this with your deployed SurveyModule URL

        // STATE
        let allSurveys = [];
        let currentFilter = 'all';
        let questionCount = 0;
        let currentSurveyId = null;

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', function() {
            loadSurveys();
        });

        // VIEW MANAGEMENT
        function showView(viewName) {
            document.getElementById('listView').classList.add('hidden');
            document.getElementById('createView').classList.add('hidden');
            document.getElementById('resultsView').classList.add('hidden');

            if (viewName === 'list') {
                document.getElementById('listView').classList.remove('hidden');
                loadSurveys();
            } else if (viewName === 'create') {
                document.getElementById('createView').classList.remove('hidden');
                resetCreateForm();
            } else if (viewName === 'results') {
                document.getElementById('resultsView').classList.remove('hidden');
            }
        }

        // LOAD SURVEYS
        function loadSurveys() {
            const container = document.getElementById('surveyList');
            container.innerHTML = '<div class="loading-message"><div class="loading-spinner"></div><div>Loading surveys...</div></div>';

            // JSONP request
            const callbackName = 'handleSurveysResponse_' + Date.now();
            window[callbackName] = function(data) {
                if (data.success) {
                    allSurveys = data.surveys;
                    renderSurveys();
                } else {
                    container.innerHTML = `<div class="error-message">‚ùå Error loading surveys: ${data.message}</div>`;
                }
                delete window[callbackName];
            };

            const script = document.createElement('script');
            script.src = `${SURVEY_API_URL}?action=getSurveys&includeArchived=false&isAdmin=true&callback=${callbackName}`;
            document.head.appendChild(script);
        }

        // RENDER SURVEYS
        function renderSurveys() {
            const container = document.getElementById('surveyList');
            
            let surveys = allSurveys;
            if (currentFilter !== 'all') {
                surveys = allSurveys.filter(s => s.status === currentFilter);
            }

            if (surveys.length === 0) {
                const filterText = currentFilter === 'all' ? 'surveys' : `${currentFilter.toLowerCase()} surveys`;
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-title">No ${filterText} found</div>
                        <div class="empty-state-description">Create your first survey to get started</div>
                        <button class="btn-primary" onclick="showView('create')">‚ûï Create Survey</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = surveys.map(survey => `
                <div class="survey-card">
                    <div class="survey-card-header">
                        <div class="survey-title">${escapeHtml(survey.title)}</div>
                        <span class="status-badge status-${survey.status.toLowerCase()}">${survey.status}</span>
                    </div>
                    <div class="survey-description">${escapeHtml(survey.description || 'No description')}</div>
                    <div class="survey-meta">
                        <div class="survey-meta-item">
                            üìÖ Created: ${formatDate(survey.createdDate)}
                        </div>
                        <div class="survey-meta-item">
                            üìä ${survey.totalResponses} responses
                        </div>
                        ${survey.isAnonymous ? '<div class="survey-meta-item">üîí Anonymous</div>' : ''}
                    </div>
                    <div class="survey-actions">
                        <button class="btn-view" onclick="viewResults('${survey.surveyId}')">
                            üìà View Results
                        </button>
                        ${survey.status === 'Draft' ? `
                            <button class="btn-activate" onclick="changeSurveyStatus('${survey.surveyId}', 'Active')">
                                ‚ñ∂Ô∏è Activate
                            </button>
                        ` : ''}
                        ${survey.status === 'Active' ? `
                            <button class="btn-close" onclick="changeSurveyStatus('${survey.surveyId}', 'Closed')">
                                ‚è∏Ô∏è Close
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // FILTER SURVEYS
        function filterSurveys(filter) {
            currentFilter = filter;
            
            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });
            
            renderSurveys();
        }

        // CREATE SURVEY FORM
        function resetCreateForm() {
            document.getElementById('surveyTitle').value = '';
            document.getElementById('surveyDescription').value = '';
            document.getElementById('isAnonymous').checked = true;
            document.getElementById('allowMultiple').checked = false;
            document.getElementById('thankYouMessage').value = 'Thank you for taking the time to provide your valuable feedback!';
            document.getElementById('questionsContainer').innerHTML = '';
            document.getElementById('createMessage').innerHTML = '';
            questionCount = 0;
            
            // Add first question
            addQuestion();
        }

        // ADD QUESTION
        function addQuestion() {
            questionCount++;
            const container = document.getElementById('questionsContainer');
            
            const questionCard = document.createElement('div');
            questionCard.className = 'question-card';
            questionCard.dataset.questionId = questionCount;
            questionCard.innerHTML = `
                <div class="question-header">
                    <div class="question-number">Question ${questionCount}</div>
                    <div class="question-actions">
                        <button class="btn-icon btn-delete" onclick="deleteQuestion(${questionCount})">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Question Text <span class="required">*</span></label>
                    <input type="text" class="form-input question-text" placeholder="Enter your question..." required>
                </div>

                <div class="form-group">
                    <label class="form-label">Question Type <span class="required">*</span></label>
                    <select class="form-select question-type" onchange="handleQuestionTypeChange(${questionCount})">
                        <option value="Rating">Rating (1-5 stars)</option>
                        <option value="Single Choice">Single Choice</option>
                        <option value="Multiple Choice">Multiple Choice</option>
                        <option value="Text">Text Response</option>
                        <option value="Yes/No">Yes/No</option>
                    </select>
                </div>

                <div class="options-container" style="display: none;">
                    <label class="form-label">Options <span class="required">*</span></label>
                    <div class="options-list">
                        <div class="option-input-group">
                            <input type="text" class="form-input option-input" placeholder="Option 1">
                            <button class="btn-icon btn-delete" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                        </div>
                        <div class="option-input-group">
                            <input type="text" class="form-input option-input" placeholder="Option 2">
                            <button class="btn-icon btn-delete" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                        </div>
                    </div>
                    <button class="btn-add-option" onclick="addOption(${questionCount})">+ Add Option</button>
                </div>

                <div class="form-group">
                    <label class="form-label">Help Text (optional)</label>
                    <input type="text" class="form-input question-help" placeholder="Additional guidance for respondents...">
                </div>

                <div class="form-checkbox-group">
                    <input type="checkbox" class="form-checkbox question-required" checked>
                    <label>Required question</label>
                </div>
            `;
            
            container.appendChild(questionCard);
        }

        // DELETE QUESTION
        function deleteQuestion(questionId) {
            const card = document.querySelector(`.question-card[data-question-id="${questionId}"]`);
            if (card) {
                card.remove();
                // Renumber remaining questions
                const cards = document.querySelectorAll('.question-card');
                cards.forEach((card, index) => {
                    card.querySelector('.question-number').textContent = `Question ${index + 1}`;
                });
                questionCount = cards.length;
            }
        }

        // HANDLE QUESTION TYPE CHANGE
        function handleQuestionTypeChange(questionId) {
            const card = document.querySelector(`.question-card[data-question-id="${questionId}"]`);
            const type = card.querySelector('.question-type').value;
            const optionsContainer = card.querySelector('.options-container');
            
            if (type === 'Single Choice' || type === 'Multiple Choice') {
                optionsContainer.style.display = 'block';
            } else if (type === 'Yes/No') {
                optionsContainer.style.display = 'block';
                const optionsList = optionsContainer.querySelector('.options-list');
                optionsList.innerHTML = `
                    <div class="option-input-group">
                        <input type="text" class="form-input option-input" value="Yes" readonly>
                    </div>
                    <div class="option-input-group">
                        <input type="text" class="form-input option-input" value="No" readonly>
                    </div>
                `;
                optionsContainer.querySelector('.btn-add-option').style.display = 'none';
            } else {
                optionsContainer.style.display = 'none';
            }
        }

        // ADD OPTION
        function addOption(questionId) {
            const card = document.querySelector(`.question-card[data-question-id="${questionId}"]`);
            const optionsList = card.querySelector('.options-list');
            const optionCount = optionsList.children.length + 1;
            
            const optionGroup = document.createElement('div');
            optionGroup.className = 'option-input-group';
            optionGroup.innerHTML = `
                <input type="text" class="form-input option-input" placeholder="Option ${optionCount}">
                <button class="btn-icon btn-delete" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            optionsList.appendChild(optionGroup);
        }

        // SAVE SURVEY
        async function saveSurvey() {
            const messageDiv = document.getElementById('createMessage');
            messageDiv.innerHTML = '';

            // Validate
            const title = document.getElementById('surveyTitle').value.trim();
            if (!title) {
                messageDiv.innerHTML = '<div class="error-message">‚ùå Please enter a survey title</div>';
                return;
            }

            const questionCards = document.querySelectorAll('.question-card');
            if (questionCards.length === 0) {
                messageDiv.innerHTML = '<div class="error-message">‚ùå Please add at least one question</div>';
                return;
            }

            // Build questions array
            const questions = [];
            let hasError = false;

            questionCards.forEach((card, index) => {
                const questionText = card.querySelector('.question-text').value.trim();
                const questionType = card.querySelector('.question-type').value;
                const helpText = card.querySelector('.question-help').value.trim();
                const isRequired = card.querySelector('.question-required').checked;

                if (!questionText) {
                    messageDiv.innerHTML = `<div class="error-message">‚ùå Question ${index + 1} is missing text</div>`;
                    hasError = true;
                    return;
                }

                const question = {
                    questionText: questionText,
                    questionType: questionType,
                    isRequired: isRequired,
                    helpText: helpText,
                    options: []
                };

                // Get options for choice questions
                if (questionType === 'Single Choice' || questionType === 'Multiple Choice' || questionType === 'Yes/No') {
                    const optionInputs = card.querySelectorAll('.option-input');
                    optionInputs.forEach(input => {
                        const optionText = input.value.trim();
                        if (optionText) {
                            question.options.push(optionText);
                        }
                    });

                    if (question.options.length < 2) {
                        messageDiv.innerHTML = `<div class="error-message">‚ùå Question ${index + 1} needs at least 2 options</div>`;
                        hasError = true;
                        return;
                    }
                }

                questions.push(question);
            });

            if (hasError) return;

            // Build survey data
            const surveyData = {
                action: 'createSurvey',
                title: title,
                description: document.getElementById('surveyDescription').value.trim(),
                createdBy: 'Admin', // Could get from session
                questions: questions,
                settings: {
                    targetAudience: 'All Residents',
                    isAnonymous: document.getElementById('isAnonymous').checked,
                    allowMultipleResponses: document.getElementById('allowMultiple').checked,
                    thankYouMessage: document.getElementById('thankYouMessage').value.trim()
                }
            };

            // Show loading
            messageDiv.innerHTML = '<div class="loading-message"><div class="loading-spinner"></div> Creating survey...</div>';

            try {
                const response = await fetch(SURVEY_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(surveyData)
                });

                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = `<div class="success-message">‚úÖ Survey created successfully!</div>`;
                    setTimeout(() => {
                        showView('list');
                    }, 1500);
                } else {
                    messageDiv.innerHTML = `<div class="error-message">‚ùå Error: ${result.message || result.error}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = `<div class="error-message">‚ùå Error creating survey: ${error.message}</div>`;
            }
        }

        // CHANGE SURVEY STATUS
        async function changeSurveyStatus(surveyId, newStatus) {
            const statusText = newStatus === 'Active' ? 'activate' : 'close';
            if (!confirm(`Are you sure you want to ${statusText} this survey?`)) {
                return;
            }

            try {
                const response = await fetch(SURVEY_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'toggleSurveyStatus',
                        surveyId: surveyId,
                        newStatus: newStatus
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ Survey ${statusText}d successfully!`);
                    loadSurveys();
                } else {
                    alert(`‚ùå Error: ${result.message || result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error changing status: ${error.message}`);
            }
        }

        // VIEW RESULTS
        function viewResults(surveyId) {
            currentSurveyId = surveyId;
            showView('results');
            loadResults(surveyId);
        }

        // LOAD RESULTS
        function loadResults(surveyId) {
            const summaryDiv = document.getElementById('resultsSummary');
            const contentDiv = document.getElementById('resultsContent');
            
            summaryDiv.innerHTML = '<div class="loading-message"><div class="loading-spinner"></div> Loading results...</div>';
            contentDiv.innerHTML = '';

            // JSONP request
            const callbackName = 'handleResultsResponse_' + Date.now();
            window[callbackName] = function(data) {
                if (data.success) {
                    renderResults(data);
                } else {
                    summaryDiv.innerHTML = `<div class="error-message">‚ùå Error loading results: ${data.message}</div>`;
                }
                delete window[callbackName];
            };

            const script = document.createElement('script');
            script.src = `${SURVEY_API_URL}?action=getSurveyResults&surveyId=${surveyId}&callback=${callbackName}`;
            document.head.appendChild(script);
        }

        // RENDER RESULTS
        function renderResults(data) {
            const survey = data.survey;
            const results = data.results;

            // Update header
            document.getElementById('resultsTitle').textContent = survey.title;
            document.getElementById('resultsSubtitle').textContent = `${survey.status} ‚Ä¢ ${data.responseCount} responses ‚Ä¢ ${survey.isAnonymous ? 'Anonymous' : 'Identified'}`;

            // Summary cards
            const summaryDiv = document.getElementById('resultsSummary');
            summaryDiv.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">${data.responseCount}</div>
                    <div class="summary-label">Total Responses</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${results.length}</div>
                    <div class="summary-label">Questions</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${survey.status}</div>
                    <div class="summary-label">Survey Status</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${survey.isAnonymous ? 'Yes' : 'No'}</div>
                    <div class="summary-label">Anonymous</div>
                </div>
            `;

            // Question results
            const contentDiv = document.getElementById('resultsContent');
            contentDiv.innerHTML = results.map((result, index) => {
                let resultHtml = `
                    <div class="question-result">
                        <div class="question-result-header">
                            ${index + 1}. ${escapeHtml(result.questionText)}
                            <span class="question-type-badge">${result.questionType}</span>
                        </div>
                `;

                if (result.questionType === 'Rating') {
                    const stars = '‚òÖ'.repeat(Math.round(parseFloat(result.averageRating))) + '‚òÜ'.repeat(5 - Math.round(parseFloat(result.averageRating)));
                    resultHtml += `
                        <div class="rating-display">
                            <div class="rating-value">${result.averageRating} / 5.0</div>
                            <div class="rating-stars">${stars}</div>
                            <div style="margin-top: 15px; color: #64748b;">Based on ${result.totalResponses} responses</div>
                        </div>
                    `;
                    if (result.ratingDistribution) {
                        resultHtml += '<div style="margin-top: 20px;">';
                        result.ratingDistribution.forEach(dist => {
                            resultHtml += `
                                <div class="answer-bar">
                                    <div class="answer-label">
                                        <span>${dist.rating} stars</span>
                                        <span class="answer-count">${dist.count} (${dist.percentage}%)</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${dist.percentage}%">
                                            ${dist.percentage}%
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        resultHtml += '</div>';
                    }
                } else if (result.questionType === 'Text') {
                    resultHtml += `<div class="text-responses">`;
                    if (result.answers && result.answers.length > 0) {
                        result.answers.forEach(answer => {
                            resultHtml += `
                                <div class="text-response">
                                    <div class="response-text">"${escapeHtml(answer.text)}"</div>
                                    <div class="response-meta">‚Äî ${answer.respondent} on ${formatDate(answer.submittedDate)}</div>
                                </div>
                            `;
                        });
                    } else {
                        resultHtml += '<div style="text-align: center; color: #64748b; padding: 20px;">No responses yet</div>';
                    }
                    resultHtml += `</div>`;
                } else {
                    // Multiple/Single Choice, Yes/No
                    if (result.answers && result.answers.length > 0) {
                        result.answers.forEach(answer => {
                            resultHtml += `
                                <div class="answer-bar">
                                    <div class="answer-label">
                                        <span>${escapeHtml(answer.option)}</span>
                                        <span class="answer-count">${answer.count} (${answer.percentage}%)</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${answer.percentage}%">
                                            ${answer.percentage}%
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        resultHtml += '<div style="text-align: center; color: #64748b; padding: 20px;">No responses yet</div>';
                    }
                }

                resultHtml += `</div>`;
                return resultHtml;
            }).join('');
        }

        // UTILITY FUNCTIONS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-AU', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
    </script>
</body>
</html>
