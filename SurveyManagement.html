<!--
=====================================================================
LAKE ILLAWONG MANAGEMENT SYSTEM - SURVEY MANAGEMENT
=====================================================================
PURPOSE: Administrative survey creation, management, and results analysis
PORTAL: Admin Portal Module
VERSION: 1.7.2 (Multiple responses always enabled)
LAST UPDATED: January 27, 2026
BACKEND API: SurveyModule.js V1.2.1
ENHANCEMENTS:
- Survey preview functionality
- Section break support
- Progress bar toggle
- Enhanced confirmation settings
- Improved question descriptions
- FIXED: Dropdown hover stability (removed gap between button and menu)
- NEW: Enhanced visual design with gradients, depth, and better color palette
- NEW: Improved card styling with subtle shadows and hover effects
- NEW: Better status badges with gradient backgrounds
- NEW: Enhanced buttons and meta items with modern styling
- FIXED: Question numbering excludes section breaks (preview, results, all views)
- NEW V1.6: Configurable rating scales (1-5 Satisfaction or 0-10 NPS)
- NEW V1.6: Rating scale selector in question form (saved to ratingMin/ratingMax)
- NEW V1.7: Click-only dropdowns (no hover) for consistency across all cards
- NEW V1.7: Portal pattern - dropdown moves to <body> to escape stacking contexts
- NEW V1.7: Visual feedback on Save button (loading, success, error states)
- CHANGE V1.7.2: Removed "Allow multiple responses" checkbox - always enabled
- CLEANED: All console.log/warn/error debug statements removed for production
- BUGFIX V1.7.1: Improved null handling for ratingMin/ratingMax in preview
=====================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Management - Lake Illawong</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(90deg, #1e40af 0%, #1e3a8a 100%);
            min-height: 100vh;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* HEADER */
        .header {
            background: transparent;
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .logo-container {
            flex-shrink: 0;
        }

        .logo-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            padding: 5px;
        }

        .header-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
        }

        .header-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: white;
            margin: 0 0 5px 0;
            line-height: 1.1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header-subtitle {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            margin: 0;
        }

        .header-divider {
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            margin-top: 15px;
        }

        /* NAVIGATION */
        .nav-header {
            background: white;
            padding: 20px 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .nav-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .btn-secondary:hover {
            background: #f8fafc;
        }

        /* VIEWS */
        .view-container {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            min-height: 400px;
        }

        /* SURVEY LIST */
        .survey-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            color: #64748b;
            border: 2px solid #e2e8f0;
            padding: 10px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .filter-btn:hover {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }

        .survey-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .survey-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06), 
                        0 0 0 1px rgba(102, 126, 234, 0.1);
            position: relative;
            overflow: visible;
            z-index: 1;
        }

        .survey-card:has(.dropdown-menu.show) {
            z-index: 100;
        }

        .survey-card:hover {
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15),
                        0 0 0 1px rgba(102, 126, 234, 0.2);
        }

        .survey-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .survey-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
            line-height: 1.3;
            background: linear-gradient(135deg, #1e293b, #475569);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .survey-description {
            color: #64748b;
            font-size: 0.95rem;
            margin-bottom: 16px;
            line-height: 1.6;
            padding-left: 12px;
            border-left: 3px solid #e2e8f0;
        }

        .survey-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
            font-size: 0.85rem;
        }

        .survey-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            padding: 6px 12px;
            border-radius: 8px;
            color: #475569;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .survey-actions {
            display: flex;
            gap: 10px;
            margin-top: 18px;
            padding-top: 18px;
            border-top: 2px solid #e2e8f0;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.03), transparent);
            overflow: visible;
        }

        .survey-actions button {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .btn-preview {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            color: #0369a1;
            border: 1px solid #bae6fd;
        }

        .btn-preview:hover {
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(3, 105, 161, 0.2);
        }

        .btn-view {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            color: #667eea;
            border: 1px solid #cbd5e1;
        }

        .btn-view:hover {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }

        .btn-activate {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .btn-activate:hover {
            background: linear-gradient(135deg, #a7f3d0, #6ee7b7);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-close {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .btn-close:hover {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
        }

        /* STATUS BADGES */
        .status-badge {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid;
        }

        .status-draft {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            color: #4b5563;
            border-color: #d1d5db;
        }

        .status-active {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-color: #6ee7b7;
        }

        .status-closed {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
            border-color: #fca5a5;
        }

        .status-archived {
            background: linear-gradient(135deg, #fce7f3, #fbcfe8);
            color: #9f1239;
            border-color: #f9a8d4;
        }

        /* CREATE SURVEY FORM */
        .form-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .section-description {
            color: #64748b;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .rating-scale-container {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .form-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .form-hint {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }

        .required {
            color: #ef4444;
        }

        /* QUESTION BUILDER */
        .questions-container {
            margin-top: 25px;
        }

        .question-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1rem;
        }

        .question-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .btn-icon:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .btn-delete {
            color: #ef4444;
        }

        .btn-delete:hover {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .options-container {
            margin-top: 15px;
        }

        .option-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .option-input-group input {
            flex: 1;
        }

        .btn-add-option {
            background: #f1f5f9;
            color: #667eea;
            border: 1px solid #e2e8f0;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            margin-top: 8px;
        }

        .btn-add-option:hover {
            background: #e2e8f0;
        }

        .add-question-btn {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            color: #667eea;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .add-question-btn:hover {
            background: #f1f5f9;
            border-color: #667eea;
        }

        /* RESULTS VIEW */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmin(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .summary-label {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .question-result {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .question-result-header {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
        }

        .question-type-badge {
            display: inline-block;
            background: #ede9fe;
            color: #7c3aed;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .answer-bar {
            margin-bottom: 12px;
        }

        .answer-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .answer-count {
            color: #667eea;
            font-weight: 700;
        }

        .progress-bar {
            background: #e2e8f0;
            height: 30px;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .text-responses {
            max-height: 400px;
            overflow-y: auto;
        }

        .text-response {
            background: #f8fafc;
            border-left: 3px solid #667eea;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 6px;
        }

        .response-text {
            color: #1e293b;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .response-meta {
            font-size: 0.85rem;
            color: #64748b;
        }

        .rating-display {
            text-align: center;
            margin: 20px 0;
        }

        .rating-value {
            font-size: 3rem;
            font-weight: 700;
            color: #667eea;
        }

        .rating-stars {
            font-size: 2rem;
            color: #fbbf24;
            margin-top: 10px;
        }

/* EDIT BUTTON STYLES */
.btn-edit {
    background: #e0f2fe;
    color: #0369a1;
    border: 1px solid #bae6fd;
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.85rem;
}

.btn-edit:hover {
    background: #bae6fd;
    border-color: #7dd3fc;
}

.btn-edit:disabled {
    background: #f3f4f6;
    color: #9ca3af;
    border-color: #e5e7eb;
    cursor: not-allowed;
}

        /* SECTION BREAK STYLES */
        .section-break {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin: 40px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .section-break::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(255, 255, 255, 0.1) 50%, 
                transparent 70%);
            animation: sectionShimmer 3s infinite;
        }

        @keyframes sectionShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .section-description {
            font-size: 1rem;
            opacity: 0.9;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        .section-divider {
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            margin: 20px auto;
            border-radius: 2px;
        }

        /* LOADING STATE */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #64748b;
            font-size: 1.1rem;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #f8fafc, #ffffff);
            border-radius: 16px;
            border: 2px dashed #cbd5e1;
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            opacity: 0.5;
            filter: grayscale(30%);
        }

        .empty-state-title {
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(135deg, #1e293b, #475569);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
        }

        .empty-state-description {
            font-size: 1.05rem;
            margin-bottom: 30px;
            color: #64748b;
            line-height: 1.6;
        }

        /* MODAL */
       .modal-overlay {
    background-color: rgba(0, 0, 0, 0.5) !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    z-index: 9999 !important;
  }
  
  /* FIX PREVIEW MODAL SCROLL */
.preview-modal {
    position: relative !important;
    background: white !important;
    border-radius: 8px !important;
    margin: 50px auto !important;
    padding: 20px !important;
    width: 90% !important;
    max-width: 800px !important;
    max-height: 85vh !important;
    overflow-y: auto !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2) !important;
}

/* Make sure content can scroll */
#previewContent {
    max-height: calc(85vh - 100px);
    overflow-y: auto;
    padding-right: 5px;
}

/* Custom scrollbar styling */
.preview-modal::-webkit-scrollbar {
    width: 8px;
}

.preview-modal::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.preview-modal::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.preview-modal::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}
  
  .preview-close {
  position: absolute !important;
  top: 15px !important;
  right: 15px !important;
  z-index: 10000 !important;
  margin: 0 !important;
  
  /* Bigger X */
  font-size: 28px !important;
  width: 44px !important;
  height: 44px !important;
  font-weight: bold !important;
  
  /* Better styling */
  color: #000 !important;
  background: white !important;
  border: 2px solid #333 !important;
  border-radius: 50% !important;
  cursor: pointer !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  padding: 0 !important;
}

.preview-close:hover {
  background: #f0f0f0 !important;
  transform: scale(1.05) !important;
}

        /* SUCCESS MESSAGE */
        .success-message {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #047857;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ERROR MESSAGE */
        .error-message {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #dc2626;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .header-text {
                align-items: center;
                text-align: center;
            }

            .header-title {
                font-size: 1.8rem;
            }

            .logo-image {
                width: 70px;
                height: 70px;
            }

            .survey-grid {
                grid-template-columns: 1fr;
            }

            .nav-header {
                flex-direction: column;
                align-items: stretch;
            }

            .nav-actions {
                flex-direction: column;
            }

            .results-summary {
                grid-template-columns: 1fr;
            }
        }

/* DELETE BUTTON STYLES */
.btn-delete-survey {
    background: #fee2e2;
    color: #dc2626;
    border: 1px solid #fecaca;
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.85rem;
}

.btn-delete-survey:hover {
    background: #fecaca;
    border-color: #f87171;
}

.btn-delete-survey:disabled {
    background: #f3f4f6;
    color: #9ca3af;
    border-color: #e5e7eb;
    cursor: not-allowed;
}

/* ACTIONS DROPDOWN - FIXED HOVER BEHAVIOR */
.actions-dropdown {
    position: relative;
    display: inline-block;
}

.btn-actions {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.85rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}

.btn-actions:hover {
    background: linear-gradient(135deg, #4b5563, #374151);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* FIXED: Removed gap and added invisible bridge to prevent hover loss */
.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background: linear-gradient(135deg, #ffffff, #f8fafc);
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    min-width: 220px;
    max-height: 400px;
    overflow-y: auto;
    overflow-x: hidden;
    z-index: 9999 !important;
    display: none;
    margin-top: 2px;
}

/* Invisible bridge between button and menu - prevents hover gap issues */
.actions-dropdown::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    height: 5px;
    background: transparent;
    display: block;
}

/* REMOVED: Hover to show dropdown - using click only for consistency */

.dropdown-menu.show {
    display: block;
}

.dropdown-menu button {
    display: block;
    width: 100%;
    padding: 12px 18px;
    text-align: left;
    background: none;
    border: none;
    color: #374151;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.2s ease;
}

.dropdown-menu button:hover:not(:disabled) {
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    color: #1e40af;
    padding-left: 22px;
}

.dropdown-menu button:disabled {
    color: #9ca3af;
    cursor: not-allowed;
    background: #fafafa;
    opacity: 0.6;
}

.dropdown-menu button.danger {
    color: #dc2626;
}

.dropdown-menu button.danger:hover:not(:disabled) {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    color: #991b1b;
}

.dropdown-menu button.success {
    color: #059669;
}

.dropdown-menu button.success:hover:not(:disabled) {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    color: #065f46;
}

.dropdown-menu button.warning {
    color: #d97706;
}

.dropdown-menu button.warning:hover:not(:disabled) {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #92400e;
}

.dropdown-divider {
    height: 2px;
    background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
    margin: 8px 0;
}

    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="header-content">
                <div class="logo-container">
                    <img src="logo.png" alt="Lake Illawong Logo" class="logo-image">
                </div>
                <div class="header-text">
                    <h1 class="header-title">Survey Management</h1>
                    <p class="header-subtitle">Community survey creation and analysis</p>
                </div>
            </div>
            <div class="header-divider"></div>
        </div>

        <!-- NAVIGATION -->
        <div class="nav-header">
            <div class="nav-actions">
                <button class="btn-primary" onclick="showView('list')">
                    üìä Survey List
                </button>
                <button class="btn-primary" onclick="showView('create')">
                    ‚ûï Create Survey
                </button>
                <button class="btn-secondary" onclick="window.location.href='AdminPortal.html'">
                    ‚Üê Back to Admin Portal
                </button>
            </div>
        </div>

        <!-- SURVEY LIST VIEW -->
        <div id="listView" class="view-container">
            <div class="survey-filters">
                <button class="filter-btn active" data-filter="all" onclick="filterSurveys('all')">
                    All Surveys
                </button>
                <button class="filter-btn" data-filter="Draft" onclick="filterSurveys('Draft')">
                    Drafts
                </button>
                <button class="filter-btn" data-filter="Active" onclick="filterSurveys('Active')">
                    Active
                </button>
                <button class="filter-btn" data-filter="Closed" onclick="filterSurveys('Closed')">
                    Closed
                </button>
            </div>

            <div id="surveyList" class="survey-grid">
                <div class="loading-message">
                    <div class="loading-spinner"></div>
                    <div>Loading surveys...</div>
                </div>
            </div>
        </div>

        <!-- CREATE SURVEY VIEW -->
        <div id="createView" class="view-container hidden">
            <div class="form-section">
                <h2 class="section-title">Create New Survey</h2>
                <p class="section-description">Build a community survey to gather feedback from residents</p>

                <div id="createMessage"></div>

                <div class="form-group">
                    <label class="form-label">Survey Title <span class="required">*</span></label>
                    <input type="text" id="surveyTitle" class="form-input" placeholder="e.g., 2026 Community Satisfaction Survey">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="surveyDescription" class="form-textarea" placeholder="Briefly describe the purpose of this survey..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Survey Settings</label>
                    
                    <div class="form-checkbox-group">
                        <input type="checkbox" id="isAnonymous" class="form-checkbox" checked>
                        <label for="isAnonymous">Anonymous responses (recommended for honest feedback)</label>
                    </div>

                    
                </div>

                <div class="form-group">
                    <label class="form-label">Thank You Message</label>
                    <textarea id="thankYouMessage" class="form-textarea" placeholder="Message shown after survey completion...">Thank you for taking the time to provide your valuable feedback!</textarea>
                </div>

                <!-- CONFIMATION SETTINGS -->
                <div class="form-section">
                    <h2 class="section-title">Confirmation Settings</h2>
                    <p class="section-description">Customize what happens after survey completion</p>

                    <div class="form-group">
                        <label class="form-label">Custom Confirmation Message</label>
                        <textarea id="confirmationMessage" class="form-textarea" placeholder="Optional custom message to show after submission..."></textarea>
                        <div class="form-hint">If left empty, the standard "Thank You" message will be used</div>
                    </div>

                    <div class="form-checkbox-group">
                        <input type="checkbox" id="allowAnotherResponse" class="form-checkbox">
                        <label for="allowAnotherResponse">Show option to submit another response (if multiple responses allowed)</label>
                    </div>

                    <div class="form-checkbox-group">
                        <input type="checkbox" id="showResponseSummary" class="form-checkbox">
                        <label for="showResponseSummary">Show response summary after submission</label>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="section-title">Questions</h2>
                <p class="section-description">Add questions to your survey (minimum 1 required)</p>

                <div id="questionsContainer" class="questions-container">
                    <!-- Questions will be added here -->
                </div>

                <button class="add-question-btn" onclick="addQuestion()">
                    ‚ûï Add Question
                </button>
            </div>

            <div class="form-section" style="margin-top: 30px;">
                <button class="btn-primary" id="saveSurveyBtn" onclick="saveSurvey()" style="width: 200px;">
    üíæ Save Survey
</button>
                <button class="btn-secondary" onclick="showView('list')" style="width: 150px; margin-left: 12px;">
                    Cancel
                </button>
            </div>
        </div>

        <!-- RESULTS VIEW -->
        <div id="resultsView" class="view-container hidden">
            <div class="results-header">
                <div>
                    <h2 id="resultsTitle" class="section-title">Survey Results</h2>
                    <p id="resultsSubtitle" class="section-description"></p>
                </div>
                <button class="btn-secondary" onclick="showView('list')">
                    ‚Üê Back to List
                </button>
            </div>

            <div id="resultsSummary" class="results-summary">
                <!-- Summary cards will be added here -->
            </div>

            <div id="resultsContent">
                <!-- Question results will be added here -->
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const SURVEY_API_URL = 'https://script.google.com/macros/s/AKfycby4CGaQHZbNwQZTv1t4zFnZ8L8opU0jqpAOWBzstfTqA7oTAN-oPykOhWjdZAxJrLazFA/exec'; 

        // STATE
        let allSurveys = [];
        let currentFilter = 'all';
        let questionCount = 0;
        let currentSurveyId = null;

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', function() {
            loadSurveys();
        });

        // VIEW MANAGEMENT
        function showView(viewName) {
            document.getElementById('listView').classList.add('hidden');
            document.getElementById('createView').classList.add('hidden');
            document.getElementById('resultsView').classList.add('hidden');

            if (viewName === 'list') {
                document.getElementById('listView').classList.remove('hidden');
                loadSurveys();
            } else if (viewName === 'create') {
                document.getElementById('createView').classList.remove('hidden');
                resetCreateForm();
            } else if (viewName === 'results') {
                document.getElementById('resultsView').classList.remove('hidden');
            }
        }

        // LOAD SURVEYS
        function loadSurveys() {
            const container = document.getElementById('surveyList');
            container.innerHTML = '<div class="loading-message"><div class="loading-spinner"></div><div>Loading surveys...</div></div>';

            // JSONP request
            const callbackName = 'handleSurveysResponse_' + Date.now();
            window[callbackName] = function(data) {
                if (data.success) {
                    allSurveys = data.surveys;
                    renderSurveys();
                } else {
                    container.innerHTML = `<div class="error-message">‚ùå Error loading surveys: ${data.message}</div>`;
                }
                delete window[callbackName];
            };

            const script = document.createElement('script');
            script.src = `${SURVEY_API_URL}?action=getSurveys&includeArchived=false&isAdmin=true&callback=${callbackName}`;
            document.head.appendChild(script);
        }

        // RENDER SURVEYS
function renderSurveys() {
    const container = document.getElementById('surveyList');
    
    let surveys = allSurveys;
    if (currentFilter !== 'all') {
        surveys = allSurveys.filter(s => s.status === currentFilter);
    }

    if (surveys.length === 0) {
        const filterText = currentFilter === 'all' ? 'surveys' : `${currentFilter.toLowerCase()} surveys`;
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <div class="empty-state-title">No ${filterText} found</div>
                <div class="empty-state-description">Create your first survey to get started</div>
                <button class="btn-primary" onclick="showView('create')">‚ûï Create Survey</button>
            </div>
        `;
        return;
    }

    container.innerHTML = surveys.map(survey => {
        // Build status buttons outside template to avoid nested template issues
        const statusButtons = survey.status === 'Draft' 
            ? `<button onclick="changeSurveyStatus('${survey.surveyId}', 'Active'); this.closest('.dropdown-menu').classList.remove('show');" class="success">‚ñ∂Ô∏è Activate Survey</button>`
            : survey.status === 'Active'
            ? `<button onclick="changeSurveyStatus('${survey.surveyId}', 'Closed'); this.closest('.dropdown-menu').classList.remove('show');" class="warning">‚è∏Ô∏è Close Survey</button>`
            : '';
        
        return `
        <div class="survey-card">
            <div class="survey-card-header">
                <div class="survey-title">${escapeHtml(survey.title)}</div>
                <span class="status-badge status-${survey.status.toLowerCase()}">${survey.status}</span>
            </div>
            <div class="survey-description">${escapeHtml(survey.description || 'No description')}</div>
            <div class="survey-meta">
                <div class="survey-meta-item">
                    üìÖ Created: ${formatDate(survey.createdDate)}
                </div>
                <div class="survey-meta-item">
                    üìä ${survey.totalResponses} responses
                </div>
                ${survey.isAnonymous ? '<div class="survey-meta-item">üîí Anonymous</div>' : ''}
            </div>
            
            <!-- SURVEY ACTIONS WITH DROPDOWN -->
            <div class="survey-actions">
                <!-- Preview button stays outside for quick access -->
                <button class="btn-preview" onclick="previewSurvey('${survey.surveyId}')">
                    üëÅÔ∏è Preview
                </button>
                
                <!-- All other actions in dropdown -->
                <div class="actions-dropdown">
                    <button class="btn-actions" onclick="toggleDropdown(event, this)">
                        ‚öôÔ∏è Actions ‚ñº
                    </button>
                    <div class="dropdown-menu" onclick="event.stopPropagation()">
                        <button onclick="editSurvey('${survey.surveyId}', this); this.closest('.dropdown-menu').classList.remove('show');" ${survey.status !== 'Draft' ? 'disabled' : ''}>
                            ‚úèÔ∏è Edit Survey
                        </button>
                        <button onclick="shareSurvey('${survey.surveyId}'); this.closest('.dropdown-menu').classList.remove('show');">
                            üîó Share Link
                        </button>
                        <button onclick="viewResults('${survey.surveyId}'); this.closest('.dropdown-menu').classList.remove('show');">
                            üìà View Results
                        </button>
                        <div class="dropdown-divider"></div>
                        <button onclick="confirmDeleteSurvey('${survey.surveyId}', '${escapeHtml(survey.title).replace(/'/g, "\\'")}', ${survey.totalResponses}); this.closest('.dropdown-menu').classList.remove('show');"
                                ${survey.totalResponses > 0 ? 'disabled' : ''}
                                class="danger">
                            üóëÔ∏è ${survey.totalResponses > 0 ? 'Archive Survey' : 'Delete Survey'}
                        </button>
                        ${statusButtons}
                    </div>
                </div>
            </div>
        </div>`;
    }).join('');
} 

        // FILTER SURVEYS
        function filterSurveys(filter) {
            currentFilter = filter;
            
            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });
            
            renderSurveys();
        }

        // TOGGLE DROPDOWN (Click-only for consistency)
        let currentOpenDropdown = null;
        
        function toggleDropdown(event, button) {
            event.stopPropagation();
            
            const dropdown = button.nextElementSibling;
            
            // If clicking on already-open dropdown, close it
            if (dropdown.classList.contains('show')) {
                closeDropdown(dropdown);
            } else {
                openDropdown(button, dropdown);
            }
        }
        
        function openDropdown(button, dropdown) {
            // Close any other open dropdowns first
            if (currentOpenDropdown && currentOpenDropdown !== dropdown) {
                closeDropdown(currentOpenDropdown);
            }
            
            dropdown.classList.add('show');
            currentOpenDropdown = dropdown;
            
            // Store original parent reference
            const actionsDropdown = button.parentElement;
            const dropdownId = 'dropdown-' + Date.now();
            actionsDropdown.dataset.dropdownId = dropdownId;
            dropdown.dataset.originalParent = dropdownId;
            
            // Calculate position before moving
            const rect = button.getBoundingClientRect();
            
            // Move to body (portal pattern)
            document.body.appendChild(dropdown);
            
            // Position using fixed
            dropdown.style.position = 'fixed';
            
            // Check if there's enough space below (estimate 200px for dropdown height)
            const spaceBelow = window.innerHeight - rect.bottom;
            const dropdownHeight = 200; // Approximate height
            
            if (spaceBelow < dropdownHeight) {
                // Not enough space below - position above
                dropdown.style.bottom = (window.innerHeight - rect.top + 4) + 'px';
                dropdown.style.top = 'auto';
            } else {
                // Enough space below - position normally
                dropdown.style.top = (rect.bottom + 4) + 'px';
                dropdown.style.bottom = 'auto';
            }
            
            dropdown.style.left = rect.left + 'px';
            dropdown.style.width = '220px';
        }
        
        function closeDropdown(dropdown) {
            dropdown.classList.remove('show');
            
            // Return to original parent
            const originalParent = dropdown.dataset.originalParent;
            if (originalParent) {
                const parent = document.querySelector(`[data-dropdown-id="${originalParent}"]`);
                if (parent) {
                    parent.appendChild(dropdown);
                }
            }
            dropdown.style.position = 'absolute';
            dropdown.style.top = '';
            dropdown.style.left = '';
            
            if (currentOpenDropdown === dropdown) {
                currentOpenDropdown = null;
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function() {
            if (currentOpenDropdown) {
                closeDropdown(currentOpenDropdown);
            }
        });

        // CREATE SURVEY FORM
        function resetCreateForm() {
    // Reset form fields
    document.getElementById('surveyTitle').value = '';
    document.getElementById('surveyDescription').value = '';
    document.getElementById('isAnonymous').checked = true;
    
    document.getElementById('thankYouMessage').value = 'Thank you for taking the time to provide your valuable feedback!';
    document.getElementById('confirmationMessage').value = '';
    document.getElementById('allowAnotherResponse').checked = false;
    document.getElementById('showResponseSummary').checked = false;
    document.getElementById('questionsContainer').innerHTML = '';
    document.getElementById('createMessage').innerHTML = '';
// Reset save button to original state
    const saveBtn = document.getElementById('saveSurveyBtn');
    if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.style.background = '';
        saveBtn.style.cursor = '';
        saveBtn.innerHTML = 'üíæ Save Changes';
    }
    
    // Reset editing state
    currentEditingSurveyId = null;
    questionCount = 0;
    
    // Reset form title
    document.querySelector('#createView .section-title').textContent = 'Create New Survey';
    document.querySelector('#createView .section-description').textContent = 'Build a community survey to gather feedback from residents';
    
    // Add first question
    addQuestion();
}

        // ADD QUESTION
        function addQuestion() {
            questionCount++;
            const container = document.getElementById('questionsContainer');
            
            const questionCard = document.createElement('div');
            questionCard.className = 'question-card';
            questionCard.dataset.questionId = questionCount;
            questionCard.innerHTML = `
                <div class="question-header">
                    <div class="question-number">Question ${questionCount}</div>
                    <div class="question-actions">
                        <button class="btn-icon btn-delete" onclick="deleteQuestion(${questionCount})">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Question Text <span class="required">*</span></label>
                    <input type="text" class="form-input question-text" placeholder="Enter your question..." required>
                </div>

                <div class="form-group">
                    <label class="form-label">Question Type <span class="required">*</span></label>
                    <select class="form-select question-type" onchange="handleQuestionTypeChange(${questionCount})">
                        <option value="Rating">Rating (1-5 stars)</option>
                        <option value="Single Choice">Single Choice</option>
                        <option value="Multiple Choice">Multiple Choice</option>
                        <option value="Text">Text Response</option>
                        <option value="Yes/No">Yes/No</option>
                        <option value="Section Break">üìã Section Break</option>
                    </select>
                </div>

                <div class="options-container" style="display: none;">
                    <label class="form-label">Options <span class="required">*</span></label>
                    <div class="options-list">
                        <div class="option-input-group">
                            <input type="text" class="form-input option-input" placeholder="Option 1">
                            <button class="btn-icon btn-delete" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                        </div>
                        <div class="option-input-group">
                            <input type="text" class="form-input option-input" placeholder="Option 2">
                            <button class="btn-icon btn-delete" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                        </div>
                    </div>
                    <button class="btn-add-option" onclick="addOption(${questionCount})">+ Add Option</button>
                </div>

                <div class="rating-scale-container" style="display: block;">
                    <label class="form-label">Rating Scale</label>
                    <select class="form-select rating-scale-type">
                        <option value="1-5">1-5 (Satisfaction)</option>
                        <option value="0-10">0-10 (NPS / Net Promoter Score)</option>
                    </select>
                    <div style="margin-top: 8px; font-size: 0.85rem; color: #64748b;">
                        Choose the rating scale for this question
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Help Text (optional)</label>
                    <input type="text" class="form-input question-help" placeholder="Additional guidance for respondents...">
                </div>

                <div class="form-checkbox-group">
                    <input type="checkbox" class="form-checkbox question-required" checked>
                    <label>Required question</label>
                </div>
            `;
            
            container.appendChild(questionCard);
        }

        // DELETE QUESTION
        function deleteQuestion(questionId) {
            const card = document.querySelector(`.question-card[data-question-id="${questionId}"]`);
            if (card) {
                card.remove();
                // Renumber remaining questions
                const cards = document.querySelectorAll('.question-card');
                cards.forEach((card, index) => {
                    card.querySelector('.question-number').textContent = `Question ${index + 1}`;
                });
                questionCount = cards.length;
            }
        }

        // HANDLE QUESTION TYPE CHANGE
        function handleQuestionTypeChange(questionId) {
            const card = document.querySelector(`.question-card[data-question-id="${questionId}"]`);
            const type = card.querySelector('.question-type').value;
            const optionsContainer = card.querySelector('.options-container');
            const ratingScaleContainer = card.querySelector('.rating-scale-container');
            const questionText = card.querySelector('.question-text');
            const helpText = card.querySelector('.question-help');
            const requiredCheckbox = card.querySelector('.question-required');
            
            // Hide both by default
            if (optionsContainer) optionsContainer.style.display = 'none';
            if (ratingScaleContainer) ratingScaleContainer.style.display = 'none';
            
            if (type === 'Single Choice' || type === 'Multiple Choice') {
                optionsContainer.style.display = 'block';
                questionText.placeholder = "Enter your question...";
                helpText.placeholder = "Additional guidance for respondents...";
                requiredCheckbox.disabled = false;
                requiredCheckbox.parentElement.style.opacity = '1';
            } else if (type === 'Yes/No') {
                optionsContainer.style.display = 'block';
                const optionsList = optionsContainer.querySelector('.options-list');
                optionsList.innerHTML = `
                    <div class="option-input-group">
                        <input type="text" class="form-input option-input" value="Yes" readonly>
                    </div>
                    <div class="option-input-group">
                        <input type="text" class="form-input option-input" value="No" readonly>
                    </div>
                `;
                optionsContainer.querySelector('.btn-add-option').style.display = 'none';
                questionText.placeholder = "Enter your question...";
                helpText.placeholder = "Additional guidance for respondents...";
                requiredCheckbox.disabled = false;
                requiredCheckbox.parentElement.style.opacity = '1';
            } else if (type === 'Rating') {
                // Show rating scale configuration
                if (ratingScaleContainer) ratingScaleContainer.style.display = 'block';
                questionText.placeholder = "Enter your question (e.g., 'How satisfied are you...?')";
                helpText.placeholder = "Additional guidance for respondents...";
                requiredCheckbox.disabled = false;
                requiredCheckbox.parentElement.style.opacity = '1';
            } else if (type === 'Section Break') {
                // Hide options for section breaks
                optionsContainer.style.display = 'none';
                // Update placeholders for section break
                questionText.placeholder = "Enter section title (e.g., 'About You', 'Community Feedback')...";
                helpText.placeholder = "Optional section description...";
                // Disable required checkbox for section breaks
                requiredCheckbox.disabled = true;
                requiredCheckbox.checked = false;
                requiredCheckbox.parentElement.style.opacity = '0.5';
            } else {
                optionsContainer.style.display = 'none';
                questionText.placeholder = "Enter your question...";
                helpText.placeholder = "Additional guidance for respondents...";
                requiredCheckbox.disabled = false;
                requiredCheckbox.parentElement.style.opacity = '1';
            }
        }

        // ADD OPTION
        function addOption(questionId) {
            const card = document.querySelector(`.question-card[data-question-id="${questionId}"]`);
            const optionsList = card.querySelector('.options-list');
            const optionCount = optionsList.children.length + 1;
            
            const optionGroup = document.createElement('div');
            optionGroup.className = 'option-input-group';
            optionGroup.innerHTML = `
                <input type="text" class="form-input option-input" placeholder="Option ${optionCount}">
                <button class="btn-icon btn-delete" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            optionsList.appendChild(optionGroup);
        }

        // JSONP HELPER FUNCTION
        function callAPI(action, data, callback) {
            const callbackName = 'apiCallback_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            
            window[callbackName] = function(response) {
                callback(response);
                // Cleanup
                delete window[callbackName];
                const script = document.querySelector(`script[src*="${callbackName}"]`);
                if (script) script.remove();
            };
            
            const script = document.createElement('script');
            let url = `${SURVEY_API_URL}?action=${action}&callback=${callbackName}`;
            
            // Add data as JSON string parameter for write operations
            if (data) {
                url += `&data=${encodeURIComponent(JSON.stringify(data))}`;
            }
            
            script.src = url;
            script.onerror = function() {
                callback({ success: false, error: 'Network error' });
                delete window[callbackName];
            };
            
            document.head.appendChild(script);
        }

        function saveSurvey() {
    const messageDiv = document.getElementById('createMessage');
    messageDiv.innerHTML = '';

    // Validate title
    const title = document.getElementById('surveyTitle').value.trim();
    if (!title) {
        messageDiv.innerHTML = '<div class="error-message">‚ùå Please enter a survey title</div>';
        return;
    }

    const questionCards = document.querySelectorAll('.question-card');
    if (questionCards.length === 0) {
        messageDiv.innerHTML = '<div class="error-message">‚ùå Please add at least one question</div>';
        return;
    }

    // Build questions array
    const questions = [];
    let hasError = false;

    questionCards.forEach((card, index) => {
        const questionText = card.querySelector('.question-text').value.trim();
        const questionType = card.querySelector('.question-type').value;
        const helpText = card.querySelector('.question-help').value.trim();
        const isRequired = card.querySelector('.question-required').checked;

        if (!questionText) {
            messageDiv.innerHTML = `<div class="error-message">‚ùå Question ${index + 1} is missing text</div>`;
            hasError = true;
            return;
        }

        const question = {
            questionText: questionText,
            questionType: questionType,
            isRequired: isRequired,
            helpText: helpText,
            options: []
        };

        // Get rating scale for Rating questions
        if (questionType === 'Rating') {
            const ratingScaleType = card.querySelector('.rating-scale-type');
            if (ratingScaleType) {
                const scaleValue = ratingScaleType.value;
                if (scaleValue === '0-10') {
                    question.ratingMin = 0;
                    question.ratingMax = 10;
                } else {
                    question.ratingMin = 1;
                    question.ratingMax = 5;
                }
            } else {
                // Default to 1-5 if not found
                question.ratingMin = 1;
                question.ratingMax = 5;
            }
        }

        // Get options for choice questions
        if (questionType === 'Single Choice' || questionType === 'Multiple Choice' || questionType === 'Yes/No') {
            const optionInputs = card.querySelectorAll('.option-input');
            optionInputs.forEach(input => {
                const optionText = input.value.trim();
                if (optionText) {
                    question.options.push(optionText);
                }
            });

            if (question.options.length < 2 && questionType !== 'Yes/No') {
                messageDiv.innerHTML = `<div class="error-message">‚ùå Question ${index + 1} needs at least 2 options</div>`;
                hasError = true;
                return;
            }
        }

        questions.push(question);
    });

    if (hasError) return;

    // Determine if creating or updating
    const isUpdate = currentEditingSurveyId !== null;
    
    // Get the save button and add visual feedback
    const saveBtn = document.getElementById('saveSurveyBtn');
    const originalBtnText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.style.background = '#94a3b8';
    saveBtn.style.cursor = 'not-allowed';
    saveBtn.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
            <div style="width: 16px; height: 16px; border: 3px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
            <span>${isUpdate ? 'Saving Changes...' : 'Creating Survey...'}</span>
        </div>
    `;
    
    // Visual feedback in message area
    messageDiv.innerHTML = `
        <div style="background: #f0f9ff; border: 2px solid #bae6fd; color: #0369a1; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
            <div style="width: 20px; height: 20px; border: 3px solid #bae6fd; border-top-color: #0369a1; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
            <div>${isUpdate ? 'Updating survey...' : 'Creating survey...'}</div>
        </div>
    `;

    // Build survey data
    const surveyData = {
        title: title,
        description: document.getElementById('surveyDescription').value.trim(),
        questions: questions,
        settings: {
            targetAudience: 'All Residents',
            isAnonymous: document.getElementById('isAnonymous').checked,
            allowMultipleResponses: true,
            thankYouMessage: document.getElementById('thankYouMessage').value.trim(),
            confirmationMessage: document.getElementById('confirmationMessage').value.trim(),
            allowAnotherResponse: document.getElementById('allowAnotherResponse').checked,
            showResponseSummary: document.getElementById('showResponseSummary').checked
        }
    };

    if (isUpdate) {
        surveyData.surveyId = currentEditingSurveyId;
        surveyData.updates = {
            title: title,
            description: document.getElementById('surveyDescription').value.trim(),
            thankYouMessage: document.getElementById('thankYouMessage').value.trim(),
            confirmationMessage: document.getElementById('confirmationMessage').value.trim(),
            allowAnotherResponse: document.getElementById('allowAnotherResponse').checked,
            showResponseSummary: document.getElementById('showResponseSummary').checked
        };
    } else {
        surveyData.createdBy = 'Admin';
    }

    const action = isUpdate ? 'updateSurvey' : 'createSurvey';
    
    callAPI(action, surveyData, function(result) {
        if (result.success) {
            // Success state - green button
            saveBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            saveBtn.style.cursor = 'pointer';
            saveBtn.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>‚úÖ</span>
                    <span>${isUpdate ? 'Changes Saved!' : 'Survey Created!'}</span>
                </div>
            `;
            
            messageDiv.innerHTML = `
                <div style="background: #d1fae5; border: 2px solid #10b981; color: #047857; padding: 15px; border-radius: 8px;">
                    ‚úÖ Survey ${isUpdate ? 'updated' : 'created'} successfully!
                </div>
            `;
            
            setTimeout(() => {
                currentEditingSurveyId = null;
                resetCreateForm();
                showView('list');
            }, 2000);
        } else {
            // Error state - red button
            saveBtn.disabled = false;
            saveBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            saveBtn.style.cursor = 'pointer';
            saveBtn.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>‚ùå</span>
                    <span>Save Failed</span>
                </div>
            `;
            
            messageDiv.innerHTML = `
                <div style="background: #fee2e2; border: 2px solid #ef4444; color: #dc2626; padding: 15px; border-radius: 8px;">
                    ‚ùå Error: ${result.message || result.error}
                </div>
            `;
            
            // Restore button after 3 seconds
            setTimeout(() => {
                saveBtn.style.background = '';
                saveBtn.innerHTML = originalBtnText;
            }, 3000);
        }
    });
}


// Helper function for messages
function showMessage(text, type = 'info') {
    const messageDiv = document.getElementById('createMessage');
    const colors = {
        success: '#d1fae5',
        error: '#fee2e2',
        saving: '#f0f9ff',
        info: '#f1f5f9'
    };
    const borders = {
        success: '#10b981',
        error: '#ef4444',
        saving: '#0ea5e9',
        info: '#94a3b8'
    };
    
    messageDiv.innerHTML = `
        <div style="
            background: ${colors[type] || colors.info};
            border: 2px solid ${borders[type] || borders.info};
            color: ${type === 'saving' ? '#0369a1' : type === 'success' ? '#047857' : type === 'error' ? '#dc2626' : '#334155'};
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeIn 0.3s ease-out;
        ">
            ${type === 'saving' ? '<div class="loading-spinner"></div>' : ''}
            <div>${text}</div>
        </div>
    `;
}

        // CHANGE SURVEY STATUS
        function changeSurveyStatus(surveyId, newStatus) {
            const statusText = newStatus === 'Active' ? 'activate' : 'close';
            if (!confirm(`Are you sure you want to ${statusText} this survey?`)) {
                return;
            }

            // Call via JSONP (simple parameters, no complex data)
            const callbackName = 'statusCallback_' + Date.now();
            
            window[callbackName] = function(result) {
                if (result.success) {
                    alert(`‚úÖ Survey ${statusText}d successfully!`);
                    loadSurveys();
                } else {
                    alert(`‚ùå Error: ${result.message || result.error}`);
                }
                delete window[callbackName];
                const script = document.querySelector(`script[src*="${callbackName}"]`);
                if (script) script.remove();
            };

            const script = document.createElement('script');
            script.src = `${SURVEY_API_URL}?action=toggleSurveyStatus&surveyId=${surveyId}&newStatus=${newStatus}&callback=${callbackName}`;
            script.onerror = function() {
                alert('‚ùå Error changing status');
                delete window[callbackName];
            };
            
            document.head.appendChild(script);
        }

        // PREVIEW SURVEY
        function previewSurvey(surveyId) {
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="preview-modal">
                    <button class="preview-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                    <div style="margin-bottom: 25px;">
                        <h3 style="font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 8px;">Survey Preview</h3>
                        <p style="color: #64748b;">This is how the survey will appear to residents</p>
                    </div>
                    <div id="previewContent">
                        <div class="loading-message">
                            <div class="loading-spinner"></div>
                            <div>Loading preview...</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Load survey details for preview
            const callbackName = 'previewCallback_' + Date.now();
            window[callbackName] = function(data) {
                if (data.success) {
                    renderPreview(data.survey);
                } else {
                    document.getElementById('previewContent').innerHTML = 
                        `<div class="error-message">‚ùå Error loading preview: ${data.message}</div>`;
                }
                delete window[callbackName];
            };
            
            const script = document.createElement('script');
            script.src = `${SURVEY_API_URL}?action=getSurveyDetails&surveyId=${surveyId}&callback=${callbackName}`;
            document.head.appendChild(script);
        }

        // RENDER PREVIEW
        function renderPreview(survey) {
            const container = document.getElementById('previewContent');
            
            // Calculate total regular questions (excluding section breaks)
            const regularQuestions = survey.questions.filter(q => q.questionType !== 'Section Break');
            const totalRegularQuestions = regularQuestions.length;
            
            // Track question number for regular questions only
            let regularQuestionNumber = 0;
            
            const surveyHtml = `
                <div style="margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 12px;">
                    <h2 style="font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; color: #1e293b;">${escapeHtml(survey.title)}</h2>
                    <p style="color: #64748b; line-height: 1.6;">${escapeHtml(survey.description || '')}</p>
                    ${survey.isAnonymous ? 
                        '<div style="margin-top: 10px; padding: 8px 12px; background: #e0f2fe; color: #0369a1; border-radius: 6px; display: inline-block; font-size: 0.85rem;">üîí Anonymous Survey</div>' : 
                        ''
                    }
                </div>
                
                <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #64748b;">Progress</span>
                        <span style="font-weight: 600; color: #667eea;">0/${totalRegularQuestions}</span>
                    </div>
                    <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%;"></div>
                    </div>
                </div>
                
                ${survey.questions.map((question, index) => {
                    // Increment question number only for regular questions
                    if (question.questionType !== 'Section Break') {
                        regularQuestionNumber++;
                    }
                    
                    // Section breaks don't get numbered - they're just visual dividers
                    if (question.questionType === 'Section Break') {
                        return renderPreviewQuestion(question);
                    }
                    
                    // Regular questions get numbered
                    return `
                        <div style="margin-bottom: 25px; padding: 20px; background: white; border: 2px solid #e2e8f0; border-radius: 12px;">
                            <div style="font-size: 0.9rem; font-weight: 600; color: #667eea; margin-bottom: 8px;">
                                Question ${regularQuestionNumber} of ${totalRegularQuestions}
                            </div>
                            
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">
                                ${escapeHtml(question.questionText)}
                                ${question.isRequired ? '<span style="color: #ef4444;"> *</span>' : ''}
                            </div>
                            
                            ${renderPreviewQuestion(question)}
                        </div>
                    `;
                }).join('')}
                
                <div style="text-align: center; padding: 20px; color: #64748b; font-size: 0.9rem;">
                    Preview only - responses cannot be submitted from this view
                </div>
            `;
            
            container.innerHTML = surveyHtml;
        }

        // RENDER PREVIEW QUESTION
        function renderPreviewQuestion(question) {
            let questionHtml = '';
            
            // Add help text if available (like Google Forms descriptions)
            // But NOT for section breaks - they handle their own help text internally
            if (question.helpText && question.questionType !== 'Section Break') {
                questionHtml += `
                    <div style="
                        font-size: 0.85rem;
                        color: #5f6368;
                        margin: 8px 0 15px 0;
                        line-height: 1.4;
                        padding: 8px 12px;
                        background: #f8f9fa;
                        border-left: 3px solid #4285f4;
                        border-radius: 0 6px 6px 0;
                    ">
                        ${escapeHtml(question.helpText)}
                    </div>
                `;
            }
            
            // Add the input based on question type
            switch(question.questionType) {
                case 'Multiple Choice':
                    questionHtml += `
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                            ${(question.optionsArray || []).map(option => `
                                <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px;">
                                    <input type="checkbox" disabled style="width: 18px; height: 18px;">
                                    <span>${escapeHtml(option)}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;
                    
                case 'Single Choice':
                case 'Yes/No':
                    questionHtml += `
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                            ${(question.optionsArray || []).map(option => `
                                <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px;">
                                    <input type="radio" disabled style="width: 18px; height: 18px;">
                                    <span>${escapeHtml(option)}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;
                    
                case 'Rating':
                    // Get rating range from question (default to 1-5)
                    const ratingMin = (question.ratingMin !== undefined && question.ratingMin !== null) ? question.ratingMin : 1;
                    const ratingMax = (question.ratingMax !== undefined && question.ratingMax !== null) ? question.ratingMax : 5;
                    
                    // Build rating array dynamically
                    const ratings = [];
                    for (let i = ratingMin; i <= ratingMax; i++) {
                        ratings.push(i);
                    }
                    
                    // Determine label text based on scale
                    let scaleLabel = '';
                    if (ratingMin === 1 && ratingMax === 5) {
                        scaleLabel = '1 = Very Dissatisfied, 5 = Very Satisfied';
                    } else if (ratingMin === 0 && ratingMax === 10) {
                        scaleLabel = '0 = Not at all likely, 10 = Extremely likely';
                    } else {
                        scaleLabel = `${ratingMin} = Low, ${ratingMax} = High`;
                    }
                    
                    questionHtml += `
                        <div style="margin-top: 10px;">
                            <div style="display: flex; gap: 8px; justify-content: center; margin: 20px 0; flex-wrap: wrap;">
                                ${ratings.map(rating => `
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                        <div style="
                                            width: 50px;
                                            height: 50px;
                                            border: 3px solid #e2e8f0;
                                            border-radius: 50%;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            font-weight: 700;
                                            font-size: 1.2rem;
                                            color: #64748b;
                                        ">${rating}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="font-size: 0.85rem; color: #64748b; text-align: center;">
                                ${scaleLabel}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Text':
                    questionHtml += `
                        <div style="margin-top: 10px;">
                            <textarea 
                                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; min-height: 100px; font-family: inherit;"
                                placeholder="Enter your response..."
                                disabled
                            ></textarea>
                        </div>
                    `;
                    break;
                    
                case 'Section Break':
                    return `
                        <div style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            padding: 30px;
                            border-radius: 12px;
                            margin: 40px 0;
                            text-align: center;
                            position: relative;
                            overflow: hidden;
                        ">
                            <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; position: relative; z-index: 1;">
                                ${escapeHtml(question.questionText || 'Section Break')}
                            </div>
                            ${question.helpText ? `
                                <div style="width: 80px; height: 4px; background: rgba(255, 255, 255, 0.3); margin: 20px auto; border-radius: 2px;"></div>
                                <div style="font-size: 1rem; opacity: 0.9; line-height: 1.6; position: relative; z-index: 1;">
                                    ${escapeHtml(question.helpText)}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    break;
                    
                default:
                    questionHtml += `
                        <div style="margin-top: 10px; color: #64748b; padding: 15px; background: #f8fafc; border-radius: 8px;">
                            [${question.questionType} question preview]
                        </div>
                    `;
            }
            
            return questionHtml;
        }

        // VIEW RESULTS
        function viewResults(surveyId) {
            currentSurveyId = surveyId;
            showView('results');
            loadResults(surveyId);
        }

        // LOAD RESULTS
        function loadResults(surveyId) {
            const summaryDiv = document.getElementById('resultsSummary');
            const contentDiv = document.getElementById('resultsContent');
            
            summaryDiv.innerHTML = '<div class="loading-message"><div class="loading-spinner"></div> Loading results...</div>';
            contentDiv.innerHTML = '';

            // JSONP request
            const callbackName = 'handleResultsResponse_' + Date.now();
            window[callbackName] = function(data) {
                if (data.success) {
                    renderResults(data);
                } else {
                    summaryDiv.innerHTML = `<div class="error-message">‚ùå Error loading results: ${data.message}</div>`;
                }
                delete window[callbackName];
            };

            const script = document.createElement('script');
            script.src = `${SURVEY_API_URL}?action=getSurveyResults&surveyId=${surveyId}&callback=${callbackName}`;
            document.head.appendChild(script);
        }

        // RENDER RESULTS
        function renderResults(data) {
            const survey = data.survey;
            const results = data.results;
            
            // Filter out section breaks from results count (they don't have responses)
            const regularQuestionResults = results.filter(r => r.questionType !== 'Section Break');

            // Update header
            document.getElementById('resultsTitle').textContent = survey.title;
            document.getElementById('resultsSubtitle').textContent = `${survey.status} ‚Ä¢ ${data.responseCount} responses ‚Ä¢ ${survey.isAnonymous ? 'Anonymous' : 'Identified'}`;

            // Summary cards
            const summaryDiv = document.getElementById('resultsSummary');
            summaryDiv.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">${data.responseCount}</div>
                    <div class="summary-label">Total Responses</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${regularQuestionResults.length}</div>
                    <div class="summary-label">Questions</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${survey.status}</div>
                    <div class="summary-label">Survey Status</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${survey.isAnonymous ? 'Yes' : 'No'}</div>
                    <div class="summary-label">Anonymous</div>
                </div>
            `;

            // Question results
            const contentDiv = document.getElementById('resultsContent');
            contentDiv.innerHTML = results.map((result, index) => {
                let resultHtml = `
                    <div class="question-result">
                        <div class="question-result-header">
                            ${index + 1}. ${escapeHtml(result.questionText)}
                            <span class="question-type-badge">${result.questionType}</span>
                        </div>
                `;

                if (result.questionType === 'Rating') {
                    const stars = '‚òÖ'.repeat(Math.round(parseFloat(result.averageRating))) + '‚òÜ'.repeat(5 - Math.round(parseFloat(result.averageRating)));
                    resultHtml += `
                        <div class="rating-display">
                            <div class="rating-value">${result.averageRating} / 5.0</div>
                            <div class="rating-stars">${stars}</div>
                            <div style="margin-top: 15px; color: #64748b;">Based on ${result.totalResponses} responses</div>
                        </div>
                    `;
                    if (result.ratingDistribution) {
                        resultHtml += '<div style="margin-top: 20px;">';
                        result.ratingDistribution.forEach(dist => {
                            resultHtml += `
                                <div class="answer-bar">
                                    <div class="answer-label">
                                        <span>${dist.rating} stars</span>
                                        <span class="answer-count">${dist.count} (${dist.percentage}%)</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${dist.percentage}%">
                                            ${dist.percentage}%
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        resultHtml += '</div>';
                    }
                } else if (result.questionType === 'Text') {
                    resultHtml += `<div class="text-responses">`;
                    if (result.answers && result.answers.length > 0) {
                        result.answers.forEach(answer => {
                            resultHtml += `
                                <div class="text-response">
                                    <div class="response-text">"${escapeHtml(answer.text)}"</div>
                                    <div class="response-meta">‚Äî ${answer.respondent} on ${formatDate(answer.submittedDate)}</div>
                                </div>
                            `;
                        });
                    } else {
                        resultHtml += '<div style="text-align: center; color: #64748b; padding: 20px;">No responses yet</div>';
                    }
                    resultHtml += `</div>`;
                } else {
                    // Multiple/Single Choice, Yes/No
                    if (result.answers && result.answers.length > 0) {
                        result.answers.forEach(answer => {
                            resultHtml += `
                                <div class="answer-bar">
                                    <div class="answer-label">
                                        <span>${escapeHtml(answer.option)}</span>
                                        <span class="answer-count">${answer.count} (${answer.percentage}%)</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${answer.percentage}%">
                                            ${answer.percentage}%
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        resultHtml += '<div style="text-align: center; color: #64748b; padding: 20px;">No responses yet</div>';
                    }
                }

                resultHtml += `</div>`;
                return resultHtml;
            }).join('');
        }

        // UTILITY FUNCTIONS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-AU', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

// ============================================
// DELETE SURVEY FUNCTIONS
// ============================================

function confirmDeleteSurvey(surveyId, surveyTitle, responseCount) {
    if (responseCount > 0) {
        if (confirm(`Cannot delete "${surveyTitle}" because it has ${responseCount} response(s). Would you like to archive it instead?`)) {
            changeSurveyStatus(surveyId, 'Archived');
        }
        return;
    }
    
    if (confirm(`Are you sure you want to delete "${surveyTitle}"? This action cannot be undone.`)) {
        deleteSurveyFrontend(surveyId, surveyTitle);
    }
}

function deleteSurveyFrontend(surveyId, surveyTitle) {
    const deleteBtn = document.querySelector(`.btn-delete-survey[onclick*="${surveyId}"]`);
    if (deleteBtn) {
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '‚è≥ Deleting...';
    }
    
    const callbackName = 'deleteCallback_' + Date.now();
    
    window[callbackName] = function(result) {
        if (result.success) {
            alert(`‚úÖ Survey "${surveyTitle}" deleted successfully!`);
            loadSurveys();
        } else {
            alert(`‚ùå Error: ${result.message || result.error}`);
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = 'üóëÔ∏è Delete';
            }
        }
        delete window[callbackName];
    };
    
    const script = document.createElement('script');
    script.src = `${SURVEY_API_URL}?action=deleteSurvey&surveyId=${surveyId}&callback=${callbackName}`;
    script.onerror = function() {
        alert('‚ùå Network error deleting survey');
        if (deleteBtn) {
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = 'üóëÔ∏è Delete';
        }
        delete window[callbackName];
    };
    
    document.head.appendChild(script);
}

// ============================================
// EDIT SURVEY FUNCTIONS - COMPLETE VERSION
// ============================================

let currentEditingSurveyId = null;

function editSurvey(surveyId, buttonElement) {
    
    // Show loading on button if button was clicked
    if (buttonElement) {
        buttonElement.innerHTML = '‚è≥ Loading...';
        buttonElement.disabled = true;
        buttonElement.dataset.loading = 'true';
    }
    
    currentEditingSurveyId = surveyId;
    loadSurveyForEditing(surveyId, buttonElement);
}

function loadSurveyForEditing(surveyId, buttonElement = null) {
    
    // FIRST, switch to create view to ensure it exists
    document.getElementById('listView').classList.add('hidden');
    document.getElementById('createView').classList.remove('hidden');
    document.getElementById('resultsView').classList.add('hidden');
    
    // NOW replace the content with loading message
    const createView = document.getElementById('createView');
    createView.innerHTML = `
        <div class="loading-container" style="text-align: center; padding: 60px;">
            <div class="loading-spinner" style="width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <h3 style="color: #667eea; margin-bottom: 10px;">Loading Survey Editor</h3>
            <p style="color: #64748b;">Loading survey data and questions...</p>
        </div>
    `;
    
    // JSONP request to get survey details
    const callbackName = 'editLoadCallback_' + Date.now();
    
    window[callbackName] = function(data) {
        // Reset button if it exists
        if (buttonElement) {
            buttonElement.innerHTML = '‚úèÔ∏è Edit';
            buttonElement.disabled = false;
            buttonElement.dataset.loading = 'false';
        }
        
        if (data.success) {
            populateEditForm(data.survey);
        } else {
            
            // Show error
            createView.innerHTML = `
                <div style="padding: 40px;">
                    <div class="error-message" style="background: #fee2e2; border: 2px solid #ef4444; color: #dc2626; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        ‚ùå Error loading survey: ${data.message || 'Unknown error'}
                    </div>
                    <div style="text-align: center;">
                        <button class="btn-primary" onclick="showView('list')" style="padding: 12px 24px;">
                            ‚Üê Back to Survey List
                        </button>
                    </div>
                </div>
            `;
        }
        delete window[callbackName];
    };
    
    const script = document.createElement('script');
    script.src = `${SURVEY_API_URL}?action=getSurveyDetails&surveyId=${surveyId}&callback=${callbackName}`;
    document.head.appendChild(script);
}

function populateEditForm(survey) {
    
    // Get the create view container
    const createView = document.getElementById('createView');
    
    // Restore the original form structure
    createView.innerHTML = `
        <div class="form-section">
            <h2 class="section-title">Edit Survey</h2>
            <p class="section-description">Editing: ${escapeHtml(survey.title)}</p>

            <div id="createMessage"></div>

            <div class="form-group">
                <label class="form-label">Survey Title <span class="required">*</span></label>
                <input type="text" id="surveyTitle" class="form-input" placeholder="e.g., 2026 Community Satisfaction Survey">
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="surveyDescription" class="form-textarea" placeholder="Briefly describe the purpose of this survey..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Survey Settings</label>
                
                <div class="form-checkbox-group">
                    <input type="checkbox" id="isAnonymous" class="form-checkbox">
                    <label for="isAnonymous">Anonymous responses (recommended for honest feedback)</label>
                </div>

                
            </div>

            <div class="form-group">
                <label class="form-label">Thank You Message</label>
                <textarea id="thankYouMessage" class="form-textarea" placeholder="Message shown after survey completion...">Thank you for taking the time to provide your valuable feedback!</textarea>
            </div>

            <!-- CONFIMATION SETTINGS -->
            <div class="form-section">
                <h2 class="section-title">Confirmation Settings</h2>
                <p class="section-description">Customize what happens after survey completion</p>

                <div class="form-group">
                    <label class="form-label">Custom Confirmation Message</label>
                    <textarea id="confirmationMessage" class="form-textarea" placeholder="Optional custom message to show after submission..."></textarea>
                    <div class="form-hint">If left empty, the standard "Thank You" message will be used</div>
                </div>

                <div class="form-checkbox-group">
                    <input type="checkbox" id="allowAnotherResponse" class="form-checkbox">
                    <label for="allowAnotherResponse">Show option to submit another response (if multiple responses allowed)</label>
                </div>

                <div class="form-checkbox-group">
                    <input type="checkbox" id="showResponseSummary" class="form-checkbox">
                    <label for="showResponseSummary">Show response summary after submission</label>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h2 class="section-title">Questions</h2>
            <p class="section-description">Add questions to your survey (minimum 1 required)</p>

            <div id="questionsContainer" class="questions-container">
                <!-- Questions will be added here -->
            </div>

            <button class="add-question-btn" onclick="addQuestion()">
                ‚ûï Add Question
            </button>
        </div>

        <div class="form-section" style="margin-top: 30px;">
            <button class="btn-primary" id="saveSurveyBtn" onclick="saveSurvey()" style="width: 200px;">
                üíæ Save Changes
            </button>
            <button class="btn-secondary" onclick="showView('list')" style="width: 150px; margin-left: 12px;">
                Cancel
            </button>
        </div>
    `;
    
    // NOW populate the form fields
    document.getElementById('surveyTitle').value = survey.title || '';
    document.getElementById('surveyDescription').value = survey.description || '';
    document.getElementById('isAnonymous').checked = survey.isAnonymous === true;
    
    document.getElementById('thankYouMessage').value = survey.thankYouMessage || 'Thank you for taking the time to provide your valuable feedback!';
    document.getElementById('confirmationMessage').value = survey.confirmationMessage || '';
    document.getElementById('allowAnotherResponse').checked = survey.allowAnotherResponse === true;
    document.getElementById('showResponseSummary').checked = survey.showResponseSummary === true;
    
    // Clear existing questions
    const questionsContainer = document.getElementById('questionsContainer');
    questionsContainer.innerHTML = '';
    questionCount = 0;
    
    // Add questions from survey
    if (survey.questions && survey.questions.length > 0) {
        survey.questions.forEach((question, index) => {
            addQuestionToEditForm(question, index + 1);
        });
    } else {
        addQuestion(); // Add empty question if none exist
    }
}

function addQuestionToEditForm(question, questionNumber) {
    questionCount = questionNumber;
    const container = document.getElementById('questionsContainer');
    
    const questionCard = document.createElement('div');
    questionCard.className = 'question-card';
    questionCard.dataset.questionId = questionCount;
    questionCard.innerHTML = `
        <div class="question-header">
            <div class="question-number">Question ${questionCount}</div>
            <div class="question-actions">
                <button class="btn-icon btn-delete" onclick="deleteQuestion(${questionCount})">
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Question Text <span class="required">*</span></label>
            <input type="text" class="form-input question-text" 
                   value="${escapeHtml(question.questionText || '')}" 
                   placeholder="Enter your question..." required>
        </div>

        <div class="form-group">
            <label class="form-label">Question Type <span class="required">*</span></label>
            <select class="form-select question-type" onchange="handleQuestionTypeChange(${questionCount})">
                <option value="Rating" ${question.questionType === 'Rating' ? 'selected' : ''}>Rating (1-5 stars)</option>
                <option value="Single Choice" ${question.questionType === 'Single Choice' ? 'selected' : ''}>Single Choice</option>
                <option value="Multiple Choice" ${question.questionType === 'Multiple Choice' ? 'selected' : ''}>Multiple Choice</option>
                <option value="Text" ${question.questionType === 'Text' ? 'selected' : ''}>Text Response</option>
                <option value="Yes/No" ${question.questionType === 'Yes/No' ? 'selected' : ''}>Yes/No</option>
                <option value="Section Break" ${question.questionType === 'Section Break' ? 'selected' : ''}>üìã Section Break</option>
            </select>
        </div>

        <div class="options-container" style="display: ${question.questionType === 'Single Choice' || question.questionType === 'Multiple Choice' || question.questionType === 'Yes/No' ? 'block' : 'none'};">
            <label class="form-label">Options <span class="required">*</span></label>
            <div class="options-list">
                ${renderOptionsForEdit(question)}
            </div>
            ${question.questionType !== 'Yes/No' ? `<button class="btn-add-option" onclick="addOption(${questionCount})">+ Add Option</button>` : ''}
        </div>

        <div class="rating-scale-container" style="display: ${question.questionType === 'Rating' ? 'block' : 'none'};">
            <label class="form-label">Rating Scale</label>
            <select class="form-select rating-scale-type">
                <option value="1-5" ${(!question.ratingMin || question.ratingMin === 1) && (!question.ratingMax || question.ratingMax === 5) ? 'selected' : ''}>1-5 (Satisfaction)</option>
                <option value="0-10" ${question.ratingMin === 0 && question.ratingMax === 10 ? 'selected' : ''}>0-10 (NPS / Net Promoter Score)</option>
            </select>
            <div style="margin-top: 8px; font-size: 0.85rem; color: #64748b;">
                Choose the rating scale for this question
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Help Text (optional)</label>
            <input type="text" class="form-input question-help" 
                   value="${escapeHtml(question.helpText || '')}" 
                   placeholder="Additional guidance for respondents...">
        </div>

        <div class="form-checkbox-group">
            <input type="checkbox" class="form-checkbox question-required" ${question.isRequired ? 'checked' : ''}>
            <label>Required question</label>
        </div>
    `;
    
    container.appendChild(questionCard);
}

function renderOptionsForEdit(question) {
    if (!question.optionsArray || question.optionsArray.length === 0) {
        // Default options for choice questions
        if (question.questionType === 'Yes/No') {
            return `
                <div class="option-input-group">
                    <input type="text" class="form-input option-input" value="Yes" readonly>
                </div>
                <div class="option-input-group">
                    <input type="text" class="form-input option-input" value="No" readonly>
                </div>
            `;
        }
        
        return `
            <div class="option-input-group">
                <input type="text" class="form-input option-input" placeholder="Option 1">
                <button class="btn-icon btn-delete" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            </div>
            <div class="option-input-group">
                <input type="text" class="form-input option-input" placeholder="Option 2">
                <button class="btn-icon btn-delete" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            </div>
        `;
    }
    
    return question.optionsArray.map((option, index) => `
        <div class="option-input-group">
            <input type="text" class="form-input option-input" 
                   value="${escapeHtml(option)}" 
                   placeholder="Option ${index + 1}">
            <button class="btn-icon btn-delete" onclick="this.parentElement.remove()">üóëÔ∏è</button>
        </div>
    `).join('');
}

// ============================================
// SHARE SURVEY FUNCTION
// ============================================

function shareSurvey(surveyId) {
    // Get the survey card to extract title
    const shareButton = document.querySelector(`button[onclick*="shareSurvey('${surveyId}')"]`);
    const surveyCard = shareButton?.closest('.survey-card');
    const surveyTitle = surveyCard?.querySelector('.survey-title')?.textContent || 'Survey';
    
    // Construct the survey URL
    const surveyUrl = `https://lake-illawong-maintenance.netlify.app/CommunitySurveys.html?survey=${surveyId}`;
    
    // Try to copy to clipboard
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(surveyUrl)
            .then(() => {
                // Show success message
                showShareNotification(`‚úÖ Survey link copied!<br><br>"${surveyTitle}"`, 'success');
            })
            .catch(() => {
                // Fallback if clipboard fails
                showShareCopyPrompt(surveyTitle, surveyUrl);
            });
    } else {
        // Fallback for older browsers
        showShareCopyPrompt(surveyTitle, surveyUrl);
    }
}

function showShareCopyPrompt(title, url) {
    const userCopied = confirm(
        `üìã Share Survey Link\n\n` +
        `Survey: "${title}"\n\n` +
        `URL: ${url}\n\n` +
        `Click OK, then copy the URL from your address bar.`
    );
    
    if (userCopied) {
        showShareNotification('‚úÖ Ready to share!', 'success');
    }
}

function showShareNotification(message, type = 'info') {
    // Remove any existing notification
    const existing = document.querySelector('.share-notification');
    if (existing) existing.remove();
    
    // Create new notification
    const notification = document.createElement('div');
    notification.className = `share-notification ${type}`;
    notification.innerHTML = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : '#3b82f6'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
        font-size: 14px;
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}




    </script>
</body>
</html>
