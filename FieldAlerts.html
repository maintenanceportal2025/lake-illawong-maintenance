<!--
=====================================================================
🔢 FIELD NOTIFICATIONS - INTEGRATED COMMUNICATION SYSTEM
=====================================================================
PURPOSE: Complete notification system with Email Server V1.0.js integration
PORTAL: Field Operations Portal Module
VERSION: v2.1.0 - EMAIL SERVER INTEGRATION
LAST UPDATED: September 21, 2025
DESIGN SYSTEM: Lake Illawong Unified v1.2 - PORTAL CONSISTENCY STANDARD
- Logo positioned horizontally next to header text
- Smart button state management with color coding
- Individual unit selection modal
- Active email counter tracking
- Template filtering system
- Real Email Server V1.0.js integration
AUTHENTICATION: None (Public Access)
DEPENDENCIES: Email Server V1.0.js (sendMassNotification endpoint)
SINGLE SOURCE OF TRUTH: Hardcoded templates (Phase 1)
INTEGRATION FEATURES:
• Real email sending via Email Server V1.0.js
• JSONP API calls for cross-origin support
• Proper zone mapping to Email Server format
• Error handling and timeout management
• Actual recipient count tracking
• Service status monitoring
=====================================================================
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>🔢 Field Notifications</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;


/* Deep Lake Blues */
background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);



            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        /* HEADER - Unified Design Standard with Logo */
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .logo-container {
            flex-shrink: 0;
        }

        .logo-image {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            object-fit: cover;
           
           
            padding: 5px;
        }

        .header-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
        }

        .header-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: white;
            margin: 0 0 5px 0;
            line-height: 1.1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header-subtitle {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            margin: 0;
        }

        /* RESPONSIVE HEADER ADJUSTMENTS */
        @media (max-width: 480px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-text {
                align-items: center;
                text-align: center;
            }
            
            .header-title {
                font-size: 1.8rem;
            }
            
            .logo-image {
                width: 70px;
                height: 70px;
            }
        }

        /* STATUS BAR */
        .status-bar {
            background: rgba(255,255,255,0.95);
            border-radius: 6px;
            padding: 15px 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-dot.offline {
            background: #ef4444;
        }

        /* TEMPLATE FILTERING */
        .template-filters {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border-color: rgba(255,255,255,0.9);
        }

        .filter-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* TEMPLATE SELECTION */
        .section {
            margin-bottom: 25px;
        }

        .section-title {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .template-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .template-card {
            background: white;
            border-radius: 6px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .template-card:active {
            transform: scale(0.95);
        }

        .template-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: scale(1.02);
        }

        .template-card[data-template="general"] {
            grid-column: 1 / -1;
        }

        .template-emoji {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .template-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .template-desc {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.3;
        }

        /* ZONE SELECTOR */
        .zone-selector {
            background: rgba(255,255,255,0.95);
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }

        .zone-title {
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: #1f2937;
        }

        .zone-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .zone-btn {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zone-btn:active {
            transform: scale(0.95);
        }

        .zone-btn.selected {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .zone-btn.all-units {
            grid-column: 1 / -1;
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .zone-btn.all-units.selected {
            background: #1d4ed8;
            border-color: #1d4ed8;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .zone-btn.special {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        /* CLEAR SELECTIONS BUTTON */
        .clear-btn {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            color: #ef4444;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: #ef4444;
            color: white;
        }

        .clear-btn:active {
            transform: scale(0.95);
        }

        /* MESSAGE COMPOSITION */
        .compose-section {
            background: rgba(255,255,255,0.95);
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }

        .compose-title {
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: #1f2937;
        }

        .message-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s;
        }

        .message-input:focus {
            border-color: #3b82f6;
        }

        .char-count {
            text-align: right;
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 8px;
        }

        .char-count.warning {
            color: #f59e0b;
        }

        .char-count.error {
            color: #ef4444;
        }

        /* SMART SEND BUTTON */
        .send-section {
            text-align: center;
        }

        .send-btn {
            background: #9ca3af;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 18px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: not-allowed;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .send-btn.template-selected {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            cursor: pointer;
        }

        .send-btn.ready-to-send {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .send-btn.ready-to-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }

        .send-btn:disabled {
            transform: none;
            box-shadow: none;
        }

        /* INDIVIDUAL UNIT SELECTOR MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 5px;
        }

        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }

        .unit-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .unit-checkbox:hover {
            border-color: #3b82f6;
        }

        .unit-checkbox.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .unit-checkbox input {
            margin: 0;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            color: #374151;
        }

        .btn-primary {
            background: #3b82f6;
            border: 2px solid #3b82f6;
            color: white;
        }

        /* NOTIFICATION POPUP */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .notification.success {
            border-left: 5px solid #10b981;
        }

        .notification.error {
            border-left: 5px solid #ef4444;
        }

        .notification.info {
            border-left: 5px solid #3b82f6;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* LOADING SPINNER */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* RESPONSIVE ADJUSTMENTS */
        @media (max-width: 400px) {
            .container {
                padding: 15px;
            }
            
            .template-grid {
                grid-template-columns: 1fr;
            }
            
            .zone-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .template-card {
                min-height: 80px;
            }
            
            .send-btn {
                width: 100%;
                min-width: auto;
            }

            .units-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header - Unified Design Standard with Logo -->
        <div class="header">
            <div class="header-content">
                <div class="logo-container">
                    <img src="https://maintenanceportal2025.github.io/maintenance-portal/logo.png" 
                         alt="Lake Illawong Logo" class="logo-image">
                </div>
                <div class="header-text">
                    <h1 class="header-title">🔢 Field Notifications</h1>
                    <p class="header-subtitle">Enhanced communication system</p>
                </div>
            </div>
        </div>

        <!-- Status Bar with Email Counter -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="serviceDot"></div>
                <span id="serviceStatus">Email Service</span>
            </div>
            <div class="status-item">
                <span id="emailCounter">📧 0 sent today</span>
            </div>
            <div class="status-item">
                <span id="lastUpdate">Last: --:--</span>
            </div>
        </div>

        <!-- Template Filters -->
        <div class="template-filters">
            <button class="filter-btn active" data-filter="all">All Templates</button>
            <button class="filter-btn" data-filter="general">General Purpose</button>
            <button class="filter-btn" data-filter="emergency">🚨 Emergency</button>
        </div>

        <!-- Template Selection -->
        <div class="section">
            <div class="section-title">Quick Templates</div>
            <div class="template-grid" id="templateGrid">
                <div class="template-card" data-template="emergency" data-category="emergency">
                    <div class="template-emoji">🚨</div>
                    <div class="template-title">Emergency</div>
                    <div class="template-desc">Urgent safety alerts</div>
                </div>
                <div class="template-card" data-template="maintenance" data-category="general">
                    <div class="template-emoji">🔧</div>
                    <div class="template-title">Maintenance</div>
                    <div class="template-desc">Scheduled work</div>
                </div>
                <div class="template-card" data-template="outage" data-category="general">
                    <div class="template-emoji">⚡</div>
                    <div class="template-title">Outage</div>
                    <div class="template-desc">Service disruptions</div>
                </div>
                <div class="template-card" data-template="announcement" data-category="general">
                    <div class="template-emoji">📢</div>
                    <div class="template-title">Announcement</div>
                    <div class="template-desc">General notices</div>
                </div>
                <div class="template-card" data-template="general" data-category="general">
                    <div class="template-emoji">📝</div>
                    <div class="template-title">General</div>
                    <div class="template-desc">Custom message</div>
                </div>
            </div>
        </div>

        <!-- Zone Selection -->
        <div class="zone-selector">
            <div class="zone-title">Select Notification Zones</div>
            <div class="zone-grid">
                <button class="zone-btn all-units" data-zone="all">All Units</button>
                <button class="zone-btn" data-zone="zone1">Zone 1 (1-8)</button>
                <button class="zone-btn" data-zone="zone2">Zone 2 (9-20)</button>
                <button class="zone-btn" data-zone="zone3">Zone 3 (21-28)</button>
                <button class="zone-btn" data-zone="zone4">Zone 4 (29-36)</button>
                <button class="zone-btn" data-zone="zone5">Zone 5 (37-44)</button>
                <button class="zone-btn special" onclick="openUnitSelector()">📋 Select Individual Units</button>
            </div>
            
            <!-- Clear Selections Button -->
            <div style="text-align: center; margin-top: 15px;">
                <button class="clear-btn" onclick="clearAllSelections()">
                    🗑️ Clear Selections
                </button>
            </div>
        </div>

        <!-- Message Composition -->
        <div class="compose-section">
            <div class="compose-title">Compose Message</div>
            <textarea 
                class="message-input" 
                id="messageText" 
                placeholder="Select a template or enter your custom message here..."
                maxlength="500"></textarea>
            <div class="char-count" id="charCount">0/500 characters</div>
        </div>

        <!-- Smart Send Button -->
        <div class="send-section">
            <button class="send-btn" id="sendBtn" disabled>
                Select Template
            </button>
        </div>
    </div>

    <!-- Individual Unit Selector Modal -->
    <div id="unitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Select Individual Units</h2>
                <button class="close-btn" onclick="closeUnitSelector()">&times;</button>
            </div>
            
            <div class="units-grid" id="unitsGrid">
                <!-- Units 1-44 will be generated here -->
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="clearAllUnits()">Clear All</button>
                <button class="btn btn-secondary" onclick="selectAllUnits()">Select All</button>
                <button class="btn btn-primary" onclick="confirmUnitSelection()">Confirm Selection</button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================================
        // CONFIGURATION - UPDATE WITH YOUR EMAIL SERVER URL
        // =====================================================================
        
        // Email Server V1.0.js deployment URL
        const EMAIL_SERVICE_URL = 'https://script.google.com/macros/s/AKfycbxWll0dkVYKZcy5yMFvwPPVUKOuQNTb6wBF-kTjBWdVH7CJ-dc552-fBGYda7nN5LMk/exec';
        
        // Global state
        let selectedTemplate = null;
        let selectedZones = [];
        let selectedUnits = [];
        let emailsSentToday = 0;
        let currentFilter = 'all';
        
        // =====================================================================
        // INITIALIZATION
        // =====================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            generateUnitsGrid();
            loadEmailCounter();
            updateEmailCounter();
            checkServiceStatus();
        });
        
        // =====================================================================
        // EVENT LISTENERS
        // =====================================================================
        
        function setupEventListeners() {
            // Template selection
            document.querySelectorAll('.template-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectTemplate(this.dataset.template);
                });
            });
            
            // Zone selection
            document.querySelectorAll('.zone-btn').forEach(btn => {
                if (!btn.onclick) { // Don't override the special button
                    btn.addEventListener('click', function() {
                        selectZone(this.dataset.zone);
                    });
                }
            });
            
            // Template filtering
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    setTemplateFilter(this.dataset.filter);
                });
            });
            
            // Character counter
            const messageInput = document.getElementById('messageText');
            messageInput.addEventListener('input', updateCharCount);
            
            // Send button
            document.getElementById('sendBtn').addEventListener('click', sendNotification);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                    selectTemplate('emergency');
                    showNotification('Emergency template selected', 'info');
                }
                if (e.ctrlKey && e.key === '?') {
                    showNotification('Shortcuts: Ctrl+Shift+E (Emergency)', 'info');
                }
            });
        }
        
        // =====================================================================
        // TEMPLATE MANAGEMENT
        // =====================================================================
        
        function selectTemplate(templateType) {
            selectedTemplate = templateType;
            
            // Update visual selection
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-template="${templateType}"]`).classList.add('selected');
            
            // Load template message
            loadTemplate(templateType);
            updateSendButton();
        }
        
        function setTemplateFilter(filter) {
            currentFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            
            // Filter templates
            document.querySelectorAll('.template-card').forEach(card => {
                const category = card.dataset.category;
                const show = filter === 'all' || category === filter;
                card.style.display = show ? 'flex' : 'none';
            });
        }
        
        function loadTemplate(type) {
            const templates = {
                emergency: "🚨 EMERGENCY ALERT 🚨\n\nImmediate action required. Please follow safety protocols and contact management if needed.\n\nTime: [TIME]\nLake Illawong Management",
                maintenance: "🔧 MAINTENANCE NOTICE\n\nScheduled maintenance work will be performed.\n\nDetails: [DETAILS]\nDuration: [TIME]\nAffected areas: [AREAS]\n\nLake Illawong Maintenance",
                outage: "⚡ SERVICE OUTAGE\n\nWe are experiencing a service disruption.\n\nAffected service: [SERVICE]\nEstimated restoration: [TIME]\n\nWe apologize for any inconvenience.\nLake Illawong Management",
                announcement: "📢 COMMUNITY ANNOUNCEMENT\n\n[YOUR MESSAGE HERE]\n\nThank you,\nLake Illawong Management",
                general: "📝 GENERAL NOTICE\n\n[YOUR MESSAGE HERE]\n\nPlease contact management if you have any questions.\n\nRegards,\nLake Illawong Management"
            };
            
            if (templates[type]) {
                const messageInput = document.getElementById('messageText');
                messageInput.value = templates[type];
                updateCharCount();
            }
        }
        
        // =====================================================================
        // ZONE MANAGEMENT
        // =====================================================================
        
        function selectZone(zone) {
            if (zone === 'all') {
                // All units selected - deselect others
                selectedZones = ['all'];
                selectedUnits = [];
                document.querySelectorAll('.zone-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.zone === 'all');
                });
            } else {
                // Individual zone selected
                const allBtn = document.querySelector('[data-zone="all"]');
                allBtn.classList.remove('selected');
                
                const btn = document.querySelector(`[data-zone="${zone}"]`);
                btn.classList.toggle('selected');
                
                if (btn.classList.contains('selected')) {
                    if (!selectedZones.includes(zone)) {
                        selectedZones = selectedZones.filter(z => z !== 'all');
                        selectedZones.push(zone);
                    }
                } else {
                    selectedZones = selectedZones.filter(z => z !== zone);
                }
                
                // If no zones selected, default to all
                if (selectedZones.length === 0) {
                    allBtn.classList.add('selected');
                    selectedZones = ['all'];
                }
                
                selectedUnits = []; // Clear individual selections
            }
            
            updateSendButton();
        }
        
        // =====================================================================
        // INDIVIDUAL UNIT SELECTION
        // =====================================================================
        
        function openUnitSelector() {
            document.getElementById('unitModal').classList.add('show');
        }
        
        function closeUnitSelector() {
            document.getElementById('unitModal').classList.remove('show');
        }
        
        function generateUnitsGrid() {
            const grid = document.getElementById('unitsGrid');
            for (let i = 1; i <= 44; i++) {
                const unitDiv = document.createElement('div');
                unitDiv.className = 'unit-checkbox';
                unitDiv.innerHTML = `
                    <input type="checkbox" id="unit${i}" value="${i}">
                    <label for="unit${i}">Unit ${i}</label>
                `;
                unitDiv.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = this.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                    }
                    this.classList.toggle('selected', this.querySelector('input').checked);
                });
                grid.appendChild(unitDiv);
            }
        }
        
        function selectAllUnits() {
            document.querySelectorAll('#unitsGrid input').forEach(input => {
                input.checked = true;
                input.closest('.unit-checkbox').classList.add('selected');
            });
        }
        
        function clearAllUnits() {
            document.querySelectorAll('#unitsGrid input').forEach(input => {
                input.checked = false;
                input.closest('.unit-checkbox').classList.remove('selected');
            });
        }
        
        function confirmUnitSelection() {
            selectedUnits = Array.from(document.querySelectorAll('#unitsGrid input:checked')).map(input => input.value);
            
            if (selectedUnits.length > 0) {
                // Clear zone selections
                selectedZones = [];
                document.querySelectorAll('.zone-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            }
            
            closeUnitSelector();
            updateSendButton();
        }
        
        // =====================================================================
        // SMART BUTTON MANAGEMENT
        // =====================================================================
        
        function updateSendButton() {
            const sendBtn = document.getElementById('sendBtn');
            
            // Reset classes
            sendBtn.classList.remove('template-selected', 'ready-to-send');
            
            if (!selectedTemplate) {
                sendBtn.textContent = 'Select Template';
                sendBtn.disabled = true;
            } else if (selectedZones.length === 0 && selectedUnits.length === 0) {
                sendBtn.textContent = 'Select Zone or Units';
                sendBtn.disabled = true;
                sendBtn.classList.add('template-selected');
            } else {
                const templateName = getTemplateName(selectedTemplate);
                const targetText = getTargetText();
                sendBtn.textContent = `Send ${templateName} to ${targetText}`;
                sendBtn.disabled = false;
                sendBtn.classList.add('ready-to-send');
            }
        }
        
        function getTemplateName(template) {
            const names = {
                'emergency': 'Emergency',
                'maintenance': 'Maintenance',
                'outage': 'Outage',
                'announcement': 'Announcement',
                'general': 'General'
            };
            return names[template] || 'Message';
        }
        
        function getTargetText() {
            if (selectedUnits.length > 0) {
                if (selectedUnits.length === 1) return `Unit ${selectedUnits[0]}`;
                if (selectedUnits.length <= 3) return selectedUnits.map(u => `Unit ${u}`).join(', ');
                return `${selectedUnits.length} units`;
            }
            
            if (selectedZones.includes('all')) return 'All Units';
            
            // Map zone codes to display names
            const zoneNames = {
                'zone1': 'Zone 1',
                'zone2': 'Zone 2', 
                'zone3': 'Zone 3',
                'zone4': 'Zone 4',
                'zone5': 'Zone 5'
            };
            
            if (selectedZones.length === 1) {
                return zoneNames[selectedZones[0]] || selectedZones[0];
            }
            if (selectedZones.length <= 3) {
                return selectedZones.map(z => zoneNames[z] || z).join(', ');
            }
            return `${selectedZones.length} zones`;
        }
        
        // =====================================================================
        // EMAIL COUNTER MANAGEMENT
        // =====================================================================
        
        function updateEmailCounter() {
            const counter = document.getElementById('emailCounter');
            counter.textContent = `📧 ${emailsSentToday} sent today`;
        }
        
        function incrementEmailCounter(count = 1) {
            emailsSentToday += count;
            updateEmailCounter();
            saveEmailCounter();
        }
        
        function loadEmailCounter() {
            const today = new Date().toDateString();
            const storedData = localStorage.getItem('emailCounter');
            
            if (storedData) {
                const data = JSON.parse(storedData);
                if (data.date === today) {
                    emailsSentToday = data.count;
                } else {
                    emailsSentToday = 0;
                    localStorage.setItem('emailCounter', JSON.stringify({
                        date: today,
                        count: 0
                    }));
                }
            } else {
                emailsSentToday = 0;
                localStorage.setItem('emailCounter', JSON.stringify({
                    date: today,
                    count: 0
                }));
            }
        }
        
        function saveEmailCounter() {
            const today = new Date().toDateString();
            localStorage.setItem('emailCounter', JSON.stringify({
                date: today,
                count: emailsSentToday
            }));
        }
        
        // =====================================================================
        // CHARACTER COUNTER
        // =====================================================================
        
        function updateCharCount() {
            const messageInput = document.getElementById('messageText');
            const charCount = document.getElementById('charCount');
            const length = messageInput.value.length;
            
            charCount.textContent = `${length}/500 characters`;
            charCount.className = 'char-count';
            if (length > 400) charCount.classList.add('warning');
            if (length > 450) charCount.classList.add('error');
        }
        
        // =====================================================================
        // EMAIL SERVER V1.0.JS INTEGRATION
        // =====================================================================
        
        async function sendNotification() {
            const message = document.getElementById('messageText').value.trim();
            
            if (!message) {
                showNotification('Please enter a message before sending.', 'error');
                return;
            }
            
            if (selectedZones.length === 0 && selectedUnits.length === 0) {
                showNotification('Please select zones or individual units.', 'error');
                return;
            }
            
            // Check if Email Server URL is configured
            if (EMAIL_SERVICE_URL === 'YOUR_EMAIL_SERVER_V1_URL_HERE') {
                showNotification('Email Server URL not configured. Please update EMAIL_SERVICE_URL.', 'error');
                return;
            }
            
            const sendBtn = document.getElementById('sendBtn');
            const originalText = sendBtn.innerHTML;
            
            // Show loading state
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="spinner"></span>Sending...';
            
            try {
                // Prepare recipient filter first
                const recipientFilter = buildRecipientFilter();
                
                // Prepare API call parameters - override template with custom message
                const customData = {
                    message: message,
                    subject: `Field Notification - ${getTemplateName(selectedTemplate)}`,
                    body: message, // Override template body with our custom message
                    timestamp: new Date().toLocaleString(),
                    templateType: selectedTemplate,
                    fieldAlert: true
                };
                
                console.log('Sending notification with params:', {
                    recipientFilter,
                    customData,
                    selectedTemplate,
                    selectedZones,
                    selectedUnits
                });
                
                // Call Email Server V1.0.js with working template
                const response = await callEmailAPI('sendMassNotification', {
                    templateId: 'WATER01', // Use WATER01 since it works reliably
                    customData: JSON.stringify(customData),
                    recipientFilter: recipientFilter,
                    adminUser: 'FieldOperations'
                });
                
                console.log('Email API response:', response);
                
                if (response.success) {
                    // Success
                    const targetText = getTargetText();
                    const recipientCount = response.recipientCount || calculateRecipientCount();
                    showNotification(`${getTemplateName(selectedTemplate)} sent to ${targetText}! (${recipientCount} recipients)`, 'success');
                    
                    // Update counter with actual count
                    incrementEmailCounter(recipientCount);
                    
                    // Reset form
                    resetForm();
                } else {
                    throw new Error(response.error || 'Failed to send notification');
                }
                
            } catch (error) {
                console.error('Send error:', error);
                showNotification('Failed to send notification: ' + error.message, 'error');
            } finally {
                // Restore button
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalText;
            }
        }
        
        function callEmailAPI(action, params) {
            return new Promise((resolve, reject) => {
                const callbackName = 'emailCallback_' + Date.now();
                const script = document.createElement('script');
                
                // Set up callback
                window[callbackName] = function(response) {
                    resolve(response);
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                // Build URL
                const url = new URL(EMAIL_SERVICE_URL);
                url.searchParams.append('action', action);
                url.searchParams.append('callback', callbackName);
                
                // Add all parameters
                Object.keys(params).forEach(key => {
                    url.searchParams.append(key, params[key]);
                });
                
                script.src = url.toString();
                script.onerror = () => {
                    reject(new Error('Network error - check Email Server URL'));
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                document.head.appendChild(script);
                
                // Timeout after 30 seconds
                setTimeout(() => {
                    if (window[callbackName]) {
                        reject(new Error('Request timeout'));
                        document.head.removeChild(script);
                        delete window[callbackName];
                    }
                }, 30000);
            });
        }
        
        function buildRecipientFilter() {
            if (selectedUnits.length > 0) {
                // Send individual units with "Unit " prefix to match UnitList format
                const unitsList = selectedUnits.map(unit => `Unit ${unit}`).join(',');
                console.log('Individual units selected:', selectedUnits);
                return `units:${unitsList}`;
            }
            
            if (selectedZones.includes('all')) {
                return 'all_units';
            }
            
            // Map our zones to Email Server format
            if (selectedZones.length === 1) {
                const zoneMap = {
                    'zone1': 'zone_1',
                    'zone2': 'zone_2', 
                    'zone3': 'zone_3',
                    'zone4': 'zone_4',
                    'zone5': 'zone_5'
                };
                return zoneMap[selectedZones[0]] || 'all_units';
            }
            
            // Multiple zones - Email Server V1.0.js doesn't support multiple zones yet
            // Default to all units for now
            console.log('Multiple zones selected:', selectedZones);
            showNotification('Multiple zone targeting coming soon. Sending to all units.', 'info');
            return 'all_units';
        }
        
        function calculateRecipientCount() {
            if (selectedUnits.length > 0) {
                return selectedUnits.length;
            }
            
            if (selectedZones.includes('all')) {
                return 44; // All units
            }
            
            // Accurate count based on actual zones
            let count = 0;
            selectedZones.forEach(zone => {
                switch(zone) {
                    case 'zone1': count += 8; break;  // Units 1-8
                    case 'zone2': count += 12; break; // Units 9-20
                    case 'zone3': count += 8; break;  // Units 21-28
                    case 'zone4': count += 8; break;  // Units 29-36
                    case 'zone5': count += 8; break;  // Units 37-44
                    default: count += 1;
                }
            });
            return count;
        }
        
        // =====================================================================
        // SERVICE STATUS MONITORING
        // =====================================================================
        
        async function checkServiceStatus() {
            const serviceDot = document.getElementById('serviceDot');
            const serviceStatus = document.getElementById('serviceStatus');
            
            if (EMAIL_SERVICE_URL === 'YOUR_EMAIL_SERVER_V1_URL_HERE') {
                serviceDot.classList.add('offline');
                serviceStatus.textContent = 'Not Configured';
                return;
            }
            
            try {
                // Test connection to Email Server
                const response = await callEmailAPI('checkEmailQuota', {});
                
                if (response.success) {
                    serviceDot.classList.remove('offline');
                    serviceStatus.textContent = 'Email Service';
                } else {
                    serviceDot.classList.add('offline');
                    serviceStatus.textContent = 'Service Error';
                }
            } catch (error) {
                serviceDot.classList.add('offline');
                serviceStatus.textContent = 'Service Offline';
                console.error('Service check failed:', error);
            }
            
            updateLastUpdateTime();
        }
        
        function updateLastUpdateTime() {
            const lastUpdate = document.getElementById('lastUpdate');
            const now = new Date();
            lastUpdate.textContent = `Last: ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        }
        
        // =====================================================================
        // UTILITY FUNCTIONS
        // =====================================================================
        
        function clearAllSelections() {
            // Clear state variables
            selectedTemplate = null;
            selectedZones = [];
            selectedUnits = [];
            
            // Clear template selections
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Clear zone selections
            document.querySelectorAll('.zone-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Clear individual unit selections
            document.querySelectorAll('#unitsGrid input').forEach(input => {
                input.checked = false;
                input.closest('.unit-checkbox').classList.remove('selected');
            });
            
            // Clear message text
            const messageInput = document.getElementById('messageText');
            messageInput.value = '';
            messageInput.placeholder = 'Select a template or enter your custom message here...';
            updateCharCount();
            
            // Update send button
            updateSendButton();
            
            // Show confirmation
            showNotification('All selections cleared', 'success');
        }
        
        function resetForm() {
            // Clear selections
            selectedTemplate = null;
            selectedZones = [];
            selectedUnits = [];
            
            // Clear visual selections
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll('.zone-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Clear individual unit selections
            document.querySelectorAll('#unitsGrid input').forEach(input => {
                input.checked = false;
                input.closest('.unit-checkbox').classList.remove('selected');
            });
            
            // Clear message
            const messageInput = document.getElementById('messageText');
            messageInput.value = '';
            updateCharCount();
            
            // Update button
            updateSendButton();
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
        
        // =====================================================================
        // PERIODIC UPDATES
        // =====================================================================
        
        // Check service status every 2 minutes
        setInterval(checkServiceStatus, 120000);
        
        // Update timestamp every 30 seconds
        setInterval(updateLastUpdateTime, 30000);
    </script>
</body>
</html>