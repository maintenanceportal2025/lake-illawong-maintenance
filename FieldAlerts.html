<!--
=====================================================================
FIELD NOTIFICATIONS - INTEGRATED COMMUNICATION SYSTEM
=====================================================================
PURPOSE: Complete notification system with Email Server V2.2.js integration
PORTAL: Field Operations Portal Module
VERSION: v2.5.2 - JSONP POST FOR ATTACHMENTS (WORKING!)
LAST UPDATED: November 25, 2025 - 9:50 AM
DESIGN SYSTEM: Lake Illawong Unified v1.2 - PORTAL CONSISTENCY STANDARD

FIXES IN V2.5.2:
- Fixed cross-origin iframe reading error
- POST now uses JSONP callback (bypasses all security restrictions)
- Form submits with callback parameter
- Backend returns JSONP format (not plain JSON)
- No more SecurityError when reading response
- Attachments now work properly!

FIXES IN V2.5.1:
- Attempted form-based POST (blocked by iframe cross-origin reading)

FIXES IN V2.5.0:
- Added POST support for large payloads

FIXES IN V2.4.1:
- Added missing sendNotification() function

AUTHENTICATION: None (Public Access)
DEPENDENCIES: Email Server V2.3.5 (with JSONP POST support)
SINGLE SOURCE OF TRUTH: UnitList for all recipient data
INTEGRATION FEATURES:
- Real email sending via Email Server with Gmail API
- JSONP for all requests (GET and POST) - bypasses CORS and iframe restrictions
- Form-based POST for large payloads (attachments)
- Proper zone mapping to Email Server format
- Error handling and timeout management
- No-email resident reminder popup
- Dynamic E-Copy distribution list from UnitList Column K
- PDF/DOC attachment support via JSONP POST
=====================================================================
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title> Field Notifications</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;


/* Deep Lake Blues */
background: linear-gradient(90deg, #1e40af 0%, #1e3a8a 100%);



            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        /* HEADER - Unified Design Standard with Logo */
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .logo-container {
            flex-shrink: 0;
        }

        .logo-image {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            object-fit: cover;
           
           
            padding: 5px;
        }

        .header-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
        }

        .header-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: white;
            margin: 0 0 5px 0;
            line-height: 1.1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header-subtitle {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            margin: 0;
        }

        /* RESPONSIVE HEADER ADJUSTMENTS */
        @media (max-width: 480px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-text {
                align-items: center;
                text-align: center;
            }
            
            .header-title {
                font-size: 1.8rem;
            }
            
            .logo-image {
                width: 70px;
                height: 70px;
            }
        }

        /* STATUS BAR */
        .status-bar {
            background: rgba(255,255,255,0.95);
            border-radius: 6px;
            padding: 15px 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-dot.offline {
            background: #ef4444;
        }

        /* TEMPLATE FILTERING */
        .template-filters {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border-color: rgba(255,255,255,0.9);
        }

        .filter-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* TEMPLATE SELECTION */
        .section {
            margin-bottom: 25px;
        }

        .section-title {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .template-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .template-card {
            background: white;
            border-radius: 6px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .template-card:active {
            transform: scale(0.95);
        }

        .template-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: scale(1.02);
        }

        .template-card[data-template="general"] {
            grid-column: 1 / -1;
        }

        .template-emoji {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .template-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .template-desc {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.3;
        }

        /* ZONE SELECTOR */
        .zone-selector {
            background: rgba(255,255,255,0.95);
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }

        .zone-title {
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: #1f2937;
        }

        .zone-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .zone-btn {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zone-btn:active {
            transform: scale(0.95);
        }

        .zone-btn.selected {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .zone-btn.all-units {
            grid-column: 1 / -1;
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .zone-btn.all-units.selected {
            background: #1d4ed8;
            border-color: #1d4ed8;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .zone-btn.special {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        /* CLEAR SELECTIONS BUTTON */
        .clear-btn {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            color: #ef4444;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: #ef4444;
            color: white;
        }

        .clear-btn:active {
            transform: scale(0.95);
        }

        /* MESSAGE COMPOSITION */
        .compose-section {
            background: rgba(255,255,255,0.95);
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }

        .compose-title {
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: #1f2937;
        }

        .message-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s;
        }

        .message-input:focus {
            border-color: #3b82f6;
        }

        .char-count {
            text-align: right;
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 8px;
        }

        .char-count.warning {
            color: #f59e0b;
        }

        .char-count.error {
            color: #ef4444;
        }

        /* SMART SEND BUTTON */
        .send-section {
            text-align: center;
        }

        .send-btn {
            background: #9ca3af;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 18px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: not-allowed;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .send-btn.template-selected {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            cursor: pointer;
        }

        .send-btn.ready-to-send {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .send-btn.ready-to-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }

        .send-btn:disabled {
            transform: none;
            box-shadow: none;
        }

        /* INDIVIDUAL UNIT SELECTOR MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 5px;
        }

        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }

        .unit-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .unit-checkbox:hover {
            border-color: #3b82f6;
        }

        .unit-checkbox.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .unit-checkbox input {
            margin: 0;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            color: #374151;
        }

        .btn-primary {
            background: #3b82f6;
            border: 2px solid #3b82f6;
            color: white;
        }

        /* NOTIFICATION POPUP */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .notification.success {
            border-left: 5px solid #10b981;
        }

        .notification.error {
            border-left: 5px solid #ef4444;
        }

        .notification.info {
            border-left: 5px solid #3b82f6;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* LOADING SPINNER */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* RESPONSIVE ADJUSTMENTS */
        @media (max-width: 400px) {
            .container {
                padding: 15px;
            }
            
            .template-grid {
                grid-template-columns: 1fr;
            }
            
            .zone-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .template-card {
                min-height: 80px;
            }
            
            .send-btn {
                width: 100%;
                min-width: auto;
            }

            .units-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
        }

        .hidden {
            display: none !important;
        }

        /* NO-EMAIL RESIDENTS MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-container {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: #fef2f2;
            border-bottom: 2px solid #fecaca;
            padding: 20px;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            color: #991b1b;
            font-size: 1.3rem;
        }

        .modal-body {
            padding: 25px;
        }

        .no-email-list {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .no-email-item {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #dc2626;
        }

        .no-email-item:last-child {
            margin-bottom: 0;
        }

        .no-email-item strong {
            display: block;
            color: #111827;
            font-size: 1.05rem;
            margin-bottom: 4px;
        }

        .no-email-item span {
            color: #6b7280;
            font-size: 0.95rem;
        }

        .no-email-warning {
            margin-top: 15px;
            padding: 12px;
            background: #fef2f2;
            border-left: 4px solid #dc2626;
            border-radius: 4px;
            color: #991b1b;
            font-weight: 600;
        }

        .modal-actions {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-btn-cancel:hover {
            background: #e5e7eb;
        }

        .modal-btn-confirm {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .modal-btn-confirm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

/* ============================================= */
        /* E-COPY DISTRIBUTION - NEW V2.4 CSS */
        /* ============================================= */

        /* E-Copy Recipients Button */
        .zone-btn.ecopy-btn {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f;
            font-weight: 600;
            grid-column: 1 / -1;
            border: 2px solid #f59e0b;
        }

        .zone-btn.ecopy-btn.selected {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-color: #d97706;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        /* Distribution List Preview */
        .distribution-preview {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid #fbbf24;
            display: none;
        }

        .distribution-preview.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .distribution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #fef3c7;
        }

        .distribution-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: #78350f;
        }

        .distribution-refresh {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
        }

        .distribution-refresh:active {
            transform: scale(0.95);
        }

        .distribution-summary {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            color: #78350f;
        }

        .distribution-summary.warning {
            background: #fef2f2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .distribution-list {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .distribution-list.collapsed {
            max-height: 120px;
        }

        .recipient-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .recipient-item.no-email {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .recipient-unit {
            font-weight: 700;
            color: #1f2937;
        }

        .recipient-name {
            color: #4b5563;
            margin: 2px 0;
        }

        .recipient-email {
            color: #3b82f6;
            font-size: 0.85rem;
        }

        .recipient-email.missing {
            color: #dc2626;
            font-weight: 600;
        }

        .distribution-actions {
            display: flex;
            gap: 10px;
        }

        .distribution-actions button {
            flex: 1;
            padding: 10px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .distribution-actions .view-all {
            color: #3b82f6;
            border-color: #3b82f6;
        }

        .distribution-actions .manage-tags {
            color: #059669;
            border-color: #059669;
        }

        /* Attachment Upload */
        .attachment-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            display: none;
        }

        .attachment-section.show {
            display: block;
        }

        .attachment-label {
            display: block;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            width: 100%;
            padding: 12px;
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .file-input::-webkit-file-upload-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
        }

        .attachment-preview {
            margin-top: 10px;
            padding: 10px;
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            display: none;
        }

        .attachment-preview.show {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .attachment-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #1e40af;
            font-size: 0.9rem;
        }

        .attachment-remove {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
        }

        @media (max-width: 480px) {
            .distribution-actions {
                flex-direction: column;
            }
        }


    </style>
</head>
<body>
    <div class="container">
        <!-- Header - Unified Design Standard with Logo -->
        <div class="header">
            <div class="header-content">
                <div class="logo-container">
            <img src="logo.png" alt="Lake Illawong Logo" class="logo-image">
        </div>
                <div class="header-text">
                    <h1 class="header-title"> Field Notifications</h1>
                    <p class="header-subtitle">Enhanced communication system</p>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
<div class="status-bar">
    <div class="status-item">
        <div class="status-dot" id="serviceDot"></div>
        <span id="serviceStatus">Email Service</span>
    </div>
    <div class="status-item">
        <span id="lastUpdate">Last: --:--</span>
    </div>
</div>

        <!-- Template Filters -->
        <div class="template-filters">
            <button class="filter-btn active" data-filter="all">All Templates</button>
            <button class="filter-btn" data-filter="general">General Purpose</button>
            <button class="filter-btn" data-filter="emergency"> Emergency</button>
        </div>

        <!-- Template Selection -->
        <div class="section">
            <div class="section-title">Quick Templates</div>
            <div class="template-grid" id="templateGrid">
                <div class="template-card" data-template="emergency" data-category="emergency">
                    <div class="template-emoji"></div>
                    <div class="template-title">Emergency</div>
                    <div class="template-desc">Urgent safety alerts</div>
                </div>
                <div class="template-card" data-template="maintenance" data-category="general">
                    <div class="template-emoji"></div>
                    <div class="template-title">Maintenance</div>
                    <div class="template-desc">Scheduled work</div>
                </div>
                <div class="template-card" data-template="outage" data-category="general">
                    <div class="template-emoji"></div>
                    <div class="template-title">Outage</div>
                    <div class="template-desc">Service disruptions</div>
                </div>
                <div class="template-card" data-template="announcement" data-category="general">
                    <div class="template-emoji"></div>
                    <div class="template-title">Announcement</div>
                    <div class="template-desc">General notices</div>
                </div>
                <div class="template-card" data-template="general" data-category="general">
                    <div class="template-emoji"></div>
                    <div class="template-title">General</div>
                    <div class="template-desc">Custom message</div>
                </div>
            </div>
        </div>

        <!-- Zone Selection -->
        <div class="zone-selector">
            <div class="zone-title">Select Notification Zones</div>
            <div class="zone-grid">
                <button class="zone-btn all-units" data-zone="all">All Units</button>
                <button class="zone-btn" data-zone="zone1">Zone 1 (1-8)</button>
                <button class="zone-btn" data-zone="zone2">Zone 2 (9-20)</button>
                <button class="zone-btn" data-zone="zone3">Zone 3 (21-28)</button>
                <button class="zone-btn" data-zone="zone4">Zone 4 (29-36)</button>
                <button class="zone-btn" data-zone="zone5">Zone 5 (37-44)</button>
<button class="zone-btn ecopy-btn" data-zone="ecopy" onclick="selectZone('ecopy')">ðŸ“§ E-Copy Recipients</button>
<button class="zone-btn special" onclick="openUnitSelector()">ðŸ”¢ Select Individual Units</button>
            </div>

<!-- E-Copy Distribution List Preview -->
<div class="distribution-preview" id="distributionPreview">
    <div class="distribution-header">
        <div class="distribution-title">ðŸ“‹ E-Copy Distribution List</div>
        <button class="distribution-refresh" onclick="loadECopyList()">ðŸ”„ Refresh</button>
    </div>
    
    <div class="distribution-summary" id="distributionSummary">
        <div style="color: #6b7280;">Loading recipients...</div>
    </div>
    
    <div class="distribution-list" id="distributionList">
        <!-- Recipients loaded here -->
    </div>
    
    <div class="distribution-actions">
        <button class="view-all" onclick="toggleFullList()">
            <span id="viewAllText">View All</span>
        </button>
        <button class="manage-tags" onclick="openManagementCentral()">
            Manage Tags â†’
        </button>
    </div>
</div>

<!-- Attachment Upload Section -->
<div class="attachment-section" id="attachmentSection">
    <label class="attachment-label">ðŸ“Ž Attach Document (Optional)</label>
    <div class="file-input-wrapper">
        <input type="file" 
               id="attachmentInput" 
               class="file-input" 
               accept=".pdf,.doc,.docx"
               onchange="handleAttachment(event)">
    </div>
    <div class="attachment-preview" id="attachmentPreview">
        <div class="attachment-info">
            <span>ðŸ“„</span>
            <span id="attachmentName"></span>
        </div>
        <button class="attachment-remove" onclick="removeAttachment()">Remove</button>
    </div>
</div>
            
            <!-- Clear Selections Button -->
            <div style="text-align: center; margin-top: 15px;">
                <button class="clear-btn" onclick="clearAllSelections()">
                     Clear Selections
                </button>
            </div>
        </div>

        <!-- Message Composition -->
        <div class="compose-section">
            <div class="compose-title">Compose Message</div>
            <textarea 
                class="message-input" 
                id="messageText" 
                placeholder="Select a template or enter your custom message here..."
                maxlength="500"></textarea>
            <div class="char-count" id="charCount">0/500 characters</div>
        </div>

        <!-- Smart Send Button -->
        <div class="send-section">
            <button class="send-btn" id="sendBtn" disabled>
                Select Template
            </button>
        </div>
    </div>


    <!-- Individual Unit Selector Modal -->
    <div id="unitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Select Individual Units</h2>
                <button class="close-btn" onclick="closeUnitSelector()">&times;</button>
            </div>
            
            <div class="units-grid" id="unitsGrid">
                <!-- Units 1-44 will be generated here -->
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="clearAllUnits()">Clear All</button>
                <button class="btn btn-secondary" onclick="selectAllUnits()">Select All</button>
                <button class="btn btn-primary" onclick="confirmUnitSelection()">Confirm Selection</button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================================
        // CONFIGURATION - UPDATE WITH YOUR EMAIL SERVER URL
        // =====================================================================
        
        // Email Server V1.0.js deployment URL
        // const EMAIL_SERVICE_URL = 'https://script.google.com/macros/s/AKfycbxWll0dkVYKZcy5yMFvwPPVUKOuQNTb6wBF-kTjBWdVH7CJ-dc552-fBGYda7nN5LMk/exec';

// Email Server V2.0.js deployment URL
       // const EMAIL_SERVICE_URL = 'https://script.google.com/macros/s/AKfycbxY6l7p9syqTYlYEER1kMwQXXND8o-34QQ4dlEQwTqxuke3j0TaXrnMw5rB3_ro0WJf/exec';

// Email Server V2.3.5.js deployment URL
        const EMAIL_SERVICE_URL = 'https://script.google.com/macros/s/AKfycbxvmGKhKlMHqICEpfXvQhoN5RoE-F1YEO6UsDqOGWhs55lLn44QN-ZTLWCLg__Fv6N-/exec';

        
        // Global state
        let selectedTemplate = null;
        let selectedZones = [];
        let selectedUnits = [];

let ecopyRecipients = [];
let showFullList = false;
let attachmentData = null;
let attachmentFilename = null;

        
        let currentFilter = 'all';
        
        // =====================================================================
        // INITIALIZATION
        // =====================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            generateUnitsGrid();
            
            // updateEmailCounter(); // Function doesn't exist - commented out
            checkServiceStatus();
        });
        
        // =====================================================================
        // EVENT LISTENERS
        // =====================================================================
        
        function setupEventListeners() {
            // Template selection
            document.querySelectorAll('.template-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectTemplate(this.dataset.template);
                });
            });
            
            // Zone selection
            document.querySelectorAll('.zone-btn').forEach(btn => {
                if (!btn.onclick) { // Don't override the special button
                    btn.addEventListener('click', function() {
                        selectZone(this.dataset.zone);
                    });
                }
            });
            
            // Template filtering
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    setTemplateFilter(this.dataset.filter);
                });
            });
            
            // Character counter
            const messageInput = document.getElementById('messageText');
            messageInput.addEventListener('input', updateCharCount);
            
            // Send button
            document.getElementById('sendBtn').addEventListener('click', sendNotification);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                    selectTemplate('emergency');
                    showNotification('Emergency template selected', 'info');
                }
                if (e.ctrlKey && e.key === '?') {
                    showNotification('Shortcuts: Ctrl+Shift+E (Emergency)', 'info');
                }
            });
        }
        
        // =====================================================================
        // TEMPLATE MANAGEMENT
        // =====================================================================
        
        function selectTemplate(templateType) {
            selectedTemplate = templateType;
            
            // Update visual selection
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-template="${templateType}"]`).classList.add('selected');
            
            // Load template message
            loadTemplate(templateType);
            updateSendButton();
        }
        
        function setTemplateFilter(filter) {
            currentFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            
            // Filter templates
            document.querySelectorAll('.template-card').forEach(card => {
                const category = card.dataset.category;
                const show = filter === 'all' || category === filter;
                card.style.display = show ? 'flex' : 'none';
            });
        }
        
        function loadTemplate(type) {
            const templates = {
                emergency: " EMERGENCY ALERT \n\nImmediate action required. Please follow safety protocols and contact management if needed.\n\nTime: [TIME]\nLake Illawong Management",
                maintenance: " MAINTENANCE NOTICE\n\nScheduled maintenance work will be performed.\n\nDetails: [DETAILS]\nDuration: [TIME]\nAffected areas: [AREAS]\n\nLake Illawong Maintenance",
                outage: " SERVICE OUTAGE\n\nWe are experiencing a service disruption.\n\nAffected service: [SERVICE]\nEstimated restoration: [TIME]\n\nWe apologize for any inconvenience.\nLake Illawong Management",
                announcement: " COMMUNITY ANNOUNCEMENT\n\n[YOUR MESSAGE HERE]\n\nThank you,\nLake Illawong Management",
                general: " GENERAL NOTICE\n\n[YOUR MESSAGE HERE]\n\nPlease contact management if you have any questions.\n\nRegards,\nLake Illawong Management"
            };
            
            if (templates[type]) {
                const messageInput = document.getElementById('messageText');
                messageInput.value = templates[type];
                updateCharCount();
            }
        }
        
        // =====================================================================
        // ZONE MANAGEMENT
        // =====================================================================
        function selectZone(zone) {
    if (zone === 'all') {
        // All units selected - deselect others
        selectedZones = ['all'];
        selectedUnits = [];
        document.querySelectorAll('.zone-btn').forEach(btn => {
            btn.classList.toggle('selected', btn.dataset.zone === 'all');
        });
    } else if (zone === 'ecopy') {
        // E-Copy Recipients - exclusive selection
        const allBtn = document.querySelector('[data-zone="all"]');
        allBtn.classList.remove('selected');
        
        // Clear all other zones
        document.querySelectorAll('.zone-btn').forEach(btn => {
            if (btn.dataset.zone && btn.dataset.zone !== 'ecopy') {
                btn.classList.remove('selected');
            }
        });
        
        const btn = document.querySelector('[data-zone="ecopy"]');
        const preview = document.getElementById('distributionPreview');
        const attachmentSection = document.getElementById('attachmentSection');
        
        if (selectedZones.includes('ecopy')) {
            // Deselect E-Copy
            selectedZones = [];
            btn.classList.remove('selected');
            if (preview) preview.classList.remove('show');
            if (attachmentSection) attachmentSection.classList.remove('show');
        } else {
            // Select E-Copy
            selectedZones = ['ecopy'];
            selectedUnits = [];
            btn.classList.add('selected');
            if (preview) {
                preview.classList.add('show');
                loadECopyList();
            }
            if (attachmentSection) attachmentSection.classList.add('show');
        }
    } else {
        // Individual zone selected
        const allBtn = document.querySelector('[data-zone="all"]');
        allBtn.classList.remove('selected');
        
        // Clear E-Copy if selected
        const ecopyBtn = document.querySelector('[data-zone="ecopy"]');
        if (ecopyBtn) {
            ecopyBtn.classList.remove('selected');
        }
        selectedZones = selectedZones.filter(z => z !== 'ecopy');
        
        // Hide E-Copy sections
        const preview = document.getElementById('distributionPreview');
        const attachmentSection = document.getElementById('attachmentSection');
        if (preview) preview.classList.remove('show');
        if (attachmentSection) attachmentSection.classList.remove('show');
        
        const btn = document.querySelector(`[data-zone="${zone}"]`);
        btn.classList.toggle('selected');
        
        if (btn.classList.contains('selected')) {
            if (!selectedZones.includes(zone)) {
                selectedZones = selectedZones.filter(z => z !== 'all');
                selectedZones.push(zone);
            }
        } else {
            selectedZones = selectedZones.filter(z => z !== zone);
        }
        
        // If no zones selected, default to all
        if (selectedZones.length === 0) {
            allBtn.classList.add('selected');
            selectedZones = ['all'];
        }
        
        selectedUnits = []; // Clear individual selections
    }
    
    updateSendButton();
}
        
        // =====================================================================
        // INDIVIDUAL UNIT SELECTION
        // =====================================================================
        
        function openUnitSelector() {
            document.getElementById('unitModal').classList.add('show');
        }
        
        function closeUnitSelector() {
            document.getElementById('unitModal').classList.remove('show');
        }
        
        function generateUnitsGrid() {
            const grid = document.getElementById('unitsGrid');
            for (let i = 1; i <= 44; i++) {
                const unitDiv = document.createElement('div');
                unitDiv.className = 'unit-checkbox';
                unitDiv.innerHTML = `
                    <input type="checkbox" id="unit${i}" value="${i}">
                    <label for="unit${i}">Unit ${i}</label>
                `;
                unitDiv.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = this.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                    }
                    this.classList.toggle('selected', this.querySelector('input').checked);
                });
                grid.appendChild(unitDiv);
            }
        }
        
        function selectAllUnits() {
            document.querySelectorAll('#unitsGrid input').forEach(input => {
                input.checked = true;
                input.closest('.unit-checkbox').classList.add('selected');
            });
        }
        
        function clearAllUnits() {
            document.querySelectorAll('#unitsGrid input').forEach(input => {
                input.checked = false;
                input.closest('.unit-checkbox').classList.remove('selected');
            });
        }
        
        function confirmUnitSelection() {
            selectedUnits = Array.from(document.querySelectorAll('#unitsGrid input:checked')).map(input => input.value);
            
            if (selectedUnits.length > 0) {
                // Clear zone selections
                selectedZones = [];
                document.querySelectorAll('.zone-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            }
            
            closeUnitSelector();
            updateSendButton();
        }
        
        // =====================================================================
        // SMART BUTTON MANAGEMENT
        // =====================================================================
        
        function updateSendButton() {
            const sendBtn = document.getElementById('sendBtn');
            
            // Reset classes
            sendBtn.classList.remove('template-selected', 'ready-to-send');
            
            if (!selectedTemplate) {
                sendBtn.textContent = 'Select Template';
                sendBtn.disabled = true;
            } else if (selectedZones.length === 0 && selectedUnits.length === 0) {
                sendBtn.textContent = 'Select Zone or Units';
                sendBtn.disabled = true;
                sendBtn.classList.add('template-selected');
            } else {
                const templateName = getTemplateName(selectedTemplate);
                const targetText = getTargetText();
                sendBtn.textContent = `Send ${templateName} to ${targetText}`;
                sendBtn.disabled = false;
                sendBtn.classList.add('ready-to-send');
            }
        }
        
        function getTemplateName(template) {
            const names = {
                'emergency': 'Emergency',
                'maintenance': 'Maintenance',
                'outage': 'Outage',
                'announcement': 'Announcement',
                'general': 'General'
            };
            return names[template] || 'Message';
        }
        
        function getTargetText() {
            if (selectedUnits.length > 0) {
                if (selectedUnits.length === 1) return `Unit ${selectedUnits[0]}`;
                if (selectedUnits.length <= 3) return selectedUnits.map(u => `Unit ${u}`).join(', ');
                return `${selectedUnits.length} units`;
            }
            
            if (selectedZones.includes('all')) return 'All Units';
            if (selectedZones.includes('ecopy')) return 'E-Copy Recipients';
            
            // Map zone codes to display names
            const zoneNames = {
                'zone1': 'Zone 1',
                'zone2': 'Zone 2', 
                'zone3': 'Zone 3',
                'zone4': 'Zone 4',
                'zone5': 'Zone 5'
            };
            
            if (selectedZones.length === 1) {
                return zoneNames[selectedZones[0]] || selectedZones[0];
            }
            if (selectedZones.length <= 3) {
                return selectedZones.map(z => zoneNames[z] || z).join(', ');
            }
            return `${selectedZones.length} zones`;
        }
        
       
        
        // =====================================================================
        // CHARACTER COUNTER
        // =====================================================================
        
        function updateCharCount() {
            const messageInput = document.getElementById('messageText');
            const charCount = document.getElementById('charCount');
            const length = messageInput.value.length;
            
            charCount.textContent = `${length}/500 characters`;
            charCount.className = 'char-count';
            if (length > 400) charCount.classList.add('warning');
            if (length > 450) charCount.classList.add('error');
        }
        
        // =====================================================================
        // EMAIL SERVER V1.0.JS INTEGRATION
        // =====================================================================
        
        // Main send function called by Send button
        async function sendNotification() {
            const message = document.getElementById('messageText').value.trim();
            
            if (!message) {
                showNotification('Please enter a message', 'error');
                return;
            }
            
            // E-Copy sends skip the no-email check
            if (selectedZones.includes('ecopy')) {
                console.log('ðŸ“§ E-Copy send - proceeding directly');
                await executeSend();
                return;
            }
            
            // For regular sends, check for residents without email
            try {
                const recipientFilter = buildRecipientFilter();
                const response = await callEmailAPI('getNoEmailResidents', {
                    recipientFilter: recipientFilter
                });
                
                if (response.success && response.residents && response.residents.length > 0) {
                    // Show warning modal
                    showNoEmailModal(response.residents);
                } else {
                    // No residents without email, proceed
                    console.log('âœ… All recipients have email. Proceeding to send.');
                    await executeSend();
                }
            } catch (error) {
                console.error('Error checking no-email residents:', error);
                showNotification('âš ï¸ Could not verify email status. Proceeding to send.', 'info');
                await executeSend();
            }
        }
        
        async function executeSend() {
    const sendBtn = document.getElementById('sendBtn');
    const originalText = sendBtn.innerHTML;
    const message = document.getElementById('messageText').value.trim();
    
    // Show loading state
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner"></span>Sending...';
    
    try {
        // Prepare recipient filter
        const recipientFilter = buildRecipientFilter();
        
        // Prepare API call parameters
        const customData = {
            message: message,
            subject: 'Field Notification - ' + getTemplateName(selectedTemplate),
            body: message,
            timestamp: new Date().toLocaleString(),
            templateType: selectedTemplate,
            fieldAlert: true
        };
        
        // NEW: Add attachment if present
        if (attachmentData && attachmentFilename) {
            customData.attachment = {
                filename: attachmentFilename,
                data: attachmentData,
                mimeType: getMimeType(attachmentFilename)
            };
        }
        
        console.log('Sending notification with params:', {
            recipientFilter: recipientFilter,
            hasAttachment: !!attachmentData,
            selectedTemplate: selectedTemplate,
            selectedZones: selectedZones,
            selectedUnits: selectedUnits
        });
        
        // Call Email Server
        const response = await callEmailAPI('sendMassNotification', {
            templateId: 'WATER01',
            customData: JSON.stringify(customData),
            recipientFilter: recipientFilter,
            adminUser: 'FieldOperations'
        });
        
        console.log('Email API response:', response);
        
        if (response.success) {
            const targetText = getTargetText();
            const recipientCount = response.recipientCount || calculateRecipientCount();
            showNotification(getTemplateName(selectedTemplate) + ' sent to ' + targetText + '! (' + recipientCount + ' recipients)', 'success');
            
            // Reset form
            resetForm();
        } else {
            throw new Error(response.error || 'Failed to send notification');
        }
        
    } catch (error) {
        console.error('Send error:', error);
        showNotification('Failed to send notification: ' + error.message, 'error');
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
    }
}

function getMimeType(filename) {
    const ext = filename.substring(filename.lastIndexOf('.')).toLowerCase();
    const mimeTypes = {
        '.pdf': 'application/pdf',
        '.doc': 'application/msword',
        '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    };
    return mimeTypes[ext] || 'application/octet-stream';
}

        
        function showNoEmailModal(residents) {
            console.log('showNoEmailModal called with:', residents);
            console.log('Number of residents:', residents ? residents.length : 'undefined');
            
            const modal = document.getElementById('noEmailModal');
            const listContainer = document.getElementById('noEmailList');
            
            // Build list HTML
            listContainer.innerHTML = residents.map(function(resident) {
                console.log('Processing resident:', resident);
                return '<div class="no-email-item">' +
                    '<strong>' + resident.name + '</strong>' +
                    '<span>' + resident.unit + ' - ' + resident.phone + '</span>' +
                    '</div>';
            }).join('');
            
            console.log('List HTML:', listContainer.innerHTML);
            
            // Show modal
            modal.classList.remove('hidden');
        }
        
        function cancelSend() {
            const modal = document.getElementById('noEmailModal');
            modal.classList.add('hidden');
            showNotification('Send cancelled', 'info');
        }
        
        async function confirmAndSend() {
            const modal = document.getElementById('noEmailModal');
            modal.classList.add('hidden');
            
            // User confirmed they'll contact residents - proceed with send
            await executeSend();
        }
        
        
        function callEmailAPI(action, params) {
            // Check if payload is too large for GET (attachments)
            const paramsJSON = JSON.stringify(params);
            const payloadSize = paramsJSON.length;
            const hasLargePayload = payloadSize > 1500; // URL limit safety threshold
            
            if (hasLargePayload) {
                // Use POST for large payloads (with attachments)
                console.log(`ðŸ“¦ Large payload detected (${payloadSize} chars) - using POST`);
                return callEmailAPI_POST(action, params);
            } else {
                // Use JSONP (GET) for small payloads
                console.log(`ðŸ“¨ Small payload (${payloadSize} chars) - using JSONP GET`);
                return callEmailAPI_JSONP(action, params);
            }
        }
        
        // JSONP method for small payloads (original method)
        function callEmailAPI_JSONP(action, params) {
            return new Promise((resolve, reject) => {
                const callbackName = 'emailCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(response) {
                    resolve(response);
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                const url = new URL(EMAIL_SERVICE_URL);
                url.searchParams.append('action', action);
                url.searchParams.append('callback', callbackName);
                
                Object.keys(params).forEach(key => {
                    url.searchParams.append(key, params[key]);
                });
                
                script.src = url.toString();
                script.onerror = () => {
                    reject(new Error('Network error - check Email Server URL'));
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                document.head.appendChild(script);
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        reject(new Error('Request timeout'));
                        document.head.removeChild(script);
                        delete window[callbackName];
                    }
                }, 30000);
            });
        }
        
        // POST method for large payloads (attachments) - CORS-friendly with JSONP callback
        function callEmailAPI_POST(action, params) {
            return new Promise((resolve, reject) => {
                // Create unique callback name
                const callbackName = 'emailCallback_' + Date.now();
                
                // Set up global callback function
                window[callbackName] = function(response) {
                    console.log('ðŸ“¥ POST callback received:', response);
                    
                    // Cleanup
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                    delete window[callbackName];
                    clearTimeout(timeoutId);
                    
                    resolve(response);
                };
                
                // Create hidden iframe to receive response
                const iframeName = 'emailPostFrame_' + Date.now();
                const iframe = document.createElement('iframe');
                iframe.name = iframeName;
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                
                // Create hidden form
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = EMAIL_SERVICE_URL;
                form.target = iframeName;
                form.style.display = 'none';
                
                // Create form fields including callback parameter
                const postData = {
                    action: action,
                    callback: callbackName,  // Add callback for JSONP response
                    ...params
                };
                
                // Add each field to form
                Object.keys(postData).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = typeof postData[key] === 'object' ? JSON.stringify(postData[key]) : postData[key];
                    form.appendChild(input);
                });
                
                document.body.appendChild(form);
                
                // Set timeout
                const timeoutId = setTimeout(() => {
                    if (window[callbackName]) {
                        document.body.removeChild(form);
                        document.body.removeChild(iframe);
                        delete window[callbackName];
                        reject(new Error('Request timeout (60s)'));
                    }
                }, 60000);
                
                // Submit form
                console.log('ðŸ“¤ Submitting POST via hidden form with JSONP callback...');
                form.submit();
            });
        }
        
        function buildRecipientFilter() {
    // Handle E-Copy role-based sending
    if (selectedZones.includes('ecopy')) {
        return 'role:E-Copy';
    }


            if (selectedUnits.length > 0) {
                // Send individual units with "Unit " prefix to match UnitList format
                const unitsList = selectedUnits.map(unit => `Unit ${unit}`).join(',');
                console.log('Individual units selected:', selectedUnits);
                return `units:${unitsList}`;
            }
            
            if (selectedZones.includes('all')) {
                return 'all_units';
            }
            
            // Map our zones to Email Server format
            if (selectedZones.length === 1) {
                const zoneMap = {
                    'zone1': 'zone_1',
                    'zone2': 'zone_2', 
                    'zone3': 'zone_3',
                    'zone4': 'zone_4',
                    'zone5': 'zone_5'
                };
                return zoneMap[selectedZones[0]] || 'all_units';
            }
            
            // Multiple zones - Email Server V1.0.js doesn't support multiple zones yet
            // Default to all units for now
            console.log('Multiple zones selected:', selectedZones);
            showNotification('Multiple zone targeting coming soon. Sending to all units.', 'info');
            return 'all_units';
        }
        
        function calculateRecipientCount() {
  if (selectedUnits.length > 0) {
    // For individual units, we can't predict exact count since some units have 1 resident, some have 2
    // The actual count will come from the Email Server response
    return selectedUnits.length * 2; // Rough estimate
  }
  
  if (selectedZones.includes('all')) {
    // This will be the actual count from getAllUnitRecipients()
    return 50; // Rough estimate based on your data
  }
  
  // Estimate based on zones
  let unitCount = 0;
  selectedZones.forEach(zone => {
    switch(zone) {
      case 'zone1': unitCount += 8; break;  // Units 1-8
      case 'zone2': unitCount += 12; break; // Units 9-20
      case 'zone3': unitCount += 8; break;  // Units 21-28
      case 'zone4': unitCount += 8; break;  // Units 29-36
      case 'zone5': unitCount += 8; break;  // Units 37-44
      default: unitCount += 1;
    }
  });
  
  // Rough estimate: average 1.5 residents per unit
  return Math.round(unitCount * 1.5);
}
        
        // =====================================================================
        // SERVICE STATUS MONITORING
        // =====================================================================
        
        async function checkServiceStatus() {
            const serviceDot = document.getElementById('serviceDot');
            const serviceStatus = document.getElementById('serviceStatus');
            
            if (EMAIL_SERVICE_URL === 'YOUR_EMAIL_SERVER_V1_URL_HERE') {
                serviceDot.classList.add('offline');
                serviceStatus.textContent = 'Not Configured';
                return;
            }
            
            try {
                // Test connection to Email Server
                const response = await callEmailAPI('checkEmailQuota', {});
                
                if (response.success) {
                    serviceDot.classList.remove('offline');
                    serviceStatus.textContent = 'Email Service';
                } else {
                    serviceDot.classList.add('offline');
                    serviceStatus.textContent = 'Service Error';
                }
            } catch (error) {
                serviceDot.classList.add('offline');
                serviceStatus.textContent = 'Service Offline';
                console.error('Service check failed:', error);
            }
            
            updateLastUpdateTime();
        }
        
        function updateLastUpdateTime() {
            const lastUpdate = document.getElementById('lastUpdate');
            const now = new Date();
            lastUpdate.textContent = `Last: ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        }
        
        // =====================================================================
        // UTILITY FUNCTIONS
        // =====================================================================
        
        function clearAllSelections() {
            // Clear state variables
            selectedTemplate = null;
            selectedZones = [];
            selectedUnits = [];
            
            // Clear template selections
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Clear zone selections
            document.querySelectorAll('.zone-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Clear individual unit selections
            document.querySelectorAll('#unitsGrid input').forEach(input => {
                input.checked = false;
                input.closest('.unit-checkbox').classList.remove('selected');
            });
            
            // Clear message text
            const messageInput = document.getElementById('messageText');
            messageInput.value = '';
            messageInput.placeholder = 'Select a template or enter your custom message here...';
            updateCharCount();
            
            // Update send button
            updateSendButton();
            
            // Show confirmation
            showNotification('All selections cleared', 'success');
        }
        
        function resetForm() {
            // Clear selections
            selectedTemplate = null;
            selectedZones = [];
            selectedUnits = [];
            
            // Clear visual selections
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll('.zone-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Clear individual unit selections
            document.querySelectorAll('#unitsGrid input').forEach(input => {
                input.checked = false;
                input.closest('.unit-checkbox').classList.remove('selected');
            });
            
            // Clear message
            const messageInput = document.getElementById('messageText');
            messageInput.value = '';
            updateCharCount();
            
            // Update button
            updateSendButton();
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

// =====================================================================
// E-COPY DISTRIBUTION LIST
// =====================================================================

async function loadECopyList() {
    console.log('ðŸ“‹ Loading E-Copy distribution list...');
    
    const summaryDiv = document.getElementById('distributionSummary');
    const listDiv = document.getElementById('distributionList');
    
    summaryDiv.innerHTML = '<div style="color: #6b7280;">ðŸ”„ Loading recipients...</div>';
    listDiv.innerHTML = '';
    
    try {
        const response = await callEmailAPI('getECopyRecipients', {});
        
        if (response.success) {
            ecopyRecipients = response.recipients || [];
            displayECopyList();
        } else {
            summaryDiv.className = 'distribution-summary warning';
            summaryDiv.innerHTML = 'âŒ Error loading recipients';
            showNotification('Failed to load E-Copy recipients', 'error');
        }
    } catch (error) {
        console.error('Error loading E-Copy list:', error);
        summaryDiv.className = 'distribution-summary warning';
        summaryDiv.innerHTML = 'âŒ Connection error';
        showNotification('Failed to connect to server', 'error');
    }
}

function displayECopyList() {
    const summaryDiv = document.getElementById('distributionSummary');
    const listDiv = document.getElementById('distributionList');
    
    const total = ecopyRecipients.length;
    const missingEmails = ecopyRecipients.filter(r => !r.email || r.email.trim() === '');
    
    // Update summary
    if (missingEmails.length > 0) {
        summaryDiv.className = 'distribution-summary warning';
        summaryDiv.innerHTML = `
            <div>âœ… ${total - missingEmails.length} recipients with email</div>
            <div>âš ï¸ ${missingEmails.length} missing email address</div>
        `;
    } else {
        summaryDiv.className = 'distribution-summary';
        summaryDiv.innerHTML = `âœ… ${total} recipients found`;
    }
    
    // Display list
    const displayCount = showFullList ? ecopyRecipients.length : Math.min(3, ecopyRecipients.length);
    listDiv.className = showFullList ? 'distribution-list' : 'distribution-list collapsed';
    
    let html = '';
    for (let i = 0; i < displayCount; i++) {
        const r = ecopyRecipients[i];
        const hasEmail = r.email && r.email.trim() !== '';
        
        html += `
            <div class="recipient-item ${hasEmail ? '' : 'no-email'}">
                <div class="recipient-unit">Unit ${r.unit}</div>
                <div class="recipient-name">${escapeHtml(r.name)}</div>
                <div class="recipient-email ${hasEmail ? '' : 'missing'}">
                    ${hasEmail ? escapeHtml(r.email) : 'âš ï¸ NO EMAIL ADDRESS'}
                </div>
            </div>
        `;
    }
    
    if (!showFullList && ecopyRecipients.length > 3) {
        html += `
            <div style="text-align: center; padding: 10px; color: #6b7280; font-size: 0.9rem;">
                ... ${ecopyRecipients.length - 3} more
            </div>
        `;
    }
    
    listDiv.innerHTML = html;
    
    // Update button
    const viewAllBtn = document.getElementById('viewAllText');
    if (ecopyRecipients.length <= 3) {
        viewAllBtn.parentElement.style.display = 'none';
    } else {
        viewAllBtn.parentElement.style.display = 'block';
        viewAllBtn.textContent = showFullList ? 'Show Less' : `View All (${ecopyRecipients.length})`;
    }
}

function toggleFullList() {
    showFullList = !showFullList;
    displayECopyList();
}

function openManagementCentral() {
    const url = 'https://maintenanceportal2025.github.io/maintenance-portal/ManagementCentral.html';
    window.open(url, '_blank');
    showNotification('Opening Management Central...', 'info');
}

// =====================================================================
// ATTACHMENT HANDLING
// =====================================================================

function handleAttachment(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    const validTypes = ['.pdf', '.doc', '.docx'];
    const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
    if (!validTypes.includes(fileExt)) {
        showNotification('Please select a PDF, DOC, or DOCX file', 'error');
        event.target.value = '';
        return;
    }
    
    // Validate file size (5MB limit)
    if (file.size > 5 * 1024 * 1024) {
        showNotification('File too large. Maximum size is 5MB', 'error');
        event.target.value = '';
        return;
    }
    
    // Read file as base64
    const reader = new FileReader();
    reader.onload = function(e) {
        attachmentData = e.target.result.split(',')[1]; // Get base64 data
        attachmentFilename = file.name;
        
        // Show preview
        document.getElementById('attachmentName').textContent = file.name;
        document.getElementById('attachmentPreview').classList.add('show');
        
        showNotification('Attachment added: ' + file.name, 'success');
    };
    reader.readAsDataURL(file);
}

function removeAttachment() {
    attachmentData = null;
    attachmentFilename = null;
    document.getElementById('attachmentInput').value = '';
    document.getElementById('attachmentPreview').classList.remove('show');
    showNotification('Attachment removed', 'info');
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, m => map[m]);
}

        
        // =====================================================================
        // PERIODIC UPDATES
        // =====================================================================
        
        // Check service status every 2 minutes
        setInterval(checkServiceStatus, 120000);
        
        // Update timestamp every 30 seconds
        setInterval(updateLastUpdateTime, 30000);
    </script>

    <!-- NO-EMAIL RESIDENTS REMINDER MODAL -->
    <div id="noEmailModal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header">
                <h2>WARNING: Residents Without Email</h2>
            </div>
            <div class="modal-body">
                <p style="font-weight: 600; margin-bottom: 10px;">
                    The following residents do NOT have email and will NOT receive this alert:
                </p>
                
                <div id="noEmailList" class="no-email-list">
                    <!-- Populated dynamically from backend -->
                </div>
                
                <div class="no-email-warning">
                    WARNING: You must contact these residents separately by phone.
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="cancelSend()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmAndSend()">I'll Contact Them</button>
            </div>
        </div>
    </div>

</body>
</html>
