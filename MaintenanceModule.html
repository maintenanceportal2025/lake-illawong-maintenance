<!--
=====================================================================
ğŸ”§ MaintenanceModule.html - CORE STAFF MANAGEMENT INTERFACE - new version
=====================================================================

ğŸ”„ WORKFLOW PROCESS:
1. **Before ANY change**: Copy current file to backup folder
2. **Make change**: Update the file
3. **Update header**: Increment version, add to VERSION HISTORY
4. **Document change**: Note what was modified

ğŸ¯ VERSION NUMBERING:
â€¢ **Major.Minor.Patch** (e.g., v1.2.3)
â€¢ **Major**: Big functionality changes
â€¢ **Minor**: Feature additions
â€¢ **Patch**: Bug fixes, documentation updates

This gives you instant rollback capability and change tracking!

ğŸ“‹ DOCUMENT INFORMATION:
â€¢ File Name: MaintenancePortal.html
â€¢ System: Lake Illawong Maintenance Portal (Production)
â€¢ Component Type: Core Staff Management Interface
â€¢ **FRONTEND FILE VERSION: v1.0.0** (This HTML file version)
â€¢ **BACKEND SCRIPT VERSION: V1.0** (MaintenancePortal V1.0.js)
â€¢ Status: âœ… PRODUCTION (Unified System Integration)
â€¢ Created: September 2025
â€¢ Last Modified: September 13, 2025
â€¢ Backup Location: MyDrive/MaintenancePortal/Backups/maintenance-portal/

ğŸ“Š FRONTEND VERSION HISTORY:
â€¢ v1.0.0 (Sep 6, 2025): Production reset - Unified system integration, removed authentication complexity

ğŸ”— BACKEND CONNECTION:
â€¢ **CURRENTLY CONNECTS TO**: MaintenancePortal V1.0.js
â€¢ **INTEGRATION STATUS**: Unified with Contact Manager and Resident Systems
â€¢ **NOTE**: All components reset to V1.0 for production simplicity

ğŸ”„ BACKUP PROTOCOL:
â€¢ Before ANY changes: Copy to MyDrive/MaintenancePortal/Backups/maintenance-portal/v[X.X.X]_[Date]/
â€¢ Update version number in header after changes
â€¢ Document what changed in VERSION HISTORY
â€¢ Keep last 3 versions minimum for rollback

ğŸ¯ PRIMARY PURPOSE:
Core staff interface for maintenance problem management and workflow operations.
Provides streamlined access for maintenance coordinators and property managers
to view, edit, update, assign, and track all maintenance problems across the village.

ğŸ”— SYSTEM CONNECTIONS:
â€¢ Backend API: MaintenancePortal V1.0.js (unified staff management API)
â€¢ Authentication: Simplified password protection (maint2025)
â€¢ Data Source: FaultLog sheet (comprehensive problem database)
â€¢ Email Integration: Auto-completion notifications via V1.0 backend
â€¢ Dropdown Management: Connects to Maintenance tab for dynamic options
â€¢ Integration: Part of unified Lake Illawong management system

âš™ï¸ TECHNICAL SPECIFICATIONS:
â€¢ Technology: HTML5 + CSS3 + Vanilla JavaScript
â€¢ Design: Mobile-first staff interface with priority-based workflow
â€¢ Authentication: Simple password protection for staff access
â€¢ Dependencies: Maintenance Portal API V1.0
â€¢ Browser Support: Modern mobile and desktop browsers
â€¢ URL Parameters: Direct problem linking support (?pid=XXX)
â€¢ API Protocol: JSONP with callback support for cross-origin compatibility

ğŸ¨ UI/UX FEATURES:
â€¢ Login Protection: Password authentication with session management
â€¢ Priority Dashboard: Color-coded problem cards by priority level
â€¢ Search & Filter: Real-time search with priority and status filtering
â€¢ Problem Cards: Touch-friendly cards with visual priority indicators
â€¢ Detail Views: Comprehensive problem detail and editing interface
â€¢ Dropdown Editing: Dynamic dropdown selectors for all problem fields
â€¢ Activity Timeline: Complete change history and audit trail
â€¢ Report Generation: Professional PDF-style reporting with copy/print
â€¢ Mobile Optimization: Touch targets, responsive layout, field work friendly

ğŸ”„ WORKFLOW:
1. Authentication: Staff login with maintenance portal password
2. Problem Overview: Browse problems with priority-based visual organization
3. Search & Filter: Find specific problems using search and filter tools
4. Problem Selection: Click problem cards to access detail view
5. Field Editing: Update status, priority, category, assignments using dropdowns
6. Save Changes: Commit updates to backend (triggers completion automation)
7. Activity Tracking: View complete change history and user actions
8. Report Generation: Create professional reports for management/records
9. Email Notifications: Automatic completion notifications to relevant parties

ğŸ“Š DATA MANAGEMENT:
â€¢ Problem Storage: Comprehensive FaultLog with all problem details
â€¢ Activity Logging: Complete audit trail of all changes and actions
â€¢ Contact Integration: Links to unified contact management system
â€¢ Email Automation: Smart notifications based on problem status and zone
â€¢ Dropdown Management: Dynamic categories and options from backend
â€¢ Search Capability: Full-text search across all problem fields

ğŸ”§ MAINTENANCE FEATURES:
â€¢ Problem Lifecycle: Complete tracking from submission to completion
â€¢ Priority Management: Visual priority indicators and filtering
â€¢ Status Tracking: Clear status progression and completion automation
â€¢ Assignment Management: Dynamic assignment to maintenance team members
â€¢ Category Organization: Hierarchical categorization with sub-categories
â€¢ Timeline Display: Chronological activity log with user attribution
â€¢ Completion Automation: Auto-completion date setting and notifications

Ã¢Å¡Â¡ PERFORMANCE OPTIMIZATIONS:
â€¢ Lazy Loading: Problems loaded on demand for fast initial page load
â€¢ Efficient Filtering: Client-side filtering for instant search results
â€¢ Optimized API Calls: Minimal backend requests with comprehensive data
â€¢ Mobile Performance: Touch-optimized interface for field work
â€¢ Caching Strategy: Session-based caching for frequently accessed data


ğŸ“± MOBILE OPTIMIZATION:
â€¢ Responsive Design: Works seamlessly on phones, tablets, and desktops
â€¢ Touch Targets: Appropriately sized buttons and interactive elements
â€¢ Field Work Ready: Optimized for outdoor maintenance work scenarios
â€¢ Offline Capability: Graceful handling of connectivity issues
â€¢ Quick Actions: Streamlined interface for rapid problem updates

ğŸ”’" INTEGRATION POINTS:
â€¢ Contact Manager: Seamless integration with resident contact system
â€¢ Email System: Automated notifications through Gmail integration
â€¢ Reporting System: Export capabilities for management reporting
â€¢ Data Consistency: Synchronized with all other system components
â€¢ API Standards: Consistent JSONP protocol across all modules

ğŸ“ˆ ANALYTICS & REPORTING:
â€¢ Problem Statistics: Overview of problem volumes and trends
â€¢ Completion Metrics: Tracking of resolution times and efficiency
â€¢ Priority Analysis: Distribution of problems by priority level
â€¢ Team Performance: Assignment and completion tracking by staff member
â€¢ Export Capabilities: PDF and data export for external reporting


=====================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Module - V1.0 </title>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(90deg, #1e40af 0%, #1e3a8a 100%);

            line-height: 1.6;
        }
        
        .hidden { 
            display: none !important; 
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 15px; 
        }
        
        /* CLEAN HEADER */
        .header-section {
            background: linear-gradient(90deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            padding: 15px 0;
            text-align: center;
        }
        
       .header-content {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.logo-title-group {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-shrink: 0;
}

/* Mobile responsive header - Unified Design System v1.4 */
@media (max-width: 768px) {
    .header-section {
        text-align: center !important;
    }
    
    .header-section .container {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .header-content {
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 15px;
        width: 100%;
    }
    
    .logo-title-group {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 10px;
        text-align: center !important;
        width: 100%;
    }
    
    .logo-title-group > div {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .header-text-container {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        text-align: center !important;
        gap: 4px;
    }
    
    .logo-title-group > div:last-child {
        text-align: center !important;
    }
    
    .logo-title-group > div:last-child h1,
    .logo-title-group > div:last-child p {
        text-align: center !important;
    }
    
    .header-right {
        width: 100%;
        display: flex !important;
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 10px;
        padding: 0 16px;
    }
    
    .header-right .btn,
    .header-right .data-indicator {
        width: 100%;
    }
}
        
        
        
        .header-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }

.header {
    background: transparent;
    padding: 30px;
    margin-bottom: 30px;
    text-align: center;
}

.header-title {
    font-size: 2.3rem;
    font-weight: 700;
    color: white;
    margin: 0 0 5px 0;
    line-height: 1.1;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
Padding: 10px;
}

.header-subtitle {
    color: white;
    font-size: 1rem;
    margin: 0;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-refresh {
            background: #059669;
            color: white;
        }
        
        .btn-logout {
            background: #dc2626;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .data-indicator {
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        /* Header logo responsive sizing */
        .header-logo {
            width: 120px;
            height: 120px;
        }

        .header-text-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .header-title-text {
            font-size: 1.5rem;
            margin: 0;
            color: white;
        }

        .header-subtitle-text {
            font-size: 0.9rem;
            margin: 0;
            color: white;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .header-logo {
                width: 100px !important;
                height: 100px !important;
            }
            
            .header-title-text {
                font-size: 1.8rem;
            }
            
            .header-subtitle-text {
                font-size: 0.9rem;
            }
        }



        
        .data-indicator.loading { background: rgba(255,255,255,0.2); color: #fff; }

        .data-indicator.success { 
    background: #10b981; 
    color: white; 
}


        .data-indicator.error { background: rgba(239, 68, 68, 0.2); color: #fecaca; }

        
        /* PRIORITY DASHBOARD - CLEAN & FUNCTIONAL */
        .priority-dashboard {
            background: white;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }
        
        .dashboard-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .dashboard-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
        }
        
        .priority-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .priority-filter {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .priority-filter:hover {
            transform: translateY(-1px);
            border-color: #2563eb;
        }
        
        .priority-filter.active {
            border-color: #2563eb;
            box-shadow: 0 0 0 1px #2563eb;
        }
        
        .priority-filter.all { background: #e5e7eb; color: #374151; }
        .priority-filter.urgent { background: #fecaca; color: #991b1b; }
        .priority-filter.high { background: #fed7aa; color: #9a3412; }
        .priority-filter.medium { background: #fde68a; color: #92400e; }
        .priority-filter.low { background: #d1fae5; color: #065f46; }
        
        /* SEARCH SECTION */
        .search-section { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .search-box { 
            display: flex; 
            gap: 10px;
        }
        
        .search-input { 
            flex: 1; 
            padding: 12px 16px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .search-input:focus {
            border-color: #2563eb;
            outline: none;
        }
        
        .search-btn { 
            background: #2563eb; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s ease;
            min-width: 120px;
        }
        
        .search-btn:hover { 
            background: #1d4ed8; 
        }
        
        .search-btn-clear {
            background: #dc2626 !important;
        }

        .search-btn-clear:hover {
            background: #b91c1c !important;
        }
        
        /* PROBLEMS SECTION - SINGLE SCROLL */
        .problems-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .section-header {
            background: #f8fafc;
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .results-count {
            background: #e5e7eb;
            color: #6b7280;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .problems-list {
            /* NO max-height or overflow - natural scroll */
        }
        
        .problem-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .problem-item:hover {
            background: #f9fafb;
        }
        
        .problem-item:last-child {
            border-bottom: none;
        }
        
        .problem-header {
            margin-bottom: 8px;
        }
        
        .problem-id {
            font-weight: 600;
            color: #2563eb;
            font-size: 15px;
            margin-bottom: 4px;
        }
        
        .problem-description {
            color: #4b5563;
            margin-bottom: 10px;
            line-height: 1.4;
            font-size: 14px;
        }
        
        .problem-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
        }
        
        .problem-badges {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .problem-date {
            color: #6b7280;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        /* OPTIMIZED BADGES */
        .badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-urgent { background: #fecaca; color: #991b1b; }
        .badge-high { background: #fed7aa; color: #9a3412; }
        .badge-medium { background: #fde68a; color: #92400e; }
        .badge-low { background: #d1fae5; color: #065f46; }
        
        .badge-reported { background: #dbeafe; color: #1d4ed8; }
.badge-in-progress { background: #fef3c7; color: #d97706; }
.badge-completed { background: #d1fae5; color: #047857; }
.badge-on-hold { background: #fde2e8; color: #be185d; }
.badge-cancelled { background: #f3f4f6; color: #6b7280; }
.badge-scheduled { background: #ede9fe; color: #7c3aed; }
.badge-programmed { background: #e9d5ff; color: #9333ea; }
.badge-project { background: #fef3c7; color: #d97706; }
.badge-unknown { background: #f3f4f6; color: #6b7280; } 
.badge-programmed-completed { background: #e9d5ff; color: #9333ea; }
        
        .report-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #2563eb;
            color: white;
        }
        
        .report-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }
        
        .report-btn.green {
            background: #059669;
            color: white;
        }
        
        .report-btn.green:hover {
            background: #047857;
        }
        
        /* LOADING PROGRESS BAR */
        .loading-phase {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #374151;
        }
        
        .loading-progress {
            width: 100%;
            max-width: 300px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            margin: 0 auto 10px;
            overflow: hidden;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .loading-sequence {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-detail {
            font-size: 14px;
            color: #6b7280;
        }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .empty-state h3 {
            margin-bottom: 8px;
            color: #374151;
        }
        
        /* DETAIL PAGE */
        .page-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .back-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .back-btn:hover {
            background: #4b5563;
        }
        
        #problemPageTitle {
            font-size: 18px;
            color: #ffffff;
            font-weight: 600;
        }
        
        .detail-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .section-title-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 16px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 20px;
        }
        
        .detail-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .detail-field.full-width {
            grid-column: 1 / -1;
        }
        
        .detail-field label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }
        
        .detail-field span {
            padding: 10px 12px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            color: #6b7280;
            font-size: 14px;
            min-height: 38px;
            display: flex;
            align-items: center;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        textarea.form-input {
            min-height: 80px;
            resize: vertical;
        }
        
        .save-btn {
            width: 100%;
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 20px;
             border-radius: 0 0 12px 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }
        
        .save-btn:hover {
            background: #1d4ed8;
        }
        
        .save-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        /* CONTACT SECTION - MOBILE OPTIMIZED */
        .contact-group {
            grid-column: 1 / -1;
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .contact-group h4 {
            margin-bottom: 15px;
            color: #1f2937;
            font-size: 16px;
        }
        
        .contact-group .detail-grid {
            padding: 0;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .contact-link {
            color: #2563eb;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .contact-link:hover {
            color: #1d4ed8;
            text-decoration: underline;
        }
        
        /* LOGIN STYLES */
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 2px;
    padding: 40px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 450px;
    text-align: center;  /* ADD THIS LINE */
}


        
        .login-title {
    font-size: 2rem;
    color: white;
    margin-bottom: 8px;
    font-weight: 600;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}
        
        .version-badge {
    background: rgba(255, 255, 255, 0.12);
    color: rgba(255, 255, 255, 0.9);
    padding: 4px 10px;
    border-radius: 2px;
    font-size: 0.75rem;
    margin-bottom: 12px;
    display: inline-block;
    border: 1px solid rgba(255, 255, 255, 0.2);
}
        
        .login-subtitle {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.95rem;
    font-weight: 500;
    margin: 0;
}
        
        .login-input {
    width: 100%;
    padding: 14px 16px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    font-size: 16px;
    color: white;
    transition: all 0.3s ease;
}

.login-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.login-input:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.4);
    outline: none;
}
        
        .login-btn {
    width: 100%;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 16px 20px;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

.login-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

        /* URL SEARCH PARAMETER ENHANCEMENT STYLES */
        .login-search-indicator {
            background: #dbeafe !important;
            color: #1e40af !important;
            border: 1px solid #93c5fd;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* RESPONSIVE */
        @media (min-width: 768px) {
            .contact-group .detail-grid {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
        }
        
        @media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    .header-content {
        flex-direction: row;
        align-items: flex-start;
        gap: 10px;
    }
    
    .header-content > div:first-child {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .header-content img {
        width: 60px !important;
        height: 60px !important;
    }
    
    .header-content h1 {
        font-size: 1.2rem !important;
    }
    
    .header-content p {
        font-size: 0.8rem !important;
    }
    
    .header-right {
        width: 100%;
        justify-content: space-between;
        margin-top: 10px;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .header-right .btn {
        font-size: 12px;
        padding: 6px 10px;
        flex: 1;
        min-width: auto;
    }
    
    .header-right .data-indicator {
        font-size: 10px;
        padding: 4px 8px;
        flex-basis: 100%;
        text-align: center;
        margin-top: 5px;
    }
}     
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .priority-filters {
                justify-content: center;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            #problemPageTitle {
                font-size: 16px;
            }
        }



/* ===================================================================
   ACTIVITY TIMELINE STYLES - ADD TO EXISTING CSS
   =================================================================== */

/* Activity Timeline Section */
.activity-timeline {
    background: #f8fafc;
    border-radius: 8px;
    padding: 20px;
    margin-top: 15px;
}

.timeline-container {
    max-height: 400px;
    overflow-y: auto;
    border-radius: 6px;
}

.timeline-item {
    display: flex;
    align-items: flex-start;
    padding: 12px 0;
    border-bottom: 1px solid #e2e8f0;
    position: relative;
}

.timeline-item:last-child {
    border-bottom: none;
}

.timeline-icon {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    background: #3b82f6;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    margin-right: 12px;
    position: relative;
    z-index: 2;
}

.timeline-icon.system {
    background: #10b981;
}

.timeline-icon.update {
    background: #f59e0b;
}

.timeline-icon.completion {
    background: #ef4444;
}

.timeline-content {
    flex: 1;
    min-width: 0;
}

.timeline-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    flex-wrap: wrap;
}

.timeline-user {
    font-weight: 600;
    color: #1f2937;
    font-size: 14px;
}

.timeline-action {
    color: #6b7280;
    font-size: 13px;
}

.timeline-time {
    color: #9ca3af;
    font-size: 12px;
    margin-left: auto;
    white-space: nowrap;
}

.timeline-changes {
    margin-top: 6px;
}

.timeline-change {
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 2px 0;
    font-size: 13px;
}

.timeline-field {
    font-weight: 500;
    color: #374151;
    min-width: 80px;
}

.timeline-values {
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 1;
}

.timeline-old-value {
    background: #fee2e2;
    color: #dc2626;
    padding: 1px 6px;
    border-radius: 4px;
    font-size: 12px;
}

.timeline-new-value {
    background: #dcfce7;
    color: #16a34a;
    padding: 1px 6px;
    border-radius: 4px;
    font-size: 12px;
}

.timeline-arrow {
    color: #9ca3af;
    font-size: 12px;
}

.timeline-empty {
    text-align: center;
    color: #6b7280;
    padding: 40px 20px;
    font-style: italic;
}

.timeline-loading {
    text-align: center;
    color: #6b7280;
    padding: 20px;
}

/* Timeline vertical line */
.timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 15px;
    top: 44px;
    bottom: -12px;
    width: 2px;
    background: #e2e8f0;
    z-index: 1;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .timeline-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .timeline-time {
        margin-left: 0;
    }
    
    .timeline-change {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .timeline-values {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
        margin-left: 10px;
    }
}
/* Enhanced comment styling */
.timeline-change.comment-addition {
    background: #f0f9ff;
    border-left: 3px solid #0ea5e9;
    padding: 8px 12px;
    border-radius: 6px;
    margin: 4px 0;
}

.timeline-comment-content {
    font-style: italic;
    color: #374151;
    margin-top: 4px;
    padding: 4px 8px;
    background: white;
    border-radius: 4px;
    border: 1px solid #e5e7eb;
}

.timeline-field {
    font-weight: 600;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Better timestamp styling */
.timeline-time {
    font-size: 12px;
    color: #6b7280;
    font-weight: normal;
    white-space: nowrap;
}
/* Problem Context Header */
.timeline-problem-context {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.context-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
}

.context-pid {
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 14px;
}

.context-unit {
    background: rgba(255, 255, 255, 0.15);
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 13px;
    font-weight: 500;
}

.context-description {
    font-style: italic;
    font-size: 14px;
    opacity: 0.9;
    line-height: 1.4;
}

/* Enhanced existing styles */
.timeline-time {
    font-size: 12px;
    color: #6b7280;
    font-weight: 500;
    white-space: nowrap;
    margin-left: auto;
}

/* Mobile responsiveness for context header */
@media (max-width: 768px) {
    .context-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .timeline-problem-context {
        padding: 12px 16px;
    }
}

.detail-input {
    width: 100%;
    padding: 12px 16px;
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    color: #374151;
    font-family: inherit;
    box-sizing: border-box;
}

.detail-textarea {
    width: 100%;
    padding: 12px 16px;
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    color: #374151;
    font-family: inherit;
    box-sizing: border-box;
    resize: vertical;
    min-height: 80px;
}

/* Mobile responsive header */
@media (max-width: 768px) {
    .header-content {
        flex-direction: column !important;
        align-items: flex-start !important;
    }
    
    .header-right {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
    }
    
    .header-right .btn {
        font-size: 12px;
        padding: 6px 12px;
    }
}

@media (max-width: 480px) {
    .header-content img {
        width: 60px !important;
        height: 60px !important;
    }
    
    .header h1 {
        font-size: 18px !important;
    }
    
    .header p {
        font-size: 12px !important;
    }

@media (max-width: 768px) {
    .login-card {
        margin: 20px;
        padding: 30px 25px;
    }
/* Responsive header layout */
@media (max-width: 768px) {
    .header-section .container > div {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .header-right {
        width: 100%;
        justify-content: flex-start;
    }
}
        
    </style>
</head>
<body>
   <!-- LOGIN SCREEN -->
<div id="loginView">
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="login-title">Maintenance Module</h1>
                <div class="version-badge">v1.0</div>
                <p class="login-subtitle">Smart Priority Management System</p>
            </div>
            
            <!-- Status -->
            <div id="loginDataStatus" style="background: rgba(16, 185, 129, 0.15); border-left: 3px solid rgba(16, 185, 129, 0.6); color: rgba(255, 255, 255, 0.9); padding: 12px 16px; margin: 20px 0; font-size: 0.9rem; border-radius: 2px; text-align: center; font-weight: 600;">
                ğŸŸ¢ System Ready - URL Search Parameter Enhancement Active
            </div>
            
            <!-- Warning Box -->
            <div style="background: rgba(245, 158, 11, 0.15); border-left: 3px solid rgba(245, 158, 11, 0.6); color: rgba(255, 255, 255, 0.9); padding: 16px; margin: 20px 0; font-size: 0.9rem; border-radius: 2px;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <span style="font-size: 18px; margin-top: 2px;">âš ï¸</span>
                    <div>
                        <div style="font-weight: 600; font-size: 18px; margin-bottom: 8px;">Authorized Personnel Only</div>
                        <div style="line-height: 1.5;">
                            This system contains sensitive maintenance data.<br>
                            Unauthorized access is prohibited.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 400; color: rgba(255, 255, 255, 0.9); font-size: 16px; margin-bottom: 8px; text-align: left;">Maintenance Password:</label>
                    <div style="position: relative;">
                        <input type="password" id="passwordInput" class="login-input"
                               placeholder="Enter maintenance password" required>
                        <button type="button" id="togglePassword" 
        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: rgba(255, 255, 255, 0.7); cursor: pointer; font-size: 18px;">
                            ğŸ‘ï¸
                        </button>
                    </div>
                </div>
                
                <button type="submit" id="loginBtn" class="login-btn">
                    ğŸ”’Access Maintenance Portal
                </button>
            </form>
            
            <!-- Footer -->
            <div style="text-align: center; margin-top: 30px; color: rgba(255, 255, 255, 0.6); font-size: 14px;">
                Lake Illawong Maintenance Team
            </div>
        </div>
    </div>
</div>
    
   
   <!-- MAIN PORTAL -->
<div id="mainView" class="hidden">
    <!-- HEADER WITH LOGO -->
    <div class="header-section">
        <div class="container">
            <!-- Logo and Title Row -->
            <div class="header-content">
                <!-- Logo and Title Group -->
                <div class="logo-title-group">
                    <!-- Logo -->
                    <div>
                        <img src="logo.png" 
                             alt="Lake Illawong Logo" 
                             class="header-logo"
                             style="object-fit: contain; background: transparent;">
                    </div>
                    
                    <!-- Title -->
                    <div class="header-text-container">
                        <h1 class="header-title-text">Maintenance Portal</h1>
                        <p class="header-subtitle-text">Simplified Problem Management</p>
                    </div>
                </div>
                
                <!-- Header Buttons - Will wrap below on mobile -->
                <div class="header-right">
        <button id="refreshBtn" class="btn btn-refresh">ğŸ”„ Refresh</button>
        <button id="activityReportBtn" class="btn" style="background: #8b5cf6; color: white;">ğŸ“‹ Activity Report</button>
        <button id="viewCompletedBtn" class="btn" style="background: #6b7280; color: white;">
            ğŸ“Š Open Desktop Explorer
        </button>
        <button id="sortToggleBtn" class="btn" style="background: #059669; color: white;">
            ğŸ“… Oldest First
        </button>
        <button id="logoutBtn" class="btn btn-logout">ğŸšª Logout</button>
        <span id="dataStatus" class="data-indicator loading">Loading...</span>
    </div>
            </div>
        </div>
    </div>

        <div class="container" id="listView">
            <!-- PRIORITY DASHBOARD -->
            <div class="priority-dashboard">
                <div class="dashboard-header">
                    <span>ğŸ“Š</span>
                    <div class="dashboard-title">Priority Filter</div>
                </div>
                <div class="priority-filters">
                    <div class="priority-filter all active" data-priority="all">
                        ğŸ” All Active (<span id="allCount">-</span>)
                    </div>
                    <div class="priority-filter urgent" data-priority="urgent">
                        ğŸš¨ Urgent (<span id="urgentCount">-</span>)
                    </div>
                    <div class="priority-filter high" data-priority="high">
                        ğŸ”¥ High (<span id="highCount">-</span>)
                    </div>
                    <div class="priority-filter medium" data-priority="medium">
                        âš¡  Medium (<span id="mediumCount">-</span>)
                    </div>
                    <div class="priority-filter low" data-priority="low">
                        âœ… Low (<span id="lowCount">-</span>)
                    </div>
                </div>
            </div>

<!-- SHOW COMPLETED TOGGLE -->
            <div class="priority-dashboard" style="margin-top: 15px;">
                <div class="dashboard-header">
                    <span>ğŸ”</span>
                    <div class="dashboard-title">View Options</div>
                </div>
                <div style="padding: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: #374151; font-weight: 500;">
                        <input type="checkbox" id="showCompletedToggle" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>Include Completed & Cancelled Problems</span>
                    </label>
                </div>
            </div>
            
            <!-- SEARCH -->
            <div class="search-section">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" 
                           placeholder="Search by PID, unit, zone, description...">
                    <button id="searchBtn" class="search-btn">ğŸ” Search</button>
                </div>
            </div>

            <!-- PROBLEMS LIST -->
            <div class="problems-section">
                <div class="section-header">
                    <h3 class="section-title">Active Problems</h3>
                    <span id="resultsCount" class="results-count">Loading...</span>
                </div>
                
                <div class="report-section" style="padding: 15px 20px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 10px;">
                    <button id="viewListReport" class="report-btn">ğŸ”„ View Report</button>
                    <button id="copyListReport" class="report-btn green">ğŸ“‹ Copy Report</button>
                </div>
                
                <div id="problemsList" class="problems-list">
                    <div class="loading-sequence">
                        <div class="loading-spinner"></div>
                        <div class="loading-phase" id="loadingPhase">Initializing system...</div>
                        <div class="loading-progress">
                            <div class="loading-progress-bar" id="loadingProgressBar"></div>
                        </div>
                        <div class="loading-detail" id="loadingDetail">Loading maintenance problems...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROBLEM DETAILS PAGE -->
        <div id="problemDetailsView" class="container hidden">
            <div class="page-header">
                <button id="backToList" class="back-btn">â† Back</button>
                <h2 id="problemPageTitle">Problem Details</h2>
            </div>

         <!-- Report Buttons Section -->
<div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; padding: 15px 20px; display: flex; gap: 10px;">
    <button id="viewProblemReport" class="report-btn">ğŸ”„ View Report</button>
    <button id="copyProblemReport" class="report-btn green">ğŸ“‹ Copy Report</button>
    <a href="https://lake-illawong-maintenance.netlify.app/guide.html" 
       target="_blank"
       class="report-btn"
       style="background: #6c757d;">
       ğŸ“š Category Guide
    </a>
</div>

            

            <!-- Problem Details -->
            <div class="detail-section">
                <div class="section-title-bar">ğŸ“‹ Problem Details</div>

                <div class="detail-grid">
                    <div class="detail-field">
                        <label>Problem ID</label>
                        <span id="detailProblemId">-</span>
                    </div>

                    <div class="detail-field">
    <label>Unit Number</label>
    <input type="text" id="detailUnitNumber" class="detail-input">
</div>


                    <div class="detail-field">
                        <label>Reported Date</label>
                        <span id="detailReportedDate">-</span>
                    </div>


                    <div class="detail-field">
    <label>Zone</label>
    <input type="text" id="detailZone" class="detail-input">
</div>


                    <div class="detail-field full-width">
    <label>Problem Description</label>
    <textarea id="detailDescription" class="detail-textarea" rows="3"></textarea>
</div>


                </div>
            </div>

            <!-- Management Details -->
            <div class="detail-section">
                <div class="section-title-bar">âš™ï¸ Management Details</div>
                <form id="managementForm">
                    <div class="detail-grid">
                        <div class="detail-field">
                            <label>Status</label>
                            <select id="detailStatus" class="form-input">
                                <option value="">Select Status</option>
                                <option value="Reported">Reported</option>
                                <option value="In Progress">In Progress</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>

<!-- Reopen Button (only shows for Completed problems) -->
<div class="detail-field" id="reopenButtonContainer" style="display: none; grid-column: 1 / -1;">
    <button id="reopenProblemBtn" class="btn" style="background: #f59e0b; color: white; width: 100%; padding: 12px; font-weight: 600;">
        ğŸ”„ Reopen Problem (Change Status to Reported)
    </button>
</div>


                        <div class="detail-field">
                            <label>Priority</label>
                            <select id="detailPriority" class="form-input">
                                <option value="">Select Priority</option>
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Urgent">Urgent</option>
                            </select>
                        </div>
                        <div class="detail-field">
                            <label>Category</label>
                            <select id="detailCategory" class="form-input">
                                <option value="">Select Category</option>
                                <option value="Plumbing">Plumbing</option>
                                <option value="HVAC">HVAC</option>
                                <option value="Electrical">Electrical</option>
                                <option value="Security">Security</option>
                                <option value="Cleaning">Cleaning</option>
                                <option value="General">General</option>
                            </select>
                        </div>
                        <div class="detail-field">
                            <label>Sub-Category</label>
                            <select id="detailSubCategory" class="form-input">
                                <option value="">Select Sub-Category</option>
                                <option value="Faucet/Tap">Faucet/Tap</option>
                                <option value="Air Conditioning">Air Conditioning</option>
                                <option value="Lighting">Lighting</option>
                                <option value="Door Lock">Door Lock</option>
                                <option value="General">General</option>
                            </select>
                        </div>
                        <div class="detail-field">
                            <label>Assigned To</label>
                            <select id="detailAssignedTo" class="form-input">
                                <option value="">Select Assignee</option>
                                <option value="Ben">Ben</option>
                                <option value="David">David</option>
                                <option value="Jade">Jade</option>
                                <option value="Residents Committee">Residents Committee</option>
                            </select>
                        </div>
                        <div class="detail-field">
                            <label>Completion Date</label>
                            <input type="date" id="detailCompletionDate" class="form-input">
                        </div>
                        <div class="detail-field full-width">
                            <label>Internal Comments</label>
                            <textarea id="detailComments" class="form-input" 
                                     placeholder="Add internal comments..."></textarea>
                        </div>
                    </div>
                    <button type="submit" id="saveDetailsBtn" class="save-btn">ğŸ’¾ Save Changes</button>
                </form>
            </div>

            <!-- Contact Details -->
            <div class="detail-section">
                <div class="section-title-bar"> ğŸ‘¤ Contact Details</div>
                <div id="contactDetailsContent" class="detail-grid">
                    <!-- Dynamic content -->
                </div>
            </div>

            <!-- Activity Timeline - MOVED INSIDE -->
            <div class="detail-section">
                <div class="section-title-bar"> ğŸ“‹ Activity Timeline</div>
                <div class="activity-timeline">
                    <div id="timelineContainer" class="timeline-container">
                        <div class="timeline-loading" id="timelineLoading">
                            Loading activity history...
                        </div>
                    </div>
                </div>
            </div>

        </div>  <!-- problemDetailsView closes HERE -->
    </div>

    

    <!-- REPORT MODAL -->
    <div id="reportModal" class="modal hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
            <div style="padding: 25px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-size: 20px; font-weight: 600; color: #1f2937;">Report Preview</h3>
                <button id="closeReportModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; padding: 0; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 6px; transition: background-color 0.2s ease;">Ã—</button>
            </div>
            <div style="padding: 25px;">
                <pre id="reportText" style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; background: #f8f9fa; padding: 20px; border-radius: 6px; max-height: 600px; overflow-y: auto;"></pre>
                <div style="margin-top: 20px;">
                    <button id="copyModalReport" class="btn" style="background: #059669; color: white;">ğŸ“‹ Copy Report</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxtdMfxB5b1F5K401X0lJxnK2-DGkiG2zYZNukJvAHx0K1AqgPTMIdiunwS3etm0FOL/exec';
        const PASSWORD_API = 'https://script.google.com/macros/s/AKfycbyu0RdVfmlQEnr1wi5tfkPi-tGNLzKcs5H3R9DAnKXzZROwqEPhnCvpNq3CsjKGeaxXwA/exec'; 
        
        
        const MAINTENANCE_PASSWORD = 'maint2025';

// MOBILE DETECTION FUNCTION 
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
               window.innerWidth <= 768;
    }
   


// ADD THIS NEW FUNCTION HERE:
async function getMaintenancePassword() {
    return new Promise((resolve, reject) => {
        const callbackName = `callback_${Date.now()}_${Math.random().toString(36).substring(7)}`;
        
        window[callbackName] = function(data) {
            delete window[callbackName];
            if (data.success && data.passwords && data.passwords.maint) {
                resolve(data.passwords.maint);
            } else {
                console.warn('âš ï¸ Password API failed, using fallback');
                resolve('maint2025');
            }
        };
        
        const script = document.createElement('script');
        script.src = `${PASSWORD_API}?action=getPasswords&callback=${callbackName}`;
        script.onerror = () => {
            delete window[callbackName];
            console.warn('âš ï¸ Password API unavailable, using fallback');
            resolve('maint2025');
        };
        document.head.appendChild(script);
    });
}

        
        
        // CLEAN STATE MANAGEMENT
        let problems = [];
        let filteredProblems = [];
        let activePriorityFilter = 'all';
        let searchTerm = '';
	let showCompleted = false;  // Toggle for showing completed/cancelled problems
        let currentProblem = null;
        let isAuthenticated = false;

let sortNewestFirst = false; // Default: Oldest first (current behavior)
        
        // URL SEARCH PARAMETER ENHANCEMENT
        let pendingSearchParam = null;
        
        // Dynamic dropdown data storage
        let dynamicDropdownData = {
            categories: [],
            subCategories: [],
            priorities: [],
            statuses: [],
            assignedTo: []
        };
        
        // PROVEN PRIORITY ORDER
        const PRIORITY_ORDER = ['Urgent', 'High', 'Medium', 'Low'];
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('* Maintenance Portal V3.0 SIMPLIFIED - Initializing...');
            
            // CAPTURE SEARCH PARAMETER FROM URL
            captureSearchParameter();
            
            setupEventListeners();
            
            if (isAuthenticated) {
                showMainPortal();
                initializeSystem();
            } else {
                showLoginScreen();
            }
        });

        // NEW FUNCTION: Capture search parameter from URL
        function captureSearchParameter() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchParam = urlParams.get('search');
            
            console.log('ğŸ”’Â Raw URL search params:', window.location.search);
            console.log('ğŸ”’Â URLSearchParams object:', urlParams);
            console.log('ğŸ”’Â Raw search parameter:', searchParam);
            
            if (searchParam) {
                // Decode URL-encoded spaces and special characters
                const decodedParam = decodeURIComponent(searchParam);
                console.log('ğŸ”’Â Decoded search parameter:', decodedParam);
                console.log('ğŸ”’Â Parameter length:', decodedParam.length);
                console.log('ğŸ”’Â Parameter characters:', decodedParam.split('').map(c => `'${c}'`));
                
                pendingSearchParam = decodedParam;
                
                // Clean the URL (remove the search parameter from browser address bar)
                const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            } else {
                console.log('ğŸ”’Â No search parameter found in URL');
            }
        }
        
        function showLoginScreen() {
            document.getElementById('loginView').classList.remove('hidden');
            document.getElementById('mainView').classList.add('hidden');
            
            // Show pending search indicator if there is one
            if (pendingSearchParam) {
                showLoginSearchIndicator();
            }
            
            setTimeout(() => {
                const passwordInput = document.getElementById('passwordInput');
                if (passwordInput) passwordInput.focus();
            }, 100);
        }

        // NEW FUNCTION: Show search indicator on login screen
        function showLoginSearchIndicator() {
            const statusDiv = document.getElementById('loginDataStatus');
            if (statusDiv && pendingSearchParam) {
                statusDiv.className = 'login-search-indicator';
                statusDiv.style.background = '#dbeafe';
                statusDiv.style.color = '#1e40af';
                statusDiv.innerHTML = `ğŸ”’Â Will search for: "${pendingSearchParam}" after login`;
            }
        }
        
        function showMainPortal() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('mainView').classList.remove('hidden');
            document.getElementById('listView').classList.remove('hidden');
            document.getElementById('problemDetailsView').classList.add('hidden');
        }
        
        async function authenticateUser(password) {
    try {
        const currentPassword = await getMaintenancePassword();
        
        if (password === currentPassword) {
            isAuthenticated = true;
            showMainPortal();
            await initializeSystem();
            return true;
        } else {
            return false;
        }
    } catch (error) {
        console.error('âš ï¸ Password check failed, trying fallback:', error);
        if (password === MAINTENANCE_PASSWORD) {
            isAuthenticated = true;
            showMainPortal();
            await initializeSystem();
            return true;
        } else {
            return false;
        }
    }
}

        // NEW FUNCTION: Apply the pending search
        function applyPendingSearch() {
            if (!pendingSearchParam) return;
            
            try {
                console.log('ğŸ”’Â Attempting to apply pending search:', pendingSearchParam);
                
                // Ensure we have problems loaded
                if (!problems || problems.length === 0) {
                    console.log('âš ï¸ No problems loaded yet, will retry in 1 second');
                    setTimeout(() => {
                        applyPendingSearch();
                    }, 1000);
                    return;
                }
                
                // Set the search input field
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.value = pendingSearchParam;
                    
                    // Update search term variable
                    searchTerm = pendingSearchParam;
                    
                    // Update search button state
                    const searchBtn = document.getElementById('searchBtn');
                    if (searchBtn) {
                        searchBtn.textContent = 'âŒ Clear';
                        searchBtn.className = 'search-btn search-btn-clear';
                        searchBtn.dataset.action = 'clear';
                    }
                    
                    // Apply the search filter
                    applyFilters();
                    
                    // Show success message
                    updateDataStatus(`Search applied: "${pendingSearchParam}"`, 'success');
                    
                    console.log('âœ… Successfully applied pending search:', pendingSearchParam);
                    console.log('ğŸ“Š Filtered problems count:', filteredProblems.length);
                } else {
                    console.error('âŒ Search input element not found');
                }
            } catch (error) {
                console.error('âŒ Error applying pending search:', error);
            } finally {
                // Clear the pending search
                pendingSearchParam = null;
            }
        }
        
        async function initializeSystem() {
    try {
        updateDataStatus('Starting system initialization...', 'loading');
        
        // Sequential loading to avoid rate limits
        updateLoadingPhase('Loading dropdown options...', 20, 'Fetching categories and assignments');
        await loadDropdownOptions();
        
        updateLoadingPhase('Loading problems data...', 60, 'Retrieving maintenance requests');
        await loadProblems();
        
        updateLoadingPhase('Finalizing display...', 90, 'Preparing user interface');
        await new Promise(resolve => setTimeout(resolve, 1000)); // Brief pause
        
        updateLoadingPhase('Complete!', 100, 'System ready for use');
        updateDataStatus(`${problems.length} problems loaded successfully`, 'success');
        console.log('âœ… System initialization complete');
        
        // Apply pending search after full initialization
        if (pendingSearchParam && isAuthenticated) {
            console.log('ğŸ”’Â System ready - applying pending search:', pendingSearchParam);
            applyPendingSearch();
        }
        
    } catch (error) {
        console.error('âŒ Error initializing system:', error);
        updateDataStatus(`Initialization failed: ${error.message}`, 'error');
        showEmptyState('Failed to load system data. Please refresh the page.');
    }
}
        
        function updateLoadingPhase(phase, progress, detail) {
            const phaseElement = document.getElementById('loadingPhase');
            const progressBar = document.getElementById('loadingProgressBar');
            const detailElement = document.getElementById('loadingDetail');
            
            if (phaseElement) phaseElement.textContent = phase;
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (detailElement) detailElement.textContent = detail;
        }
        
        function setupEventListeners() {
            // Login
            const loginForm = document.getElementById('loginForm');
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('passwordInput');
            
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', function() {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    this.textContent = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
                });
            }
            
            // Search
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            
            if (searchInput) {
                searchInput.addEventListener('input', handleSearchInput);
            }
            
            if (searchBtn) {
                // Search button
		searchBtn.addEventListener('click', handleSearchButton);

		// Show Completed Toggle (only exists after login)
const showCompletedToggle = document.getElementById('showCompletedToggle');
if (showCompletedToggle) {
    showCompletedToggle.addEventListener('change', function() {
        showCompleted = this.checked;
        console.log('ğŸ” Show completed toggle:', showCompleted);
        applyFilters();
    });
}

// Reopen Problem Button
// Reopen Problem Button
const reopenBtn = document.getElementById('reopenProblemBtn');
if (reopenBtn) {
    reopenBtn.addEventListener('click', reopenProblem);
}

		// Priority filters
		document.querySelectorAll('.priority-filter').forEach(filter => {
                filter.addEventListener('click', function() {
                    const priority = this.dataset.priority;
                    setActivePriorityFilter(priority);
                });
            });
            } 
            
            // Navigation
            const backToList = document.getElementById('backToList');
            if (backToList) {
                backToList.addEventListener('click', showListView);
            }
            
            // Management form
            const managementForm = document.getElementById('managementForm');
            if (managementForm) {
                managementForm.addEventListener('submit', saveDetailsFromPage);
            }
            
            // Header buttons
const refreshBtn = document.getElementById('refreshBtn');
const logoutBtn = document.getElementById('logoutBtn');
const activityReportBtn = document.getElementById('activityReportBtn');
const viewCompletedBtn = document.getElementById('viewCompletedBtn');

if (refreshBtn) {
    refreshBtn.addEventListener('click', refreshData);
}





// ADD THIS NEW LISTENER BLOCK
// Update the existing event listener for viewCompletedBtn
    if (viewCompletedBtn) {
        viewCompletedBtn.addEventListener('click', function() {
            if (isMobileDevice()) {
                // Open Mobile Explorer for mobile devices
                window.open('MobileExplorer.html', '_blank');
                console.log('ğŸ“± Opening Mobile Explorer for completed problems review');
            } else {
                // Open Desktop Explorer for desktop devices
                window.open('DesktopExplorer.html', '_blank');
                console.log('ğŸ–¥ï¸ Opening Desktop Explorer for completed problems review');
            }
        });
    }

if (logoutBtn) {
    logoutBtn.addEventListener('click', logout);
}

if (activityReportBtn) {
    activityReportBtn.addEventListener('click', generateActivityReport);
}
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
            
            // Report button listeners
            const viewReportBtn = document.getElementById('viewListReport');
            const copyReportBtn = document.getElementById('copyListReport');
            const closeReportModal = document.getElementById('closeReportModal');
            const copyModalReport = document.getElementById('copyModalReport');
            const viewProblemReportBtn = document.getElementById('viewProblemReport');
            const copyProblemReportBtn = document.getElementById('copyProblemReport');
            
            if (viewReportBtn) {
                viewReportBtn.addEventListener('click', showReportModal);
            }
            
            if (copyReportBtn) {
                copyReportBtn.addEventListener('click', copyReportToClipboard);
            }
            
            if (viewProblemReportBtn) {
                viewProblemReportBtn.addEventListener('click', showProblemReportModal);
            }
            
            if (copyProblemReportBtn) {
                copyProblemReportBtn.addEventListener('click', copyProblemReportToClipboard);
            }
            
            if (copyModalReport) {
                copyModalReport.addEventListener('click', copyReportToClipboard);
            }
            
            if (closeReportModal) {
                closeReportModal.addEventListener('click', () => {
                    document.getElementById('reportModal').classList.add('hidden');
                });
            }
            
            // Modal click-outside-to-close
            const reportModal = document.getElementById('reportModal');
            if (reportModal) {
                reportModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.add('hidden');
                    }
                });
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    // Close report modal
                    const reportModal = document.getElementById('reportModal');
                    if (reportModal && !reportModal.classList.contains('hidden')) {
                        reportModal.classList.add('hidden');
                        return;
                    }
                    
                    // Or go back to list view
                    if (!document.getElementById('problemDetailsView').classList.contains('hidden')) {
                        showListView();
                    }
                }
            });
        }
        
        async function loadDropdownOptions() {
    try {
        updateConnectionStatus('Loading dropdown options...', 'loading');
        console.log('ğŸ›ï¸ Loading dropdown options from Categories TAB...');
        
        const response = await makeRequest('getDropdownOptions');
        
        if (response.success) {
            dynamicDropdownData = response.data;
            console.log('âœ… Dropdown data loaded:', dynamicDropdownData);
            updateAllDropdowns();
            updateConnectionStatus('Dropdowns loaded', 'success');
            return response.data;
        } else {
            throw new Error(response.error || 'Failed to load dropdown options');
        }
        
    } catch (error) {
        console.error('âŒ Error loading dropdown options:', error);
        updateConnectionStatus('Using fallback dropdown values', 'loading');
        console.log('âš ï¸ Using fallback dropdown values');
        updateAllDropdowns();
        throw error;
    }
}
        
        function updateAllDropdowns() {
            updateStatusDropdowns();
            updatePriorityDropdowns();
            updateCategoryDropdowns();
            updateSubCategoryDropdowns();
            updateAssignedToDropdowns();
        }
        
        function updateStatusDropdowns() {
            const statusSelects = [
                document.getElementById('detailStatus')
            ];
            
            statusSelects.forEach(select => {
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Status</option>';
                
                const statuses = dynamicDropdownData.statuses.length > 0 
                    ? dynamicDropdownData.statuses 
                    : ['Reported', 'In Progress', 'On Hold', 'Completed', 'Cancelled'];
                
                statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    if (status === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }
        
        function updatePriorityDropdowns() {
            const prioritySelects = [
                document.getElementById('detailPriority')
            ];
            
            prioritySelects.forEach(select => {
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Priority</option>';
                
                const priorities = dynamicDropdownData.priorities.length > 0 
                    ? dynamicDropdownData.priorities 
                    : ['Low', 'Medium', 'High', 'Urgent'];
                
                priorities.forEach(priority => {
                    const option = document.createElement('option');
                    option.value = priority;
                    option.textContent = priority;
                    if (priority === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }
        
        function updateCategoryDropdowns() {
            const categorySelects = [
                document.getElementById('detailCategory')
            ];
            
            categorySelects.forEach(select => {
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Category</option>';
                
                const categories = dynamicDropdownData.categories.length > 0 
                    ? dynamicDropdownData.categories 
                    : ['Plumbing', 'HVAC', 'Electrical', 'Security', 'Cleaning', 'General'];
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    if (category === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }
        
        function updateSubCategoryDropdowns() {
            const subCategorySelects = [
                document.getElementById('detailSubCategory')
            ];
            
            subCategorySelects.forEach(select => {
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Sub-Category</option>';
                
                const subCategories = dynamicDropdownData.subCategories.length > 0 
                    ? dynamicDropdownData.subCategories 
                    : ['Faucet/Tap', 'Air Conditioning', 'Lighting', 'Door Lock', 'General'];
                
                subCategories.forEach(subCategory => {
                    const option = document.createElement('option');
                    option.value = subCategory;
                    option.textContent = subCategory;
                    if (subCategory === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }
        
        function updateAssignedToDropdowns() {
            const assignedToSelects = [
                document.getElementById('detailAssignedTo')
            ];
            
            assignedToSelects.forEach(select => {
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Assignee</option>';
                
                const assignedToOptions = dynamicDropdownData.assignedTo.length > 0 
                    ? dynamicDropdownData.assignedTo 
                    : ['Ben', 'David', 'Jade', 'Residents Committee'];
                
                assignedToOptions.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person;
                    option.textContent = person;
                    if (person === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }
        
        async function loadProblems() {
    console.log('* loadProblems() FUNCTION STARTED');
    
    try {
        updateConnectionStatus('Loading problems data...', 'loading');
        
        const response = await makeRequest('getFaultLogData');
        
        if (response.success) {
            problems = response.data || [];
            console.log('ğŸ“Š Problems loaded:', problems.length);
            
            // Apply filters and render
            applyFilters();
            updatePriorityCounts();
            updateConnectionStatus(`${problems.length} problems loaded`, 'success');
        } else {
            throw new Error(response.message || 'Failed to load problems');
        }
    } catch (error) {
        console.error('âŒ Error loading problems:', error);
        updateConnectionStatus(`Load failed: ${error.message}`, 'error');
        throw error;
    }
}
        
        function handleSearchInput() {
            const value = document.getElementById('searchInput').value.trim();
            const searchBtn = document.getElementById('searchBtn');
            
            if (value.length > 0) {
                searchTerm = value;
                searchBtn.textContent = 'âŒ Clear';
                searchBtn.className = 'search-btn search-btn-clear';
                searchBtn.dataset.action = 'clear';
            } else {
                searchTerm = '';
                searchBtn.textContent = 'ğŸ”’ Search';
                searchBtn.className = 'search-btn';
                searchBtn.dataset.action = 'search';
            }
            
            applyFilters();
        }
        
        function handleSearchButton() {
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');
            
            if (searchBtn.dataset.action === 'clear') {
                searchInput.value = '';
                searchTerm = '';
                searchBtn.textContent = 'ğŸ”’ Search';
                searchBtn.className = 'search-btn';
                searchBtn.dataset.action = 'search';
                searchInput.focus();
                applyFilters();
            }
        }
        
        function setActivePriorityFilter(priority) {
            activePriorityFilter = priority;
            
            // Update UI
            document.querySelectorAll('.priority-filter').forEach(filter => {
                filter.classList.remove('active');
            });
            document.querySelector(`[data-priority="${priority}"]`).classList.add('active');
            
            // Apply filters
            applyFilters();
            
            console.log('ğŸ¯ Priority filter changed to:', priority);
        }
        
        // SINGLE CLEAN FILTERING FUNCTION
        function applyFilters() {
    let filtered = [...problems];
    
    console.log('ğŸ”’" Starting with', filtered.length, 'problems');
    
    // Step 1: Conditionally exclude completed and cancelled
if (!showCompleted) {
    filtered = filtered.filter(problem => 
        problem.problemStatus !== 'Completed' && 
        problem.problemStatus !== 'Cancelled'
    );
    console.log('ğŸ“Š After excluding completed/cancelled:', filtered.length);
} else {
    console.log('ğŸ“Š Including all problems (completed/cancelled shown):', filtered.length);
}
    
    // Step 2: Apply priority filter
    if (activePriorityFilter !== 'all') {
        const targetPriority = activePriorityFilter.charAt(0).toUpperCase() + activePriorityFilter.slice(1);
        filtered = filtered.filter(problem => 
            (problem.problemPriority || 'Medium') === targetPriority
        );
        console.log('ğŸ¯ After priority filter (' + targetPriority + '):', filtered.length);
    }
    
    // Step 3: Apply search filter
    if (searchTerm) {
        const searchLower = searchTerm.toLowerCase();
        filtered = filtered.filter(problem => {
            const friendlyPID = getFriendlyPID(problem.internalId);
            const unitNumber = String(problem.unitNumber || '');
            const description = String(problem.problemDescription || '');
            const reporter = String(problem.reportedBy || '');
            const zone = String(problem.zone || '');
            
            return friendlyPID.toLowerCase().includes(searchLower) ||
                   unitNumber.toLowerCase().includes(searchLower) ||
                   description.toLowerCase().includes(searchLower) ||
                   reporter.toLowerCase().includes(searchLower) ||
                   zone.toLowerCase().includes(searchLower);
        });
        console.log('ğŸ”’Â After search filter (' + searchTerm + '):', filtered.length);
    }
    
    // Step 4: SORTING - Oldest vs Newest
    

    filtered.sort((a, b) => {
        const getTimestamp = (problem) => {
            const timestamp = problem.timestamp;
            if (!timestamp) return 0;
            const date = new Date(timestamp);
            return isNaN(date.getTime()) ? 0 : date.getTime();
        };
        
        const aTime = getTimestamp(a);
        const bTime = getTimestamp(b);
        
        // Primary sort: by timestamp
        if (aTime !== bTime) {
            if (sortNewestFirst) {
                return bTime - aTime; // Newest first
            } else {
                return aTime - bTime; // Oldest first
            }
        }
        
        // Secondary sort: Internal ID
        return (a.internalId || '').localeCompare(b.internalId || '');
    });

 
    filtered.slice(0, 5).forEach((problem, index) => {
        const date = problem.timestamp ? new Date(problem.timestamp).toLocaleDateString() : 'No date';
        console.log(`  ${index + 1}. ${getFriendlyPID(problem.internalId)} - ${date}`);
    });
    
    filteredProblems = filtered;
    renderProblemsList();
}
        
        function updatePriorityCounts() {
            // Count only active problems (excluding completed/cancelled)
            const activeProblems = problems.filter(problem => 
                problem.problemStatus !== 'Completed' && 
                problem.problemStatus !== 'Cancelled'
            );
            
            const counts = {
                all: activeProblems.length,
                urgent: activeProblems.filter(p => (p.problemPriority || 'Medium') === 'Urgent').length,
                high: activeProblems.filter(p => (p.problemPriority || 'Medium') === 'High').length,
                medium: activeProblems.filter(p => (p.problemPriority || 'Medium') === 'Medium').length,
                low: activeProblems.filter(p => (p.problemPriority || 'Medium') === 'Low').length
            };
            
            document.getElementById('allCount').textContent = counts.all;
            document.getElementById('urgentCount').textContent = counts.urgent;
            document.getElementById('highCount').textContent = counts.high;
            document.getElementById('mediumCount').textContent = counts.medium;
            document.getElementById('lowCount').textContent = counts.low;
            
            console.log('ğŸ“Š Priority counts updated:', counts);
        }
        
        function renderProblemsList() {
            const container = document.getElementById('problemsList');
            const countElement = document.getElementById('resultsCount');
            
            const filterText = activePriorityFilter === 'all' ? 'Active Problems' : 
                             activePriorityFilter.charAt(0).toUpperCase() + activePriorityFilter.slice(1) + ' Priority';
            countElement.textContent = `${filteredProblems.length} ${filterText}`;
            
            if (filteredProblems.length === 0) {
                showEmptyState(searchTerm ? 'No problems match your search criteria.' : 'No active problems found.');
                return;
            }
            
            container.innerHTML = filteredProblems.map(problem => createProblemCard(problem)).join('');
            
            // Add click handlers
            container.querySelectorAll('.problem-item').forEach(item => {
                item.addEventListener('click', function() {
                    const problemId = this.dataset.problemId;
                    const problem = problems.find(p => p.internalId === problemId);
                    if (problem) openProblemDetailsPage(problem);
                });
            });
            
            console.log('âœ… Rendered', filteredProblems.length, 'problems');
        }
        
        function generateListReport() {
            const reportData = filteredProblems.map(problem => ({
                pid: getFriendlyPID(problem.internalId),
                unit: problem.unitNumber || 'Unknown',
                zone: problem.zone || 'Unknown',
                priority: problem.problemPriority || 'Medium',
                status: problem.problemStatus || 'Reported',
                description: problem.problemDescription || 'No description',
                reporter: problem.reportedBy || 'Unknown',
                date: formatDate(problem.timestamp),
                assignedTo: problem.assignedTo || 'Unassigned'
            }));
            
            let report = 'MAINTENANCE PORTAL - PROBLEMS REPORT\n';
            report += '='.repeat(60) + '\n';
            report += `Generated: ${new Date().toLocaleString('en-AU')}\n`;
            report += `Total Problems: ${reportData.length}\n`;
            report += `Filter: ${activePriorityFilter === 'all' ? 'All Active Problems' : activePriorityFilter.charAt(0).toUpperCase() + activePriorityFilter.slice(1) + ' Priority'}\n`;
            report += `Search: ${searchTerm || 'None'}\n`;
            report += '='.repeat(60) + '\n\n';
            
            const priorityCount = {
                'Urgent': reportData.filter(p => p.priority === 'Urgent').length,
                'High': reportData.filter(p => p.priority === 'High').length,
                'Medium': reportData.filter(p => p.priority === 'Medium').length,
                'Low': reportData.filter(p => p.priority === 'Low').length
            };
            
            Object.entries(priorityCount).forEach(([priority, count]) => {
                if (count > 0) {
                    report += `${priority}: ${count}\n`;
                }
            });
            report += '\n';
            
            const statusCount = {};
            reportData.forEach(p => {
                statusCount[p.status] = (statusCount[p.status] || 0) + 1;
            });
            
            report += 'STATUS BREAKDOWN:\n';
            report += '-'.repeat(30) + '\n';
            Object.entries(statusCount).forEach(([status, count]) => {
                report += `${status}: ${count}\n`;
            });
            report += '\n';
            
            report += 'DETAILED PROBLEM LIST:\n';
            report += '-'.repeat(60) + '\n';
            
            reportData.forEach((problem, index) => {
                report += `${index + 1}. ${problem.pid}\n`;
                report += `   Unit: ${problem.unit} (${problem.zone})\n`;
                report += `   Priority: ${problem.priority} | Status: ${problem.status}\n`;
                report += `   Reporter: ${problem.reporter} | Date: ${problem.date}\n`;
                report += `   Assigned: ${problem.assignedTo}\n`;
                report += `   Description: ${problem.description}\n`;
                report += '\n';
            });
            
            report += '='.repeat(60) + '\n';
            report += 'End of Report\n';
            
            return report;
        }
        
function toggleSortOrder() {

    sortNewestFirst = !sortNewestFirst;
    
    // Update button text
    const sortBtn = document.getElementById('sortToggleBtn');
    if (sortBtn) {
        sortBtn.textContent = sortNewestFirst ? 'ğŸ“… Newest First' : 'ğŸ“… Oldest First';
    }
    
    // Re-apply filters (which will use the new sort order)
    applyFilters();
    
    console.log('ğŸ”’" Sort order changed to:', sortNewestFirst ? 'Newest First' : 'Oldest First');
}

// Add with other header button listeners
const sortToggleBtn = document.getElementById('sortToggleBtn');
if (sortToggleBtn) {
    sortToggleBtn.addEventListener('click', function() {
        
        
       
        toggleSortOrder();
    });
}


        function generateProblemReport() {
            if (!currentProblem) {
                return 'No problem selected for report generation.';
            }
            
            const friendlyPID = getFriendlyPID(currentProblem.internalId);
            const reportedDate = formatDate(currentProblem.timestamp);
            const completionDate = currentProblem.completionDate ? formatDate(currentProblem.completionDate) : 'Not completed';
            
            let report = 'MAINTENANCE PORTAL - PROBLEM REPORT\n';
            report += '='.repeat(60) + '\n';
            report += `Generated: ${new Date().toLocaleString('en-AU')}\n`;
            report += `Problem ID: ${friendlyPID}\n`;
            report += `Unit: ${currentProblem.unitNumber || 'Unknown'}\n`;
            report += '='.repeat(60) + '\n\n';
            
            // Problem Details Section
            report += 'PROBLEM DETAILS:\n';
            report += '-'.repeat(30) + '\n';
            report += `Problem ID: ${friendlyPID}\n`;
            report += `Unit Number: ${currentProblem.unitNumber || 'Unknown'}\n`;
            report += `Zone: ${currentProblem.zone || 'Unknown'}\n`;
            report += `Reported Date: ${reportedDate}\n`;
            report += `Reported By: ${currentProblem.reportedBy || 'Unknown'}\n`;
            report += `Description: ${currentProblem.problemDescription || 'No description'}\n\n`;
            
            // Management Details Section
            report += 'MANAGEMENT DETAILS:\n';
            report += '-'.repeat(30) + '\n';
            report += `Status: ${currentProblem.problemStatus || 'Unknown'}\n`;
            report += `Priority: ${currentProblem.problemPriority || 'Unknown'}\n`;
            report += `Category: ${currentProblem.category || 'Not assigned'}\n`;
            report += `Sub-Category: ${currentProblem.subCategory || 'Not assigned'}\n`;
            report += `Assigned To: ${currentProblem.assignedTo || 'Unassigned'}\n`;
            report += `Completion Date: ${completionDate}\n`;
            
            if (currentProblem.comments && currentProblem.comments.trim()) {
                report += `Internal Comments: ${currentProblem.comments}\n`;
            }
            report += '\n';
            
            // Contact Details Section
            report += 'CONTACT DETAILS:\n';
            report += '-'.repeat(30) + '\n';
            
            // Unit Primary Contact
            report += 'Unit Primary Contact:\n';
            report += `  Name: ${currentProblem.unitPrimaryName || 'Not available'}\n`;
            report += `  Email: ${currentProblem.unitPrimaryEmail || 'Not available'}\n`;
            report += `  Phone: ${currentProblem.unitPrimaryPhone || 'Not available'}\n`;
            
            // Reporter Contact (if different)
            const reportedBy = currentProblem.reportedBy || '';
            const unitPrimaryName = currentProblem.unitPrimaryName || '';
            
            if (reportedBy && reportedBy !== unitPrimaryName) {
                report += '\nReporter Contact:\n';
                report += `  Name: ${currentProblem.reportedBy || 'Not available'}\n`;
                report += `  Email: ${currentProblem.reporterEmail || 'Not available'}\n`;
                report += `  Phone: ${currentProblem.reporterPhone || 'Not available'}\n`;
            }
            
            report += '\n' + '='.repeat(60) + '\n';
            report += 'End of Problem Report\n';
            
            return report;
        }
        
        function showReportModal() {
            const modal = document.getElementById('reportModal');
            const reportText = document.getElementById('reportText');
            
            const report = generateListReport();
            reportText.textContent = report;
            
            modal.classList.remove('hidden');
        }
        
        function showProblemReportModal() {
            const modal = document.getElementById('reportModal');
            const reportText = document.getElementById('reportText');
            
            const report = generateProblemReport();
            reportText.textContent = report;
            
            modal.classList.remove('hidden');
        }
        
        async function copyReportToClipboard() {
            const report = generateListReport();
            
            try {
                await navigator.clipboard.writeText(report);
                
                const copyBtn = document.getElementById('copyListReport') || document.getElementById('copyModalReport');
                if (copyBtn) {
                    const originalText = copyBtn.innerHTML;
                    
                    copyBtn.innerHTML = 'âœ… Copied!';
                    
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                    }, 2000);
                }
                
                updateDataStatus('Report copied to clipboard', 'success');
            } catch (error) {
                console.error('Failed to copy report:', error);
                updateDataStatus('Failed to copy report', 'error');
            }
        }
        
        async function copyProblemReportToClipboard() {
            const report = generateProblemReport();
            
            try {
                await navigator.clipboard.writeText(report);
                
                const copyBtn = document.getElementById('copyProblemReport') || document.getElementById('copyModalReport');
                if (copyBtn) {
                    const originalText = copyBtn.innerHTML;
                    
                    copyBtn.innerHTML = 'âœ… Copied!';
                    
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                    }, 2000);
                }
                
                updateDataStatus('Problem report copied to clipboard', 'success');
            } catch (error) {
                console.error('Failed to copy problem report:', error);
                updateDataStatus('Failed to copy problem report', 'error');
            }
        }
        
        function createProblemCard(problem) {
            const friendlyPID = getFriendlyPID(problem.internalId);
            const priority = problem.problemPriority || 'Medium';
            const status = problem.problemStatus || 'Reported';
            
            const priorityClass = `badge-${priority.toLowerCase()}`;
            const statusClass = `badge-${status.toLowerCase().replace(' ', '-')}`;
            
            // FIXED: Use correct timestamp field (Col A - Timestamp)
            const formattedDate = formatDate(problem.timestamp);
            
            return `
                <div class="problem-item" data-problem-id="${problem.internalId}">
                    <div class="problem-header">
                        <div class="problem-id">${friendlyPID} ${problem.unitNumber || 'Unknown Unit'} â€¢ ${problem.zone || 'Zone Unknown'}</div>
                    </div>
                    <div class="problem-description">${problem.problemDescription || 'No description'}</div>
                    <div class="problem-footer">
                        <div class="problem-badges">
                            <span class="badge ${priorityClass}">${priority}</span>
                            <span class="badge ${statusClass}">${status}</span>
                        </div>
                        <div class="problem-date">${formattedDate}</div>
                    </div>
                </div>
            `;
        }
        
        function showEmptyState(message) {
            document.getElementById('problemsList').innerHTML = `
                <div class="empty-state">
                    <h3>ğŸ”Â­ ${message}</h3>
                    <p>Try adjusting your filters or search criteria.</p>
                </div>
            `;
        }

        
 function openProblemDetailsPage(problem) {
    currentProblem = problem;
    
    const friendlyPID = getFriendlyPID(problem.internalId);
    
    document.getElementById('problemPageTitle').textContent = `${friendlyPID} - ${problem.unitNumber}`;
    
    // Problem Details (read-only)
    document.getElementById('detailProblemId').textContent = friendlyPID;


  //  document.getElementById('detailUnitNumber').textContent = problem.unitNumber || 'Unknown';
    document.getElementById('detailUnitNumber').value = problem.unitNumber || '';

    
    // FIXED: Use correct timestamp field (Col A - Timestamp) for reported date
    document.getElementById('detailReportedDate').textContent = formatDate(problem.timestamp);
    
    // document.getElementById('detailZone').textContent = problem.zone || 'Unknown';
       document.getElementById('detailZone').value = problem.zone || '';


    // document.getElementById('detailDescription').textContent = problem.problemDescription || 'No description';
       document.getElementById('detailDescription').value = problem.problemDescription || '';


    
    // Update dropdowns before setting values
    updateAllDropdowns();
    
    // Management Details (editable)
    document.getElementById('detailStatus').value = problem.problemStatus || 'Reported';

document.getElementById('detailStatus').value = problem.problemStatus || 'Reported';

// Show/hide reopen button based on status
const reopenContainer = document.getElementById('reopenButtonContainer');
if (problem.problemStatus === 'Completed' || problem.problemStatus === 'Cancelled') {
    reopenContainer.style.display = 'block';
} else {
    reopenContainer.style.display = 'none';
}

document.getElementById('detailPriority').value = problem.problemPriority || 'Medium';


    document.getElementById('detailPriority').value = problem.problemPriority || 'Medium';
    document.getElementById('detailCategory').value = problem.category || '';
    document.getElementById('detailSubCategory').value = problem.subCategory || '';
    document.getElementById('detailAssignedTo').value = problem.assignedTo || '';
    
    // Completion date
    const completionDate = problem.completionDate || '';
    if (completionDate) {
        const date = new Date(completionDate);
        const formattedDate = date.toISOString().split('T')[0];
        document.getElementById('detailCompletionDate').value = formattedDate;
    } else {
        document.getElementById('detailCompletionDate').value = '';
    }
    
    document.getElementById('detailComments').value = problem.comments || '';
    
    // Contact Details
    populateContactDetails(problem);
    
    // Show details view
    showDetailsView();
    
    // ğŸ¯ FIXED: Add small delay to ensure all data is populated
    setTimeout(() => {
        console.log('ğŸ”’Â Timeline Debug - Problem data:', problem);
        console.log('ğŸ”’Â Timeline Debug - Activity Log:', problem.activityLogParsed);
        displayActivityTimeline(problem);
    }, 100);
}
        
        // UPDATED populateContactDetails function - Add this to MaintenanceModule.html
// Replace the existing function starting at line 2520

function populateContactDetails(problem) {

console.log('ğŸ”’Â DEBUG: Full problem object:', problem);
    console.log('ğŸ”’Â DEBUG: photoUrls value:', problem.photoUrls);
    console.log('ğŸ”’Â DEBUG: photoUrls type:', typeof problem.photoUrls);
    console.log('ğŸ”’Â DEBUG: photoUrls exists?', problem.photoUrls ? 'YES' : 'NO');
    console.log('ğŸ”’Â DEBUG: photoUrls trimmed:', problem.photoUrls ? problem.photoUrls.trim() : 'N/A');
    
    const container = document.getElementById('contactDetailsContent');
    const reportedBy = problem.reportedBy || '';
    const unitPrimaryName = problem.unitPrimaryName || '';
    
    let contactHTML = '';
    
    // Unit Primary Contact
    contactHTML += `
        <div class="contact-group">
            <h4>Unit Primary Contact</h4>
            <div class="detail-grid">
                <div class="detail-field">
                    <label>Name</label>
                    <span>${problem.unitPrimaryName || 'Not available'}</span>
                </div>
                <div class="detail-field">
                    <label>Email</label>
                    <span>${problem.unitPrimaryEmail ? `<a href="mailto:${problem.unitPrimaryEmail}" class="contact-link">${problem.unitPrimaryEmail}</a>` : 'Not available'}</span>
                </div>
                <div class="detail-field">
                    <label>Mobile</label>
                    <span>${problem.unitPrimaryPhone ? `<a href="tel:${problem.unitPrimaryPhone.replace(/\s/g, '')}" class="contact-link">${problem.unitPrimaryPhone}</a>` : 'Not available'}</span>
                </div>
            </div>
        </div>
    `;
    
    // Reporter Contact (if different)
    if (reportedBy && reportedBy !== unitPrimaryName) {
        contactHTML += `
            <div class="contact-group">
                <h4>Reporter Contact</h4>
                <div class="detail-grid">
                    <div class="detail-field">
                        <label>Name</label>
                        <span>${problem.reportedBy || 'Not available'}</span>
                    </div>
                    <div class="detail-field">
                        <label>Email</label>
                        <span>${problem.reporterEmail ? `<a href="mailto:${problem.reporterEmail}" class="contact-link">${problem.reporterEmail}</a>` : 'Not available'}</span>
                    </div>
                    <div class="detail-field">
                        <label>Mobile</label>
                        <span>${problem.reporterPhone ? `<a href="tel:${problem.reporterPhone.replace(/\s/g, '')}" class="contact-link">${problem.reporterPhone}</a>` : 'Not available'}</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ğŸ“· NEW: Photo Section
    if (problem.photoUrls && problem.photoUrls.trim() !== '') {
        contactHTML += `
            <div class="contact-group" style="border-top: 2px solid #e5e7eb; padding-top: 20px; margin-top: 20px;">
                <h4> ğŸ“· Photos</h4>
                <div class="detail-grid">
                    <div class="detail-field full-width">
                        <a href="${problem.photoUrls}" 
                           target="_blank" 
                           style="display: inline-block; padding: 12px 24px; background: #0891b2; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: background 0.3s;"
                           onmouseover="this.style.background='#0e7490'"
                           onmouseout="this.style.background='#0891b2'">
                            ğŸ“· View Photos in Drive
                        </a>
                        <div style="margin-top: 8px; font-size: 13px; color: #64748b;">
                            Opens Drive folder with problem photos
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = contactHTML;
}
        
        function showListView() {
            document.getElementById('listView').classList.remove('hidden');
            document.getElementById('problemDetailsView').classList.add('hidden');
            currentProblem = null;
        }
        
        function showDetailsView() {
            document.getElementById('listView').classList.add('hidden');
            document.getElementById('problemDetailsView').classList.remove('hidden');
        }
        
        // =====================================================================
// SOFT VALIDATION FOR COMPLETION COMMENTS
// Add this code in the saveDetailsFromPage function in MaintenanceModule.html
// =====================================================================

async function saveDetailsFromPage(e) {
    e.preventDefault();
    
    if (!currentProblem) return;
    
    const saveBtn = document.getElementById('saveDetailsBtn');
    const originalText = saveBtn.textContent;
    
    try {
        saveBtn.disabled = true;
        saveBtn.textContent = 'ğŸ’¾ Saving...';
        
        // ğŸ”§ FIX: Get these values first to check conditions
        const completionDateValue = document.getElementById('detailCompletionDate').value;
        const statusValue = document.getElementById('detailStatus').value;
        
        // Build base update data (without completion date)
        const updateData = {
            internalId: currentProblem.internalId,
            unitNumber: document.getElementById('detailUnitNumber').value,
            zone: document.getElementById('detailZone').value,
            problemDescription: document.getElementById('detailDescription').value,
            problemStatus: statusValue,
            problemPriority: document.getElementById('detailPriority').value,
            category: document.getElementById('detailCategory').value,
            subCategory: document.getElementById('detailSubCategory').value,
            assignedTo: document.getElementById('detailAssignedTo').value,
            comments: document.getElementById('detailComments').value
        };
        
        // ğŸ”§ FIX: Only include completion date when appropriate
        // Case 1: User manually entered a date (for backdating)
        if (completionDateValue && completionDateValue.trim() !== '') {
            updateData.completionDate = completionDateValue;
            console.log('âœ… Using manual completion date:', completionDateValue);
        } 
        // Case 2: Status is Completed but no manual date (backend will auto-set)
        else if (statusValue === 'Completed') {
            updateData.completionDate = '';  // Empty signals backend to auto-set
            console.log('âœ… Backend will auto-set completion date');
        }
        // Case 3: Not completing, no date needed - don't include field at all
        else {
            console.log('âœ… No completion date needed');
        }
        
        // ============================================================
        // IMPROVED SOFT VALIDATION: Prompt for closing comments on completion
        // ============================================================
        if (updateData.problemStatus === 'Completed') {
            const commentsField = document.getElementById('detailComments');
            const comments = commentsField.value.trim();
            const existingComments = currentProblem.comments || '';
            
            // Improved logic: Check if user already added meaningful comments
            const hasMeaningfulComments = comments.length > 0 && comments !== existingComments;
            
            if (!hasMeaningfulComments) {
                // Highlight the comments field to draw attention
                commentsField.style.border = '3px solid #f59e0b';
                commentsField.style.backgroundColor = '#fffbeb';
                
                const shouldAddComments = confirm(
                    'âš ï¸ CLOSING NOTES RECOMMENDED\n\n' +
                    'You\'re marking this problem as Completed.\n\n' +
                    'Best Practice - Add brief closing notes:\n' +
                    'â€¢ What was done to fix the problem\n' +
                    'â€¢ Parts or materials used\n' +
                    'â€¢ Time spent or follow-up needed\n' +
                    '\n' +
                    'This helps with:\n' +
                    'âœ“ Future reference and warranty tracking\n' +
                    'âœ“ Team knowledge sharing\n' +
                    'âœ“ Complete audit trail\n' +
                    '\n' +
                    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n' +
                    'Click OK to add notes (recommended)\n' +
                    'Click Cancel to complete without notes'
                );
                
                if (shouldAddComments) {
                    // User chose to add comments - stop save, focus field, but don't validate length
                    commentsField.style.border = '2px solid #2563eb';
                    commentsField.style.backgroundColor = '#f0f9ff';
                    commentsField.focus();
                    commentsField.setSelectionRange(comments.length, comments.length);
                    
                    // Re-enable save button but don't block future saves
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    
                    // Show helpful message
                    updateDataStatus('* Please add your closing notes, then save again', 'loading');
                    return; // Stop THIS save attempt, allow user to add comments
                } else {
                    // User chose to proceed without comments - reset styling and continue with save
                    commentsField.style.border = '';
                    commentsField.style.backgroundColor = '';
                    console.log('âœ… User opted to complete without additional comments');
                }
            } else {
                // User already added meaningful comments - proceed with save
                console.log('âœ… Closing notes provided, proceeding with completion');
            }
        }

        // ============================================================
        // END IMPROVED SOFT VALIDATION
        // ============================================================
        
        const response = await makeRequest('updateProblem', updateData);
        
        if (response.success) {
            // Update local data
            const problemIndex = problems.findIndex(p => p.internalId === currentProblem.internalId);
            if (problemIndex !== -1) {
                problems[problemIndex] = { 
                    ...problems[problemIndex], 
                    ...updateData
                };
            }
            
            // Refresh views
            applyFilters();
            updatePriorityCounts();
            updateDataStatus('Problem updated successfully', 'success');
            
            // Check if status was changed to Completed and show toast
            if (updateData.problemStatus === 'Completed') {
                updateDataStatus('Problem marked as completed âœ“', 'success');
            }
            
            currentProblem = problems[problemIndex];
        } else {
            throw new Error(response.message || 'Update failed');
        }
        
    } catch (error) {
        console.error('Error saving problem:', error);
        updateDataStatus('Error: ' + error.message, 'error');
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
    }
}

async function reopenProblem() {
    if (!currentProblem) return;
    
    const confirmReopen = confirm(
        `Reopen Problem ${getFriendlyPID(currentProblem.internalId)}?\n\n` +
        `This will change the status from "${currentProblem.problemStatus}" to "Reported" ` +
        `and return it to the active queue.\n\n` +
        `Are you sure you want to proceed?`
    );
    
    if (!confirmReopen) return;
    
    try {
        // Prepare update data
        const updateData = {
            internalId: currentProblem.internalId,
            unitNumber: currentProblem.unitNumber,
            zone: currentProblem.zone,
            problemDescription: currentProblem.problemDescription,
            problemStatus: 'Reported',  // Change to Reported
            problemPriority: currentProblem.problemPriority,
            category: currentProblem.category,
            subCategory: currentProblem.subCategory,
            assignedTo: currentProblem.assignedTo || '',
            comments: (currentProblem.comments || '') + '\n[REOPENED - Problem returned to active queue]',
            completionDate: ''  // Clear completion date
        };
        
        console.log('ğŸ”„ Reopening problem:', updateData);
        
        // Save changes
        const response = await makeRequest('updateProblem', updateData);
        
        if (response.success) {
            alert('âœ… Problem successfully reopened and returned to active queue');
            
            // Refresh data and return to list
            await loadProblems();
            showListView();
        } else {
            throw new Error(response.message || 'Failed to reopen problem');
        }
        
    } catch (error) {
        console.error('âŒ Error reopening problem:', error);
        alert('Failed to reopen problem: ' + error.message);
    }
}
        
        async function makeRequest(action, additionalData = {}, retryCount = 0) {
    const MAX_RETRIES = 2;
    const TIMEOUT_DURATION = 30000; // 30 seconds

    return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        
        console.log(`ğŸ”’Â Making request (attempt ${retryCount + 1}):`, action);
        
        const script = document.createElement('script');
        const params = new URLSearchParams({
            action: action,
            callback: callbackName,
            ...additionalData
        });
        
        script.src = `${WEB_APP_URL}?${params.toString()}`;
        console.log('* Request URL:', script.src);
        
        // Success handler
        window[callbackName] = function(response) {
            console.log('âœ… Received JSONP response:', response);
            cleanup();
            resolve(response);
        };
        
        // Error handler
        script.onerror = function(error) {
            console.error(`âŒ Script loading error (attempt ${retryCount + 1}):`, error);
            cleanup();
            
            if (retryCount < MAX_RETRIES) {
                console.log(`ğŸ”’" Retrying request (${retryCount + 1}/${MAX_RETRIES})...`);
                setTimeout(() => {
                    resolve(makeRequest(action, additionalData, retryCount + 1));
                }, 2000 * (retryCount + 1)); // Progressive backoff
            } else {
                reject(new Error(`Network request failed after ${MAX_RETRIES + 1} attempts`));
            }
        };
        
        // Timeout handler
        const timeoutId = setTimeout(() => {
            console.error(`â° Request timeout (${TIMEOUT_DURATION}ms) on attempt ${retryCount + 1}`);
            cleanup();
            
            if (retryCount < MAX_RETRIES) {
                console.log(`ğŸ”’" Retrying after timeout (${retryCount + 1}/${MAX_RETRIES})...`);
                setTimeout(() => {
                    resolve(makeRequest(action, additionalData, retryCount + 1));
                }, 2000 * (retryCount + 1));
            } else {
                reject(new Error(`Request timeout after ${MAX_RETRIES + 1} attempts`));
            }
        }, TIMEOUT_DURATION);
        
        // Cleanup function
        function cleanup() {
            clearTimeout(timeoutId);
            if (script.parentNode) {
                document.head.removeChild(script);
            }
            delete window[callbackName];
        }
        
        document.head.appendChild(script);
    });
}
        
        function updateDataStatus(message, type) {
            const indicator = document.getElementById('dataStatus');
            if (indicator) {
                indicator.textContent = message;
                indicator.className = `data-indicator ${type}`;
            }
        }
        
        function getFriendlyPID(internalId) {
            if (!internalId) return 'PID Unknown';
            const parts = internalId.split('-');
            return parts.length === 2 ? `PID ${parts[1]}` : `PID ${internalId}`;
        }


// ==================== NEW HELPER FUNCTIONS ====================
// Add these right after updateDataStatus function

function updateConnectionStatus(message, type = 'loading') {
    const status = document.getElementById('dataStatus');
    if (status) {
        status.textContent = message;
        status.className = `data-indicator ${type}`;
    }
}

function showRetryNotification(attempt, maxAttempts) {
    const status = document.getElementById('dataStatus');
    if (status) {
        status.textContent = `ğŸ”’" Connection slow, retrying... (${attempt}/${maxAttempts})`;
        status.className = 'data-indicator loading';
    }
}
        
        function formatDate(dateString) {
    if (!dateString) return 'No Date';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Invalid Date';
        
        // Handle Zulu time (UTC) and convert to local Australian time
        const options = {
            timeZone: 'Australia/Sydney',
            day: '2-digit',
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        };
        
        return date.toLocaleString('en-AU', options);
    } catch (error) {
        console.error('Date formatting error:', error);
        // Fallback: basic date format without timezone
        return new Date(dateString).toLocaleDateString('en-AU');
    }
}
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const passwordInput = document.getElementById('passwordInput');
            const loginBtn = document.getElementById('loginBtn');
            const password = passwordInput.value.trim();
            
            if (!password) {
                showLoginError('Please enter a password');
                return;
            }
            
            loginBtn.disabled = true;
           loginBtn.innerHTML = 'â³ Authenticating...';
            
            try {
                const success = await authenticateUser(password);
                
                if (success) {
                    console.log('âœ… Authentication successful');
                } else {
                    showLoginError('Invalid password. Please try again.');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
                
            } catch (error) {
                console.error('âŒ Authentication error:', error);
                showLoginError('Authentication failed. Please try again.');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'ğŸ”’Â Access Maintenance Portal';
            }
        }
        
        function showLoginError(message) {
            const statusDiv = document.getElementById('loginDataStatus');
            if (statusDiv) {
                statusDiv.style.background = '#fecaca';
                statusDiv.style.color = '#991b1b';
                statusDiv.innerHTML = `âŒ ${message}`;
                
                setTimeout(() => {
                    statusDiv.style.background = '#d1fae5';
                    statusDiv.style.color = '#065f46';
                    statusDiv.innerHTML = 'ğŸŸ¢ System Ready - URL Search Parameter Enhancement Active';
                }, 3000);
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                problems = [];
                filteredProblems = [];
                currentProblem = null;
                activePriorityFilter = 'all';
                searchTerm = '';
                isAuthenticated = false;
                
                // Clear pending search parameter on logout
                pendingSearchParam = null;
                
                showLoginScreen();
                updateDataStatus('Logged out', 'error');
                
                document.getElementById('passwordInput').value = '';
                console.log('ğŸšª User logged out');
            }
        }
        
        async function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = 'â³ Refreshing...';
            }
            
            try {
                console.log('ğŸ”„ Refreshing dropdown options...');
                await loadDropdownOptions();
                
                updateDataStatus('Refreshing problems...', 'loading');
                await loadProblems();
                updateDataStatus('Data refreshed successfully', 'success');
                
                // Refresh current problem if viewing details
                if (currentProblem && !document.getElementById('problemDetailsView').classList.contains('hidden')) {
                    const updatedProblem = problems.find(p => p.internalId === currentProblem.internalId);
                    if (updatedProblem) {
                        currentProblem = updatedProblem;
                        openProblemDetailsPage(updatedProblem);
                    }
                }
                
            } catch (error) {
                console.error('âŒ Error refreshing data:', error);
                updateDataStatus('Error refreshing data', 'error');
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = 'ğŸ”„ Refresh';
                }
            }
        }

/**
 * SAFE FUNCTION: Display activity timeline for current problem
 * Called from existing openProblemDetailsPage() function
 */
        
function displayActivityTimeline(problem) {
    console.log('ğŸ” Displaying activity timeline for:', problem.internalId);
    
    const container = document.getElementById('timelineContainer');
    const loading = document.getElementById('timelineLoading');
    
    if (!container || !problem) {
        console.log('Timeline container or problem not found');
        return;
    }
    
    // Show loading state
    if (loading) {
        loading.style.display = 'block';
    }
    
    try {
        // Get activity log from problem data (Column T - activityLogParsed)
        const activities = problem.activityLogParsed || [];
        
        console.log('ğŸ“Š Activity log data:', activities);
        
        // Hide loading
        if (loading) {
            loading.style.display = 'none';
        }
        
        if (!activities || activities.length === 0) {
            container.innerHTML = `
                <div class="timeline-empty">
                    <div style="font-size: 32px; margin-bottom: 10px;">ğŸ”Â</div>
                    <div>No activity history available</div>
                    <div style="font-size: 12px; color: #9ca3af; margin-top: 5px;">
                        Activity tracking started with recent updates
                    </div>
                </div>
            `;
            return;
        }
        
        // Sort activities by timestamp (newest first)
        const sortedActivities = [...activities].sort((a, b) => 
            new Date(b.timestamp) - new Date(a.timestamp)
        );
        
        // Generate timeline HTML
        let timelineHTML = '';
        
        sortedActivities.forEach((activity, index) => {
          

// const timelineItem = createTimelineItem(activity, index === 0);
const timelineItem = createTimelineItem(activity, index === 0);
            
            timelineHTML += timelineItem;
        });
        
        container.innerHTML = timelineHTML;
        
        console.log('âœ… Activity timeline displayed successfully');
        
    } catch (error) {
        console.error('âŒ Error displaying activity timeline:', error);
        
        // Hide loading and show error state
        if (loading) {
            loading.style.display = 'none';
        }
        
        container.innerHTML = `
            <div class="timeline-empty">
                <div style="font-size: 32px; margin-bottom: 10px;">âš ï¸</div>
                <div>Unable to load activity history</div>
                <div style="font-size: 12px; color: #9ca3af; margin-top: 5px;">
                    ${error.message || 'Unknown error occurred'}
                </div>
            </div>
        `;
    }
}
        
/**
 * SAFE FUNCTION: Create individual timeline item HTML
 */

        
function createTimelineItem(activity, isLatest = false) {
    // FIX: Move timestamp creation to the top
    const timestamp = new Date(activity.timestamp);
    const timeAgo = getTimeAgo(timestamp);
    
    // Keep the original format for now - just ensure timestamp is defined first
    const formattedTime = timestamp.toLocaleString('en-AU', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Determine icon and style based on activity type
    let icon = ' ğŸ“';
    let iconClass = 'update';
    
    if (activity.action === 'Created') {
        icon = 'âœ¨';
        iconClass = 'system';
    } else if (activity.action === 'Completed') {
        icon = 'âœ…';
        iconClass = 'completion';
    } else if (activity.action === 'Updated') {
        icon = ' ğŸ“';
        iconClass = 'update';
    } else if (activity.user === 'SYSTEM') {
        icon = 'âš™ï¸';
        iconClass = 'system';
    }
    
    // Build changes HTML
    let changesHTML = '';
    if (activity.changes && activity.changes.length > 0) {
        changesHTML = '<div class="timeline-changes">';
        
        activity.changes.forEach(change => {
            // Handle different change types
            if (change.field === 'Comment Added') {
                // Special handling for comment additions
                changesHTML += `
                    <div class="timeline-change comment-addition">
                        <span class="timeline-field">ğŸ’¬ Comment Added:</span>
                        <div class="timeline-comment-content">
                            "${change.newValue}"
                        </div>
                    </div>
                `;
            } else {
                // Standard field changes
                const oldValue = change.oldValue || '(empty)';
                const newValue = change.newValue || '(empty)';
                
                changesHTML += `
                    <div class="timeline-change">
                        <span class="timeline-field">${change.field}:</span>
                        <div class="timeline-values">
                            <span class="timeline-old-value">${oldValue}</span>
                            <span class="timeline-arrow">â†’</span>
                            <span class="timeline-new-value">${newValue}</span>
                        </div>
                    </div>
                `;
            }
        });
        
        changesHTML += '</div>';
    }
    
    return `
        <div class="timeline-item">
            <div class="timeline-icon ${iconClass}">
                ${icon}
            </div>
            <div class="timeline-content">
                <div class="timeline-header">
                    <span class="timeline-user">${activity.user || 'System'}</span>
                    <span class="timeline-action">${activity.action || 'Updated'}</span>
                    <span class="timeline-time" title="${formattedTime}">
                        ${formattedTime}
                    </span>
                </div>
                ${changesHTML}
            </div>
        </div>
    `;
}

/**
 * SAFE FUNCTION: Get human-readable time ago
 */
function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} min${diffMins === 1 ? '' : 's'} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
    
    return date.toLocaleDateString('en-AU');
}

/**
 * Generate comprehensive activity report from all loaded problems
 */
function generateActivityReport() {
    console.log('ğŸ“‹ Generating activity report...');
    
    try {
        if (!problems || problems.length === 0) {
            alert('No problems loaded. Please refresh the data first.');
            return;
        }
        
        let reportText = `LAKE ILLAWONG MAINTENANCE SYSTEM - ACTIVITY REPORT
Generated: ${new Date().toLocaleString('en-AU')}
========================================================

`;
        
        let totalActivities = 0;
        
        // Process each problem for activities
        problems.forEach(problem => {
            const activities = problem.activityLogParsed || [];
            
            if (activities.length > 0) {
                reportText += `PROBLEM: ${problem.internalId} - Unit ${problem.unitNumber}
Description: ${problem.description || 'No description'}
--------------------------------------------------------
`;
                
                // Sort activities by timestamp (newest first)
                const sortedActivities = [...activities].sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                
                sortedActivities.forEach(activity => {
                    const timestamp = new Date(activity.timestamp).toLocaleString('en-AU');
                    reportText += `${timestamp} - ${activity.user || 'System'}: ${activity.action || 'Updated'}\n`;
                    
                    if (activity.changes && activity.changes.length > 0) {
                        activity.changes.forEach(change => {
                            if (change.field === 'Comment Added') {
                                reportText += `  ğŸ’¬ Comment: "${change.newValue}"\n`;
                            } else {
                                reportText += `  ğŸ”Â ${change.field}: ${change.oldValue || '(empty)'} â†’ ${change.newValue || '(empty)'}\n`;
                            }
                        });
                    }
                    reportText += '\n';
                    totalActivities++;
                });
                
                reportText += '\n';
            }
        });
        
        reportText += `========================================================
SUMMARY: ${totalActivities} total activities across ${problems.length} problems
Report generated by Maintenance Portal `;
        
        // Copy to clipboard
        navigator.clipboard.writeText(reportText).then(() => {
            alert(`Activity report generated and copied to clipboard!\n\nSummary: ${totalActivities} activities from ${problems.length} problems`);
        }).catch(() => {
            // Fallback: show in alert if clipboard fails
            alert('Activity report generated:\n\n' + reportText.substring(0, 500) + '...\n\n(Full report logged to console)');
            console.log('ğŸ“‹ FULL ACTIVITY REPORT:\n', reportText);
        });
        
    } catch (error) {
        console.error('Error generating activity report:', error);
        alert('Error generating activity report. Please try again.');
    }
}
// Add this temporarily to debug dates
function debugProblemData() {
    if (problems.length > 0) {
        const firstProblem = problems[0];
        console.log('ğŸ”’Â DEBUG - First problem data:');
        console.log('timestamp:', firstProblem.timestamp);
        console.log('reportedDate:', firstProblem.reportedDate);
        console.log('reported:', firstProblem.reported);
        console.log('date:', firstProblem.date);
        console.log('All keys:', Object.keys(firstProblem));
    }
}

        
        
        
        console.log('ğŸ¯ Maintenance Portal - Enhanced with URL Search Parameter - Ready for action!');
    </script>
</body>
</html>
